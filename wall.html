<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>T∆∞·ªùng nh√† - Qola</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
:root{
  --accent-1:#60a5fa; --accent-2:#2563eb;
  --bg-dark:#0f172a; --bg-light:#111827; --bg-nav:#0b1220;
  --glass-border:rgba(255,255,255,.08); --glass:rgba(255,255,255,.06);
  --glass-3:rgba(17,24,39,.9);
  --text-primary:#e5e7eb; --text-secondary:#9ca3af;
  --post-bg:#0f172a; --input-bg:rgba(0,0,0,.28);
  --toast-bg:rgba(17,24,39,.92);
  --shadow:0 10px 30px rgba(0,0,0,.35);
}

/* === TH√äM KH·ªêI N√ÄY V√ÄO SAU :root === */
.light {
  --accent-1: #007aff; --accent-2: #0056b3; /* ƒê·ªïi m√†u nh·∫•n */
  --bg-dark: #f0f2f5; --bg-light: #ffffff; --bg-nav: #ffffff; /* N·ªÅn s√°ng */
  --glass-border: rgba(0,0,0,.1); --glass: rgba(0,0,0,.04); /* Border/Glass s√°ng */
  --glass-3: rgba(255,255,255,.9); /* Modal s√°ng */
  --text-primary: #050505; --text-secondary: #65676b; /* Ch·ªØ ƒëen/x√°m */
  --post-bg: #ffffff; --input-bg: rgba(0,0,0,.05); /* Post/Input s√°ng */
  --toast-bg: rgba(255,255,255,.95); /* Toast s√°ng */
  --shadow: 0 6px 18px rgba(0,0,0,.1); /* B√≥ng m·ªù h∆°n */
  --skeleton-bg: rgba(0, 0, 0, 0.08); /* Skeleton s√°ng */
}

/* ƒêi·ªÅu ch·ªânh nh·ªè cho header s√°ng */
.light .wall-header {
    background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.8));
    border-bottom-color: var(--glass-border);
}
.light .search-input {
    background: var(--input-bg);
    border-color: var(--glass-border);
    color: var(--text-primary);
}
.light .add-post-btn {
    /* Gi·ªØ nguy√™n m√†u xanh ho·∫∑c ƒë·ªïi n·∫øu mu·ªën */
}

/* ƒêi·ªÅu ch·ªânh post card s√°ng */
.light .post-card {
    background: var(--post-bg);
    border-color: var(--glass-border);
    box-shadow: 0 1px 2px rgba(0,0,0,.15); /* B√≥ng nh·∫π h∆°n */
}

/* ƒêi·ªÅu ch·ªânh n√∫t action s√°ng */
.light .action-btn {
    background: var(--input-bg);
    border-color: var(--glass-border);
    color: var(--text-secondary);
}
.light .action-btn.liked {
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
    color: #fff;
    border-color: transparent;
}

/* ƒêi·ªÅu ch·ªânh modal s√°ng */
.light .modal-content {
    background: var(--glass-3);
    border-color: var(--glass-border);
    box-shadow: var(--shadow);
}
.light .modal-content textarea, .light .modal-content input, .light .modal-content select {
    background: var(--input-bg);
    border-color: var(--glass-border);
    color: var(--text-primary);
}
.light .btn-ghost {
    background: rgba(0,0,0,.05);
    border-color: var(--glass-border);
    color: var(--text-secondary);
}
.light .chip {
    background: var(--input-bg);
    border-color: var(--glass-border);
}
.light .mention-suggest {
     background: var(--glass-3);
     border-color: var(--glass-border);
}
.light .mention-item:hover {
     background: rgba(0,0,0,.05);
}

/* === CSS CHO SKELETON LOADING === */
.skeleton {
    background: var(--skeleton-bg, rgba(255, 255, 255, 0.05)); /* D√πng bi·∫øn n·∫øu c√≥, fallback m√†u t·ªëi */
    border-radius: 8px;
    position: relative;
    overflow: hidden;
}
.skeleton-circle {
    border-radius: 50%;
}
.skeleton-line {
    border-radius: 6px; /* Bo g√≥c nh·∫π cho line */
}

/* Animation l·∫•p l√°nh */
.skeleton::after {
    content: '';
    position: absolute;
    inset: 0;
    transform: translateX(-100%);
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent);
    animation: shimmer 1.5s infinite;
}
@keyframes shimmer {
    100% {
        transform: translateX(100%);
    }
}

/* Ghi ƒë√® l·∫°i CSS loading c≈© ƒë·ªÉ ·∫©n placeholder khi kh√¥ng load n·ªØa */
/* (CSS n√†y c√≥ th·ªÉ ƒë√£ c√≥ ·ªü b∆∞·ªõc tr∆∞·ªõc) */
body:not(.wall-loading) #post-list .post-card-placeholder {
     display: none;
}
/* ƒê·∫£m b·∫£o placeholder hi·ªán khi ƒëang loading */
body.wall-loading #post-list .post-card-placeholder {
     display: block; /* Ho·∫∑c flex t√πy v√†o c·∫•u tr√∫c skeleton c·∫≠u mu·ªën */
}
/* ·∫®n post th·∫≠t khi ƒëang load */
body.wall-loading #post-list .post-card:not(.post-card-placeholder) {
    display: none;
}

/* === CSS CHO HI·ªÜU ·ª®NG LOADING WALL === */

/* 1. M·∫∑c ƒë·ªãnh ·∫©n t·∫•t c·∫£ b√†i ƒëƒÉng TH·∫¨T b√™n trong #post-list */
body.wall-loading #post-list .post-card:not(.post-card-placeholder) {
    display: none;
}

/* 2. Style cho placeholder khi ƒëang loading (T√πy ch·ªânh n·∫øu mu·ªën) */
body.wall-loading #post-list .post-card-placeholder {
    display: flex; /* ƒê·∫£m b·∫£o n√≥ hi·ªán ra */
    min-height: 200px; /* Cho n√≥ cao h∆°n ch√∫t */
    align-items: center;
    justify-content: center;
    font-size: 1.1em;
    color: var(--text-secondary);
    opacity: 0.8;
}

*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Poppins',sans-serif;background:var(--bg-dark);color:var(--text-primary);padding-top:72px}

.wall-header{position:fixed;top:0;left:0;right:0;height:72px;display:flex;align-items:center;gap:14px;padding:14px 18px;background:linear-gradient(180deg,rgba(2,6,23,.8),rgba(2,6,23,.6));backdrop-filter:blur(10px);border-bottom:1px solid var(--glass-border);z-index:1000}
.back-btn{display:none!important}
.header-info{display:flex;align-items:center;gap:12px;overflow:hidden}
.header-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid var(--glass-border)}
.header-name{font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.search-wrap{margin-left:auto;display:flex;align-items:center;gap:10px}
.search-input{width:230px;padding:10px 14px;border-radius:999px;border:1px solid var(--glass-border);background:var(--input-bg);outline:none;color:var(--text-primary)}
.add-post-btn{width:40px;height:40px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));color:#fff;font-size:26px;display:flex;align-items:center;justify-content:center;cursor:pointer}

.wall-container{max-width:720px;margin:18px auto;padding:0 16px}
#post-list{display:flex;flex-direction:column;gap:18px}
.post-card{background:var(--post-bg);border:1px solid var(--glass-border);border-radius:16px;padding:16px 18px;box-shadow:0 6px 18px rgba(0,0,0,.18)}
.post-card-placeholder{min-height:100px;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);font-style:italic}

.post-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.author-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid var(--glass-border);cursor:pointer}
.author-info{flex:1}
.author-name{font-weight:600;cursor:pointer}
.author-name:hover{text-decoration:underline}
.post-timestamp{font-size:12px;color:var(--text-secondary)}
.post-content{margin-top:4px}
.post-text{white-space:pre-wrap;line-height:1.6;margin-bottom:8px}
.mentions{color:#93c5fd;font-weight:600}
.post-image{display:block;max-width:100%;border-radius:12px;margin-top:10px;border:1px solid var(--glass-border)}

.post-actions{display:flex;align-items:center;gap:12px;border-top:1px solid var(--glass-border);margin-top:12px;padding-top:10px}
.action-btn{padding:8px 12px;border-radius:999px;border:1px solid var(--glass-border);background:var(--glass);color:var(--text-secondary);cursor:pointer}
.action-btn.liked{background:linear-gradient(135deg,var(--accent-1),var(--accent-2));border-color:transparent;color:#fff}
.count{margin-left:auto;font-size:13px;color:var(--text-secondary)}

#toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--toast-bg);color:var(--text-primary);padding:14px 18px;border-radius:12px;border:1px solid var(--glass-border);box-shadow:var(--shadow);display:none;z-index:1100}
#toast.success{border-left:4px solid #22c55e;color:#22c55e}
#toast.error{border-left:4px solid #ef4444;color:#ef4444}
#toast.info{border-left:4px solid var(--accent-1);color:var(--accent-1)}

/* === TH√äM CSS CHO SPINNER XOAY === */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Modal ‚Äì fix layout */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:2000}
.modal-content{width:min(92vw,640px);background:var(--glass-3);border:1px solid var(--glass-border);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.5);padding:20px 22px}
.modal-content h2{font-size:20px;margin-bottom:12px;text-align:left}
.modal-row{display:flex;gap:12px;align-items:flex-start}
.modal-col{flex:1}
.modal-content label{display:block;margin:10px 0 6px;color:var(--text-secondary);font-size:14px}
.modal-content textarea,.modal-content input,.modal-content select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--glass-border);background:var(--input-bg);color:var(--text-primary);outline:none}
.modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:14px}
.btn{padding:10px 16px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));color:#fff;cursor:pointer}
.btn-ghost{padding:10px 16px;border:1px solid var(--glass-border);border-radius:10px;background:transparent;color:var(--text-primary);cursor:pointer}

/* Chips + mention popup */
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--glass);border:1px solid var(--glass-border);font-size:13px}
.remove-x{cursor:pointer;opacity:.85}
.mention-suggest{position:absolute;z-index:3000;background:var(--glass-3);border:1px solid var(--glass-border);border-radius:12px;padding:6px;max-height:240px;overflow:auto;box-shadow:var(--shadow);display:none}
.mention-item{padding:8px 10px;border-radius:8px;display:flex;align-items:center;gap:8px;cursor:pointer}
.mention-item:hover{background:var(--glass)}
.mention-avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid var(--glass-border)}
</style>
</head>
<body>
<div id="toast"></div>

<div class="wall-header">
  <button id="back-to-profile-btn" class="back-btn" title="Quay l·∫°i">‚Äπ</button>
  <div class="header-info">
    <img id="header-avatar" class="header-avatar" src="https://placehold.co/40x40" alt="avatar">
    <span id="header-name">ƒêang t·∫£i...</span>
  </div>

  <div class="search-wrap">
    <input id="search-input" class="search-input" type="text" placeholder="T√¨m b√†i ƒëƒÉng..." />
    <button id="open-create-post-modal-btn" class="add-post-btn" title="T·∫°o b√†i ƒëƒÉng m·ªõi" style="display:none;">+</button>
  </div>
</div>

<div class="wall-container">
  <div id="post-list">
    <div class="post-card post-card-placeholder" style="padding: 16px 18px; display: block; min-height: 0;"> <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px; flex-shrink: 0;"></div>
            <div style="flex-grow: 1;">
                <div class="skeleton skeleton-line" style="height: 16px; width: 40%; margin-bottom: 6px;"></div>
                <div class="skeleton skeleton-line" style="height: 12px; width: 30%;"></div>
            </div>
        </div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 90%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 95%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 70%;"></div>
    </div>
    <div class="post-card post-card-placeholder" style="padding: 16px 18px; display: block; min-height: 0;"> <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px; flex-shrink: 0;"></div>
            <div style="flex-grow: 1;">
                <div class="skeleton skeleton-line" style="height: 16px; width: 40%; margin-bottom: 6px;"></div>
                <div class="skeleton skeleton-line" style="height: 12px; width: 30%;"></div>
            </div>
        </div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 90%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 95%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 70%;"></div>
    </div>
    <div class="post-card post-card-placeholder" style="padding: 16px 18px; display: block; min-height: 0;"> <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px; flex-shrink: 0;"></div>
            <div style="flex-grow: 1;">
                <div class="skeleton skeleton-line" style="height: 16px; width: 40%; margin-bottom: 6px;"></div>
                <div class="skeleton skeleton-line" style="height: 12px; width: 30%;"></div>
            </div>
        </div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 90%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 95%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 70%;"></div>
    </div>
    <div class="post-card post-card-placeholder" style="padding: 16px 18px; display: block; min-height: 0;"> <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px; flex-shrink: 0;"></div>
            <div style="flex-grow: 1;">
                <div class="skeleton skeleton-line" style="height: 16px; width: 40%; margin-bottom: 6px;"></div>
                <div class="skeleton skeleton-line" style="height: 12px; width: 30%;"></div>
            </div>
        </div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 90%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 95%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 70%;"></div>
    </div>
    <div class="post-card post-card-placeholder" style="padding: 16px 18px; display: block; min-height: 0;"> <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px; flex-shrink: 0;"></div>
            <div style="flex-grow: 1;">
                <div class="skeleton skeleton-line" style="height: 16px; width: 40%; margin-bottom: 6px;"></div>
                <div class="skeleton skeleton-line" style="height: 12px; width: 30%;"></div>
            </div>
        </div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 90%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 95%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 70%;"></div>
    </div>
    <div class="post-card post-card-placeholder" style="padding: 16px 18px; display: block; min-height: 0;"> <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px; flex-shrink: 0;"></div>
            <div style="flex-grow: 1;">
                <div class="skeleton skeleton-line" style="height: 16px; width: 40%; margin-bottom: 6px;"></div>
                <div class="skeleton skeleton-line" style="height: 12px; width: 30%;"></div>
            </div>
        </div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 90%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 95%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 70%;"></div>
    </div>
    <div class="post-card post-card-placeholder" style="padding: 16px 18px; display: block; min-height: 0;"> <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px; flex-shrink: 0;"></div>
            <div style="flex-grow: 1;">
                <div class="skeleton skeleton-line" style="height: 16px; width: 40%; margin-bottom: 6px;"></div>
                <div class="skeleton skeleton-line" style="height: 12px; width: 30%;"></div>
            </div>
        </div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 90%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 95%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 70%;"></div>
    </div><div class="post-card post-card-placeholder" style="padding: 16px 18px; display: block; min-height: 0;"> <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px; flex-shrink: 0;"></div>
            <div style="flex-grow: 1;">
                <div class="skeleton skeleton-line" style="height: 16px; width: 40%; margin-bottom: 6px;"></div>
                <div class="skeleton skeleton-line" style="height: 12px; width: 30%;"></div>
            </div>
        </div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 90%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 95%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 70%;"></div>
    </div>
    <div class="post-card post-card-placeholder" style="padding: 16px 18px; display: block; min-height: 0;"> <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px; flex-shrink: 0;"></div>
            <div style="flex-grow: 1;">
                <div class="skeleton skeleton-line" style="height: 16px; width: 40%; margin-bottom: 6px;"></div>
                <div class="skeleton skeleton-line" style="height: 12px; width: 30%;"></div>
            </div>
        </div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 90%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 95%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-line" style="height: 14px; width: 70%;"></div>
    </div>
    </div>
</div>

<!-- Modal t·∫°o b√†i -->
<div id="create-post-modal" class="modal-overlay">
  <div class="modal-content">
    <h2>T·∫°o b√†i ƒëƒÉng m·ªõi</h2>
    <div>
      <label for="post-text-input">N·ªôi dung</label>
      <div style="position:relative">
        <textarea id="post-text-input" rows="5" placeholder="B·∫°n ƒëang nghƒ© g√¨?"></textarea>
        <div id="mention-list" class="mention-suggest"></div>
      </div>

      <div class="modal-row">
        <div class="modal-col">
          <label>Tag b·∫°n b√®</label>
          <div id="tag-chips" class="chips"></div>
        </div>
        <div style="width:220px">
          <label>Quy·ªÅn xem</label>
          <select id="visibility-select">
            <option value="public">C√¥ng khai</option>
            <option value="friends">B·∫°n b√®</option>
            <option value="only_me">Ch·ªâ m√¨nh t√¥i</option>
            <option value="friends_except">B·∫°n b√® tr·ª´‚Ä¶</option>
          </select>
        </div>
      </div>

      <div id="except-wrap" style="display:none">
        <label>Lo·∫°i tr·ª´ (ch·ªçn b·∫°n kh√¥ng mu·ªën h·ªç th·∫•y)</label>
        <div id="except-chips" class="chips"></div>
      </div>

      <label>·∫¢nh/Video</label>
      <div class="modal-row" style="align-items:center">
        <input type="file" id="post-image-input" accept="image/*,video/*" />
        <div id="post-image-filename" style="color:var(--text-secondary);font-size:13px"></div>
      </div>
    </div>

    <div class="modal-actions">
      <button id="cancel-create-post-btn" class="btn-ghost">H·ªßy</button>
      <button id="submit-post-btn" class="btn">ƒêƒÉng b√†i</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, collection, query, where, orderBy, getDocs, addDoc, serverTimestamp,
  onSnapshot, setDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

const firebaseConfig = { apiKey:"AIzaSyBuGG9WKYZHb1qbmihpJFjCBsTB_VJ_LvU", authDomain:"qola-web.firebaseapp.com", databaseURL:"https://qola-web-default-rtdb.firebaseio.com", projectId:"qola-web", storageBucket:"qola-web.firebasestorage.app", messagingSenderId:"477682993077", appId:"1:477682993077:web:7dce15eb2c365729173bfc" };
const IMGBB_API_KEY = "e6c2724ff8344c073410da4876c3d35f";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

(function initWallTheme() {
    const savedTheme = localStorage.getItem('theme'); // ƒê·ªçc theme t·ª´ localStorage
    if (savedTheme === 'light') {
        document.body.classList.add('light');
    } else {
        document.body.classList.remove('light'); // ƒê·∫£m b·∫£o theme m·∫∑c ƒë·ªãnh l√† dark n·∫øu kh√¥ng c√≥ setting
    }
})();
// === K·∫æT TH√öC ƒêO·∫†N CODE THEME ===
const toast = document.getElementById('toast');
const headerAvatar = document.getElementById('header-avatar');
const headerName = document.getElementById('header-name');
const postList = document.getElementById('post-list');
const openCreatePostModalBtn = document.getElementById('open-create-post-modal-btn');
const createPostModal = document.getElementById('create-post-modal');
const cancelCreatePostBtn = document.getElementById('cancel-create-post-btn');
const submitPostBtn = document.getElementById('submit-post-btn');
const postTextInput = document.getElementById('post-text-input');
const mentionList = document.getElementById('mention-list');
const postImageInput = document.getElementById('post-image-input');
const postImageFilename = document.getElementById('post-image-filename');
const tagChips = document.getElementById('tag-chips');
const exceptWrap = document.getElementById('except-wrap');
const exceptChips = document.getElementById('except-chips');
const visibilitySelect = document.getElementById('visibility-select');
const searchInput = document.getElementById('search-input');

const params = new URLSearchParams(window.location.search);
const wallUserId = params.get("id");

let toastTimer, currentUser, wallUserData;
let friends = []; // [{uid, displayName, avatarUrl}]
let selectedTags = new Set();
let selectedExcept = new Set();
let loadedPosts = []; // cache ƒë·ªÉ filter t√¨m ki·∫øm

function showToast(msg, type='info'){ clearTimeout(toastTimer); toast.textContent=msg; toast.className=''; toast.classList.add(type); toast.style.display='block'; toastTimer=setTimeout(()=>toast.style.display='none',3000); }
function formatTimestamp(date){ const now=new Date(); const diff=(now-date)/1000|0; if(diff<60) return `${diff} gi√¢y tr∆∞·ªõc`; const m=diff/60|0; if(m<60) return `${m} ph√∫t tr∆∞·ªõc`; const h=m/60|0; if(h<24) return `${h} gi·ªù tr∆∞·ªõc`; const d=h/24|0; if(d<7) return `${d} ng√†y tr∆∞·ªõc`; return date.toLocaleDateString('vi-VN'); }
async function uploadImage(file){ if(!IMGBB_API_KEY) throw new Error('Thi·∫øu API ImgBB'); const fd=new FormData(); fd.append('image', file); const res=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:'POST',body:fd}); const data=await res.json(); if(data.success) return data.data.url; throw new Error(data.error?.message||'Upload th·∫•t b·∫°i'); }
function el(tag, attrs={}, ...children){ const e=document.createElement(tag); for(const [k,v] of Object.entries(attrs)){ if(k==='className') e.className=v; else if(k==='dataset') Object.assign(e.dataset,v); else if(k.startsWith('on')) e[k]=v; else e.setAttribute(k,v) } children.forEach(c=>e.append(c)); return e; }

onAuthStateChanged(auth, async (u) => {
    if (!u) {
        // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p, chuy·ªÉn v·ªÅ trang login
        window.location.href = 'login.html';
        return;
    }
    currentUser = u; // G√°n user hi·ªán t·∫°i v√†o bi·∫øn global

    // TH√äM D√íNG N√ÄY: K√≠ch ho·∫°t tr·∫°ng th√°i loading ngay t·ª´ ƒë·∫ßu
    document.body.classList.add('wall-loading');

    // Ki·ªÉm tra xem c√≥ wallUserId t·ª´ URL kh√¥ng
    if (!wallUserId) {
        headerName.textContent = "L·ªói: Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng";
        postList.innerHTML = '<div class="post-card post-card-placeholder" style="color: red;">Kh√¥ng th·ªÉ t·∫£i trang n√†y.</div>';
        document.body.classList.remove('wall-loading'); // X√≥a loading ƒë·ªÉ hi·ªán l·ªói
        return; // D·ª´ng l·∫°i n·∫øu kh√¥ng c√≥ ID
    }

    // B·∫Øt ƒë·∫ßu kh·ªëi try ƒë·ªÉ x·ª≠ l√Ω b·∫•t k·ª≥ l·ªói n√†o khi t·∫£i d·ªØ li·ªáu
    try {
        // L·∫•y th√¥ng tin ng∆∞·ªùi d√πng c·ªßa t∆∞·ªùng nh√† n√†y
        const userSnap = await getDoc(doc(db, 'users', wallUserId));
        if (!userSnap.exists() || userSnap.data().isDeactivated) {
            headerName.textContent = "Ng∆∞·ªùi d√πng kh√¥ng t·ªìn t·∫°i";
            postList.innerHTML = '<div class="post-card post-card-placeholder">T√†i kho·∫£n n√†y kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ ng·ª´ng ho·∫°t ƒë·ªông.</div>';
            document.body.classList.remove('wall-loading'); // X√≥a loading ƒë·ªÉ hi·ªán l·ªói
            return; // D·ª´ng l·∫°i n·∫øu user kh√¥ng h·ª£p l·ªá
        }
        wallUserData = userSnap.data(); // L∆∞u th√¥ng tin ch·ªß t∆∞·ªùng

        // C·∫≠p nh·∫≠t th√¥ng tin tr√™n header
        const headerInitial = (wallUserData.displayName || wallUserData.email || '?')[0].toUpperCase();
        headerAvatar.src = wallUserData.avatarUrl || `https://placehold.co/40x40?text=${headerInitial}`;
        headerName.textContent = wallUserData.displayName || wallUserData.email || 'Ng∆∞·ªùi d√πng Qola';
        document.title = `T∆∞·ªùng nh√† ${wallUserData.displayName || ''} - Qola`; // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ trang

        // Ki·ªÉm tra xem c√≥ ph·∫£i t∆∞·ªùng nh√† c·ªßa ch√≠nh m√¨nh kh√¥ng
        const isOwnWall = (wallUserId === currentUser.uid);

        // X·ª≠ l√Ω n√∫t ƒëƒÉng b√†i (+)
        openCreatePostModalBtn.style.display = isOwnWall ? 'flex' : 'none';
        if (isOwnWall) {
            // G√°n s·ª± ki·ªán cho modal t·∫°o b√†i ch·ªâ khi l√† t∆∞·ªùng c·ªßa m√¨nh
            openCreatePostModalBtn.onclick = () => { resetCreateForm(); createPostModal.style.display = 'flex'; };
            cancelCreatePostBtn.onclick = () => createPostModal.style.display = 'none';
            submitPostBtn.onclick = createPost;
            postImageInput.onchange = () => postImageFilename.textContent = postImageInput.files[0]?.name || '';
            visibilitySelect.onchange = () => exceptWrap.style.display = (visibilitySelect.value === 'friends_except') ? 'block' : 'none';

            // Ch·ªâ load danh s√°ch b·∫°n b√® n·∫øu l√† t∆∞·ªùng c·ªßa m√¨nh (ƒë·ªÉ tag/mention)
            friends = await loadFriends(currentUser.uid);
            renderChipLists(); // Render l·∫°i chip n·∫øu c·∫ßn
            attachMentionSuggest(); // G·∫Øn l·∫°i mention
        } else {
             // N·∫øu kh√¥ng ph·∫£i t∆∞·ªùng c·ªßa m√¨nh, ƒë·∫£m b·∫£o g·ª° b·ªè c√°c listener c≈©
             openCreatePostModalBtn.onclick = null;
             cancelCreatePostBtn.onclick = null;
             submitPostBtn.onclick = null;
             postImageInput.onchange = null;
             visibilitySelect.onchange = null;
             // Kh√¥ng c·∫ßn load friends hay g·∫Øn mention
             friends = []; // Reset friends
        }

        // === T·∫¢I B√ÄI ƒêƒÇNG (QUAN TR·ªåNG) ===
        if (isOwnWall) {
            await loadUnifiedFeed(); // T·∫£i feed t·ªïng h·ª£p (ch·ªù xong)
        } else {
            await loadOnlyWallUser(); // T·∫£i b√†i c·ªßa ch·ªß t∆∞·ªùng (ch·ªù xong)
        }
        // === K·∫æT TH√öC T·∫¢I B√ÄI ƒêƒÇNG ===


    } catch (error) {
        // X·ª≠ l√Ω l·ªói n·∫øu c√≥ v·∫•n ƒë·ªÅ trong qu√° tr√¨nh l·∫•y data user ho·∫∑c posts
        console.error("L·ªói khi t·∫£i trang t∆∞·ªùng nh√†:", error);
        headerName.textContent = "L·ªói t·∫£i trang"; // C·∫≠p nh·∫≠t header b√°o l·ªói
        postList.innerHTML = '<div class="post-card post-card-placeholder" style="color: red;">ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu!</div>';

    } finally {
        // TH√äM D√íNG N√ÄY: Lu√¥n x√≥a tr·∫°ng th√°i loading SAU KHI load xong (k·ªÉ c·∫£ khi l·ªói)
        document.body.classList.remove('wall-loading');
    }

    // G·∫Øn s·ª± ki·ªán cho √¥ t√¨m ki·∫øm (lu√¥n g·∫Øn, nh∆∞ng h√†m filterAndRenderPosts s·∫Ω ch·∫°y ƒë√∫ng v√¨ loadedPosts ƒë√£ c√≥)
    searchInput.addEventListener('input', filterAndRenderPosts);

}); // K·∫øt th√∫c onAuthStateChanged

async function loadFriends(uid){
  const out=new Map();
  // subcollection
  try{
    const snap=await getDocs(collection(db,'users',uid,'friends'));
    for(const d of snap.docs){
      const fid=d.id;
      const us=await getDoc(doc(db,'users',fid));
      if(us.exists()) out.set(fid,{uid:fid,displayName:us.data().displayName||'B·∫°n b√®',avatarUrl:us.data().avatarUrl||null});
    }
  }catch(_){}
  // array fallback
  try{
    const me=await getDoc(doc(db,'users',uid));
    if(me.exists()){
      const arr=me.data().friends||[];
      for(const fid of arr){
        if(out.has(fid)) continue;
        const us=await getDoc(doc(db,'users',fid));
        if(us.exists()) out.set(fid,{uid:fid,displayName:us.data().displayName||'B·∫°n b√®',avatarUrl:us.data().avatarUrl||null});
      }
    }
  }catch(_){}
  return Array.from(out.values());
}

function renderChipLists(){
  tagChips.innerHTML=''; exceptChips.innerHTML='';
  for(const f of friends){
    if(selectedTags.has(f.uid)) tagChips.appendChild(chip(f,()=>{selectedTags.delete(f.uid);renderChipLists();}));
    if(selectedExcept.has(f.uid)) exceptChips.appendChild(chip(f,()=>{selectedExcept.delete(f.uid);renderChipLists();}));
  }
}

function chip(friend, onRemove){
  return el('span',{className:'chip'},
    el('img',{src:friend.avatarUrl||'https://placehold.co/20x20',style:'width:18px;height:18px;border-radius:50%;object-fit:cover;border:1px solid var(--glass-border)'}),
    document.createTextNode(friend.displayName||'B·∫°n'),
    el('span',{className:'remove-x',onclick:onRemove,title:'B·ªè'},'‚úï')
  );
}

function resetCreateForm(){
  postTextInput.value=''; postImageInput.value=''; postImageFilename.textContent='';
  selectedTags=new Set(); selectedExcept=new Set(); visibilitySelect.value='public'; exceptWrap.style.display='none';
  renderChipLists();
}

/* Mention popup @ */
function attachMentionSuggest(){
  let atMode=false, atStart=0;
  const close=()=> mentionList.style.display='none';
  const open=(items)=>{
    mentionList.innerHTML='';
    items.slice(0,20).forEach(f=>{
      const row=el('div',{className:'mention-item',onclick:()=>select(f)},
        el('img',{src:f.avatarUrl||'https://placehold.co/28x28',className:'mention-avatar'}),
        el('span',{},f.displayName||'B·∫°n')
      );
      mentionList.appendChild(row);
    });
    const r=postTextInput.getBoundingClientRect();
    mentionList.style.left=r.left+'px';
    mentionList.style.top=(r.top+window.scrollY-mentionList.offsetHeight-6)+'px';
    mentionList.style.display='block';
  };
  const select=(friend)=>{
    const t=postTextInput.value;
    const end=postTextInput.selectionStart;
    const before=t.slice(0,atStart); const after=t.slice(end);
    const insert='@'+(friend.displayName||'Ban')+' ';
    postTextInput.value=before+insert+after;
    const caret=(before+insert).length; postTextInput.setSelectionRange(caret,caret);
    atMode=false; close(); selectedTags.add(friend.uid); renderChipLists();
  };
  postTextInput.addEventListener('keydown',e=>{ if(e.key==='Escape'){ atMode=false; close(); }});
  postTextInput.addEventListener('input',()=>{
    const pos=postTextInput.selectionStart; const text=postTextInput.value; const sub=text.slice(0,pos);
    const i=sub.lastIndexOf('@');
    if(i>=0){
      const token=sub.slice(i+1,pos);
      if(token.includes(' ')||token.includes('\n')){ atMode=false; close(); return; }
      atMode=true; atStart=i;
      const key=token.trim().toLowerCase();
      const list=key? friends.filter(f=>(f.displayName||'').toLowerCase().includes(key)) : friends;
      if(list.length) open(list); else close();
    }else{ atMode=false; close(); }
  });
  document.addEventListener('click',e=>{ if(!mentionList.contains(e.target) && e.target!==postTextInput) close(); });
}

/* Hi·ªÉn th·ªã b√†i: h·ª£p nh·∫•t cho t∆∞·ªùng c·ªßa ch√≠nh m√¨nh */
async function loadUnifiedFeed(){
  loadedPosts=[];
  const ids=[currentUser.uid, ...friends.map(f=>f.uid)];
  // chia l√¥ 10 uid
  const chunks=[]; for(let i=0;i<ids.length;i+=10) chunks.push(ids.slice(i,i+10));
  const postsRef=collection(db,'posts');
  for(const group of chunks){
    const qy=query(postsRef, where('userId','in',group), orderBy('timestamp','desc'));
    const snap=await getDocs(qy);
    snap.forEach(d=> loadedPosts.push({id:d.id, ...d.data()}));
  }
  loadedPosts.sort((a,b)=> (b.timestamp?.toMillis?.()||0)-(a.timestamp?.toMillis?.()||0));
  filterAndRenderPosts();
}

/* Ch·ªâ b√†i c·ªßa ch·ªß t∆∞·ªùng (khi xem ng∆∞·ªùi kh√°c) */
async function loadOnlyWallUser(){
  postList.innerHTML='<div class="post-card post-card-placeholder">ƒêang t·∫£i b√†i ƒëƒÉng‚Ä¶</div>';
  loadedPosts=[];
  const postsRef=collection(db,'posts');
  const qy=query(postsRef, where('userId','==',wallUserId), orderBy('timestamp','desc'));
  const snap=await getDocs(qy);
  snap.forEach(d=> loadedPosts.push({id:d.id, ...d.data()}));
  filterAndRenderPosts();
}

/* Quy·ªÅn xem */
function isFriend(viewerId){
  return friends.some(f=>f.uid===viewerId);
}
function canViewPost(p, viewerId){
  const v=p.visibility||'public';
  if(p.userId===viewerId) return true;
  if(v==='public') return true;
  if(v==='only_me') return false;
  if(v==='friends') return isFriend(viewerId);
  if(v==='friends_except'){
    if(!isFriend(viewerId)) return false;
    return !(p.exceptList||[]).includes(viewerId);
  }
  return true;
}

/* T√¨m ki·∫øm c·ª•c b·ªô + render */
function filterAndRenderPosts(){
  const kw=(searchInput.value||'').trim().toLowerCase();
  let list=loadedPosts.filter(p=>canViewPost(p,currentUser.uid));
  if(kw){
    list=list.filter(p=>{
      const text=(p.text||'').toLowerCase();
      const author=(p.displayName||'').toLowerCase();
      const tags=(p.taggedFriends||[]).map(uid=>friends.find(x=>x.uid===uid)?.displayName?.toLowerCase()||'').join(' ');
      return text.includes(kw)||author.includes(kw)||tags.includes(kw);
    });
  }
  renderPostList(list);
}

function renderPostList(posts){
  postList.innerHTML='';
  if(!posts.length){ postList.innerHTML='<div class="post-card post-card-placeholder">Kh√¥ng c√≥ b√†i ph√π h·ª£p.</div>'; return; }
  posts.forEach(p=> postList.appendChild(createPostElement(p.id,p)));
}

/* B√†i + Like realtime */
function createPostElement(postId, postData){
  const card=el('div',{className:'post-card',dataset:{postId}});
  const header=el('div',{className:'post-header'});
  const ava=el('img',{className:'author-avatar',src:postData.avatarUrl||`https://placehold.co/40x40?text=${(postData.displayName||'?')[0]}`,onclick:()=>window.location.href=`profile.html?id=${postData.userId}`});
  const info=el('div',{className:'author-info'});
  const name=el('div',{className:'author-name',onclick:()=>window.location.href=`profile.html?id=${postData.userId}`},postData.displayName||'Ng∆∞·ªùi d√πng Qola');
  const time=el('div',{className:'post-timestamp'}, postData.timestamp?formatTimestamp(postData.timestamp.toDate()):'');
  info.append(name,time); header.append(ava,info);

  const content=el('div',{className:'post-content'});
  if(postData.text){
    const txt=el('p',{className:'post-text'}, postData.text);
    content.append(txt);
    if((postData.taggedFriends||[]).length){
      const mentions=el('div',{className:'mentions'},'Tag: '+(postData.taggedFriends||[]).map(uid=>friends.find(f=>f.uid===uid)?.displayName||'B·∫°n').join(', '));
      content.append(mentions);
    }
  }
  if(postData.imageUrl) content.append(el('img',{className:'post-image',src:postData.imageUrl}));

  const actions=el('div',{className:'post-actions'});
  const likeBtn=el('button',{className:'action-btn'},'‚ù§Ô∏è Th√≠ch');
  const likeCount=el('span',{className:'count'},'0 l∆∞·ª£t th√≠ch');

  const likesCol=collection(db,'posts',postId,'likes');
  const likeDoc=doc(db,'posts',postId,'likes', currentUser.uid);

  onSnapshot(likesCol,(snap)=>{ likeCount.textContent=`${snap.size} l∆∞·ª£t th√≠ch`; });
  onSnapshot(likeDoc,(s)=>{ likeBtn.classList.toggle('liked',s.exists()); likeBtn.textContent=s.exists()?'üíô ƒê√£ th√≠ch':'‚ù§Ô∏è Th√≠ch'; });
  likeBtn.onclick=async()=>{ const cur=await getDoc(likeDoc); if(cur.exists()) await deleteDoc(likeDoc); else await setDoc(likeDoc,{at:serverTimestamp()}); };

  // nh√£n quy·ªÅn xem
  const visIcon={public:'üåê',friends:'üë•',only_me:'üîí',friends_except:'üö´'}[postData.visibility||'public']||'üåê';
  name.appendChild(el('span',{style:'margin-left:6px;color:var(--text-secondary);font-size:13px'},visIcon));

  actions.append(likeBtn,likeCount);
  card.append(header,content,actions);
  return card;
}

/* T·∫°o b√†i */
async function createPost(){
  if(!currentUser) return;
  const text=postTextInput.value.trim();
  const file=postImageInput.files[0];
  if(!text && !file) return showToast('Vui l√≤ng nh·∫≠p n·ªôi dung ho·∫∑c ch·ªçn ·∫£nh.', 'error');

  submitPostBtn.disabled=true; submitPostBtn.textContent='ƒêang ƒëƒÉng‚Ä¶';
  try{
    let imageUrl=null;
    if(file) imageUrl=await uploadImage(file);

    const me=await getDoc(doc(db,'users',currentUser.uid));
    const meData=me.exists()? me.data() : {};

    const visibility=visibilitySelect.value;
    const exceptList=(visibility==='friends_except')? Array.from(selectedExcept):[];

    const postData={
      userId:currentUser.uid,
      displayName:meData.displayName || currentUser.email,
      avatarUrl:meData.avatarUrl || null,
      text:text || null,
      imageUrl,
      taggedFriends:Array.from(selectedTags),
      visibility,
      exceptList,
      timestamp:serverTimestamp(),
    };

    await addDoc(collection(db,'posts'),postData);
    showToast('ƒêƒÉng b√†i th√†nh c√¥ng!','success');
    createPostModal.style.display='none';
    resetCreateForm();

    if(wallUserId===currentUser.uid) await loadUnifiedFeed(); else await loadOnlyWallUser();

  }catch(e){ console.error(e); showToast('ƒêƒÉng b√†i th·∫•t b·∫°i: '+e.message,'error'); }
  finally{ submitPostBtn.disabled=false; submitPostBtn.textContent='ƒêƒÉng b√†i'; }
}
</script>
</body>
</html>
