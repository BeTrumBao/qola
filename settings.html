<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Cài đặt - Qola</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

/* --- Variables --- */
:root {
    --accent-1: #60a5fa;
    --accent-2: #2563eb;
    --bg-page: #0f172a;
    --bg-card: #1e293b;
    --bg-nav: #111827;
    --glass-border: rgba(255, 255, 255, 0.1);
    --hover-bg: rgba(255, 255, 255, 0.05);
    --active-bg: rgba(96, 165, 250, 0.15);
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --input-bg: rgba(0, 0, 0, 0.2);
    --modal-bg: rgba(22, 25, 35, 0.85);
    --toast-bg: rgba(22, 25, 35, 0.85);
    --shadow: 0 10px 30px rgba(0,0,0,0.2);
}
.light {
    --accent-1: #007aff;
    --accent-2: #0056b3;
    --bg-page: #f0f2f5;
    --bg-card: #ffffff;
    --bg-nav: #f9fafb;
    --glass-border: rgba(0, 0, 0, 0.1);
    --hover-bg: rgba(0, 0, 0, 0.04);
    --active-bg: rgba(0, 122, 255, 0.1);
    --text-primary: #111827;
    --text-secondary: #4b5563;
    --input-bg: rgba(0, 0, 0, 0.05);
    --modal-bg: rgba(249, 250, 251, 0.95);
    --toast-bg: rgba(249, 250, 251, 0.95);
    --shadow: 0 8px 25px rgba(0,0,0,0.08);
}

/* --- Base Styles --- */
* { box-sizing: border-box; margin: 0; padding: 0; }
html { height: 100%; }
body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--bg-page);
    color: var(--text-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100%;
    margin: 0;
    padding: 20px;
    transition: background-color 0.3s ease;
    font-size: 17px;
}
.settings-container {
    width: min(95vw, 1200px);
    height: min(95vh, 800px);
    display: flex;
    background: var(--bg-card);
    border: 1px solid var(--glass-border);
    border-radius: 18px;
    box-shadow: var(--shadow);
    overflow: hidden;
}

/* --- Left Navigation Menu --- */
.settings-nav {
    width: 280px;
    flex-shrink: 0;
    background-color: var(--bg-nav);
    border-right: 1px solid var(--glass-border);
    padding: 30px 20px;
    overflow-y: auto;
}
.settings-nav h1 {
    font-size: 24px;
    padding: 0 10px 20px 10px;
    margin: 0;
    border-bottom: 1px solid var(--glass-border);
    margin-bottom: 20px;
}
.nav-list { list-style: none; padding: 0; margin: 0; }
.nav-item {
    display: flex;
    align-items: center;
    padding: 14px 20px;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
    color: var(--text-secondary);
    font-weight: 500;
    font-size: 16px;
    margin-bottom: 6px;
}
.nav-item:hover {
    background-color: var(--hover-bg);
    color: var(--text-primary);
}
.nav-item.active {
    background-color: var(--active-bg);
    color: var(--accent-1);
    font-weight: 600;
}

/* --- Right Content Area --- */
.settings-content {
    flex: 1;
    padding: 35px 50px;
    overflow-y: auto;
}
.settings-section { margin-bottom: 40px; }
.settings-section h2 {
    font-size: 22px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 30px 0;
    padding-bottom: 18px;
    border-bottom: 1px solid var(--glass-border);
}

.btn-ghost {
    /* background: var(--glass-border); */ /* Bỏ background cũ */
    border: 1px solid var(--glass-border); /* Dùng border thay thế */
    background-color: transparent; /* Nền trong suốt */
    color: var(--text-secondary); /* Màu chữ nhạt hơn */
    font-weight: 500;
}
.btn-ghost:hover {
    background-color: var(--hover-bg); /* Thêm nền khi hover */
    color: var(--text-primary); /* Chữ đậm hơn khi hover */
    border-color: var(--text-secondary); /* Viền đậm hơn khi hover */
    transform: none;
    box-shadow: none;
}
/* Style cho theme sáng */
.light .btn-ghost {
    background-color: transparent;
    color: var(--text-secondary);
    border-color: rgba(0, 0, 0, 0.15); /* Viền đậm hơn chút */
}
.light .btn-ghost:hover {
    background-color: rgba(0, 0, 0, 0.05); /* Nền tối hơn chút */
    color: var(--text-primary);
    border-color: rgba(0, 0, 0, 0.2);
}

.btn {
    padding: 10px 16px;
    border: none; /* THÊM DÒNG NÀY */
    border-radius: 10px;
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
    color: #fff;
    cursor: pointer;
}
.danger-btn {
    background: linear-gradient(135deg, #ef4444, #b91c1c);
     border: none; /* THÊM DÒNG NÀY */
}

.modal-actions button {
    font-size: 16px; /* Giữ font size */
    padding: 11px 22px; /* Giữ padding */
    width: auto;
    margin-top: 0;
    border-radius: 9px; /* Đồng bộ bo góc */
    font-weight: 500; /* Đồng bộ độ đậm */
    /* Các style khác được kế thừa hoặc ghi đè bởi .btn / .btn-ghost */
}

.settings-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 0;
    min-height: 60px;
    border-bottom: 1px solid var(--glass-border);
}
.settings-row:last-child { border-bottom: none; }
.row-left { display: flex; flex-direction: column; gap: 5px; padding-right: 20px; /* Thêm padding để không dính vào nút */}
.settings-row-label {
    font-weight: 500;
    font-size: 17px;
    color: var(--text-primary);
}
.settings-row-description {
    font-size: 15px;
    color: var(--text-secondary);
}
.row-right { flex-shrink: 0; margin-left: 30px; }

/* --- Controls: Switch & Buttons --- */
/* ĐẢM BẢO CSS CHO SWITCH CÓ ĐẦY ĐỦ */
.switch {
    position: relative;
    width: 44px;
    height: 24px;
    background: var(--glass-border);
    border-radius: 999px;
    cursor: pointer;
    flex-shrink: 0;
    transition: background-color 0.2s ease-in-out;
}
.switch::after {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #fff;
    top: 3px;
    left: 4px;
    transition: left 0.2s ease-in-out;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.switch.on { background: var(--accent-2); }
.switch.on::after { left: 22px; }

.settings-content button {
    padding: 10px 20px;
    border-radius: 9px;
    color: var(--text-primary);
    font-weight: 500;
    font-size: 16px;
    cursor: pointer;
    transition: 0.2s ease;
    background: var(--input-bg);
    border: 1px solid var(--glass-border);
    margin-top: 0;
    width: auto;
}
.settings-content button:hover:not(:disabled) {
    background: var(--hover-bg);
    border-color: var(--text-secondary);
}
.settings-content button:disabled { opacity: 0.6; cursor: not-allowed; }
.settings-content .danger-btn {
    background: rgba(239, 68, 68, 0.1);
    border-color: rgba(239, 68, 68, 0.3);
    color: #fca5a5;
}
.settings-content .danger-btn:hover:not(:disabled) {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.5);
    color: #fda4af;
}
.settings-content button:disabled {
     background: var(--input-bg) !important;
     color: var(--text-secondary) !important;
     opacity: 0.5;
     border-color: var(--glass-border) !important;
}

/* --- Modals --- */
.modal-overlay {
    position: fixed !important; inset: 0 !important;
    background: rgba(0,0,0,0.65) !important;
    backdrop-filter: blur(10px) !important;
    display: flex !important; justify-content: center !important; align-items: center !important;
    z-index: 5000 !important;
    padding: 20px;
    opacity: 0; visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}
.modal-overlay.show { opacity: 1; visibility: visible; }
.modal-content {
    background: var(--modal-bg); border: 1px solid var(--glass-border); border-radius: 20px;
    padding: 30px 35px; color: var(--text-primary); text-align: left;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3); width: min(90vw, 500px);
    transform: scale(0.95); transition: transform 0.3s ease;
}
.modal-overlay.show .modal-content { transform: scale(1); }
.modal-content h2 { font-size: 22px; margin-bottom: 20px; text-align: center; } /* Căn giữa title modal */
.modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 30px; }
.modal-actions button { font-size: 16px; padding: 11px 22px; width: auto; margin-top: 0; }
.btn-ghost { background: var(--glass-border); color: var(--text-primary); }
.btn-ghost:hover { background: rgba(255, 255, 255, 0.2); }
.light .btn-ghost { background: rgba(0, 0, 0, 0.05); color: var(--text-secondary); }
.light .btn-ghost:hover { background: rgba(0, 0, 0, 0.1); }
.modal-content label { font-size: 15px; display: block; margin: 18px 0 8px; color: var(--text-secondary); }
.modal-content input, .modal-content textarea { font-size: 16px; padding: 13px; box-sizing: border-box; width: 100%; border-radius: 10px; border: 1px solid var(--glass-border); background: var(--input-bg); color: var(--text-primary); outline: none; transition: border-color 0.3s, box-shadow 0.3s; }
.modal-content input:focus, .modal-content textarea:focus { border-color: var(--accent-1); box-shadow: 0 0 15px rgba(96, 165, 250, 0.2); }
.modal-content textarea { resize: vertical; min-height: 80px; }
.reason-form { text-align: left; margin: 20px 0; }
.reason-row { display: flex; align-items: center; padding: 10px; border-radius: 10px; cursor: pointer; transition: background-color 0.2s; }
.reason-row:hover { background-color: rgba(255,255,255,0.05); }
.light .reason-row:hover { background-color: rgba(0,0,0,0.03); }
.reason-row input[type="radio"] { margin-right: 12px; width: 18px; height: 18px; accent-color: var(--accent-2); }

/* --- Toast --- */
#toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--toast-bg); color: var(--text-primary); padding: 18px 28px; border-radius: 12px; z-index: 10000; backdrop-filter: blur(10px); border: 1px solid var(--glass-border); box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: none; font-weight: 500; animation: slideIn .3s ease, slideOut .3s ease 2.7s forwards; font-size: 15px; }
#toast.success { border-left: 4px solid #22c55e; color: #22c55e; } #toast.error { border-left: 4px solid #ef4444; color: #ef4444; } #toast.info { border-left: 4px solid var(--accent-1); color: var(--accent-1); }
@keyframes slideIn { from { top: -100px; opacity: 0; } to { top: 20px; opacity: 1; } } @keyframes slideOut { from { top: 20px; opacity: 1; } to { top: -100px; opacity: 0; } }

/* === Responsive cho Mobile === */
@media (max-width: 900px) {
    body { padding: 0; align-items: stretch; }
    .settings-container { width: 100%; height: 100%; max-width: 100%; max-height: 100%; border-radius: 0; flex-direction: column; border: none; box-shadow: none; }
    .settings-nav { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--glass-border); padding: 15px; overflow-y: initial; }
    .settings-nav h1 { font-size: 20px; padding-bottom: 12px; margin-bottom: 10px; text-align: center; }
    .nav-list { display: flex; overflow-x: auto; padding-bottom: 8px; -ms-overflow-style: none; scrollbar-width: none; }
    .nav-list::-webkit-scrollbar { display: none; }
    .nav-item { padding: 10px 18px; gap: 8px; min-width: fit-content; text-align: center; font-size: 15px; margin-bottom: 0; white-space: nowrap; }
    .nav-item.active { background-color: var(--active-bg); color: var(--accent-1); }
    .settings-content { padding: 25px; flex: 1; }
    .settings-section h2 { font-size: 19px; margin-bottom: 20px; padding-bottom: 12px; }
    .settings-row { padding: 14px 0; min-height: 55px; /* Có thể xếp dọc nếu cần */ /* flex-direction: column; align-items: flex-start; gap: 5px; */ }
    .settings-row-label { font-size: 16px; }
    .settings-row-description { font-size: 14px; }
    .row-right { margin-left: 15px; }
    .settings-content button { font-size: 15px; padding: 9px 16px;}
    .modal-content { width: min(90vw, 420px); } /* Modal hẹp hơn trên mobile */
}
</style>
</head>
<body class=""> <div id="toast"></div>

<div class="settings-container">
    <nav class="settings-nav">
        <h1>Cài đặt</h1>
        <ul class="nav-list">
            <li class="nav-item active" data-section="interface">Giao diện</li>
            <li class="nav-item" data-section="notifications">Thông báo</li>
            <li class="nav-item" data-section="privacy">Riêng tư</li>
            <li class="nav-item" data-section="verification">Xác minh</li>
        </ul>
    </nav>

    <div class="settings-content">
        <div class="settings-section active" id="interface">
            <h2>Giao diện</h2>
            <div class="settings-row">
                <div class="row-left">
                     <span class="settings-row-label">Chế độ Sáng/Tối</span>
                     <span class="settings-row-description">Thay đổi giao diện sáng hoặc tối.</span>
                </div>
                <div class="row-right">
                    <div id="theme-switch" class="switch"></div>
                </div>
            </div>
        </div>

        <div class="settings-section" id="notifications" style="display:none;">
            <h2>Thông báo</h2>
            <div class="settings-row">
                 <div class="row-left">
                     <span class="settings-row-label">Thông báo trên trình duyệt</span>
                     <span class="settings-row-description">Nhận thông báo tin nhắn mới.</span>
                </div>
                <div class="row-right">
                    <button id="enable-browser-notifs-btn">Cho phép</button>
                </div>
            </div>
        </div>

        <div class="settings-section" id="privacy" style="display:none;">
            <h2>Quyền riêng tư</h2>
            <div class="settings-row">
                <div class="row-left">
                    <span class="settings-row-label">Ẩn trạng thái hoạt động</span>
                    <span class="settings-row-description">Người khác sẽ không thấy bạn đang online.</span>
                </div>
                <div class="row-right">
                    <div id="hide-status-switch" class="switch"></div>
                </div>
            </div>
            <div class="settings-row">
                <div class="row-left">
                    <span class="settings-row-label">Ngừng hoạt động tài khoản</span>
                    <span class="settings-row-description">Vô hiệu hóa tài khoản và ẩn thông tin.</span>
                </div>
                 <div class="row-right">
                    <button id="delete-account-btn" class="danger-btn">Yêu cầu</button>
                </div>
            </div>
        </div>

        <div class="settings-section" id="verification" style="display:none;">
            <h2>Xác minh tài khoản (Tick Xanh)</h2>
            <div class="settings-row">
                <div class="row-left">
                    <span id="verification-status" class="settings-row-description" style="flex: 1;">Đang tải...</span>
                </div>
                <div class="row-right">
                    <button id="request-verification-btn">Yêu cầu</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="delete-confirm-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div id="password-step">
            <h2 style="color: #f59e0b;">Xác thực tài khoản</h2>
            <p style="margin: 15px 0 20px; color: var(--text-secondary); font-size: 15px; text-align: center;">Vui lòng nhập lại mật khẩu.</p>
            <label for="password-confirm-input">Mật khẩu</label>
            <input type="password" id="password-confirm-input" placeholder="••••••••" autocomplete="current-password">
            <div class="modal-actions">
                <button id="delete-cancel-btn" class="btn-ghost">Hủy</button>
                <button id="delete-continue-btn" class="btn">Tiếp tục</button>
            </div>
        </div>
        <div id="reason-step" style="display:none;">
            <h2 style="color: #ef4444;">Lý do ngừng hoạt động</h2>
            <p style="margin: 15px 0; color: var(--text-secondary); text-align: center;">Vui lòng cho biết lý do.</p>
            <div class="reason-form">
                <label class="reason-row"><input type="radio" name="deleteReason" value="not_like" checked> Không thích ứng dụng</label>
                <label class="reason-row"><input type="radio" name="deleteReason" value="privacy_concern"> Lo ngại riêng tư</label>
                <label class="reason-row"><input type="radio" name="deleteReason" value="new_account"> Tạo tài khoản mới</label>
                <label class="reason-row"><input type="radio" name="deleteReason" value="other"> Lý do khác</label>
            </div>
            <div class="modal-actions">
                <button id="delete-back-btn" class="btn-ghost">Quay lại</button>
                <button id="delete-ok-btn" class="btn danger-btn">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<div id="verification-request-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h2>Yêu cầu xác minh</h2>
        <p style="margin: 15px 0 20px; color: var(--text-secondary); font-size: 15px; text-align: center;">
            Cung cấp thông tin. Yêu cầu sẽ được xem xét.
        </p>
        <label for="verification-fullname">Họ và Tên:</label>
        <input type="text" id="verification-fullname" placeholder="Nguyễn Văn A" style="margin-bottom: 15px;">
        <label for="verification-reason">Lý do yêu cầu:</label>
        <textarea id="verification-reason" rows="3" placeholder="Ví dụ: Người nổi tiếng,..." style="margin-bottom: 20px;"></textarea>
        <div class="modal-actions">
            <button id="cancel-verification-request-btn" class="btn-ghost">Hủy</button>
            <button id="submit-verification-request-btn" class="btn">Gửi yêu cầu</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getAuth, onAuthStateChanged, reauthenticateWithCredential, EmailAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc,addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBuGG9WKYZHb1qbmihpJFjCBsTB_VJ_LvU", authDomain: "qola-web.firebaseapp.com", databaseURL: "https://qola-web-default-rtdb.firebaseio.com", projectId: "qola-web", storageBucket: "qola-web.firebasestorage.app", messagingSenderId: "477682993077", appId: "1:477682993077:web:7dce15eb2c365729173bfc"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM Elements
const toast = document.getElementById('toast');
const themeSwitch = document.getElementById('theme-switch');
const notifBtn = document.getElementById('enable-browser-notifs-btn');
const hideStatusSwitch = document.getElementById('hide-status-switch'); // Đảm bảo ID này đúng
const deleteAccountBtn = document.getElementById('delete-account-btn');
const verificationStatus = document.getElementById('verification-status');
const requestVerificationBtn = document.getElementById('request-verification-btn');
const verificationRequestModal = document.getElementById('verification-request-modal');
const verificationFullNameInput = document.getElementById('verification-fullname');
const verificationReasonInput = document.getElementById('verification-reason');
const cancelVerificationRequestBtn = document.getElementById('cancel-verification-request-btn');
const submitVerificationRequestBtn = document.getElementById('submit-verification-request-btn');
const deleteConfirmModal = document.getElementById('delete-confirm-modal');
const passwordStep = document.getElementById('password-step');
const reasonStep = document.getElementById('reason-step');
const passwordConfirmInput = document.getElementById('password-confirm-input');
const deleteCancelBtn = document.getElementById('delete-cancel-btn');
const deleteContinueBtn = document.getElementById('delete-continue-btn');
const deleteBackBtn = document.getElementById('delete-back-btn');
const deleteOkBtn = document.getElementById('delete-ok-btn');
const navItems = document.querySelectorAll('.nav-item');
const settingsSections = document.querySelectorAll('.settings-section');

// --- Navigation Logic ---
function showSection(sectionId) {
    settingsSections.forEach(section => {
        // Luôn dùng style.display để ẩn/hiện
        section.style.display = (section.id === sectionId) ? 'block' : 'none';
    });
    navItems.forEach(item => {
        item.classList.toggle('active', item.dataset.section === sectionId);
    });
    const contentArea = document.querySelector('.settings-content');
    if (contentArea) contentArea.scrollTop = 0;
}
navItems.forEach(item => { item.onclick = () => { showSection(item.dataset.section); }; });
showSection('interface'); // Mặc định hiện tab Giao diện

// --- Toast ---
let toastTimer;
function showToast(message, type = 'info') {
    clearTimeout(toastTimer);
    toast.textContent = message;
    toast.className = ''; toast.classList.add(type);
    toast.style.display = 'block';
    toastTimer = setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

// --- Theme ---
(function initTheme() {
    const saved = localStorage.getItem('theme') || 'dark';
    document.body.classList.toggle('light', saved === 'light');
    themeSwitch.classList.toggle('on', saved === 'light');
})();
themeSwitch.onclick = () => {
    const isLight = document.body.classList.toggle('light');
    localStorage.setItem('theme', isLight ? 'light' : 'dark');
    themeSwitch.classList.toggle('on', isLight);
};

// --- Notifications ---
notifBtn.onclick = () => {
    if (!("Notification" in window)) return showToast("Trình duyệt không hỗ trợ.", "error");
    if (Notification.permission === 'denied') return showToast("Bạn đã từ chối quyền.", "info");
    if (Notification.permission !== 'granted') {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") { showToast("Đã bật thông báo!", "success"); notifBtn.textContent = "Đã cho phép"; notifBtn.disabled = true; }
            else { showToast("Bạn không cấp quyền.", "info"); if(permission === 'denied'){ notifBtn.textContent = "Đã từ chối"; notifBtn.disabled = true; } }
        });
    }
};

// --- Account Deactivation ---
function showDeleteConfirmation() {
    passwordStep.style.display = 'block'; reasonStep.style.display = 'none'; passwordConfirmInput.value = '';
    deleteContinueBtn.disabled = false; deleteContinueBtn.textContent = "Tiếp tục"; deleteOkBtn.disabled = false; deleteOkBtn.textContent = "Xác nhận"; // Sửa lại text
    deleteConfirmModal.classList.add('show'); // Hiện modal bằng class
}
deleteAccountBtn.onclick = showDeleteConfirmation;
deleteCancelBtn.onclick = () => deleteConfirmModal.classList.remove('show'); // Đóng modal bằng class
deleteBackBtn.onclick = () => { passwordStep.style.display = 'block'; reasonStep.style.display = 'none'; };
deleteContinueBtn.onclick = async () => {
    const password = passwordConfirmInput.value; const user = auth.currentUser;
    if (!password || !user) return showToast("Vui lòng nhập mật khẩu.", "error");
    deleteContinueBtn.disabled = true; deleteContinueBtn.textContent = "Đang kiểm tra...";
    const credential = EmailAuthProvider.credential(user.email, password);
    try { await reauthenticateWithCredential(user, credential); passwordStep.style.display = 'none'; reasonStep.style.display = 'block'; }
    catch (error) { showToast("Mật khẩu không đúng.", "error"); }
    finally { deleteContinueBtn.disabled = false; deleteContinueBtn.textContent = "Tiếp tục"; }
};
deleteOkBtn.onclick = async () => {
    const user = auth.currentUser; if (!user) return;
    const reasonElement = document.querySelector('input[name="deleteReason"]:checked');
    const reason = reasonElement ? reasonElement.value : 'unknown';
    deleteOkBtn.disabled = true; deleteOkBtn.textContent = "Đang xử lý...";
    try {
        const userDocRef = doc(db, 'users', user.uid);
        await updateDoc(userDocRef, { isDeactivated: true, deactivationReason: reason, displayName: "Người dùng ẩn danh", bio: "", avatarUrl: "https://placehold.co/120x120/64748b/fff?text=X", friends: [] }); // Đổi tên + avatar
        await signOut(auth); showToast("Tài khoản đã ngừng hoạt động.", "success");
        deleteConfirmModal.classList.remove('show'); // Đóng modal
        setTimeout(() => { window.location.href = "login.html"; }, 1500);
    } catch (error) { showToast(`Lỗi: ${error.message}.`, "error"); deleteOkBtn.disabled = false; deleteOkBtn.textContent = "Xác nhận"; } // Sửa lại text
};

// --- Main Auth Listener ---
onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = 'login.html';
    const userDocRef = doc(db, 'users', user.uid);
    const userSnap = await getDoc(userDocRef);
    if (!userSnap.exists()) { await signOut(auth); window.location.href = "login.html"; return; }
    const userData = userSnap.data();

    // Init Hide Status switch - Đảm bảo hideStatusSwitch tồn tại
    if (hideStatusSwitch) {
        hideStatusSwitch.classList.toggle('on', userData.hideOnlineStatus === true);
        hideStatusSwitch.onclick = async () => {
             const wantsToHide = !hideStatusSwitch.classList.contains('on');
             try { await updateDoc(userDocRef, { hideOnlineStatus: wantsToHide }); hideStatusSwitch.classList.toggle('on', wantsToHide); showToast(`Đã ${wantsToHide ? 'ẩn' : 'hiện'} trạng thái online.`, "success"); }
             catch (e) { showToast("Lỗi cập nhật.", "error"); }
        };
    } else {
        console.error("Element #hide-status-switch not found!"); // Báo lỗi nếu không tìm thấy
    }


    // Init Verification Status
    if (userData.isVerified) {
        verificationStatus.textContent = "Tài khoản đã được xác minh.";
        requestVerificationBtn.textContent = "Đã xác minh"; requestVerificationBtn.disabled = true;
    } else if (userData.verificationStatus === 'pending') {
        verificationStatus.textContent = "Yêu cầu đang chờ xem xét.";
        requestVerificationBtn.textContent = "Đã yêu cầu"; requestVerificationBtn.disabled = true;
    } else {
        verificationStatus.textContent = "Chưa xác minh.";
        requestVerificationBtn.textContent = "Yêu cầu xác minh"; requestVerificationBtn.disabled = false;
        requestVerificationBtn.onclick = () => {
             if(verificationFullNameInput) verificationFullNameInput.value = userData.displayName || '';
             if(verificationReasonInput) verificationReasonInput.value = '';
             verificationRequestModal.classList.add('show'); // Hiện modal bằng class
        };
    }

    // Init Notification Button Status
    if ("Notification" in window) {
        if (Notification.permission === 'granted') { notifBtn.textContent = "Đã cho phép"; notifBtn.disabled = true; }
        else if (Notification.permission === 'denied') { notifBtn.textContent = "Đã từ chối"; notifBtn.disabled = true; }
        else { notifBtn.textContent = "Cho phép"; notifBtn.disabled = false; }
    } else { notifBtn.textContent = "Không hỗ trợ"; notifBtn.disabled = true; }
});

// --- Verification Request Modal Events ---
cancelVerificationRequestBtn.onclick = () => { verificationRequestModal.classList.remove('show'); }; // Đóng modal bằng class
submitVerificationRequestBtn.onclick = async () => {
    const fullName = verificationFullNameInput ? verificationFullNameInput.value.trim() : '';
    const reason = verificationReasonInput ? verificationReasonInput.value.trim() : '';
    if (!fullName) return showToast("Vui lòng nhập Họ và Tên.", "error");
    if (!reason) return showToast("Vui lòng nhập lý do.", "error");
    if (!auth.currentUser) return;

    submitVerificationRequestBtn.disabled = true; submitVerificationRequestBtn.textContent = "Đang gửi...";
    try {
        await addDoc(collection(db, "verification_requests"), { userId: auth.currentUser.uid, userEmail: auth.currentUser.email, fullName: fullName, reason: reason, requestTimestamp: serverTimestamp(), status: "pending" });
        await updateDoc(doc(db, 'users', auth.currentUser.uid), { verificationStatus: 'pending' });
        showToast("Đã gửi yêu cầu!", "success"); verificationRequestModal.classList.remove('show'); // Đóng modal
        requestVerificationBtn.disabled = true; requestVerificationBtn.textContent = "Đã yêu cầu";
        verificationStatus.textContent = "Yêu cầu đang chờ xem xét.";
    } catch (error) { console.error("Lỗi gửi yêu cầu:", error); showToast("Gửi thất bại.", "error"); }
    finally { submitVerificationRequestBtn.disabled = false; submitVerificationRequestBtn.textContent = "Gửi yêu cầu"; }
};

// Đóng modal khi bấm ra ngoài (Thêm cho cả 2 modal)
[deleteConfirmModal, verificationRequestModal].forEach(modal => {
    if (modal) {
        modal.onclick = (e) => {
             if (e.target === modal) {
                  modal.classList.remove('show');
             }
        };
    }
});

</script>
</body>
</html>