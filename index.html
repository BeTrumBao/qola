<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Qola Messenger</title>
<link rel="icon" type="image/png" href="Res/favicon.png">
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');

/* --- BIẾN MÀU CSS --- */
:root{
  --accent-1:#60a5fa;
  --accent-2:#2563eb;
  --bg-page:linear-gradient(135deg,#0f172a,#1e293b);
  --glass:rgba(255,255,255,0.06);
  --glass-2:rgba(255,255,255,0.08);
  --glass-3:rgba(30, 41, 59, 0.75);
  --text:#e5e7eb; /* Chữ chính trong dark mode */
  --text-2:#cbd5e1; /* Chữ phụ trong dark mode */
  --border:rgba(255,255,255,0.12);
  --bubble-me: linear-gradient(135deg,#3b82f6,#2563eb);
  --bubble-you: rgba(255,255,255,0.15);
  --input:#0b1220;
  --shadow: 0 18px 60px rgba(0,0,0,.35);
  --recalled-bg: rgba(255,255,255,0.1);
  --skeleton-bg: rgba(255,255,255,0.08);
  --background-1: #1e293b; /* Nền chính content dark */
  --text-1: #f1f5f9;      /* Chữ chính dark */
  --primary: #2563eb;
  --primary-hover: #3b82f6;
  --white: #ffffff;
  --hover-bg: rgba(255, 255, 255, 0.1);
  --glass-border: rgba(255, 255, 255, 0.1);
  --bg-nav: #111827;
  --bg-light: #1e293b; /* Main background dark */
  --bg-dark: #0f172a;
  --text-secondary: #94a3b8;
  --text-primary: #e5e7eb;
  --input-bg: #0b1220;
  --bg-card: rgba(255, 255, 255, 0.05);
}
.light {
  --bg-page: linear-gradient(135deg,#a1c4fd,#c2e9fb);
  --glass: rgba(255,255,255,0.5);
  --glass-2: rgba(255,255,255,0.6);
  --glass-3: rgb(249, 250, 251);
  --text:#0f172a; /* Chữ chính light */
  --text-2:#334155; /* Chữ phụ light */
  --border: rgba(0,0,0,0.1);
  --bubble-me: linear-gradient(135deg,#007aff,#0056b3);
  --bubble-you: rgba(229,229,234,0.92);
  --input: rgba(255,255,255,0.85);
  --shadow: 0 18px 60px rgba(0,0,0,.2);
  --recalled-bg: rgba(0,0,0,0.05);
  --skeleton-bg: rgba(0,0,0,0.08);
  --background-1: #f9fafb; /* Nền chính content light */
  --text-1: #1f2937;      /* Chữ chính light */
  --hover-bg: rgba(0, 0, 0, 0.05);
  --glass-border: rgba(0, 0, 0, 0.1);
  --bg-nav: #ffffff;
  --bg-light: #f9fafb;
  --bg-dark: #f3f4f6;
  --text-secondary: #6b7280;
  --text-primary: #1f2937;
  --input-bg: #ffffff;
  --bg-card: #ffffff;
}

/* --- Reset & Base --- */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg-page); color:var(--text);
  overflow:hidden; display:flex;
}
button { font-family: inherit; }
input, textarea { font-family: inherit; }
svg { vertical-align: middle; }

/* --- Layout Chính --- */
.app-layout { display: flex; width: 100%; height: 100%; }
.app-nav { width: 70px; background-color: var(--bg-nav); border-right: 1px solid var(--glass-border); padding: 15px 0; display: flex; flex-direction: column; align-items: center; gap: 15px; flex-shrink: 0; position: relative; }
.nav-button { background-color: transparent; border: none; width: 48px; height: 48px; border-radius: 15px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; position: relative; }
.nav-button svg { width: 24px; height: 24px; }
.nav-button:hover { background-color: var(--accent-1); color: #fff; border-radius: 12px; }
.nav-button.active { background-color: var(--accent-2); color: #fff; border-radius: 12px; }
.nav-button.active::before { content: ''; position: absolute; left: -10px; top: 5px; bottom: 5px; width: 4px; background-color: #fff; border-radius: 0 4px 4px 0; }
.light .nav-button { background-color: #e5e7eb; color: var(--text-secondary); }
.light .nav-button:hover { background-color: var(--accent-1); color: #fff; }
.light .nav-button.active { background-color: var(--accent-2); color: #fff; }
.light .nav-button.active::before { background-color: var(--accent-2); }
.nav-spacer { flex-grow: 1; }
.nav-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid var(--glass-border); cursor: pointer; margin-bottom: 10px; }
#nav-settings-menu { position: absolute; bottom: 75px; left: 80px; width: 220px; display: none; background: var(--glass-3); backdrop-filter: blur(18px); border: 1px solid var(--glass-border); border-radius: 12px; padding: 10px; box-shadow: var(--shadow); z-index: 101; }
.light #nav-settings-menu .settings-row { color: var(--text-primary); }
.app-main { flex: 1; overflow: hidden; position: relative; background: var(--bg-light); }
.app-view { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: none; height: 100%; width: 100%; }
.app-view.active { display: block; }

/* --- CSS cho Chat View --- */
.chat-view .container { width: 100%; height: 100%; border-radius: 0; border: none; box-shadow: none; margin-top: 0; background: none; backdrop-filter: none; display: flex; }
.chat-view #sidebar { height: 100%; width: 36%; max-width: 420px; background: var(--bg-light); border-right: 1px solid var(--glass-border); padding: 16px; display: flex; flex-direction: column; gap: 14px; position: relative; }
.chat-view #chat-window { height: 100%; flex: 1; padding: 0; display: flex; flex-direction: column; position: relative; background: transparent; }
.chat-view .sidebar-footer { display: none !important; }

/* --- CSS Sidebar --- */
.sidebar-head{ display:flex; align-items:center; gap:12px; padding-bottom: 10px; position:relative }
.sidebar-title{ font-size:22px; font-weight:700 }
#add-btn { background: var(--glass-border); border: none; width: 36px; height: 36px; border-radius: 12px; color: var(--text-secondary); font-size: 24px; font-weight: 500; cursor: pointer; margin-left: auto; transition: all 0.2s; position: relative; z-index: 30; }
#add-btn:hover { background: rgba(255, 255, 255, 0.2); color: var(--text-primary); }
#add-menu { position:absolute; left: auto; right: 16px; top: 60px; width: 180px; height: auto !important; display:none; background:var(--glass-3); border:1px solid var(--border); border-radius:12px; padding:10px; box-shadow:var(--shadow); z-index: 20; backdrop-filter: blur(18px); }
#sidebar-search-container { position: relative; padding-bottom: 10px; }
#global-search{ width: 100%; padding: 12px 16px; border: none; outline: none; border-radius: 12px; background: var(--input); color: var(--text); font-size: 14px; }
#search-dropdown{ position:absolute; top: 50px; left: 0; right: 0; width: auto; margin: 0; background:var(--glass-3); border:1px solid var(--border); border-radius:16px; backdrop-filter:blur(18px); box-shadow:var(--shadow); max-height:52vh; overflow:auto; display:none; padding:6px 6px 10px; z-index: 100; }
.section-title{font-size:12px; opacity:.8; margin:8px 6px}
.result-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:12px; cursor:pointer; }
.result-item:hover{background:var(--glass)}
.result-left{display:flex; align-items:center; gap:10px; min-width:0}
.result-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
.result-name{font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.result-sub{font-size:12px; color:var(--text-2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.result-actions{display:flex; gap:8px}
.result-action { display: flex; align-items: center; justify-content: flex-end; }
.add-friend-btn { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; border: none; padding: 6px 10px; border-radius: 8px; font-size: 13px; cursor: pointer; transition: 0.2s; }
.add-friend-btn:hover { transform: scale(1.05); opacity: 0.9; }
.add-friend-btn:disabled { background: rgba(255,255,255,0.3); cursor: default; opacity: 0.7; transform: none;}
.friend-label { font-size: 13px; opacity: 0.7; }
.list-title{font-size:13px; color:var(--text-2); margin:4px 0}
ul{list-style:none}
#chat-list{ overflow:auto; max-height:calc(100vh - 200px); padding-right:6px }
.item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px; border-radius:12px; cursor:pointer; }
.item:hover{background:var(--glass)}
.item-left{min-width:0; display:flex; align-items:center; gap:10px}
.item-name{ white-space: normal; word-break: break-word; }
.item-last-msg { font-size: 13px; color: var(--text-2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
.beta-tag { font-size: 10px; background-color: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-left: 8px; }
.sidebar-loader .skeleton-item { display: flex; align-items: center; gap: 10px; padding: 12px; }
.skeleton { background: var(--skeleton-bg); position: relative; overflow: hidden; }
.skeleton-circle { width: 40px; height: 40px; border-radius: 50%; }
.skeleton-line { height: 16px; border-radius: 6px; flex: 1; }
.skeleton::after { content: ''; position: absolute; inset: 0; transform: translateX(-100%); background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent); animation: shimmer 1.5s infinite; }
@keyframes shimmer { 100% { transform: translateX(100%); } }
#sidebar-lists { display: none; }
#sidebar.loaded #sidebar-lists { display: block; }
#sidebar.loaded #sidebar-loader { display: none; }
.settings-menu{ display:none; background:var(--glass-3); border:1px solid var(--border); border-radius:12px; padding:10px; box-shadow:var(--shadow); z-index: 20; backdrop-filter: blur(18px); }
.settings-row{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px; border-radius:10px; cursor:pointer;}
.settings-row:hover{background:var(--glass)}
.switch{position:relative; width:44px; height:24px; background:var(--glass); border:1px solid var(--border); border-radius:999px}
.switch::after{ content:''; position:absolute; width:18px; height:18px; border-radius:50%; background:linear-gradient(135deg,var(--accent-1),var(--accent-2)); top:2px; left:3px; transition:.2s; }
.switch.on::after{left:23px}
/* --- CSS CHO HIỆU ỨNG GRADIENT TEXT --- */
.gradient-text {
    background: linear-gradient(90deg, var(--accent-1), #a855f7, #ec4899); /* Dải màu gradient (Xanh -> Tím -> Hồng) */
    -webkit-background-clip: text; /* Clip background theo hình dạng chữ (cho trình duyệt Webkit/Blink) */
    background-clip: text; /* Clip background theo hình dạng chữ (chuẩn) */
    -webkit-text-fill-color: transparent; /* Ẩn màu chữ gốc (cho Webkit/Blink) */
    color: transparent; /* Ẩn màu chữ gốc (chuẩn) */
    display: inline-block; /* Cần thiết để background-clip hoạt động đúng */
}

/* Optional: Style cho theme sáng nếu muốn màu gradient khác */
.light .gradient-text {
    background: linear-gradient(90deg, #007aff, #5856d6, #ff2d55); /* Gradient khác cho theme sáng */
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    color: transparent;
}

/* --- CSS HEADER CHAT --- */
#chat-window { display: flex; flex-direction: column; height: 100%; }
#chat-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid var(--border); flex-shrink: 0; box-sizing: border-box; }
#chat-header-left { display: flex; align-items: center; gap: 12px; min-width: 0; }
#current-chat-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 1px solid var(--border); cursor: pointer; }
#chat-header-info { display: flex; flex-direction: column; min-width: 0; }
#current-chat-friend-name { font-size: 17px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#peer-info-extra { display: none; align-items: center; gap: 8px; margin-top: 2px; }
.stranger-label { font-size: 12px; color: var(--text-2); }
#add-friend-header-btn { padding: 3px 8px; font-size: 11px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; border: none; border-radius: 8px; cursor: pointer; transition: 0.2s; }
#add-friend-header-btn:hover { transform: scale(1.05); opacity: 0.9; }
#add-friend-header-btn:disabled { background: rgba(255,255,255,0.3); cursor: default; opacity: 0.7; transform: none;}
#chat-header-buttons { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
#open-info-btn, #group-info-btn { background: none; border: none; color: var(--text); font-size: 24px; cursor: pointer; padding: 5px; border-radius: 50%; line-height: 1; }
#open-info-btn:hover, #group-info-btn:hover { background-color: var(--glass); }
/* Bỏ nút back khỏi index.html */
/* #mobile-back-btn { display: none; } */

/* --- CSS MESSAGES CONTAINER & INPUT --- */
#messages-container{ flex:1; overflow:auto; display:flex; flex-direction:column; gap:2px; padding:14px 15px; scrollbar-width:thin; }
#messages-container::-webkit-scrollbar{width:8px}
#messages-container::-webkit-scrollbar-thumb{background:var(--glass-3); border-radius:10px}
#messages-container::-webkit-scrollbar-track{background:transparent}
.msg-wrapper { position: relative; margin: 6px 0; align-self: flex-start; max-width: 70%; display: flex; gap: 10px; align-items: flex-end; }
.msg-wrapper:hover .reaction-picker { opacity: 1; transform: translateY(0) scale(1); }
.msg-wrapper.sent { align-self: flex-end; }
.msg-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-bottom: 6px; cursor: pointer; }
.msg-wrapper.sent .msg-avatar { display: none; }
.msg-sender-name { font-size: 13px; font-weight: 500; color: var(--text-2); margin-bottom: 4px; }
.msg { background: var(--bubble-you); color: var(--text); padding: 10px 14px; border-radius: 18px; display: inline-block; word-break: break-word; line-height: 1.4em; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: background 0.3s ease; position: relative; }
.msg.sent { background: var(--bubble-me); color: #fff; box-shadow: 0 2px 8px rgba(37,99,235,0.4); }
.msg img { max-width: 100%; border-radius: 14px; margin-top: 5px; cursor: pointer; }
.msg-meta, .msg-status { font-size: 11px; opacity: 0.7; text-align: right; margin-top: 4px; }
.sent .msg-status { color: rgba(255,255,255,0.7); }
.recalled-message { font-style: italic; color: var(--text-2); background-color: var(--recalled-bg); border: 1px dashed var(--border); padding: 8px 12px; border-radius: 12px; }
.reply-quote { background: var(--glass); padding: 6px 10px; border-left: 3px solid var(--accent-1); margin-bottom: 8px; border-radius: 4px; }
.reply-quote .sender { font-weight: 600; font-size: 13px; }
.reply-quote .text { font-size: 13px; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.edited-label { margin-left: 6px; font-style: italic; opacity: 0.8; font-size: 10px; }
.message-date-separator { text-align: center; margin: 18px 0; font-size: 13px; color: rgba(255,255,255,0.6); font-weight: 500; width: 100%; }
.message-date-separator::before, .message-date-separator::after { content: ""; position: relative; display: inline-block; width: 30%; height: 1px; background: rgba(255,255,255,0.1); top: -3px; margin: 0 8px; }
.msg-wrapper.mentioned-me .msg { background-color: rgba(96, 165, 250, 0.25); border: 1px solid var(--accent-1); }
.light .msg-wrapper.mentioned-me .msg { background-color: rgba(0, 122, 255, 0.15); border: 1px solid var(--accent-2); }
.mention { font-weight: 600; color: var(--accent-1); background-color: rgba(96, 165, 250, 0.15); padding: 1px 4px; border-radius: 4px; }
.chat-input { display: flex; gap: 0; align-items: flex-end; padding: 15px; margin-top: auto; border-top: 1px solid var(--border); flex-shrink: 0; }
#message-input{ transition: width 0.3s ease; flex: 1; border: 1px solid var(--border); border-radius: 16px; padding: 12px 14px; background: var(--input); color: var(--text); margin: 0 10px; }
.image-upload-label{ background: transparent; color: var(--accent-1); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; cursor: pointer; flex-shrink: 0; }
#send-btn { width: 0; padding: 12px 0; margin: 0; border: none; border-radius: 12px; background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); color: #fff; transform: scale(0.8); opacity: 0; overflow: hidden; transition: all 0.3s ease; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
.chat-input.has-text #send-btn { width: 48px; padding: 12px; transform: scale(1); opacity: 1; }
#send-btn[disabled]{ opacity:.6; cursor:not-allowed }
#send-btn .spinner-icon { display: none; }
#send-btn.loading { cursor: wait; }
#send-btn.loading .send-icon { display: none; }
#send-btn.loading .spinner-icon { display: block; animation: spin 1.2s linear infinite; }
@keyframes spin { 100% { transform: rotate(360deg); } }
#typing-indicator{height:22px; font-size:13px; font-style:italic; color:var(--text-2); padding: 0 15px; }
#image-preview-container, #reply-preview-container, #edit-preview-container { display:none; background:var(--glass); border:1px solid var(--border); border-radius:12px; padding: 8px 12px; margin: 0 15px 8px 15px; position:relative; }
#image-preview{max-height:130px; border-radius:8px}
#cancel-preview-btn{position:absolute; right:-6px; top:-6px; width:22px; height:22px; border-radius:50%; border:none; background:#111; color:#fff; cursor:pointer}
#reply-preview-container { border-left: 3px solid var(--accent-1); }
#edit-preview-container { border-left: 3px solid #f59e0b; }
#reply-preview-sender, #edit-preview-title { font-weight: 600; font-size: 13px; }
#edit-preview-title { color: #f59e0b; }
#reply-preview-text, #edit-preview-text { font-size: 13px; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#edit-preview-text { font-style: italic; }
#cancel-reply-btn, #cancel-edit-btn { position:absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-2); cursor: pointer; font-size: 16px; padding: 5px; }
#inactive-chat-indicator { text-align: center; padding: 12px; margin: 15px; border-radius: 12px; background: rgba(0,0,0,0.15); color: var(--text-2); font-style: italic; font-size: 14px; border: 1px solid var(--border); }

/* --- CSS Modals, Lightbox, Context Menu, Reactions etc. --- */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(12px); display: none; /* Changed to none */ justify-content: center; align-items: center; z-index: 5000; }
.modal-content { background: rgba(22, 25, 35, 0.85); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px; padding: 30px 35px; width: min(90vw, 520px); color: #fff; text-align: left; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: fadeIn .3s ease; }
.modal-content h2 { text-align: center; margin-bottom: 25px; font-size: 22px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border); background: -webkit-linear-gradient(45deg, var(--accent-1), #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; justify-content: center; gap: 10px; }
#friend-request-modal .modal-content h2::before { content: '👥'; font-size: 24px; display: inline-block; filter: grayscale(100%) contrast(200%); } /* Example icon */
@keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to {opacity:1; transform:scale(1);} }
.btn{ padding:8px 12px; border:none; border-radius:10px; background:linear-gradient(135deg,var(--accent-1),var(--accent-2)); color:#fff; cursor:pointer; }
.btn-ghost, .cancel-btn { background: rgba(255,255,255,0.15); color: #fff; border: none; padding: 10px 14px; border-radius: 10px; cursor: pointer; }
.danger-btn { background: linear-gradient(135deg, #ef4444, #b91c1c); }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
.form-label { font-size: 14px; color: var(--text-2); margin-bottom: 6px; display: block; }
.modal-content input, .modal-content textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--input); color: var(--text); outline: none; font-size: 14px; margin-bottom: 15px; }
.clickable{cursor:pointer}
.hidden{display:none}
.verified-tick { display: inline-block; width: 1.1em; height: 1.1em; margin-left: 5px; vertical-align: -0.2em; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2360a5fa'%3E%3Cpath fill-rule='evenodd' d='M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.06 0l4-5.5z' clip-rule='evenodd' /%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; background-position: center; }
.suggestion-popup { position: absolute; bottom: 75px; left: 15px; right: 15px; max-height: 200px; overflow-y: auto; background: var(--glass-3); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); border-radius: 14px; box-shadow: 0 -8px 20px rgba(0,0,0,0.2); z-index: 100; display: none; padding: 6px; scrollbar-width: thin; }
.suggestion-popup::-webkit-scrollbar{ width: 6px; }
.suggestion-popup::-webkit-scrollbar-thumb{ background: var(--glass); border-radius: 6px; }
.suggestion-item { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 10px; cursor: pointer; color: var(--text-primary); transition: background-color 0.2s; }
.suggestion-item:hover { background-color: var(--glass); }
.suggestion-item img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
.suggestion-item .name { font-weight: 500; }
.suggestion-item .all { font-weight: 600; color: var(--accent-1); }
.lightbox-overlay { position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); display: none; /* Changed */ justify-content: center; align-items: center; animation: fadeIn 0.3s; }
.lightbox-content { max-width: 90%; max-height: 90%; object-fit: contain; }
.lightbox-close-btn { position: absolute; top: 20px; right: 35px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; transition: 0.2s; }
.lightbox-close-btn:hover { color: #bbb; }
#friend-request-list { max-height: 350px; min-height: 200px; overflow-y: auto; margin: 15px 0; display: flex; align-items: center; justify-content: center; }
.friend-req-btn { padding: 8px 14px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; transition: .2s; }
.friend-req-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px 12px; margin-bottom: 8px; transition: background .2s; }
.friend-req-item:hover { background: rgba(255,255,255,0.1); }
.friend-req-name { font-weight: 500; text-align: left; }
.friend-req-buttons { display: flex; gap: 6px; }
.accept-btn { background: linear-gradient(135deg,#22c55e,#15803d); color: #fff; }
.reject-btn { background: rgba(239,68,68,0.9); color: #fff; }
.msg-content-wrapper { position: relative; }
#group-members-checklist { max-height: 200px; overflow-y: auto; text-align: left; border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin: 10px 0 20px; background: var(--input); }
#group-members-checklist label { display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 8px; cursor: pointer; }
#group-members-checklist label:hover { background-color: var(--glass); }
#group-members-checklist input[type="checkbox"] { width: 18px; height: 18px; }
#message-context-menu { position: fixed; display: none; background: var(--glass-3); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 12px; padding: 8px; box-shadow: var(--shadow); z-index: 9999; }
.context-menu-btn { display: block; width: 100%; text-align: left; background: none; border: none; color: var(--text); padding: 10px 14px; border-radius: 8px; cursor: pointer; }
.context-menu-btn:hover { background: var(--glass); }
.context-menu-btn.danger { color: #f43f5e; }
.reaction-picker { position: absolute; top: -45px; background: var(--glass-3); backdrop-filter: blur(10px); border-radius: 20px; padding: 6px; display: flex; gap: 8px; box-shadow: var(--shadow); opacity: 0; transition: opacity 0.2s, transform 0.2s; pointer-events: none; z-index: 100; }
.msg-wrapper.sent .reaction-picker { right: 10px; }
.msg-wrapper.received .reaction-picker { left: 10px; }
.msg-wrapper:hover .reaction-picker { opacity: 1; transform: scale(1); pointer-events: all; }
.reaction-btn { font-size: 22px; cursor: pointer; transition: transform 0.15s; }
.reaction-btn:hover { transform: scale(1.2); }
.reactions-display { position: absolute; bottom: -10px; background: var(--glass-2); border-radius: 10px; padding: 2px 5px; display: flex; gap: 3px; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); cursor: pointer; }
.msg-wrapper.sent .reactions-display { right: 10px; }
.msg-wrapper.received .reactions-display { left: 0px; }
#reactions-modal .modal-content { text-align: center; width: 380px; }
#reactions-list { max-height: 300px; overflow-y: auto; margin: 15px 0; }
.reaction-user-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 8px; }
.reaction-user-item:hover { background: var(--glass); }
.reaction-user-info { display: flex; align-items: center; gap: 10px; }
.reaction-user-avatar { width: 36px; height: 36px; border-radius: 50%; }
.reaction-user-name { font-weight: 500; }
.reaction-emoji { font-size: 20px; }
#toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(22, 25, 35, 0.85); color: white; padding: 20px 30px; border-radius: 12px; z-index: 10000; backdrop-filter: blur(10px); border: 1px solid var(--border); box-shadow: var(--shadow); text-align: center; display: none; animation: fadeIn .3s ease; }
#toast-message { margin-bottom: 15px; }
#toast-close-btn { background: var(--accent-1); color: white; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; }
.report-form .form-label { text-align: left; margin-bottom: 10px; }
.report-reason-row { display: flex; align-items: center; padding: 12px; border-radius: 10px; border: 1px solid transparent; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
.report-reason-row:hover { background-color: var(--glass); }
.report-reason-row input[type="radio"] { display: none; }
.report-reason-row .custom-radio { width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 50%; margin-right: 12px; display: inline-block; position: relative; transition: border-color 0.2s; }
.report-reason-row input[type="radio"]:checked + .custom-radio { border-color: var(--accent-1); }
.report-reason-row input[type="radio"]:checked + .custom-radio::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 10px; height: 10px; border-radius: 50%; background-color: var(--accent-1); }
.report-reason-row.selected { background-color: var(--glass); border-color: var(--accent-1); }
#messages-container.selection-mode .msg-wrapper { cursor: pointer; padding: 4px; border-radius: 14px; border: 2px solid transparent; transition: border-color 0.2s, background-color 0.2s; }
#messages-container.selection-mode .msg-wrapper:hover { background-color: var(--glass); }
#messages-container.selection-mode .msg-wrapper.selected { border-color: var(--accent-1); background-color: rgba(96, 165, 250, 0.2); }

/* --- CSS Chat Info Panel --- */
#open-info-btn, #group-info-btn { border:1px solid var(--border); background:transparent; color:var(--text); border-radius:12px; padding:8px 12px; cursor:pointer; }
#chat-info-panel { position: absolute; right: 0; top: 0; width: 320px; height: 100%; background: rgba(22, 25, 35, 0.85); backdrop-filter: blur(20px); border-left: 1px solid rgba(255,255,255,0.08); box-shadow: -8px 0 25px rgba(0,0,0,0.4); color: #f3f4f6; transform: translateX(340px); transition: transform .3s ease; display: flex; flex-direction: column; z-index: 1000; }
#chat-info-panel.open { transform: translateX(0); }
#chat-info-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); }
#chat-info-header h3 { font-size: 18px; font-weight: 600; color: #fff; }
#close-info-btn { background: rgba(255,255,255,0.2); border: none; border-radius: 8px; width: 30px; height: 30px; color: #fff; cursor: pointer; transition: .2s; }
#close-info-btn:hover { background: rgba(255,255,255,0.4); }
.chat-info-body { flex: 1; overflow-y: auto; padding: 16px; }
.chat-info-section { text-align: center; margin-bottom: 25px; }
.chat-info-avatar { width: 95px; height: 95px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); box-shadow: 0 0 15px rgba(59,130,246,0.3); object-fit: cover; }
.chat-info-name { font-size: 18px; font-weight: 600; margin: 10px 0; }
.chat-info-body h5 { font-size: 14px; text-transform: uppercase; letter-spacing: .5px; color: rgba(255,255,255,0.75); margin-bottom: 10px; text-align: left; }
.sent-images-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 25px; }
.sent-images-grid img { width: 100%; border-radius: 8px; cursor: pointer; transition: 0.2s; }
.sent-images-grid img:hover { transform: scale(1.06); box-shadow: 0 4px 10px rgba(59,130,246,0.5); }
.chat-actions button { width: 100%; padding: 11px; border: none; border-radius: 10px; font-size: 15px; color: #fff; cursor: pointer; margin-top: 10px; transition: 0.25s; }
#block-user-btn, #unblock-user-btn { background: linear-gradient(135deg, #ef4444, #b91c1c); }
#unblock-user-btn { background: linear-gradient(135deg, #22c55e, #16a34a); display:none; }
#block-user-btn:hover, #unblock-user-btn:hover { filter: brightness(1.1); }
#remove-friend-btn { background: linear-gradient(135deg, #6b7280, #4b5563); opacity: 0.9; }
#remove-friend-btn:hover { opacity: 1; filter: brightness(1.1); }
#leave-group-btn { background: linear-gradient(135deg, #ef4444, #b91c1c); }
#group-members-list {list-style: none; padding: 0; margin-bottom: 20px; display: flex; flex-direction: column; gap: 8px;}
.member-item { display: flex; justify-content: space-between; align-items: center; background: var(--glass); padding: 8px 12px; border-radius: 8px; }
.member-info { display: flex; flex-direction: column; align-items: flex-start; }
.member-name { font-weight: 500; }
.member-role { font-size: 12px; opacity: 0.7; padding: 2px 6px; border-radius: 6px; color: white; } /* Common color */
.role-admin { background-color: #a855f7; }
.role-moderator { background-color: #2563eb; }
.role-member { background-color: #4b5563; }
.member-actions button { background: none; border: 1px solid var(--border); color: var(--text-2); padding: 4px 8px; font-size: 11px; border-radius: 6px; cursor: pointer; margin-left: 4px; }
.member-actions button:hover { background: var(--glass-3); }
#group-avatar.editable-group-info, #group-name-display.editable-group-info { cursor: pointer; transition: opacity 0.2s; }
#group-avatar.editable-group-info:hover, #group-name-display.editable-group-info:hover { opacity: 0.7; }
/* Fix Edit Group Modal Quirks */
#edit-group-modal .modal-content { width: min(90vw, 520px) !important; box-sizing: border-box !important; padding: 30px 35px !important; }
#edit-group-modal .modal-content > div:first-of-type { display: flex !important; align-items: flex-start !important; gap: 20px !important; margin-bottom: 20px !important; box-sizing: border-box !important; }
#edit-group-modal .modal-content > div:first-of-type > div:first-child { flex-shrink: 0 !important; text-align: center !important; box-sizing: border-box !important; }
#edit-group-modal #edit-group-avatar-preview { width: 95px !important; height: 95px !important; border-radius: 50% !important; object-fit: cover !important; border: 2px solid var(--border) !important; cursor: pointer !important; transition: opacity 0.2s !important; display: block !important; margin: 0 auto !important; }
#edit-group-modal #edit-group-avatar-loading { font-size: 13px !important; color: var(--accent-1) !important; display: none; margin-top: 5px !important; }
#edit-group-modal .modal-content > div:first-of-type > div:last-child { flex-grow: 1 !important; min-width: 0 !important; box-sizing: border-box !important; }
#edit-group-modal .modal-content label.form-label { display: block !important; text-align: left !important; margin-bottom: 6px !important; font-size: 14px !important; color: var(--text-2) !important; box-sizing: border-box !important; }
#edit-group-modal .modal-content input[type="text"] { width: 100% !important; padding: 10px !important; border-radius: 8px !important; border: 1px solid var(--border) !important; background: var(--input) !important; color: var(--text) !important; outline: none !important; font-size: 14px !important; margin-bottom: 15px !important; box-sizing: border-box !important; }
#edit-group-modal .modal-content label[for="edit-group-avatar-input"] { margin-top: 15px !important; }
#edit-group-modal .modal-actions { display: flex !important; justify-content: flex-end !important; gap: 10px !important; margin-top: 20px !important; box-sizing: border-box !important; }

/* --- CSS Tab Bạn bè --- */
.friends-view { padding: 20px; height: 100%; overflow-y: auto; }
.friends-container h1 { font-size: 24px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--glass-border); }
#friends-search-input { width: 100%; padding: 12px 16px; border-radius: 10px; border: 1px solid var(--glass-border); background: var(--input-bg); color: var(--text-primary); outline: none; font-size: 15px; margin-bottom: 20px; }
#friends-tab-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 10px; }
.friend-item { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 12px 15px; border-radius: 12px; cursor: pointer; background-color: var(--bg-nav); transition: background-color 0.2s ease; }
.friend-item:hover { background-color: var(--hover-bg); }
.friend-item-left { display: flex; align-items: center; gap: 12px; min-width: 0; }
.friend-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 1px solid var(--glass-border); flex-shrink: 0; }
.friend-name { font-weight: 600; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.friend-status { width: 10px; height: 10px; border-radius: 50%; background: #64748b; flex-shrink: 0; margin-left: auto; }
.friend-status.online { background: #22c55e; }
.friend-item-placeholder { color: var(--text-secondary); text-align: center; padding: 20px; }
.light .friend-item { background-color: var(--bg-card); }
.light .friend-item:hover { background-color: var(--hover-bg); }
.light #friends-search-input { background: var(--input-bg); border-color: var(--glass-border); }

/* --- CSS Tab Wall --- */
.wall-view { background-color: var(--bg-dark); } /* Assume wall has dark bg */
#wall-iframe { width: 100%; height: 100%; border: none; }
#wall-loader { position: absolute; inset: 0; background: var(--bg-dark); display: none; /* JS will show */ justify-content: center; align-items: center; z-index: 10; }

/* --- CSS Changelog Modal --- */
#changelog-content { scrollbar-width: thin; }
#changelog-content::-webkit-scrollbar { width: 6px; }
#changelog-content::-webkit-scrollbar-thumb { background: var(--glass); border-radius: 3px; }
.changelog-entry { margin-bottom: 20px; }
.changelog-meta { display: flex; align-items: baseline; gap: 8px; margin-bottom: 8px; }
.changelog-meta h3 { font-size: 1.1em; font-weight: 600; color: var(--accent-1); margin: 0; }
.changelog-meta span { font-size: 0.85em; color: var(--text-secondary); }
.changelog-desc p { margin-bottom: 8px; line-height: 1.6; color: var(--text-primary); }
.changelog-desc p::before { content: "- "; margin-right: 4px; }
.changelog-image { display: block; max-width: 80%; height: auto; border-radius: 8px; margin: 15px auto 10px auto; border: 1px solid var(--glass-border); }
hr.changelog-divider { border: none; height: 1px; background-color: var(--glass-border); margin: 25px 0; }
#changelog-content .changelog-entry:last-child + hr.changelog-divider { display: none; }

/* --- CSS Announcement Popup --- */
#announcement-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); display: none; /* Changed */ align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
#announcement-overlay.show { opacity: 1; visibility: visible; display: flex; }
#announcement-popup { background: var(--glass-3, rgba(30, 41, 59, 0.9)); padding: 25px 30px; border-radius: 16px; border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.1)); box-shadow: var(--shadow, 0 10px 30px rgba(0,0,0,0.3)); width: min(90vw, 450px); text-align: center; transform: scale(0.9); transition: transform 0.3s ease; }
#announcement-overlay.show #announcement-popup { transform: scale(1); }
#announcement-title { font-size: 20px; font-weight: 600; margin-bottom: 15px; color: var(--text-primary); }
#announcement-image { max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 15px; object-fit: contain; }
#announcement-text { font-size: 15px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px; white-space: pre-wrap; }
#close-announcement-btn { display: inline-block; width: auto; padding: 10px 25px; background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 500; margin-top: 0; }
.light #announcement-popup { background: var(--glass-3, rgba(255, 255, 255, 0.95)); border-color: var(--glass-border, rgba(0, 0, 0, 0.1)); }
.light #announcement-title { color: var(--text-primary); }
.light #announcement-text { color: var(--text-secondary); }

/* --- CSS Responsive (@media) --- */
@media (max-width: 768px) {
    body { padding: 0; align-items: stretch; }
    .app-main { padding-bottom: 60px !important; }
    .app-nav { display: flex !important; flex-direction: row !important; align-items: center; width: 100%; height: 60px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; padding: 0 15px; background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(18px); border-top: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 -4px 15px rgba(0,0,0,0.2); }
    .app-nav .nav-avatar { display: block; width: 40px !important; height: 40px !important; margin: 0; padding: 0; border-radius: 50%; overflow: hidden; border: 2px solid transparent; transition: border-color 0.2s ease; flex-shrink: 0; cursor: pointer; }
    .app-nav .nav-avatar img { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
    .app-nav .nav-avatar:hover { border-color: var(--glass); }
    .app-nav .nav-button { flex: 1; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); border-radius: 12px; transition: background-color 0.2s ease, color 0.2s ease; background-color: transparent; border: none; cursor: pointer; }
    .app-nav .nav-button:hover { background-color: var(--glass); color: var(--text); }
    .app-nav .nav-button.active { background-color: var(--accent-1); color: #fff; }
    .app-nav .nav-button.active::before { display: none; }
    .app-nav .nav-button svg { width: 24px; height: 24px; }
    .app-nav .nav-spacer { display: none !important; }
    #nav-settings-menu { position: fixed !important; bottom: 70px !important; left: 15px !important; right: auto !important; width: 200px !important; z-index: 1010 !important; display: none; background: var(--glass-3); backdrop-filter: blur(18px); border: 1px solid var(--glass-border); border-radius: 12px; padding: 10px; box-shadow: var(--shadow); top: auto !important; }
    .chat-view .container#app { width: 100% !important; display: flex !important; }
    .chat-view #sidebar, .chat-view #chat-window { width: 100% !important; max-width: none !important; height: 100%; padding: 10px; box-sizing: border-box; border-right: none; flex-shrink: 0; }
    #chat-placeholder { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: var(--text-secondary); font-size: 16px; padding: 20px; }
    body:not(.mobile-chat-active) .chat-view #chat-window { display: none !important; }
    body:not(.mobile-chat-active) .chat-view #chat-placeholder { display: none !important; }
    body:not(.mobile-chat-active) .chat-view #sidebar { display: flex !important; }
    body.mobile-chat-active .chat-view #sidebar { display: none !important; }
    body.mobile-chat-active .chat-view #chat-window { display: flex !important; }
    body.mobile-chat-active .chat-view #chat-placeholder { display: none !important; }
    #chat-header { padding: 8px 10px; gap: 8px; }
    #current-chat-friend-name { font-size: 16px; }
    #current-chat-avatar { width: 36px; height: 36px; }
    #open-info-btn, #group-info-btn { font-size: 22px; padding: 3px;}
    .chat-input { gap: 8px; align-items: flex-end; padding: 10px; }
    #message-input { padding: 10px 12px; margin: 0; flex: 1; transition: none; }
    .image-upload-label { padding: 10px 14px; }
    #send-btn { display: none; width: 44px; height: 44px; padding: 0; margin: 0; border-radius: 50%; flex-shrink: 0; align-items: center; justify-content: center; }
    .chat-input.has-text #send-btn { display: flex !important; }
    .chat-input.has-text #send-btn:not(.loading) .send-icon { display: block !important; margin: auto; }
    .chat-input.has-text #send-btn:not(.loading) .spinner-icon { display: none !important; }
    #send-btn.loading .send-icon { display: none !important; }
    #send-btn.loading .spinner-icon { display: block !important; margin: auto; animation: spin 1.2s linear infinite; }
    #chat-info-panel { display: none !important; }
    #open-friend-req-btn { display: none; }
    .modal-content { width: min(90vw, 420px); padding: 20px 25px; }
    .modal-content h2 { font-size: 20px; }
    .modal-actions button { font-size: 15px; padding: 10px 18px; }
    .friends-view { padding: 15px; }
    .friends-container h1 { font-size: 20px; margin-bottom: 10px; }
    #friends-search-input { padding: 10px 14px; font-size: 14px; margin-bottom: 15px; }
    .friend-item { padding: 10px; gap: 10px; }
    .friend-avatar { width: 40px; height: 40px; }
    .friend-name { font-size: 15px; }
} /* Kết thúc @media */

#nav-settings-menu {
    position: absolute;
    bottom: 75px;
    left: 80px;
    width: 220px;
    display: none;
    background: var(--glass-3);
    backdrop-filter: blur(18px);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 10px;
    box-shadow: var(--shadow);
    z-index: 1010; /* <<< TĂNG GIÁ TRỊ NÀY LÊN */
}

/* Đảm bảo z-index cho mobile cũng cao */
@media (max-width: 768px) {
    #nav-settings-menu {
        position: fixed !important;
        bottom: 70px !important;
        left: 15px !important;
        right: auto !important;
        width: 200px !important;
        z-index: 1010 !important; /* <<< ĐẢM BẢO GIÁ TRỊ NÀY CAO */
    }
}

/* --- CSS CHO LINK TRONG TIN NHẮN --- */
.message-link {
    color: var(--accent-1); /* Màu xanh accent */
    text-decoration: underline;
    cursor: pointer;
}
.message-link:hover {
    color: var(--accent-2); /* Màu xanh đậm hơn khi hover */
}
/* Style cho theme sáng (nếu cần màu khác) */
.light .message-link {
     color: #007aff; /* Màu xanh dương cho theme sáng */
}
.light .message-link:hover {
     color: #0056b3;
}
/* --- CSS CHO THÔNG TIN APP DƯỚI NAV --- */
#app-info {
    padding: 10px 8px; /* Khoảng cách xung quanh text */
    font-size: 10px; /* Cỡ chữ nhỏ */
    color: var(--text-secondary); /* Màu chữ phụ */
    text-align: center; /* Căn giữa chữ */
    line-height: 1.4; /* Giãn dòng */
    word-break: break-all; /* Tự xuống dòng nếu UID quá dài */
    margin-bottom: 5px; /* Khoảng cách nhỏ với avatar */
}

/* Đẩy Avatar lên một chút */
.app-nav .nav-avatar {
    margin-bottom: 5px; /* Thay vì 10px mặc định */
}

/* Đẩy menu settings lên tương ứng (nếu cần) */
#nav-settings-menu {
     bottom: 65px; /* Tăng bottom lên một chút (thay vì 75px) */
     /* Kiểm tra lại vị trí trên mobile nếu cần */
}

/* Responsive cho mobile (đẩy menu lên cao hơn nữa) */
@media (max-width: 768px) {
    #app-info {
        display: none; /* Ẩn thông tin này trên mobile cho gọn */
    }
    .app-nav .nav-avatar {
        margin-bottom: 0; /* Reset margin bottom avatar trên nav đáy */
        margin-right: 10px; /* Thêm margin phải để cách nút */
    }
    #nav-settings-menu {
        bottom: 70px !important; /* Vị trí gốc cho mobile */
        left: 15px !important; /* Vị trí gốc cho mobile */
    }
}

/* --- CSS CHO THÔNG TIN APP DƯỚI NAV --- */
#app-info {
    padding: 10px 8px;
    font-size: 10px;
    color: var(--text-secondary);
    text-align: center;
    line-height: 1.4;
    /* word-break: break-all; */ /* <<< BỎ HOẶC COMMENT DÒNG NÀY */
    overflow-wrap: break-word; /* <<< THÊM DÒNG NÀY */
    margin-bottom: 5px;
}

#user-uid-display {
    cursor: pointer; /* <<< THÊM CURSOR POINTER */
    /* Optional: Add hover effect */
    transition: color 0.2s;
}

#user-uid-display:hover {
    color: var(--text-primary); /* Sáng lên khi hover */
}

/* ... (CSS còn lại giữ nguyên) ... */

/* --- CSS CHO THÔNG TIN APP DƯỚI NAV --- */
#app-info {
    padding: 10px 8px;
    font-size: 10px;
    color: var(--text-secondary);
    /* text-align: center; */ /* <<< BỎ HOẶC SỬA THÀNH LEFT */
    text-align: left;       /* <<< CĂN TRÁI */
    line-height: 1.4;
    /* Bỏ word-break và overflow-wrap */
    /* word-break: break-all; */
    /* overflow-wrap: break-word; */
    margin-bottom: 5px;
    overflow: hidden; /* <<< THÊM DÒNG NÀY ĐỂ TRÁNH TRÀN */
}

#user-uid-display {
    cursor: pointer;
    transition: color 0.2s;
    /* === THÊM CÁC DÒNG NÀY === */
    white-space: nowrap;   /* Ngăn xuống dòng */
    overflow: hidden;      /* Ẩn phần bị tràn */
    text-overflow: ellipsis; /* Hiện dấu "..." */
    display: inline-block; /* Cần thiết cho text-overflow */
    max-width: 100%;       /* Đảm bảo không tràn khỏi #app-info */
    vertical-align: bottom; /* Căn chỉnh với chữ UID: */
    /* === KẾT THÚC THÊM === */
}

#user-uid-display:hover {
    color: var(--text-primary);
}

/* ... (CSS còn lại giữ nguyên) ... */
/* Tìm đoạn CSS này */
#open-friend-req-btn {
    position: absolute;
    /* bottom: 15px; */ /* <<< XÓA HOẶC SỬA DÒNG NÀY */
    bottom: 55px;     /* <<< THAY BẰNG GIÁ TRỊ CAO HƠN */
    left: 16px;
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
    /* ... (các style khác giữ nguyên) ... */
}

/* --- CSS CHO THÔNG TIN APP (GHIM GÓC DƯỚI TRÁI) --- */
#app-info {
    position: fixed;        /* <<< GHIM CỐ ĐỊNH */
    bottom: 10px;           /* <<< CÁCH ĐÁY 10PX */
    left: 10px;             /* <<< CÁCH TRÁI 10PX */
    z-index: 1001;          /* <<< Nằm trên các view nhưng dưới modal */

    /* Style khung nền (giữ nguyên hoặc sửa) */
    background-color: rgba(0, 0, 0, 0.5); /* Nền tối hơn chút */
    border-radius: 8px;       /* Bo góc ít hơn */
    padding: 4px 10px;        /* Padding nhỏ hơn */

    /* Style chữ bên trong */
    font-size: 11px;
    color: var(--text-secondary);
    line-height: 1.4;
    text-align: left;

    /* Cho phép dài ra và có "..." */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 300px; /* <<< Giới hạn chiều dài tối đa nếu muốn */
}

#app-info span { /* Style chung cho các span con */
    color: var(--text);
    font-weight: 500;
    vertical-align: middle;
}

#user-uid-display {
    cursor: pointer;
    transition: color 0.2s;
    /* Không cần style overflow ở đây nữa */
}

#user-uid-display:hover {
    color: var(--accent-1);
}

/* --- ĐIỀU CHỈNH LẠI NAV (NẾU CẦN) --- */
/* Bỏ margin-bottom của #app-info cũ khỏi avatar */
.app-nav .nav-avatar {
     margin-bottom: 40px; /* Trả về margin gốc */
}
/* Trả lại vị trí gốc cho menu settings */
#nav-settings-menu {
     bottom: 60px;
     /* CSS mobile cho menu settings vẫn giữ nguyên */
}

/* Bỏ ẩn #app-info trên mobile nếu muốn hiện */
/* @media (max-width: 768px) { #app-info { display: none; } } */

/* --- CSS CHO THÔNG TIN APP (SỬA LẠI WIDTH) --- */
#app-info {
    position: fixed;
    bottom: 10px;
    left: 10px;
    z-index: 1001;
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 8px;
    /* padding: 6px 12px; */ /* Padding cũ */
    padding: 4px 10px;        /* <<< GIẢM PADDING */
    font-size: 11px;
    color: var(--text-secondary);
    line-height: 1.4; /* Giảm line-height chút */
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    /* max-width: 300px; */ /* Width cũ */
    max-width: 400px;         /* <<< TĂNG MAX-WIDTH LÊN */
}

/* --- CSS CHO LIGHTBOX XEM ẢNH (Nâng cấp) --- */
.lightbox-overlay {
    position: fixed;
    inset: 0; /* top: 0; left: 0; right: 0; bottom: 0; */
    background-color: rgba(0, 0, 0, 0.85); /* Nền đen mờ hơn */
    backdrop-filter: blur(8px); /* Hiệu ứng mờ nền */
    display: none; /* Dùng flex khi hiện */
    justify-content: center;
    align-items: center;
    z-index: 9999; /* Nằm trên cùng */
    animation: fadeIn 0.3s ease; /* Giữ animation cũ */
    user-select: none; /* Chặn bôi đen chữ/nút */
    -webkit-user-select: none;
}
/* Thêm class 'show' để JS dễ dàng điều khiển */
.lightbox-overlay.show {
    display: flex;
}

.lightbox-content {
    max-width: 90%;
    max-height: 90%;
    object-fit: contain; /* Hiển thị toàn bộ ảnh */
    display: block; /* Để margin auto hoạt động */
    margin: auto; /* Căn giữa tuyệt đối */
    border-radius: 5px; /* Bo góc nhẹ cho ảnh */
    box-shadow: 0 5px 25px rgba(0,0,0,0.4);
}

.lightbox-close-btn {
    position: absolute;
    top: 15px; /* Gần góc hơn */
    right: 20px;
    color: rgba(255, 255, 255, 0.8);
    font-size: 45px; /* To hơn chút */
    font-weight: bold;
    cursor: pointer;
    transition: color 0.2s ease;
    line-height: 1; /* Căn chuẩn hơn */
    z-index: 10001; /* Nằm trên nút nav */
}
.lightbox-close-btn:hover {
    color: #fff;
}

/* === CSS CHO NÚT ĐIỀU HƯỚNG MỚI === */
.lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 40px; /* Cỡ icon mũi tên */
    font-weight: bold;
    padding: 10px 18px; /* Kích thước nút */
    border-radius: 50%; /* Nút tròn */
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
    z-index: 10000; /* Nằm trên ảnh */
    line-height: 1;
    display: none; /* Mặc định ẩn, JS sẽ hiện */
}
.lightbox-nav:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
}
.lightbox-nav.prev {
    left: 20px; /* Vị trí nút Previous */
}
.lightbox-nav.next {
    right: 20px; /* Vị trí nút Next */
}
/* === KẾT THÚC CSS NÚT ĐIỀU HƯỚNG === */

/* Giữ keyframes fadeIn */
@keyframes fadeIn { from { opacity:0; } to {opacity:1; } }

/* Responsive cho nút bấm trên mobile */
@media (max-width: 768px) {
    .lightbox-close-btn { font-size: 35px; top: 10px; right: 15px; }
    .lightbox-nav { font-size: 30px; padding: 8px 14px; }
    .lightbox-nav.prev { left: 10px; }
    .lightbox-nav.next { right: 10px; }
}

.lightbox-overlay.show {
    display: flex;
    opacity: 1; /* Thêm opacity để chắc chắn */
    visibility: visible; /* Thêm visibility */
}
/* ... (CSS còn lại giữ nguyên) ... */

/* --- CSS CHO LIGHTBOX XEM ẢNH (Kiểm tra lại) --- */
.lightbox-overlay {
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    display: none; /* << MẶC ĐỊNH LÀ NONE */
    justify-content: center;
    align-items: center;
    z-index: 9999; /* << ĐẢM BẢO Z-INDEX CAO */
    opacity: 0; /* Thêm opacity để làm hiệu ứng */
    visibility: hidden; /* Thêm visibility */
    transition: opacity 0.3s ease, visibility 0.3s ease; /* Hiệu ứng mờ dần */
}

/* KHI CÓ CLASS 'show' SẼ HIỆN RA */
.lightbox-overlay.show {
    display: flex; /* <<< QUAN TRỌNG: ĐỔI THÀNH FLEX */
    opacity: 1;
    visibility: visible;
}

.lightbox-content { /* Ảnh bên trong */
    max-width: 90%;
    max-height: 90%;
    object-fit: contain;
    display: block;
    margin: auto;
    border-radius: 5px;
    box-shadow: 0 5px 25px rgba(0,0,0,0.4);
}

.lightbox-close-btn { /* Nút đóng */
    position: absolute;
    top: 15px;
    right: 20px;
    color: rgba(255, 255, 255, 0.8);
    font-size: 45px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.2s ease;
    line-height: 1;
    z-index: 10001; /* Cao hơn nút nav */
}
.lightbox-close-btn:hover { color: #fff; }

.lightbox-nav { /* Nút prev/next */
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 40px;
    font-weight: bold;
    padding: 10px 18px;
    border-radius: 50%;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
    z-index: 10000;
    line-height: 1;
    display: none; /* JS sẽ quản lý */
}
.lightbox-nav:hover { background: rgba(255, 255, 255, 0.2); color: #fff; }
.lightbox-nav.prev { left: 20px; }
.lightbox-nav.next { right: 20px; }

/* --- CSS CHO NÚT TẢI VÀ DANH SÁCH THUMBNAIL --- */

.lightbox-action-btn { /* Style chung cho các nút hành động */
    position: absolute;
    top: 15px;
    background: rgba(255, 255, 255, 0.15);
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s ease;
    z-index: 10001; /* Đảm bảo nằm trên ảnh */
}
.lightbox-action-btn:hover {
    background: rgba(255, 255, 255, 0.25);
}
.lightbox-action-btn svg {
    color: rgba(255, 255, 255, 0.8);
    width: 22px;
    height: 22px;
}
.lightbox-action-btn:hover svg {
    color: #fff;
}

#lightbox-download-btn { /* Vị trí nút tải */
    right: 80px; /* Cách nút đóng 1 khoảng */
}

#lightbox-thumbnails-container {
    position: absolute;
    bottom: 0; /* Nằm sát đáy */
    left: 0;
    width: 100%;
    padding: 10px 0; /* Padding trên dưới */
    background: linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0)); /* Hiệu ứng mờ dần */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000; /* Nằm trên ảnh nhưng dưới nút đóng/tải */
    height: 100px; /* Chiều cao container */
    pointer-events: none; /* Ban đầu không cho tương tác */
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}
.lightbox-overlay.show #lightbox-thumbnails-container {
    opacity: 1;
    visibility: visible;
    pointer-events: auto; /* Cho phép tương tác khi hiện */
}


#lightbox-thumbnails-list {
    display: flex;
    overflow-x: auto; /* Cuộn ngang */
    gap: 8px; /* Khoảng cách giữa các thumbnail */
    padding: 0 20px; /* Padding hai bên cho list cuộn */
    -ms-overflow-style: none; /* Ẩn scrollbar trên IE/Edge */
    scrollbar-width: none; /* Ẩn scrollbar trên Firefox */
    max-width: 90%; /* Giới hạn chiều rộng */
    margin: 0 auto; /* Căn giữa */
    align-items: center; /* Căn giữa theo chiều dọc */
}
#lightbox-thumbnails-list::-webkit-scrollbar {
    display: none; /* Ẩn scrollbar trên Chrome/Safari */
}

.lightbox-thumbnail-item {
    width: 60px; /* Kích thước thumbnail */
    height: 60px;
    border-radius: 5px;
    object-fit: cover;
    cursor: pointer;
    border: 2px solid transparent; /* Border mặc định */
    transition: border-color 0.2s ease, transform 0.2s ease;
    flex-shrink: 0; /* Không co lại */
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.lightbox-thumbnail-item:hover {
    transform: scale(1.05); /* Hiệu ứng phóng to khi hover */
}
.lightbox-thumbnail-item.active {
    border-color: var(--accent-1); /* Màu border khi active */
    transform: scale(1.1);
}

/* Responsive cho nút và thumbnails */
@media (max-width: 768px) {
    #lightbox-download-btn {
        right: 65px; /* Giảm khoảng cách trên mobile */
        width: 38px;
        height: 38px;
    }
    #lightbox-download-btn svg { width: 18px; height: 18px; }

    #lightbox-thumbnails-container {
        height: 80px;
        padding: 8px 0;
    }
    #lightbox-thumbnails-list {
        gap: 6px;
        padding: 0 10px;
        max-width: 95%;
    }
    .lightbox-thumbnail-item {
        width: 50px;
        height: 50px;
    }
}

/* --- CSS CHO TRẠNG THÁI LAST SEEN HEADER --- */
.last-seen-status {
    font-size: 12px; /* Chữ nhỏ */
    color: var(--text-secondary); /* Màu chữ phụ */
    margin-top: 2px; /* Khoảng cách nhỏ với tên/nút kết bạn */
    height: 15px; /* Chiều cao cố định để tránh nhảy layout */
    line-height: 15px; /* Căn chữ giữa theo chiều dọc */
    white-space: nowrap; /* Luôn hiển thị trên 1 dòng */
    overflow: hidden;
    text-overflow: ellipsis;
}
.light .last-seen-status {
    color: #6b7280; /* Màu chữ phụ cho theme sáng */
}

/* --- CSS CHO MENU SETTINGS NÂNG CẤP (TRONG NAV DỌC) --- */

/* Style cho cái menu popup */
#nav-settings-menu {
    position: absolute;
    /* bottom: 75px; */ /* Vị trí cũ */
    bottom: 65px;     /* <<< VỊ TRÍ MỚI (vì đã thêm #app-info) */
    left: 80px;
    width: 240px; /* Tăng chiều rộng một chút cho icon */
    display: none;
    background: var(--glass-3);
    backdrop-filter: blur(18px);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 8px; /* Giảm padding tổng */
    box-shadow: var(--shadow);
    z-index: 1010; /* Tăng z-index */
}
/* Style cho mỗi hàng trong menu */
.settings-row {
    display: flex; /* <<< THÊM: Sắp xếp icon và chữ */
    align-items: center; /* <<< THÊM: Căn giữa icon và chữ */
    gap: 12px; /* <<< THÊM: Khoảng cách giữa icon và chữ */
    justify-content: flex-start; /* <<< THÊM: Căn sang trái */
    padding: 10px 14px; /* Sửa padding */
    border-radius: 10px;
    cursor: pointer;
    color: var(--text-primary); /* Đổi màu chữ chính */
    font-size: 15px; /* Giảm cỡ chữ chút */
    font-weight: 500;
    transition: background-color 0.2s; /* Thêm transition */
}
.settings-row:hover {
    background: var(--glass);
    color: var(--text-primary);
}

/* Style cho Icon (SVG) */
#nav-settings-menu .settings-row svg {
    width: 20px;
    height: 20px;
    stroke: var(--text-secondary); /* Màu icon nhạt hơn */
    flex-shrink: 0; /* Icon không bị co lại */
    transition: stroke 0.2s;
}
.settings-row:hover svg {
    stroke: var(--text-primary); /* Icon sáng lên khi hover */
}
/* Style cho chữ bên cạnh icon */
#nav-settings-menu .settings-row span {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Nút Đăng xuất màu đỏ */
#nav-settings-menu #go-login {
    color: #f87171; /* Màu đỏ nhạt */
}
#nav-settings-menu #go-login svg {
    stroke: #f87171;
}
#nav-settings-menu #go-login:hover {
    background: rgba(239, 68, 68, 0.1); /* Nền đỏ mờ */
    color: #ef4444; /* Màu đỏ đậm */
}
#nav-settings-menu #go-login:hover svg {
    stroke: #ef4444;
}

/* Responsive cho menu settings (Giữ nguyên) */
@media (max-width: 768px) {
    #nav-settings-menu {
        bottom: 70px !important; /* Vị trí gốc cho mobile */
        left: 15px !important;
        width: 220px; /* Giữ chiều rộng cũ trên mobile */
    }
}

friends-view {
        /* Đảm bảo nó chiếm full không gian */
        width: 100%;
        height: 100%;
        padding: 0;
        background-color: var(--bg-dark); /* Nền tối hơn cho view này */
    }
    .friends-layout-container {
        display: flex;
        width: 100%;
        height: 100%;
    }
.friends-nav-sidebar {
    width: 320px;
    height: 250px; /* <<< SỬA DÒNG NÀY (từ 100%) */
    background-color: var(--bg-nav);
    border-right: 1px solid var(--glass-border);
    display: flex;
    flex-direction: column;
    padding: 20px;
    /* gap: 15px; */ /* Đảm bảo dòng này đã bị xóa hoặc comment */
    flex-shrink: 0;
}

.friends-nav-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px; /* Khoảng cách dưới header */
    }
    .friends-nav-header h2 {
        font-size: 20px;
        color: var(--text-primary);
    }
    .friends-nav-add-btn {
        background: var(--hover-bg);
        border: 1px solid var(--glass-border);
        color: var(--text-secondary);
        width: 32px;
        height: 32px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .friends-nav-add-btn:hover {
        background: var(--glass);
        color: var(--text-primary);
        border-color: var(--accent-1);
    }
    .friends-nav-search-bar {
        position: relative;
    }
    .friends-nav-search-bar svg {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        opacity: 0.7;
    }
    .friends-nav-search-bar input {
        width: 100%;
        padding: 10px 12px 10px 38px; /* Padding trái cho icon */
        border-radius: 8px;
        background: var(--input-bg);
        border: 1px solid var(--glass-border);
        color: var(--text-primary);
        outline: none;
        font-size: 15px;
    }
    .friends-nav-search-bar input:focus {
        border-color: var(--accent-1);
        box-shadow: 0 0 10px rgba(96, 165, 250, 0.2);
    }
    .friends-nav-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
        border-top: 1px solid var(--glass-border); /* <<< THÊM DÒNG NÀY */
        padding-top: 15px; /* <<< THÊM DÒNG NÀY */
    }
    .friends-nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 15px;
        border-radius: 8px;
        cursor: pointer;
        color: var(--text-secondary);
        font-weight: 500;
        transition: background-color 0.2s, color 0.2s;
    }
    .friends-nav-item svg {
        flex-shrink: 0;
    }
    .friends-nav-item:hover {
        background-color: var(--hover-bg);
        color: var(--text-primary);
    }
    .friends-nav-item.active {
        background-color: var(--active-bg);
        color: var(--text-primary); /* Màu chữ đậm khi active */
        font-weight: 600;
    }
    .nav-badge {
        margin-left: auto;
        background-color: var(--red-accent);
        color: white;
        font-size: 11px;
        font-weight: 600;
        padding: 2px 7px;
        border-radius: 10px;
        min-width: 20px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* --- Content Area (Bên phải tab Bạn Bè) --- */
    .friends-content-area {
        flex: 1;
        height: 100%;
        display: flex;
        flex-direction: column;
        background: var(--bg-light); /* Nền giống sidebar chat */
    }
    .friends-content-page {
        width: 100%;
        height: 100%;
        display: none; /* Mặc định ẩn */
        flex-direction: column;
        overflow: hidden; /* Ngăn header bị cuộn */
    }
    .friends-content-page.active {
        display: flex; /* Hiện trang active */
    }
    .friends-content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 30px;
        border-bottom: 1px solid var(--glass-border);
        flex-shrink: 0;
    }
    .friends-content-header h2 {
        font-size: 20px;
        color: var(--text-primary);
    }
    .friends-content-filters {
        display: flex;
        gap: 10px;
    }
    .friends-list-search-input {
        padding: 8px 12px;
        border-radius: 8px;
        background: var(--input-bg);
        border: 1px solid var(--glass-border);
        color: var(--text-primary);
        outline: none;
        font-size: 14px;
        width: 200px;
    }
    .filter-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        border-radius: 8px;
        background: var(--input-bg);
        border: 1px solid var(--glass-border);
        color: var(--text-secondary);
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .filter-btn:hover {
        background-color: var(--hover-bg);
        color: var(--text-primary);
    }
    .filter-btn svg { width: 16px; height: 16px; }

    /* --- List (Bạn bè, Lời mời...) --- */
    .friends-list-container {
        flex: 1; /* Chiếm hết không gian còn lại */
        overflow-y: auto; /* Cho phép cuộn */
        padding: 20px 30px;
    }
    .friends-list-placeholder {
        color: var(--text-secondary);
        text-align: center;
        padding: 40px;
        font-size: 15px;
    }
    .letter-divider {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        padding: 10px 0;
        margin-bottom: 5px;
        border-bottom: 1px solid var(--glass-border);
    }
   .friend-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
 }
    .friend-list-item:hover {
        background-color: var(--hover-bg);
    }
    .friend-list-left {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
    }
    .friend-list-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
    }
    .friend-list-name {
        font-weight: 500;
        font-size: 16px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: inline-flex; /* Cho tick xanh */
        align-items: center;
    }
    .friend-list-actions button {
        background: none;
        border: none;
        color: var(--text-secondary);
        padding: 5px;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    .friend-list-actions button:hover {
        background-color: var(--glass);
        color: var(--text-primary);
    }

    /* Style cho list Lời mời kết bạn (dùng lại style cũ) */
    #friends-requests-list-page .friend-req-item {
        /* Kế thừa từ CSS gốc */
    }
    #friends-requests-list-page .friend-req-name {
        /* Kế thừa */
    }

    /* Responsive cho Tab Bạn Bè (Mobile) */
    @media (max-width: 768px) {
        .friends-nav-sidebar {
            width: 100%; /* Chiếm full width */
            height: auto;
            border-right: none;
            border-bottom: 1px solid var(--glass-border);
            padding: 15px;
            gap: 10px;
        }
        .friends-layout-container {
            flex-direction: column; /* Xếp dọc 2 cột */
        }
        .friends-nav-header h2 { font-size: 18px; }
        .friends-nav-search-bar input { padding: 9px 10px 9px 34px; font-size: 14px; }
        .friends-nav-list {
            flex-direction: row; /* Nav nội bộ nằm ngang */
            overflow-x: auto; /* Cho phép cuộn ngang */
            padding-bottom: 5px;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .friends-nav-list::-webkit-scrollbar { display: none; }
        .friends-nav-item {
            padding: 9px 14px;
            font-size: 14px;
            white-space: nowrap; /* Không xuống dòng */
            margin-bottom: 0;
        }
        .friends-nav-item span {
            /* Ẩn chữ đi nếu cần cho gọn */
            /* display: none; */ 
        }
        .nav-badge { font-size: 10px; padding: 2px 6px; }

        .friends-content-area {
            flex: 1;
            overflow: hidden; /* Cần thiết */
        }
        .friends-content-header {
            padding: 15px;
            flex-direction: column; /* Xếp dọc header */
            align-items: flex-start; /* Căn trái */
            gap: 10px;
        }
        .friends-content-header h2 { font-size: 18px; }
        .friends-content-filters {
            width: 100%;
            gap: 8px;
        }
        .friends-list-search-input {
            flex-grow: 1; /* Cho ô search chiếm nhiều không gian */
            width: auto;
        }
        .filter-btn { padding: 8px 10px; font-size: 13px; }
        .filter-btn span { display: none; } /* Ẩn chữ, chỉ hiện icon */

        .friends-list-container {
            padding: 10px 15px;
        }
        .friend-list-item { padding: 10px 5px; }
        .friend-list-avatar { width: 36px; height: 36px; }
        .friend-list-name { font-size: 15px; }
    }

    .friends-content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 30px;
        border-bottom: 1px solid var(--glass-border);
        flex-shrink: 0;
        /* --- THÊM 4 DÒNG NÀY --- */
        width: 100%;
}

.friends-list-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px 30px;
    width: 100%;
}

#toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--glass-3);
  color: var(--text-primary);
  padding: 16px 24px;
  border-radius: 12px;
  z-index: 10000;
  backdrop-filter: blur(18px);
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow);
  display: none;
  min-width: 250px;
  max-width: 400px;
  overflow: hidden;
}

#toast::after {
  content: '';
  position: absolute;
  bottom: -20px;
  right: -20px;
  width: 100px;
  height: 100px;
  background-repeat: no-repeat;
  background-position: center;
  background-size: contain;
  opacity: 0.3;
  pointer-events: none;
  transform: rotate(15deg); /* <<< Dòng này nè */
}

#toast.toast-success {
  background: rgba(30, 41, 59, 0.85);
  border-color: #22c55e;
  color: #e5e7eb;
  backdrop-filter: blur(10px);
}
#toast.toast-success::after {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cg opacity='0.7'%3E%3Ccircle cx='65' cy='65' r='25' fill='%2322c55e'/%3E%3Cpath d='M55 65 l5 5 l10 -10' stroke='%23ffffff' stroke-width='5' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='85' cy='85' r='8' fill='%2322c55e' opacity='0.7'/%3E%3Ccircle cx='90' cy='50' r='5' fill='%2322c55e' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E");
}

#toast.toast-error {
  background: rgba(30, 41, 59, 0.85);
  border-color: #ef4444;
  color: #e5e7eb;
  backdrop-filter: blur(10px);
}
#toast.toast-error::after {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cg opacity='0.7'%3E%3Ccircle cx='65' cy='65' r='25' fill='%23ef4444'/%3E%3Cpath d='M57 57 l16 16 M73 57 l-16 16' stroke='%23ffffff' stroke-width='5' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='85' cy='85' r='8' fill='%23ef4444' opacity='0.7'/%3E%3Ccircle cx='90' cy='50' r='5' fill='%23ef4444' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E");
}

#toast.toast-info {
  background: var(--glass-3);
  border-color: #60a5fa;
  color: var(--text-primary);
  backdrop-filter: blur(18px);
}

#toast.toast-info::after {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cg opacity='0.7'%3E%3Ccircle cx='65' cy='65' r='25' fill='%2360a5fa'/%3E%3Cline x1='65' y1='60' x2='65' y2='80' stroke='%23ffffff' stroke-width='5' stroke-linecap='round'/%3E%3Ccircle cx='65' cy='50' r='3' fill='%23ffffff'/%3E%3Ccircle cx='85' cy='85' r='8' fill='%2360a5fa' opacity='0.7'/%3E%3Ccircle cx='90' cy='50' r='5' fill='%2360a5fa' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E");
}

.light #toast.toast-success {
  background: var(--glass-3);
  border-color: #22c55e;
  color: var(--text-primary);
}
.light #toast.toast-success::after {
   background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cg opacity='0.2'%3E%3Ccircle cx='65' cy='65' r='25' fill='%2322c55e'/%3E%3Cpath d='M55 65 l5 5 l10 -10' stroke='%23ffffff' stroke-width='5' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='85' cy='85' r='8' fill='%2322c55e' opacity='0.7'/%3E%3Ccircle cx='90' cy='50' r='5' fill='%2322c55e' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E");
}

.light #toast.toast-error {
  background: var(--glass-3);
  border-color: #ef4444;
  color: var(--text-primary);
}
.light #toast.toast-error::after {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cg opacity='0.2'%3E%3Ccircle cx='65' cy='65' r='25' fill='%23ef4444'/%3E%3Cpath d='M57 57 l16 16 M73 57 l-16 16' stroke='%23ffffff' stroke-width='5' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='85' cy='85' r='8' fill='%23ef4444' opacity='0.7'/%3E%3Ccircle cx='90' cy='50' r='5' fill='%23ef4444' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E");
}

.light #toast.toast-info {
  background: var(--glass-3);
  border-color: var(--glass-border);
  color: var(--text-primary);
}

#toast-message {
  margin: 0;
  font-weight: 500;
  font-size: 15px;
  line-height: 1.4;
  text-align: center;
}

#toast-close-btn { 
    display: none; 
}

#chat-window-placeholder {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  color: var(--text-secondary);
  padding: 20px;
  display: none;
}
#chat-window-placeholder .placeholder-icon {
  width: 80px;
  height: 80px;
  color: var(--glass-border);
  stroke-width: 1.5px;
  margin-bottom: 20px;
}
#chat-window-placeholder h2 {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
}
#chat-window-placeholder p {
  font-size: 15px;
  max-width: 300px;
  line-height: 1.5;
}

/* --- CSS LÀM ĐẸP POPUP CHANGELOG --- */

/* Thêm icon cho tiêu đề H2 */
#changelog-modal .modal-content h2::before {
  content: '';
  display: inline-block;
  width: 24px;
  height: 24px;
  margin-right: 8px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23c084fc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'%3E%3C/path%3E%3Cpolyline points='14 2 14 8 20 8'%3E%3C/polyline%3E%3Cline x1='16' y1='13' x2='8' y2='13'%3E%3C/line%3E%3Cline x1='16' y1='17' x2='8' y2='17'%3E%3C/line%3E%3Cpolyline points='10 9 9 9 8 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-size: contain;
  background-repeat: no-repeat;
  opacity: 0.8;
}

/* Sửa lại cái gạch đầu dòng "-" thành dấu tick */
.changelog-desc p::before {
  content: '✓';
  margin-right: 10px;
  color: var(--accent-1);
  font-weight: 700;
  font-size: 1.1em;
}

/* Đổi nút "Đóng" thành nút chính màu xanh */
#close-changelog-modal {
  background: linear-gradient(135deg,var(--accent-1),var(--accent-2));
  color: #fff;
  border: none;
}
#close-changelog-modal:hover {
   filter: brightness(1.15);
   background: linear-gradient(135deg,var(--accent-1),var(--accent-2));
}

#news-banner-image {
  width: 100%;
  height: 280px;
  object-fit: cover;
  border-radius: 20px 20px 0 0;
  border-bottom: 1px solid var(--glass-border);
}
#changelog-modal .modal-content h2 {
   padding-bottom: 10px;
   margin-bottom: 0;
}

.modal-close-x {
  position: absolute;
 top: 20px;
  right: 10px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.3);
  color: #fff;
  border: 1px solid rgba(255, 255, 255, 0.1);
  font-size: 24px;
  font-weight: bold;
  line-height: 30px;
  text-align: center;
  cursor: pointer;
  transition: background-color 0.2s ease;
  z-index: 10;
}
.modal-close-x:hover {
  background: rgba(0, 0, 0, 0.6);
}
.light .modal-close-x {
  background: rgba(255, 255, 255, 0.7);
  color: #000;
  border: 1px solid rgba(0, 0, 0, 0.1);
}
.light .modal-close-x:hover {
  background: rgba(255, 255, 255, 1);
}

/* --- SỬA POPUP TIN TỨC THÀNH DẠNG BOX --- */

/* 1. Biến mỗi bản tin thành 1 cái box */
.changelog-entry {
  background-color: rgba(255, 255, 255, 0.03);
  border-radius: 10px;
  padding: 16px 20px;
  margin-bottom: 12px;
  border: 1px solid var(--glass-border);
  transition: background-color 0.2s ease;
}
.light .changelog-entry {
   background-color: rgba(0, 0, 0, 0.02);
}

/* 2. Sửa lại tiêu đề (Phiên bản 1.0) cho đẹp hơn */
.changelog-meta h3 {
  font-size: 1.1em;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
}

/* 3. Bỏ dấu tick (✓) thay bằng dấu gạch ngang (-) */
.changelog-desc p::before {
  content: '-';
  margin-right: 10px;
  color: var(--text-secondary);
  font-weight: 700;
}

/* 4. Ẩn cái đường kẻ ngang (vì đã có box) */
hr.changelog-divider {
  display: none;
}

/* 5. Sửa lại padding của khu vực cuộn */
#changelog-content {
   padding-right: 10px;
   margin-top: 15px;
}

/* --- CSS CHO TIN TỨC KIỂU BUNG RA (ACCORDION) --- */
.changelog-entry-box {
  background-color: rgba(255, 255, 255, 0.03);
  border-radius: 10px;
  margin-bottom: 12px;
  border: 1px solid var(--glass-border);
  transition: background-color 0.2s ease;
}
.light .changelog-entry-box {
   background-color: rgba(0, 0, 0, 0.02);
}


.changelog-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 15px;
  cursor: pointer;
}
.changelog-header:hover {
  background-color: rgba(255, 255, 255, 0.05);
}
.light .changelog-header:hover {
  background-color: rgba(0, 0, 0, 0.04);
}

.changelog-header-left {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.changelog-header-left h3 {
  font-size: 1.1em;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
}
.changelog-header-left span {
  font-size: 0.9em;
  color: var(--text-secondary);
}

.changelog-chevron {
  color: var(--text-secondary);
  transition: transform 0.2s ease;
}
.changelog-header.open .changelog-chevron {
  transform: rotate(90deg);
}

.changelog-details-content {
  padding: 0px 15px 20px 15px;
  border-top: 1px solid var(--glass-border);
  margin: 0;
  padding-top: 15px;
  display: none;
}
.changelog-details-content p {
  margin-bottom: 8px;
  line-height: 1.6;
  color: var(--text-primary);
  padding-left: 15px;
  position: relative;
}
.changelog-details-content p::before {
  content: '-';
  position: absolute;
  left: 0;
  top: 0;
  color: var(--text-secondary);
  font-weight: 700;
}
.changelog-details-content p:last-child {
  margin-bottom: 0;
}

/* Ẩn cái đường kẻ ngang cũ */
hr.changelog-divider {
  display: none;
}

/* Sửa lại padding của khu vực cuộn */
#changelog-content {
   padding-right: 10px;
   margin-top: 20px;
}

/* Ẩn cái CSS cũ của .changelog-desc */
.changelog-desc p::before {
    content: none;
}
.changelog-entry {
    padding: 0;
    border: none;
    background: none;
}

#page-loader {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-dark); /* Hoặc màu nền phù hợp với theme của cậu */
    z-index: 99999;
    opacity: 1;
    visibility: visible;
    transition: opacity 0.4s ease-out, visibility 0.4s ease-out;
}

.loader-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px; /* Khoảng cách giữa các phần tử */
    width: 90%; /* Chiều rộng tối đa của nội dung loading */
    max-width: 400px; /* Giới hạn chiều rộng để không quá to trên màn hình lớn */
    color: var(--text-secondary);
    text-align: center;
}

.loader-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid var(--glass-border);
    border-top-color: var(--accent-1); /* Màu vòng xoay */
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.loader-text {
    font-size: 1.25em; /* Lớn hơn chút */
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: -5px; /* Giảm khoảng cách với dòng ETA */
}

.loader-eta {
    font-size: 0.9em;
    color: var(--text-secondary);
}

.loader-progress-bar {
    width: 100%; /* Dài bằng chiều rộng của loader-content */
    height: 8px; /* Độ dày của thanh loading */
    background: var(--glass-border); /* Nền của thanh loading */
    border-radius: 5px;
    overflow: hidden;
    margin-top: 10px; /* Khoảng cách từ ETA đến thanh loading */
}

.loader-progress {
    width: 0%; /* Bắt đầu từ 0%, sẽ được JS thay đổi */
    height: 100%;
    background: linear-gradient(90deg, var(--accent-1), var(--accent-2)); /* Màu chạy của thanh loading */
    border-radius: 5px;
    animation: loadingProgress 3s forwards cubic-bezier(0.25, 0.1, 0.25, 1); /* Hiệu ứng chạy 3 giây */
}


.loader-tip {
  font-size: 0.9em;
  line-height: 1.5;
  margin-bottom: 12px;
}

/* Ẩn đi khi body có class "loaded" */
body.loaded #page-loader {
    opacity: 0;
    visibility: hidden;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes loadingProgress {
    0% { width: 0%; }
    100% { width: 100%; }
}

/* --- CSS CHO MÀN HÌNH LOADING MỚI --- */
#page-loader {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: var(--bg-dark);
  z-index: 99999;
  opacity: 1;
  visibility: visible;
  transition: opacity 0.4s ease-out 0.2s, visibility 0.4s ease-out 0.2s;
  padding: 30px;
}
.loader-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
  width: 90%;
  max-width: 400px;
  color: var(--text-secondary);
  text-align: center;
  margin: auto 0;
}
.loader-logo {
  width: 70px;
  height: 70px;
  background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
  border-radius: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 20px;
  transform: rotate(-10deg);
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
.loader-text {
  font-size: 1.25em;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: -5px;
}
.loader-eta {
  font-size: 0.9em;
  color: var(--text-secondary);
}
.loader-progress-bar {
  width: 100%;
  height: 8px;
  background: var(--glass-border);
  border-radius: 5px;
  overflow: hidden;
  margin-top: 10px;
}
.loader-progress {
  width: 0%;
  height: 100%;
  background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
  border-radius: 5px;
  animation: loadingProgress 3s forwards cubic-bezier(0.25, 0.1, 0.25, 1);
}
.loader-footer {
  position: absolute;
  bottom: 30px;
  left: 0;
  right: 0;
  width: 100%;
  max-width: 600px;
  text-align: center;
  color: var(--text-secondary);
  padding: 0 30px;
  margin: 0 auto;
}
.loader-tip {
  font-size: 0.9em;
  line-height: 1.5;
  margin-bottom: 15px;
}
.loader-info {
    position: fixed;
    bottom: 10px;
    left: 10px;
    z-index: 1001;
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 8px;
    /* padding: 6px 12px; */ /* Padding cũ */
    padding: 4px 10px;        /* <<< GIẢM PADDING */
    font-size: 11px;
    color: var(--text-secondary);
    line-height: 1.4; /* Giảm line-height chút */
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    /* max-width: 300px; */ /* Width cũ */
    max-width: 400px;         /* <<< TĂNG MAX-WIDTH LÊN */
}
.loader-info span {
  white-space: nowrap;
}
body.loaded #page-loader {
  opacity: 0;
  visibility: hidden;
}
@keyframes loadingProgress {
  0% { width: 0%; }
  100% { width: 100%; }
}

/* 1. NỘI DUNG Ở GIỮA (Không đổi) */
.loading-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    width: 90%;
    max-width: 400px;
}

.logo {
    width: 60px;
    height: 60px;
    background-color: #0078ff;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    font-weight: bold;
    margin: 0 auto 20px;
}

.loading-container h1 {
    font-size: 22px;
    margin-bottom: 8px;
}

.loading-container p {
    font-size: 14px;
    color: #a0a0a0;
}

/* 4. THANH LOADING MỚI (Phần cậu cần) */
.progress-bar-bottom-wrapper {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 6px; /* Cậu có thể chỉnh độ dày ở đây */
    background-color: #3a3f5a; /* Màu nền của thanh */
    z-index: 100;
}

.progress-bar-bottom {
    width: 60%; /* % hoàn thành */
    height: 100%;
    background-color: #0078ff;
    border-radius: 0 3px 3px 0; /* Bo góc phải cho đẹp */
}

/* 3. USER AGENT (ĐÃ SỬA) */
.user-agent-footer {
    position: absolute;
    bottom: 6px; /* Đẩy lên trên thanh loading (6px = chiều cao thanh loading) */
    left: 0;
    width: 100%;
    padding: 6px 10px;
    background-color: rgba(0, 0, 0, 0.1);
    font-size: 11px;
    color: #777;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    box-sizing: border-box;
    z-index: 99;
}

/* 2. MẸO (ĐÃ SỬA) */
.tip-footer {
    position: absolute;
    bottom: 35px; /* Đẩy lên trên cả user agent */
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 800px;
    text-align: center;
    font-size: 14px;
    color: #a0a0a0;
    z-index: 99;
}
/* --- KẾT THÚC CSS LOADING --- */
/* --- KẾT THÚC CSS LOADING MỚI --- */

</style>
</head>
<body>

<nav class="app-nav">
    <button class="nav-button active" data-view="chat" title="Trò chuyện">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
    </button>
    <button class="nav-button" data-view="friends" title="Bạn bè">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    </button>
    <button class="nav-button" data-view="wall" title="Tường nhà">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
    </button>
    <div class="nav-spacer"></div>
    <img id="nav-avatar" class="nav-avatar" src="https://placehold.co/48x48" alt="avatar" title="Cài đặt & Hồ sơ">
  <div class="settings-menu" id="nav-settings-menu">
    <div class="settings-row clickable" id="go-to-profile">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span>Cá nhân</span>
    </div>
    <div class="settings-row clickable" id="show-changelog-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
        <span>Tin Tức</span>
    </div>
    <div class="settings-row clickable" id="open-report-bug-modal">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13a6 6 0 0 0-6 6h-4a6 6 0 0 0-6-6v-4a6 6 0 0 0 6-6h4a6 6 0 0 0 6 6v4Z"/><path d="m14 4 3 3"/><path d="m10 20 3-3"/><line x1="12" y1="12" x2="12" y2="12.01"/></svg>
        <span>Báo lỗi</span>
    </div>
    <div class="settings-row clickable" id="open-about-modal">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        <span>Thông tin tác giả</span>
    </div>
    <div class="settings-row clickable" id="go-to-settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        <span>Cài đặt</span>
    </div>
    <div class="settings-row clickable" id="go-login">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        <span>Đăng xuất</span>
    </div>
</div>
</nav>

<div id="app-info">
    <span>Ver: </span><span id="app-version-display">?.?</span>
    <span>&nbsp;Uid: </span><span id="user-uid-display" title="Click để sao chép UID">Đang tải...</span>
    <span>&nbsp;</span><span id="utc-time-display">--:--:-- UTC+0</span>
</div>

<div class="app-layout">
    <main class="app-main">

        <div class="app-view chat-view active" data-view="chat">
            <div id="toast" style="display:none;"><div id="toast-message"></div></div>
            <div id="message-context-menu" style="display:none;"></div>
      <div id="image-lightbox" class="lightbox-overlay">
    <span class="lightbox-close-btn" title="Đóng">&times;</span>
    <button class="lightbox-nav prev" id="lightbox-prev-btn" title="Ảnh trước">‹</button>
    <img class="lightbox-content" id="lightbox-img" src="" alt="Xem ảnh lớn">
    <button class="lightbox-nav next" id="lightbox-next-btn" title="Ảnh tiếp theo">›</button>

    <a id="lightbox-download-btn" class="lightbox-action-btn download-btn" href="#" download target="_blank" title="Tải ảnh">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
    </a>

    <div id="lightbox-thumbnails-container">
        <div id="lightbox-thumbnails-list">
            </div>
    </div>
</div>
            <div id="friend-request-modal" class="modal-overlay"><div class="modal-content"><h2>Lời Mời Kết Bạn</h2><div id="friend-request-list"></div><button id="close-friend-req-modal" class="cancel-btn">Đóng</button></div></div>
            <div id="create-group-modal" class="modal-overlay"><div class="modal-content"><h2>Tạo nhóm mới</h2><input type="text" id="group-name-input" placeholder="Nhập tên nhóm..."><h4>Mời bạn bè</h4><div id="group-members-checklist"></div><div class="modal-actions"><button id="close-group-modal-btn" class="btn-ghost">Hủy</button><button id="confirm-create-group-btn" class="btn">Tạo Nhóm</button></div></div></div>
            <div id="reactions-modal" class="modal-overlay"><div class="modal-content"><h2>Lượt bày tỏ cảm xúc</h2><div id="reactions-list"></div><button id="close-reactions-modal" class="btn-ghost" style="margin-top: 15px;">Đóng</button></div></div>
            <div id="edit-profile-modal" class="modal-overlay"><div class="modal-content"><h2>Chỉnh sửa hồ sơ</h2><label class="form-label" for="profile-display-name">Tên hiển thị</label><input type="text" id="profile-display-name" placeholder="Tên của bạn..."><label class="form-label" for="profile-bio">Giới thiệu (Bio)</label><textarea id="profile-bio" rows="3" placeholder="Viết gì đó về bạn..."></textarea><label class="form-label" for="profile-avatar-url">URL Ảnh đại diện</label><input type="text" id="profile-avatar-url" placeholder="https://example.com/avatar.png"><div class="modal-actions"><button id="cancel-profile-edit-btn" class="btn-ghost">Hủy</button><button id="save-profile-edit-btn" class="btn">Lưu thay đổi</button></div></div></div>
            <div id="custom-confirm-modal" class="modal-overlay"><div class="modal-content" style="width: 400px; text-align: center;"><h2 id="confirm-title">Xác nhận hành động</h2><p id="confirm-message" style="margin: 15px 0; color: var(--text-2); font-size: 15px;"></p><div class="modal-actions" style="justify-content: center;"><button id="confirm-cancel-btn" class="btn-ghost">Hủy</button><button id="confirm-ok-btn" class="btn danger-btn">OK</button></div></div></div>
            <div id="report-user-modal" class="modal-overlay"><div class="modal-content"><h2>Báo cáo người dùng</h2><p id="reporting-user-name" style="color: var(--text-2); margin-bottom: 20px;"></p><div id="report-form" class="form report-form"><label class="form-label">Lý do báo cáo:</label><label class="report-reason-row"><input type="radio" name="reportReason" value="spam" checked><span class="custom-radio"></span>Gửi tin nhắn rác (Spam)</label><label class="report-reason-row"><input type="radio" name="reportReason" value="harassment"><span class="custom-radio"></span>Quấy rối, bắt nạt</label><label class="report-reason-row"><input type="radio" name="reportReason" value="inappropriate"><span class="custom-radio"></span>Nội dung không phù hợp</label><label class="report-reason-row"><input type="radio" name="reportReason" value="impersonation"><span class="custom-radio"></span>Mạo danh</label><label for="report-details" class="form-label" style="margin-top: 15px;">Mô tả thêm (nếu có):</label><textarea id="report-details" rows="3" placeholder="Cung cấp thêm chi tiết về hành vi..."></textarea><button id="attach-evidence-btn" class="btn-ghost" style="margin-top: 15px;">➕ Đính kèm bằng chứng (tin nhắn)</button><div id="evidence-preview" style="font-size: 13px; color: var(--text-2); margin-top: 8px; display: none;"></div></div><div class="modal-actions"><button id="cancel-report-btn" class="btn-ghost">Hủy</button><button id="submit-report-btn" class="btn danger-btn">Gửi báo cáo</button></div></div></div>
            <div id="force-update-profile-modal" class="modal-overlay" style="z-index: 9998;"><div class="modal-content"><h2 style="text-align: center;">Hoàn tất hồ sơ của bạn</h2><p style="color: var(--text-2); text-align: center; margin-bottom: 20px; font-size: 15px;">Vui lòng cập nhật thông tin để bắt đầu trò chuyện.</p><label class="form-label" for="force-name-input">Tên hiển thị (Bắt buộc)</label><input type="text" id="force-name-input" placeholder="Tên của bạn..."><label class="form-label" for="force-avatar-input">URL Ảnh đại diện (Bắt buộc)</label><input type="text" id="force-avatar-input" placeholder="https://example.com/avatar.png"><label class="form-label" for="force-bio-input">Giới thiệu (Bio)</label><textarea id="force-bio-input" rows="2" placeholder="Viết gì đó về bạn..."></textarea><label class="form-label" for="force-cover-input">URL Ảnh bìa</label><input type="text" id="force-cover-input" placeholder="https://example.com/cover.png"><div class="modal-actions" style="margin-top: 25px;"><button id="force-save-btn" class="btn">Cập nhật và Bắt đầu</button></div></div></div>
            <div id="edit-group-modal" class="modal-overlay"><div class="modal-content"><h2>Cập nhật thông tin nhóm</h2><div style="display: flex; align-items: flex-start; gap: 20px; margin-bottom: 20px;"><div style="flex-shrink: 0; text-align: center;"><label class="form-label" style="margin-bottom: 10px;">Ảnh đại diện</label><img id="edit-group-avatar-preview" src="https://placehold.co/95x95" style="width: 95px; height: 95px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border); cursor: pointer; transition: opacity 0.2s;" title="Nhấn để tải ảnh lên"><div id="edit-group-avatar-loading" style="font-size: 13px; color: var(--accent-1); display: none; margin-top: 5px;">Đang tải...</div></div><div style="flex-grow: 1; min-width: 0;"><label class="form-label" for="edit-group-name-input">Tên nhóm</label><input type="text" id="edit-group-name-input" placeholder="Tên nhóm mới..."><label class="form-label" for="edit-group-avatar-input" style="margin-top: 15px;">Hoặc dán URL Avatar</label><input type="text" id="edit-group-avatar-input" placeholder="https://.../avatar.png"></div></div><div class="modal-actions"><button id="cancel-edit-group-btn" class="btn-ghost">Hủy</button><button id="save-edit-group-btn" class="btn">Lưu thay đổi</button></div></div></div>
            <div id="add-member-modal" class="modal-overlay"><div class="modal-content"><h2>Thêm thành viên vào nhóm</h2><p id="add-member-group-name" style="color: var(--text-2); margin-bottom: 20px; text-align: center;"></p><label class="form-label">Chọn bạn bè để thêm:</label><div id="add-member-friend-list" style="max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin-bottom: 20px; background: var(--input);"></div><div class="modal-actions"><button id="cancel-add-member-btn" class="btn-ghost">Hủy</button><button id="confirm-add-member-btn" class="btn">Thêm vào nhóm</button></div></div></div>
            <div id="changelog-modal" class="modal-overlay" style="z-index: 9999;">
              <div class="modal-content" style="width: min(90vw, 650px); text-align: left; padding: 0; position: relative;">
                <button class="modal-close-x" id="close-changelog-x-btn">&times;</button>
                <img id="news-banner-image" src="Res/panel.png  " alt="Banner Tin Tức">
                <div style="padding: 25px 35px 30px 35px;">
                  <h2>Tin Tức</h2>
                  <div id="changelog-content" style="max-height: 50vh; overflow-y: auto; padding-right: 15px; margin-bottom: 25px; margin-top: 15px;"></div>
                </div>
              </div>
            </div>
            <div id="report-bug-modal" class="modal-overlay"><div class="modal-content"><h2>Báo lỗi</h2><p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 20px;">Cảm ơn bạn đã giúp cải thiện Qola! Vui lòng mô tả lỗi bạn gặp phải.</p><div class="form"><label class="form-label" for="bug-description">Mô tả lỗi:</label><textarea id="bug-description" rows="4" placeholder="..."></textarea><label class="form-label" for="bug-steps">Các bước tái hiện ra lỗi : </label><textarea id="bug-steps" rows="3" placeholder="..."></textarea></div><div class="modal-actions"><button id="cancel-report-bug-btn" class="btn-ghost">Hủy</button><button id="submit-bug-report-btn" class="btn">Gửi báo cáo</button></div></div></div>
            <div id="about-modal" class="modal-overlay"><div class="modal-content" style="text-align: center;"><h2>Thông tin tác giả</h2><img src="https://i.ibb.co/xtQ6WDy8/z7088478191410-b16d303436bd2300dd9a3700a9db92ea-1.jpg" alt="Tác giả" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 10px auto; border: 2px solid var(--glass-border);"><p style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">Được phát triển bởi <span style="color: var(--accent-1);">QiQi</span></p><p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">Ver.1.0 </p><p style="font-size: 14px; line-height: 1.6;">Qola - Nới Nhắn Gửi Yêu Thương. <br>Liên hệ: <a href="mailto:betrumbaodeptraivippro@gmail.com" style="color: var(--accent-1);">betrumbaodeptraivippro@gmail.com</a></p><div class="modal-actions" style="justify-content: center;"><button id="close-about-modal-btn" class="btn-ghost">Đóng</button></div></div></div>
            <div id="join-group-modal" class="modal-overlay"><div class="modal-content" style="text-align: center;"><div class="chat-info-section" style="margin-bottom: 15px;"><img id="join-group-avatar" class="chat-info-avatar" src="https://placehold.co/80x80" alt="avatar nhóm"><h3 id="join-group-name" class="chat-info-name" style="margin-top: 10px; margin-bottom: 5px; font-size: 20px;">Tên nhóm</h3><p id="join-group-member-count" style="color: var(--text-2); font-size: 14px; margin: 0;">... thành viên</p></div><p style="margin: 15px 0; color: var(--text-2);">Bạn có muốn tham gia nhóm này không?</p><div class="modal-actions" style="justify-content: center;"><button id="cancel-join-group-btn" class="btn-ghost">Hủy</button><button id="confirm-join-group-btn" class="btn">Tham gia ngay</button></div></div></div>
            <div id="add-friend-modal" class="modal-overlay"><div class="modal-content"><h2>Thêm bạn bè</h2><label for="add-friend-email-input" class="form-label">Nhập email của người bạn muốn kết bạn:</label><input type="email" id="add-friend-email-input" placeholder="nhapemail@qola.com"><div class="modal-actions"><button id="cancel-add-friend-btn" class="btn-ghost">Hủy</button><button id="confirm-add-friend-btn" class="btn">Tìm kiếm</button></div></div></div>
            <input type="file" id="group-avatar-upload-input" accept="image/*" style="display:none;">

            <div class="container" id="app" style="display:none;">
                <div id="sidebar">
                    <div class="sidebar-head">
                        <div class="sidebar-title">Qola</div>
                        <button id="add-btn" title="Tùy chọn mới">+</button>
                        <div class="settings-menu" id="add-menu">
                            <div class="settings-row clickable" id="create-group-from-menu">Tạo nhóm mới</div>
                            <div class="settings-row clickable" id="add-friend-from-menu">Thêm bạn bè</div>
                        </div>
                    </div>
                    <div id="sidebar-search-container">
                        <input id="global-search" placeholder="Tìm mọi thứ: người dùng, bạn bè, nhóm..." />
                        <div id="search-dropdown"></div>
                    </div>
                    <div id="sidebar-loader">
                        <div class="list-title">Bạn bè</div>
                        <div class="skeleton-item"><div class="skeleton skeleton-circle"></div><div class="skeleton skeleton-line"></div></div>
                        <div class="skeleton-item"><div class="skeleton skeleton-circle"></div><div class="skeleton skeleton-line"></div></div>
                        <div class="list-title">Nhóm</div>
                        <div class="skeleton-item"><div class="skeleton skeleton-circle"></div><div class="skeleton skeleton-line"></div></div>
                    </div>
                    <div id="sidebar-lists">
                        <ul id="chat-list"></ul>
                    </div>
                </div>

                <div id="chat-window">
                    <div id="chat-header">
                        <div id="chat-header-left">
                            <img id="current-chat-avatar" src="https://placehold.co/40x40" alt="avatar">
                            <div id="chat-header-info">
                                <div id="current-chat-friend-name">Chọn cuộc trò chuyện</div>
                                <div id="peer-info-extra" style="display: none;">
                                    <span class="stranger-label">Người lạ</span>
                                    <button id="add-friend-header-btn" class="add-friend-btn">Kết bạn</button>
                                </div>
                                <div id="chat-header-last-seen" class="last-seen-status"></div>
                            </div>
                        </div>
                        <div id="chat-header-buttons">
                            <button id="open-info-btn" title="Thông tin">☰</button>
                            <button id="group-info-btn" title="Thông tin nhóm">☰</button>
                        </div>
                    </div>

                    <div id="messages-container"></div>
                    <div id="chat-window-placeholder" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="placeholder-icon"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        <h2>Qola Messenger</h2>
                        <p>Chọn một người bạn hoặc nhóm từ danh sách bên trái để bắt đầu nhắn tin.</p>
                    </div>
                    <div id="typing-indicator"></div>

                    <div id="reply-preview-container" style="display: none;"><div id="reply-preview-sender"></div><div id="reply-preview-text"></div><button id="cancel-reply-btn">✖</button></div>
                    <div id="edit-preview-container" style="display: none;"><div id="edit-preview-title">Đang chỉnh sửa</div><div id="edit-preview-text"></div><button id="cancel-edit-btn">✖</button></div>
                    <div id="image-preview-container" style="display: none;"><img id="image-preview" /><button id="cancel-preview-btn">✖</button></div>
                    <div id="selection-bar" style="display: none; padding: 10px; background: var(--glass-3); border-top: 1px solid var(--border); text-align: right;"><span id="selection-count" style="margin-right: 15px; color: var(--text-2);">Đã chọn: 0</span><button id="cancel-selection-btn" class="btn-ghost">Hủy</button><button id="confirm-selection-btn" class="btn">Xong</button></div>
                    <div id="mention-suggestions" class="suggestion-popup"></div>

                    <div class="chat-input">
                        <label for="image-input" class="image-upload-label"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg></label>
                        <input id="image-input" type="file" accept="image/*" style="display:none" />
                        <input id="message-input" placeholder="Nhập tin nhắn..."/>
                        <button id="send-btn">
                            <svg class="send-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                            <svg class="spinner-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>
                        </button>
                    </div>
                    <div id="inactive-chat-indicator" style="display: none;">Không thể gửi tin nhắn cho người này.</div>
                </div>

                 <div id="chat-info-panel">
                      <div id="chat-info-header"><h3>Thông tin</h3><button id="close-info-btn">✖</button></div>
                      <div class="chat-info-body">
                          <div id="friend-info-content" style="display:none;"><div class="chat-info-section"><img id="chat-friend-avatar-info" class="chat-info-avatar" src="https://placehold.co/80x80"><div id="friend-name-display-area" class="chat-info-name" style="display: flex; align-items: center; justify-content: center; gap: 8px;"><h4 id="chat-friend-name-info" style="margin: 0; font-size: 18px; font-weight: 600;">Chưa chọn</h4><button id="edit-nickname-btn" class="btn-ghost" title="Đặt biệt danh" style="padding: 4px 8px; font-size: 14px; margin-top: 0; width: auto; flex-shrink: 0;">✏️</button></div><div id="friend-name-edit-area" style="display: none; margin-top: 10px; width: 100%;"><label class="form-label" for="nickname-input" style="text-align: left; margin: 0 0 6px 0; color: var(--text-2);">Đặt biệt danh</label><input type="text" id="nickname-input" placeholder="Nhập biệt danh..." style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input); color: var(--text);"><div style="display: flex; gap: 8px; margin-top: 8px;"><button id="cancel-nickname-btn" class="btn-ghost" style="width: 100%; margin-top: 0; padding: 8px;">Hủy</button><button id="save-nickname-btn" class="btn" style="width: 100%; margin-top: 0; padding: 8px;">Lưu</button></div></div></div><h5>Ảnh đã gửi</h5><div id="sent-images-grid" class="sent-images-grid"></div><div class="chat-actions"><button id="toggle-mute-btn-friend" title="Tắt thông báo" style="border:1px solid var(--border); background:var(--glass-border); color:var(--text); border-radius:10px; padding: 11px; cursor:pointer; display: block; width: 100%; margin-bottom: 10px;"><svg id="mute-icon-on-friend" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="display: inline-block; vertical-align: middle; margin-right: 5px;"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h6.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/></svg><svg id="mute-icon-off-friend" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="display: none; vertical-align: middle; margin-right: 5px;"><path d="M5.161 14.016A2 2 0 0 0 8 16a2 2 0 0 0 2.828-1.984l-5.667-5.667zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h1.967l1.08-1.08A5.002 5.002 0 0 1 8 1.917zM14.22 12c.223.447.481.801.78 1H8.914l-1-1-.31-.31L1.053 2.379a.5.5 0 1 1 .708-.708L14.707 14.707a.5.5 0 0 1-.708.708l-1.61-1.61zM13 6c0-.88.32-4.2 1.22-6l-1.08 1.08A5.002 5.002 0 0 0 8 1.018a5.002 5.002 0 0 0-4.141 2.997l-1.08-1.08C3.68 3.8 4 5.12 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258H13z"/></svg><span id="mute-btn-text-friend">Tắt thông báo</span></button><button id="block-user-btn">Chặn người này</button><button id="unblock-user-btn">Bỏ chặn người này</button><button id="remove-friend-btn">Xóa bạn bè</button><button id="report-user-btn" style="background: #a16207;">Báo cáo người này</button></div></div>
                          <div id="group-info-content" style="display:none;"><div class="chat-info-section"><img id="group-avatar" class="chat-info-avatar editable-group-info" src="https://placehold.co/80x80/EFEFEF/333333?text=G" alt="avatar nhóm"><h4 id="group-name-display" class="chat-info-name editable-group-info">Tên nhóm</h4></div><h5>Thành viên</h5><ul id="group-members-list"></ul><button id="add-group-member-btn" class="btn primary-btn" style="width: auto; padding: 6px 12px; font-size: 13px; margin: 10px 0 15px 0; display: none;">➕ Thêm thành viên</button><h5>Ảnh đã gửi</h5><div id="group-sent-images-grid" class="sent-images-grid"></div><div class="chat-actions"><button id="toggle-mute-btn-group" title="Tắt thông báo" style="border:1px solid var(--border); background:var(--glass-border); color:var(--text); border-radius:10px; padding: 11px; cursor:pointer; display: block; width: 100%; margin-bottom: 10px;"><svg id="mute-icon-on-group" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="display: inline-block; vertical-align: middle; margin-right: 5px;"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h6.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/></svg><svg id="mute-icon-off-group" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="display: none; vertical-align: middle; margin-right: 5px;"><path d="M5.161 14.016A2 2 0 0 0 8 16a2 2 0 0 0 2.828-1.984l-5.667-5.667zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h1.967l1.08-1.08A5.002 5.002 0 0 1 8 1.917zM14.22 12c.223.447.481.801.78 1H8.914l-1-1-.31-.31L1.053 2.379a.5.5 0 1 1 .708-.708L14.707 14.707a.5.5 0 0 1-.708.708l-1.61-1.61zM13 6c0-.88.32-4.2 1.22-6l-1.08 1.08A5.002 5.002 0 0 0 8 1.018a5.002 5.002 0 0 0-4.141 2.997l-1.08-1.08C3.68 3.8 4 5.12 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258H13z"/></svg><span id="mute-btn-text-group">Tắt thông báo</span></button><button id="disband-group-btn" class="danger-btn" style="display: none;">Giải tán nhóm</button><button id="leave-group-btn">Rời nhóm</button></div></div>
                      </div>
                 </div>
            </div>
        </div>

        <div class="app-view friends-view" data-view="friends">
    <div class="friends-layout-container">

        <nav class="friends-nav-sidebar">
            <div class="friends-nav-header">
                <h2>Bạn bè</h2>
            <ul class="friends-nav-list">
                <li class="friends-nav-item active" data-friends-page="list">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    <span>Danh sách bạn bè</span>
                </li>
                <li class="friends-nav-item" data-friends-page="groups">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect x="7" y="7" width="10" height="10" rx="1"/><path d="M12 11v6"/><path d="M9 14h6"/></svg>
                    <span>Danh sách nhóm</span>
                </li>
                <li class="friends-nav-item" data-friends-page="requests">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
                    <span>Lời mời kết bạn</span>
                    <span id="friend-request-count-badge" class="nav-badge" style="display: none;">0</span>
                </li>
            </ul>
        </nav>

        <div class="friends-content-area">
            <div class="friends-content-page active" id="friends-page-list">
                <div class="friends-content-header">
                    <h2 id="friends-count-title">Bạn bè (0)</h2>
                    <div class="friends-content-filters">
                        <input type="text" id="friends-list-search" class="friends-list-search-input" placeholder="Tìm bạn...">

                    </div>
                </div>
                <div class="friends-list-container" id="friends-list-alphabetical">
                    <p class="friends-list-placeholder">Đang tải danh sách bạn bè...</p>
                </div>
            </div>

            <div class="friends-content-page" id="friends-page-groups" style="display: none;">
                <div class="friends-content-header">
                    <h2>Danh sách nhóm và cộng đồng</h2>
                    </div>
                <div class="friends-list-container" id="friends-groups-list">
                     <p class="friends-list-placeholder">Tính năng đang phát triển.</p>
                </div>
            </div>

            <div class="friends-content-page" id="friends-page-requests" style="display: none;">
                 <div class="friends-content-header">
                    <h2>Lời mời kết bạn</h2>
                </div>
                <div class="friends-list-container" id="friends-requests-list-page">
                     <p class="friends-list-placeholder">Đang tải lời mời...</p>
                </div>
            </div>
        </div> </div> </div>

        <div class="app-view wall-view" data-view="wall">
            <div id="wall-loader"><div style="border: 4px solid var(--glass); border-top: 4px solid var(--accent-1); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div></div>
            <iframe id="wall-iframe" src="about:blank" frameborder="0"></iframe>
        </div>

    </main>
</div>

<div id="page-loader">
        <div class="loader-content">
            <div class="loader-logo">Q</div>
            <p class="loader-text">Đang tải dữ liệu...</p>
            <div class="loader-progress-bar">
                <div class="loader-progress"></div>
            </div>
        </div>
        <div class="loader-footer">
            <p class="loader-tip">💡 Mẹo: Đang tải mẹo...</p>
            <div class="loader-info">
                <span id="loader-version">Ver: ...</span>
                <span id="loader-open-id">Open ID: ...</span>
                <span id="loader-time">--:--:-- UTC+0</span>
            </div>
        </div>
    </div>
</body>
<script type="module">

// --- LOGIC CHO MÀN HÌNH LOADING (NÂNG CẤP) ---

// --- LOGIC CHO MÀN HÌNH LOADING (NÂNG CẤP) ---
const loadingTips = [
    "Mẹo: Bạn có thể nhấn chuột phải vào tin nhắn để trả lời, thu hồi hoặc thả cảm xúc!",
    "Mẹo: Nhấn vào UID ở góc dưới bên trái để sao chép ID của bạn.",
    "Mẹo: Bạn có thể đổi tên bạn bè bằng cách nhấn vào nút 'Thông tin' (☰) trong chat.",
    "Mẹo: Sử dụng @ để tag bạn bè trong nhóm chat.",
    "Mẹo: Tải ảnh lên bằng cách dán (Paste) ảnh trực tiếp vào ô chat."
];
const MIN_LOADING_TIME = 3000;
const startTime = Date.now();

function showRandomTip() {
    const tipElement = document.querySelector("#page-loader .loader-tip");
    if (tipElement) {
        const randomIndex = Math.floor(Math.random() * loadingTips.length);
        tipElement.textContent = `💡 ${loadingTips[randomIndex]}`;
    }
}
function updateLoaderTime() {
    const timeElement = document.getElementById('loader-time');
    if (!timeElement) return;
    const now = new Date();
    const hours = String(now.getUTCHours()).padStart(2, '0');
    const minutes = String(now.getUTCMinutes()).padStart(2, '0');
    const seconds = String(now.getUTCSeconds()).padStart(2, '0');
    timeElement.textContent = `${hours}:${minutes}:${seconds} UTC+0`;
}
showRandomTip();
updateLoaderTime();
setInterval(updateLoaderTime, 1000);
// --- KẾT THÚC LOGIC TRÊN CÙNG ---

function generateOpenID(uid) {
    if (!uid || uid.length < 5) return "RANDOM_ID_123";
    const uidPart = uid.substring(0, 5);
    let randomPart = '';
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    for (let i = 0; i < 7; i++) {
        randomPart += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    return `${randomPart}${uidPart}`;
}

function hideLoader() {
    const endTime = Date.now();
    const timeElapsed = endTime - startTime;
    const timeRemaining = MIN_LOADING_TIME - timeElapsed;
    if (timeRemaining > 0) {
        setTimeout(() => {
            document.body.classList.add('loaded');
        }, timeRemaining);
    } else {
        document.body.classList.add('loaded');
    }
}

// --- KẾT THÚC LOGIC LOADING ---
// --- PHẦN 1: KHỞI TẠO FIREBASE & BIẾN TOÀN CỤC ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, getDocs, setDoc, updateDoc, addDoc,
  collection, query, where, onSnapshot, serverTimestamp, limit, arrayUnion, arrayRemove, deleteField, deleteDoc
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
import {
  getDatabase, ref, onValue, onChildAdded, onChildChanged, push, update as rtdbUpdate,
  set, onDisconnect, serverTimestamp as dbServerTimestamp, off, remove,
  query as rtdbQuery, orderByChild, limitToLast, get
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
// import { getRemoteConfig, fetchAndActivate, getBoolean, getValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-remote-config.js"; // Nếu dùng Remote Config

const firebaseConfig = {
    apiKey: "AIzaSyBuGG9WKYZHb1qbmihpJFjCBsTB_VJ_LvU",
    authDomain: "qola-web.firebaseapp.com",
    databaseURL: "https://qola-web-default-rtdb.firebaseio.com",
    projectId: "qola-web",
    storageBucket: "qola-web.firebasestorage.app",
    messagingSenderId: "477682993077",
    appId: "1:477682993077:web:7dce15eb2c365729173bfc"
};
const IMGBB_API_KEY = "e6c2724ff8344c073410da4876c3d35f"; // API Key ImgBB

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const rtdb = getDatabase(app);
// const remoteConfig = getRemoteConfig(app); // Nếu dùng

// --- DOM Elements ---
const appRoot = document.getElementById('app');
const navButtons = document.querySelectorAll('.app-nav .nav-button');
const appViews = document.querySelectorAll('.app-main .app-view');
const wallIframe = document.getElementById('wall-iframe');
const navAvatar = document.getElementById('nav-avatar');
const navSettingsMenu = document.getElementById('nav-settings-menu');
const sidebar = document.getElementById('sidebar');
const chatListElement = document.getElementById('chat-list');
const addBtn = document.getElementById('add-btn');
const addMenu = document.getElementById('add-menu');
const globalSearch = document.getElementById('global-search');
const searchDropdown = document.getElementById('search-dropdown');
const openFriendReqBtn = document.getElementById('open-friend-req-btn');
const chatWindow = document.getElementById('chat-window');
const chatHeader = document.getElementById('chat-header');
const currentChatAvatar = document.getElementById('current-chat-avatar');
const currentChatFriendName = document.getElementById('current-chat-friend-name');
const peerInfoExtra = document.getElementById('peer-info-extra');
const addFriendHeaderBtn = document.getElementById('add-friend-header-btn');
const messagesContainer = document.getElementById('messages-container');
const typingIndicator = document.getElementById('typing-indicator');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const imageInput = document.getElementById('image-input');
const chatInputContainer = document.querySelector('.chat-input');
const chatInfoPanel = document.getElementById('chat-info-panel');
const openInfoBtn = document.getElementById('open-info-btn');
const groupInfoBtn = document.getElementById('group-info-btn');
const closeInfoBtn = document.getElementById('close-info-btn');
const imagePreviewContainer = document.getElementById('image-preview-container');
const imagePreview = document.getElementById('image-preview');
const cancelPreviewBtn = document.getElementById('cancel-preview-btn');
const replyPreviewContainer = document.getElementById('reply-preview-container');
const replyPreviewSender = document.getElementById('reply-preview-sender');
const replyPreviewText = document.getElementById('reply-preview-text');
const cancelReplyBtn = document.getElementById('cancel-reply-btn');
const editPreviewContainer = document.getElementById('edit-preview-container');
const editPreviewText = document.getElementById('edit-preview-text');
const cancelEditBtn = document.getElementById('cancel-edit-btn');
const inactiveChatIndicator = document.getElementById('inactive-chat-indicator');
const messageContextMenu = document.getElementById('message-context-menu');
const imageLightbox = document.getElementById('image-lightbox');
const lightboxImg = document.getElementById('lightbox-img');
const lightboxCloseBtn = document.querySelector('.lightbox-close-btn');
const toast = document.getElementById('toast');
let currentStatusUnsub = null; // <<< THÊM BIẾN NÀY
const toastMessage = document.getElementById('toast-message');
const toastCloseBtn = document.getElementById('toast-close-btn');
const mentionSuggestions = document.getElementById('mention-suggestions');
const reactionsModal = document.getElementById('reactions-modal');
const reactionsList = document.getElementById('reactions-list');
const closeReactionsModal = document.getElementById('close-reactions-modal');
const friendReqModal = document.getElementById('friend-request-modal');
const friendReqList = document.getElementById('friend-request-list');
const lightboxDownloadBtn = document.getElementById('lightbox-download-btn');
const lightboxThumbnailsContainer = document.getElementById('lightbox-thumbnails-container');
const lightboxThumbnailsList = document.getElementById('lightbox-thumbnails-list');
const closeFriendReqModal = document.getElementById('close-friend-req-modal');
const createGroupModal = document.getElementById('create-group-modal');
const closeGroupModalBtn = document.getElementById('close-group-modal-btn');
const groupNameInput = document.getElementById('group-name-input');
const groupMembersChecklist = document.getElementById('group-members-checklist');
const confirmCreateGroupBtn = document.getElementById('confirm-create-group-btn');
const editProfileModal = document.getElementById('edit-profile-modal');
const profileDisplayName = document.getElementById('profile-display-name');
const profileBio = document.getElementById('profile-bio');
const profileAvatarUrl = document.getElementById('profile-avatar-url');
const saveProfileEditBtn = document.getElementById('save-profile-edit-btn');
const cancelProfileEditBtn = document.getElementById('cancel-profile-edit-btn');
const confirmModal = document.getElementById('custom-confirm-modal');
const confirmMessage = document.getElementById('confirm-message');
const confirmOkBtn = document.getElementById('confirm-ok-btn');
const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
const reportUserModal = document.getElementById('report-user-modal');
const reportingUserName = document.getElementById('reporting-user-name');
const submitReportBtn = document.getElementById('submit-report-btn');
const cancelReportBtn = document.getElementById('cancel-report-btn');
const reportDetails = document.getElementById('report-details');
const attachEvidenceBtn = document.getElementById('attach-evidence-btn');
const evidencePreview = document.getElementById('evidence-preview');
const selectionBar = document.getElementById('selection-bar');
const selectionCount = document.getElementById('selection-count');
const cancelSelectionBtn = document.getElementById('cancel-selection-btn');
const confirmSelectionBtn = document.getElementById('confirm-selection-btn');
const friendInfoContent = document.getElementById('friend-info-content');
const friendAvatarInfo = document.getElementById('chat-friend-avatar-info');
const friendNameInfo = document.getElementById('chat-friend-name-info');
const sentImagesGrid = document.getElementById('sent-images-grid');
const blockUserBtn = document.getElementById('block-user-btn');
const unblockUserBtn = document.getElementById('unblock-user-btn');
const removeFriendBtn = document.getElementById('remove-friend-btn');
const groupInfoContent = document.getElementById('group-info-content');
const groupAvatarInfo = document.getElementById('group-avatar');
const groupNameDisplayInfo = document.getElementById('group-name-display');
const groupMembersList = document.getElementById('group-members-list');
const groupSentImagesGrid = document.getElementById('group-sent-images-grid');
const leaveGroupBtn = document.getElementById('leave-group-btn');
const changelogModal = document.getElementById('changelog-modal');
const changelogContent = document.getElementById('changelog-content');
const closeChangelogModalBtn = document.getElementById('close-changelog-modal');
const showChangelogBtn = document.getElementById('show-changelog-btn');
const announcementOverlay = document.getElementById('announcement-overlay');
let currentChatImages = []; // Mảng chứa {url, key} của ảnh trong chat hiện tại
let currentLightboxIndex = -1; // Index của ảnh đang xem trong currentChatImages
const announcementPopup = document.getElementById('announcement-popup');
const announcementTitle = document.getElementById('announcement-title');
const announcementImage = document.getElementById('announcement-image');
const announcementText = document.getElementById('announcement-text');
const closeAnnouncementBtn = document.getElementById('close-announcement-btn');
const reportBugModal = document.getElementById('report-bug-modal');
const openReportBugModalBtn = document.getElementById('open-report-bug-modal');
const cancelReportBugBtn = document.getElementById('cancel-report-bug-btn');
const submitBugReportBtn = document.getElementById('submit-bug-report-btn');
const bugDescription = document.getElementById('bug-description');
const bugSteps = document.getElementById('bug-steps');
const aboutModal = document.getElementById('about-modal');
const openAboutModalBtn = document.getElementById('open-about-modal');
const closeAboutModalBtn = document.getElementById('close-about-modal-btn');
const editNicknameBtn = document.getElementById('edit-nickname-btn');
const friendNameDisplayArea = document.getElementById('friend-name-display-area');
const friendNameEditArea = document.getElementById('friend-name-edit-area');
const nicknameInput = document.getElementById('nickname-input');
const saveNicknameBtn = document.getElementById('save-nickname-btn');
const cancelNicknameBtn = document.getElementById('cancel-nickname-btn');
const toggleMuteBtnFriend = document.getElementById('toggle-mute-btn-friend');
const muteIconOnFriend = document.getElementById('mute-icon-on-friend');
const muteIconOffFriend = document.getElementById('mute-icon-off-friend');
const muteBtnTextFriend = document.getElementById('mute-btn-text-friend');
const toggleMuteBtnGroup = document.getElementById('toggle-mute-btn-group');
const muteIconOnGroup = document.getElementById('mute-icon-on-group');
const muteIconOffGroup = document.getElementById('mute-icon-off-group');
const muteBtnTextGroup = document.getElementById('mute-btn-text-group');
const editGroupModal = document.getElementById('edit-group-modal');
const editGroupNameInput = document.getElementById('edit-group-name-input');
const editGroupAvatarInput = document.getElementById('edit-group-avatar-input');
const editGroupAvatarPreview = document.getElementById('edit-group-avatar-preview');
const editGroupAvatarLoading = document.getElementById('edit-group-avatar-loading');
const groupAvatarUploadInput = document.getElementById('group-avatar-upload-input');
const saveEditGroupBtn = document.getElementById('save-edit-group-btn');
const cancelEditGroupBtn = document.getElementById('cancel-edit-group-btn');
const addMemberBtn = document.getElementById('add-group-member-btn');
const addMemberModal = document.getElementById('add-member-modal');
const addMemberGroupName = document.getElementById('add-member-group-name');
const addMemberFriendList = document.getElementById('add-member-friend-list');
const confirmAddMemberBtn = document.getElementById('confirm-add-member-btn');
const cancelAddMemberBtn = document.getElementById('cancel-add-member-btn');
const disbandGroupBtn = document.getElementById('disband-group-btn');
const wallLoader = document.getElementById('wall-loader');
const friendsListElement = document.getElementById('friends-tab-list');
const friendsSearchInput = document.getElementById('friends-search-input');

// --- State Variables ---
let currentUser = null;
let currentUserData = {};
let currentFriends = []; // Mảng UID bạn bè
let friends = []; // Mảng object bạn bè đầy đủ thông tin
let currentChatId = null;
let currentChatType = null;
let currentFriendUid = null;
let currentChatPeerData = null; // Data của người đang chat cùng (direct)
let typingTimer;
let typingUnsub = null;
let msgsUnsub = null;
let currentGroupMembers = []; // Thành viên nhóm hiện tại
let selectedImageFile = null;
let replyingTo = null;
let editingMessageKey = null;
let isEditing = false;
let lastMessageDate = null;
let unreadCount = 0;
const originalTitle = document.title;
let userListenerUnsubscribe = null; // Listener cho data user hiện tại
let groupsListenerUnsubscribe = null; // Listener cho danh sách nhóm user tham gia
let allChats = []; // Mảng chứa thông tin tất cả chat (direct + group) để sort
let chatListeners = {}; // Lưu các listener của last message và status
let wallLoaded = false; // Cờ check xem wall đã load lần nào chưa
let reportingUser = null; // Lưu thông tin người bị báo cáo
let selectedEvidence = []; // Lưu tin nhắn bằng chứng khi báo cáo
const userCache = {}; // Cache thông tin user
const APP_VERSION = "1.3"; // << THÊM DÒNG NÀY (Sửa số phiên bản nếu cần)

// === DỮ LIỆU CHANGELOG ===
const changelogData = [
    { 
        version: "1.0", 
        date: "18/10/2025", 
        subtitle: "Bản phát hành chính thức đầu tiên!", 
        details: [
            "Qola đã chính thức ra mắt !", 
            "Bạn có thể chat với bạn bè và tham gia các nhóm chat !"
        ] 
    }
];

// --- PHẦN 2: KHỞI ĐỘNG APP & AUTHENTICATION ---

// Hàm khởi động các thành phần chính của app sau khi xác thực và kiểm tra hồ sơ
function initializeAppLogic(user, userData) {
    if (!appRoot) { console.error("initializeAppLogic: appRoot not found!"); return; }
    appRoot.style.display = 'flex'; // Hiện giao diện chính
    showChatPlaceholder(); // <<< THÊM DÒNG NÀY
    // --- CẬP NHẬT UID/VERSION VÀ GẮN SỰ KIỆN COPY ---
    const uidDisplay = document.getElementById('user-uid-display');
    const versionDisplay = document.getElementById('app-version-display');

    if (uidDisplay) {
        uidDisplay.textContent = user.uid; // Cập nhật UID
        // Gắn sự kiện click để copy
        uidDisplay.onclick = () => {
            navigator.clipboard.writeText(user.uid)
                .then(() => {
                    showToast("Đã sao chép UID!", "success"); // Thông báo thành công
                })
                .catch(err => {
                    console.error('Lỗi sao chép UID:', err);
                    showToast("Lỗi sao chép UID!", "error"); // Thông báo lỗi
                });
        };
    }
    if (versionDisplay) {
        versionDisplay.textContent = APP_VERSION; // Cập nhật Version
    }
    startUpdatingUTCTime(); // Bắt đầu cập nhật giờ (đặt ở đây là đủ)
    // --- KẾT THÚC CẬP NHẬT & GẮN SỰ KIỆN ---

    setupPresence(user.uid, userData.hideOnlineStatus); // Thiết lập trạng thái online/offline
    wireProfile(); // Cập nhật avatar trên thanh nav
    loadAndSortChats(); // Tải danh sách chat ban đầu
    attachEventListeners(); // Gắn các sự kiện click, input...
    attachGlobalSearch(); // Kích hoạt thanh tìm kiếm
    handleUrlChat(); // Xử lý nếu có link chat trực tiếp trong URL
    listenForNotifications_Optimized(); // Bắt đầu lắng nghe thông báo mới
    loadFriendRequests(); // Tải lời mời kết bạn (để hiện chấm đỏ nếu có)

    // Mở khóa các thành phần UI
    if (messageInput) {
        messageInput.disabled = false;
        messageInput.placeholder = "Nhập tin nhắn...";
    }
    if(sidebar) {
        sidebar.style.pointerEvents = 'auto'; // Cho phép click trên sidebar
    }
    // Gọi hàm xử lý popup thông báo nếu có
    // handleAnnouncementPopup(); // Bỏ comment nếu cậu dùng Remote Config
}

function showChatPlaceholder() {
    if (currentChatFriendName) currentChatFriendName.textContent = "Chọn cuộc trò chuyện";
    if (currentChatAvatar) currentChatAvatar.style.display = 'none';
    if (openInfoBtn) openInfoBtn.style.display = 'none';
    if (groupInfoBtn) groupInfoBtn.style.display = 'none';
    if (document.getElementById('chat-header-last-seen')) document.getElementById('chat-header-last-seen').textContent = '';
    
    const placeholder = document.getElementById('chat-window-placeholder');
    const msgContainer = document.getElementById('messages-container');
    const chatInput = document.querySelector('.chat-input');
    const inactiveIndicator = document.getElementById('inactive-chat-indicator');

    if (placeholder) placeholder.style.display = 'flex';
    if (msgContainer) msgContainer.style.display = 'none';
    if (chatInput) chatInput.style.display = 'none';
    if (inactiveIndicator) inactiveIndicator.style.display = 'none';
    
    currentChatId = null;
    currentChatType = null;
    currentFriendUid = null;
}

// Lắng nghe thay đổi trạng thái đăng nhập
onAuthStateChanged(auth, async (user) => {
    // 1. Chưa đăng nhập -> Về trang login
    if (!user) {
        window.location.href = 'login.html';
        return;
    }

    // 2. Lấy dữ liệu user từ Firestore
    const userDocRef = doc(db, 'users', user.uid);
    const userDocSnap = await getDoc(userDocRef);

    // 3. User không tồn tại trong DB, bị khóa, hoặc cần setup -> Về trang login/setup
    if (!userDocSnap.exists() || userDocSnap.data().isDeactivated === true || userDocSnap.data().needsSetup === true) {
        await signOut(auth); // Đăng xuất trước khi chuyển trang
        // Nếu cần setup thì chuyển sang setup.html, còn lại về login
        if (userDocSnap.exists() && userDocSnap.data().needsSetup === true) {
            window.location.href = 'setup.html';
        } else {
            window.location.href = 'login.html';
        }
        return;
    }

    // 4. Gán biến global khi user hợp lệ
    const userData = userDocSnap.data();
        document.getElementById('loader-version').textContent = `Ver: ${APP_VERSION}`;
        let userAgent = navigator.userAgent;
        const openIdElement = document.getElementById('loader-open-id');
        openIdElement.title = userAgent;

        if (userAgent.length > 50) {
            userAgent = userAgent.substring(0, 50) + "...";
        }
        openIdElement.textContent = `Agent: ${userAgent}`;
        hideLoader();
    currentUser = user;
    currentUserData = userData;

    // // Optional: Xử lý Remote Config (nếu dùng)
    // try {
    //     await fetchAndActivate(remoteConfig);
    //     const isMaintenance = getBoolean(remoteConfig, "is_maintenance_mode");
    //     if (isMaintenance) {
    //         showMaintenancePopup(); // Hiện popup bảo trì và dừng
    //         return;
    //     }
    // } catch (err) {
    //     console.error("Error fetching remote config:", err);
    // }

    // 5. Kiểm tra hồ sơ có đầy đủ không (Tên hiển thị & Avatar)
    const isProfileIncomplete = !userData.displayName || !userData.avatarUrl;

    if (isProfileIncomplete) {
        // --- HỒ SƠ THIẾU -> HIỆN MODAL CẬP NHẬT ---
        if (!appRoot) return;
        appRoot.style.display = 'flex'; // Vẫn hiện UI mờ ảo phía sau

        // Khóa các chức năng chính
        if (messageInput) {
            messageInput.disabled = true;
            messageInput.placeholder = "Vui lòng cập nhật hồ sơ để chat...";
        }
        if (sidebar) sidebar.style.pointerEvents = 'none';

        // Lấy các element của modal force update
        const modal = document.getElementById('force-update-profile-modal');
        const forceNameInput = document.getElementById('force-name-input');
        const forceAvatarInput = document.getElementById('force-avatar-input');
        const forceBioInput = document.getElementById('force-bio-input');
        const forceCoverInput = document.getElementById('force-cover-input');
        const forceSaveBtn = document.getElementById('force-save-btn');

        // Kiểm tra tất cả element tồn tại trước khi thao tác
        if (modal && forceNameInput && forceAvatarInput && forceBioInput && forceCoverInput && forceSaveBtn) {
            modal.style.display = 'flex'; // Hiện modal

            // Điền thông tin cũ vào form
            forceNameInput.value = userData.displayName || '';
            forceAvatarInput.value = userData.avatarUrl || '';
            forceBioInput.value = userData.bio || '';
            forceCoverInput.value = userData.coverUrl || '';

            // Gắn sự kiện cho nút Lưu
            forceSaveBtn.onclick = async () => {
                 const newName = forceNameInput.value.trim();
                 const newAvatar = forceAvatarInput.value.trim();
                 const newBio = forceBioInput.value.trim();
                 const newCover = forceCoverInput.value.trim();

                 // Kiểm tra trường bắt buộc
                 if (!newName || !newAvatar) {
                     showToast("Vui lòng nhập Tên hiển thị và URL Avatar.", "error");
                     return;
                 }

                 forceSaveBtn.disabled = true; forceSaveBtn.textContent = "Đang lưu...";

                 try {
                     // Cập nhật lên Firestore
                     await updateDoc(userDocRef, {
                         displayName: newName,
                         avatarUrl: newAvatar,
                         bio: newBio,
                         coverUrl: newCover || deleteField() // Xóa nếu rỗng
                     });

                     // Cập nhật lại biến currentUserData ngay lập tức
                     currentUserData.displayName = newName;
                     currentUserData.avatarUrl = newAvatar;
                     currentUserData.bio = newBio;
                     currentUserData.coverUrl = newCover || undefined; // Cập nhật hoặc xóa

                     modal.style.display = 'none'; // Ẩn modal
                     showToast("Cập nhật thành công!", "success");

                     // Khởi động app với dữ liệu mới
                     initializeAppLogic(user, currentUserData);

                 } catch (err) {
                     showToast("Lỗi khi lưu: " + err.message, "error");
                     forceSaveBtn.disabled = false; forceSaveBtn.textContent = "Cập nhật";
                 }
            };
        } else {
            console.error("Missing elements for force update profile modal!");
        }

        // Chỉ chạy 2 hàm này để hiện avatar nav trong lúc chờ cập nhật
        setupPresence(user.uid, userData.hideOnlineStatus);
        wireProfile();

    } else {
    
        // --- HỒ SƠ ĐẦY ĐỦ -> KHỞI ĐỘNG APP ---
        initializeAppLogic(user, userData);
    }
});

/**
 * Định dạng timestamp thành chuỗi "Last seen".
 * Sẽ không hiển thị "Đang hoạt động" nếu displayAsOnline là false.
 * Sẽ không hiển thị trạng thái gần đây ("vừa mới", "x phút trước") nếu showDetailedRecency là false.
 * @param {boolean} displayAsOnline Có nên hiển thị là đang online không.
 * @param {number} timestamp Thời gian (milliseconds).
 * @param {boolean} [showDetailedRecency=true] Có nên hiển thị chi tiết thời gian gần đây không.
 * @returns {string} Chuỗi đã định dạng.
 */
function formatLastSeen(displayAsOnline, timestamp, showDetailedRecency = true) {
    // Ưu tiên hiển thị "Đang hoạt động" nếu được phép
    if (displayAsOnline) {
        return "Đang hoạt động";
    }

    // Nếu không có timestamp (offline lâu)
    if (!timestamp) {
        return "Không có thông tin";
    }

    const now = new Date();
    const lastSeenDate = new Date(timestamp);
    const diffSeconds = Math.floor((now - lastSeenDate) / 1000);
    const diffMinutes = Math.floor(diffSeconds / 60);
    const diffHours = Math.floor(diffMinutes / 60);

    // --- Logic khi KHÔNG hiển thị chi tiết gần đây (ai đó ẩn status) ---
    if (!showDetailedRecency) {
        // Nếu là ngày hôm nay -> Hiển thị "lần cuối lúc HH:MM"
        if (diffHours < 24 && now.getDate() === lastSeenDate.getDate()) {
             const hours = String(lastSeenDate.getHours()).padStart(2, '0');
             const minutes = String(lastSeenDate.getMinutes()).padStart(2, '0');
             return `Truy cập lần cuối lúc ${hours}:${minutes}`;
        }
        // Nếu là hôm qua -> Hiển thị "hôm qua lúc HH:MM"
        if (diffHours < 48 && now.getDate() - lastSeenDate.getDate() === 1) {
             const hours = String(lastSeenDate.getHours()).padStart(2, '0');
             const minutes = String(lastSeenDate.getMinutes()).padStart(2, '0');
             return `Truy cập hôm qua lúc ${hours}:${minutes}`;
        }
        // Nếu lâu hơn -> Hiển thị ngày/tháng/năm
        const day = String(lastSeenDate.getDate()).padStart(2, '0');
        const month = String(lastSeenDate.getMonth() + 1).padStart(2, '0');
        const year = lastSeenDate.getFullYear();
        return `Truy cập lần cuối ${day}/${month}/${year}`;
        // Hoặc có thể trả về "Không có thông tin" nếu muốn ẩn hoàn toàn thời gian gần đây?
        // return "Không có thông tin";
    }

    // --- Logic khi hiển thị chi tiết gần đây (không ai ẩn status) ---
    if (diffSeconds < 60) return "Vừa mới truy cập";
    if (diffMinutes < 60) return `Truy cập ${diffMinutes} phút trước`;
    // Trong cùng ngày -> "lần cuối lúc HH:MM"
    if (diffHours < 24 && now.getDate() === lastSeenDate.getDate()) {
        const hours = String(lastSeenDate.getHours()).padStart(2, '0');
        const minutes = String(lastSeenDate.getMinutes()).padStart(2, '0');
        return `Truy cập lần cuối lúc ${hours}:${minutes}`;
    }
    // Hôm qua -> "hôm qua lúc HH:MM"
    if (diffHours < 48 && now.getDate() - lastSeenDate.getDate() === 1) {
        const hours = String(lastSeenDate.getHours()).padStart(2, '0');
        const minutes = String(lastSeenDate.getMinutes()).padStart(2, '0');
        return `Truy cập hôm qua lúc ${hours}:${minutes}`;
    }
    // Lâu hơn -> Ngày/tháng/năm
    const day = String(lastSeenDate.getDate()).padStart(2, '0');
    const month = String(lastSeenDate.getMonth() + 1).padStart(2, '0');
    const year = lastSeenDate.getFullYear();
    return `Truy cập lần cuối ${day}/${month}/${year}`;
}
// --- HÀM CẬP NHẬT GIỜ UTC+0 ---
let intervalId = null; // Biến để lưu ID của setInterval

// Hàm cập nhật giờ lên UI
function updateUTCTimeDisplay() {
    const utcTimeDisplay = document.getElementById('utc-time-display');
    if (!utcTimeDisplay) {
        console.warn("UTC time display element not found.");
        if (intervalId) clearInterval(intervalId); // Dừng nếu element biến mất
        return;
    }
    const now = new Date();
    // Lấy giờ, phút, giây UTC
    const hours = String(now.getUTCHours()).padStart(2, '0');
    const minutes = String(now.getUTCMinutes()).padStart(2, '0');
    const seconds = String(now.getUTCSeconds()).padStart(2, '0');
    utcTimeDisplay.textContent = `${hours}:${minutes}:${seconds} UTC+0`;
}

// Hàm bắt đầu cập nhật giờ mỗi giây
function startUpdatingUTCTime() {
    if (intervalId) clearInterval(intervalId); // Xóa interval cũ nếu có
    updateUTCTimeDisplay(); // Cập nhật lần đầu ngay lập tức
    intervalId = setInterval(updateUTCTimeDisplay, 1000); // Cập nhật mỗi giây
}

// --- PHẦN 3: CÁC HÀM TIỆN ÍCH ---

// Khởi tạo theme (dark/light) dựa vào localStorage
function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'dark'; // Mặc định là dark

}

// Chuyển đổi ký tự đặc biệt HTML thành dạng an toàn
function escapeHtml(unsafeString) {
    if (typeof unsafeString !== 'string') {
        return ''; // Trả về chuỗi rỗng nếu đầu vào không phải string
    }
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;' // Hoặc &apos;
    };
    return unsafeString.replace(/[&<>"']/g, char => map[char]);
}

// Tạo HTML cho dấu tick xanh (nếu user đã xác minh)
function createVerifiedTickHTML(isVerified) {
    return isVerified ? '<span class="verified-tick"></span>' : '';
}

// Hiển thị thông báo toast ngắn gọn
function showToast(message, type = 'info') {
    if (!toast) {
        console.warn("Toast elements not found, using alert instead.");
        alert(message);
        return;
    }

    toast.className = `toast-${type}`;
    toast.innerHTML = `<div id="toast-message">${escapeHtml(message)}</div>`;
    toast.style.display = 'block';

    setTimeout(() => {
        toast.style.display = 'none';
        toast.className = '';
        toast.innerHTML = '';
    }, 3000);
}

// Hiển thị modal xác nhận (Yes/No) và trả về Promise (true/false)
function showConfirmation(message) {
    return new Promise(resolve => {
        // Ưu tiên dùng modal nếu có
        if (confirmMessage && confirmModal && confirmOkBtn && confirmCancelBtn) {
            confirmMessage.textContent = message;
            confirmModal.style.display = 'flex'; // Hiện modal

            // Gán sự kiện chỉ chạy 1 lần cho nút OK và Cancel
            confirmOkBtn.onclick = () => {
                confirmModal.style.display = 'none'; // Ẩn modal
                resolve(true); // Trả về true khi bấm OK
            };
            confirmCancelBtn.onclick = () => {
                confirmModal.style.display = 'none'; // Ẩn modal
                resolve(false); // Trả về false khi bấm Cancel
            };
            // Optional: Đóng khi bấm ra ngoài modal overlay
            confirmModal.onclick = (e) => {
                 if (e.target === confirmModal) {
                      confirmModal.style.display = 'none';
                      resolve(false); // Coi như bấm Cancel
                 }
            };
        } else {
            // Fallback: Dùng window.confirm của trình duyệt
            console.warn("Confirmation modal elements not found, using window.confirm.");
            resolve(window.confirm(message));
        }
    });
}

// --- HÀM TÌM KIẾM & MỞ PROFILE KHI THÊM BẠN BÈ BẰNG EMAIL ---
async function addFriendByEmail() {
    // 1. Lấy DOM elements
    const emailInput = document.getElementById('add-friend-email-input');
    const addFriendModal = document.getElementById('add-friend-modal'); // Đảm bảo ID này đúng
    const confirmBtn = document.getElementById('confirm-add-friend-btn');

    // Kiểm tra elements tồn tại
    if (!emailInput || !addFriendModal || !confirmBtn) {
        console.error("Missing elements for add friend modal!");
        showToast("Lỗi giao diện, không thể thêm bạn bè.", "error");
        return;
    }

    const email = emailInput.value.trim().toLowerCase();

    if (!email) {
        showToast("Vui lòng nhập email.", "error");
        return;
    }

    // --- BẮT ĐẦU LOGIC TÌM KIẾM ---
    confirmBtn.disabled = true;
    confirmBtn.textContent = "Đang tìm...";

    try {
        const q = query(collection(db, "users"), where("email", "==", email));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
            showToast("Không tìm thấy người dùng với email này.", "error");
        } else {
            const targetUser = querySnapshot.docs[0].data();
            const targetUid = querySnapshot.docs[0].id; // Lấy UID từ doc ID

            if (targetUid === currentUser.uid) {
                showToast("Đây là email của bạn.", "error");
            } else {
                // Mở trang profile trong tab mới
                window.open(`profile.html?id=${targetUid}`, '_blank');

                // Dọn dẹp modal
                emailInput.value = '';
                addFriendModal.style.display = 'none';
            }
        }
    } catch (err) {
        console.error("Lỗi khi tìm bạn:", err);
        showToast("Đã xảy ra lỗi khi tìm kiếm.", "error");
    } finally { // Dùng finally để đảm bảo nút được reset
        // Chỉ reset nếu modal chưa bị đóng (trường hợp tìm thấy và mở tab mới)
        if (addFriendModal.style.display !== 'none') {
             confirmBtn.disabled = false;
             confirmBtn.textContent = "Tìm kiếm";
        } else {
             // Nếu modal đã đóng, vẫn nên reset trạng thái nút phòng trường hợp mở lại
             confirmBtn.disabled = false;
             confirmBtn.textContent = "Tìm kiếm";
        }
    }
}

/**
 * Hiển thị thông tin chi tiết của bạn bè trong panel bên phải.
 * Bao gồm avatar, tên, biệt danh (nếu có), ảnh đã gửi, nút mute, chặn, xóa bạn, báo cáo.
 * @param {string} friendUid UID của người bạn cần hiển thị thông tin.
 */
async function showFriendInfo(friendUid) {
    if (!friendInfoContent || !groupInfoContent) { console.error("Missing info panel content elements!"); return; }
    groupInfoContent.style.display = 'none'; // Ẩn panel nhóm
    friendInfoContent.style.display = 'block'; // Hiện panel bạn bè

    // Lấy các DOM element cần thiết trong panel (cẩn thận trùng tên với biến global)
    const friendAvatarPanel = friendInfoContent.querySelector('.chat-info-avatar'); // Đổi tên biến local
    const friendNamePanel = friendInfoContent.querySelector('#chat-friend-name-info'); // Đổi tên biến local
    const nameDisplayAreaPanel = friendInfoContent.querySelector('#friend-name-display-area');
    const nameEditAreaPanel = friendInfoContent.querySelector('#friend-name-edit-area');
    const editNicknameBtnPanel = friendInfoContent.querySelector('#edit-nickname-btn');
    const nicknameInputPanel = friendInfoContent.querySelector('#nickname-input');
    const saveNicknameBtnPanel = friendInfoContent.querySelector('#save-nickname-btn');
    const cancelNicknameBtnPanel = friendInfoContent.querySelector('#cancel-nickname-btn');
    const sentImagesGridPanel = friendInfoContent.querySelector('#sent-images-grid');
    const toggleMuteBtnFriendPanel = friendInfoContent.querySelector('#toggle-mute-btn-friend');
    const muteIconOnFriendPanel = friendInfoContent.querySelector('#mute-icon-on-friend');
    const muteIconOffFriendPanel = friendInfoContent.querySelector('#mute-icon-off-friend');
    const muteBtnTextFriendPanel = friendInfoContent.querySelector('#mute-btn-text-friend');
    const blockUserBtnPanel = friendInfoContent.querySelector('#block-user-btn');
    const unblockUserBtnPanel = friendInfoContent.querySelector('#unblock-user-btn');
    const removeFriendBtnPanel = friendInfoContent.querySelector('#remove-friend-btn');
    const reportUserBtnPanel = friendInfoContent.querySelector('#report-user-btn');


    // Kiểm tra các element quan trọng
    if (!friendAvatarPanel || !friendNamePanel || !blockUserBtnPanel || !unblockUserBtnPanel || !removeFriendBtnPanel || !reportUserBtnPanel || !sentImagesGridPanel || !toggleMuteBtnFriendPanel) {
        console.error("Missing elements inside friend info panel!");
        return;
    }

    // Mặc định ẩn vùng sửa tên
    if (nameDisplayAreaPanel) nameDisplayAreaPanel.style.display = 'flex';
    if (nameEditAreaPanel) nameEditAreaPanel.style.display = 'none';

    // Reset UI trước khi load data mới
    friendNamePanel.innerHTML = 'Đang tải...';
    friendAvatarPanel.src = 'https://placehold.co/95x95';
    sentImagesGridPanel.innerHTML = '';
    blockUserBtnPanel.style.display = 'none';
    unblockUserBtnPanel.style.display = 'none';
    removeFriendBtnPanel.style.display = 'none';
    toggleMuteBtnFriendPanel.style.display = 'none';
    reportUserBtnPanel.style.display = 'none';


    // Lấy thông tin người bạn mới nhất
    const friendDoc = await getDoc(doc(db, "users", friendUid));
    if (!friendDoc.exists()) {
        friendNamePanel.innerHTML = "Không tìm thấy user";
        return; // Dừng nếu không có user
    }

    const d = friendDoc.data();
    const isFriend = currentUserData.friends?.includes(friendUid);
    const isBlocked = currentUserData.blocked?.includes(friendUid);
    const verifiedTick = createVerifiedTickHTML(d.isVerified);
    const currentNickname = currentUserData.nicknames?.[friendUid];
    const displayName = currentNickname || d.displayName || d.email;
    const realName = d.displayName || d.email; // Luôn giữ tên thật

    // Hiển thị thông tin cơ bản
    friendNamePanel.innerHTML = `${escapeHtml(displayName)} ${verifiedTick}`;
    friendAvatarPanel.src = d.avatarUrl || `https://placehold.co/95x95/EFEFEF/333?text=${escapeHtml(realName[0].toUpperCase())}`;

    // Hiện/ẩn nút chặn/bỏ chặn/xóa bạn
    removeFriendBtnPanel.style.display = isFriend ? 'block' : 'none';
    blockUserBtnPanel.style.display = !isBlocked ? 'block' : 'none';
    unblockUserBtnPanel.style.display = isBlocked ? 'block' : 'none';
    reportUserBtnPanel.style.display = 'block'; // Nút báo cáo luôn hiện
    toggleMuteBtnFriendPanel.style.display = 'block'; // Nút mute luôn hiện

    // Gán sự kiện cho các nút hành động cơ bản
    blockUserBtnPanel.onclick = () => blockUser(friendUid, displayName);
    unblockUserBtnPanel.onclick = () => unblockUser(friendUid, displayName);
    reportUserBtnPanel.onclick = () => {
        reportingUser = { uid: friendUid, name: realName }; // Báo cáo bằng tên thật
        if (reportingUserName && reportUserModal) {
             reportingUserName.textContent = `Bạn đang báo cáo ${escapeHtml(realName)}.`;
             reportUserModal.style.display = 'flex';
        }
    };
    removeFriendBtnPanel.onclick = async () => { /* ... logic xóa bạn ... */
        const confirmed = await showConfirmation(`Bạn chắc chắn muốn xóa "${escapeHtml(displayName)}" khỏi danh sách bạn bè?`);
        if (confirmed) {
            const meRef = doc(db, 'users', currentUser.uid);
            const friendRef = doc(db, 'users', friendUid);
            try {
                await updateDoc(meRef, { friends: arrayRemove(friendUid), [`nicknames.${friendUid}`]: deleteField() });
                await updateDoc(friendRef, { friends: arrayRemove(currentUser.uid) });
                showToast("Đã xóa bạn.", 'success');
                if (chatInfoPanel) chatInfoPanel.classList.remove('open');
                const chatIdToRemove = [currentUser.uid, friendUid].sort().join('_');
                if (currentChatId === chatIdToRemove) { /* Reset chat UI */
                    if(currentChatFriendName) currentChatFriendName.textContent = "Chọn cuộc trò chuyện";
                    if(messagesContainer) messagesContainer.innerHTML = '';
                    if(messageInput) messageInput.disabled = true; if(sendBtn) sendBtn.disabled = true;
                    currentChatId = null; currentChatType = null;
                    if(currentChatAvatar) currentChatAvatar.style.display = 'none';
                    if(openInfoBtn) openInfoBtn.style.display = 'none';
                    if(toggleMuteBtnFriendPanel) toggleMuteBtnFriendPanel.style.display = 'none';
                }
                // loadAndSortChats sẽ tự cập nhật sidebar
            } catch(error) { console.error("Lỗi khi xóa bạn:", error); showToast("Có lỗi xảy ra khi xóa bạn."); }
        }
    };

    // --- LOGIC BIỆT DANH ---
    if (editNicknameBtnPanel && nameDisplayAreaPanel && nameEditAreaPanel && nicknameInputPanel && saveNicknameBtnPanel && cancelNicknameBtnPanel) {
        editNicknameBtnPanel.onclick = () => {
            nameDisplayAreaPanel.style.display = 'none';
            nameEditAreaPanel.style.display = 'block';
            nicknameInputPanel.value = currentNickname || '';
            nicknameInputPanel.placeholder = `Đặt biệt danh cho ${escapeHtml(realName)}`;
            nicknameInputPanel.focus();
        };
        cancelNicknameBtnPanel.onclick = () => {
            nameDisplayAreaPanel.style.display = 'flex';
            nameEditAreaPanel.style.display = 'none';
        };
        saveNicknameBtnPanel.onclick = async () => { /* ... logic lưu nickname ... */
            const newNickname = nicknameInputPanel.value.trim();
            saveNicknameBtnPanel.disabled = true; saveNicknameBtnPanel.textContent = 'Lưu...';
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                const fieldName = `nicknames.${friendUid}`;
                if (newNickname) {
                    await updateDoc(userRef, { [fieldName]: newNickname });
                    if (!currentUserData.nicknames) currentUserData.nicknames = {};
                    currentUserData.nicknames[friendUid] = newNickname;
                    showToast("Đã lưu biệt danh!", "success");
                } else {
                    await updateDoc(userRef, { [fieldName]: deleteField() });
                    if (currentUserData.nicknames) delete currentUserData.nicknames[friendUid];
                    showToast("Đã xóa biệt danh.", "info");
                }
                const finalName = newNickname || realName;
                friendNamePanel.innerHTML = `${escapeHtml(finalName)} ${verifiedTick}`; // Cập nhật tên trong panel
                // Cập nhật tên trên header nếu đang chat với người này
                const chatIdToCheck = [currentUser.uid, friendUid].sort().join('_');
                if (currentChatId === chatIdToCheck && currentChatFriendName) {
                    currentChatFriendName.innerHTML = `${escapeHtml(finalName)} ${verifiedTick}`;
                }
                // Cập nhật tên trên sidebar nếu có
                const sidebarNameEl = document.getElementById(`sidebar-friend-name-${friendUid}`);
                if (sidebarNameEl) { sidebarNameEl.innerHTML = `${escapeHtml(finalName)} ${verifiedTick}`; }
                nameDisplayAreaPanel.style.display = 'flex'; nameEditAreaPanel.style.display = 'none'; // Đóng vùng sửa
            } catch (err) { console.error("Lỗi lưu nickname: ", err); showToast("Lỗi!", "error"); }
            finally { saveNicknameBtnPanel.disabled = false; saveNicknameBtnPanel.textContent = 'Lưu'; }
        };
    } else {
        console.warn("Missing nickname elements in friend info panel.");
    }


    // --- LOGIC NÚT MUTE ---
    if (toggleMuteBtnFriendPanel && muteIconOnFriendPanel && muteIconOffFriendPanel && muteBtnTextFriendPanel) {
        const chatIdForMute = [currentUser.uid, friendUid].sort().join('_');
        const isMutedFriend = currentUserData.mutedChats?.[chatIdForMute] === true;
        muteIconOnFriendPanel.style.display = isMutedFriend ? 'none' : 'inline-block';
        muteIconOffFriendPanel.style.display = isMutedFriend ? 'inline-block' : 'none';
        muteBtnTextFriendPanel.textContent = isMutedFriend ? "Bật thông báo" : "Tắt thông báo";
        toggleMuteBtnFriendPanel.title = isMutedFriend ? "Bật thông báo" : "Tắt thông báo";

        toggleMuteBtnFriendPanel.onclick = async () => { /* ... logic mute ... */
            const currentlyMuted = currentUserData.mutedChats?.[chatIdForMute] === true;
            const newMutedStatus = !currentlyMuted;
            toggleMuteBtnFriendPanel.disabled = true;
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                const fieldName = `mutedChats.${chatIdForMute}`;
                if (newMutedStatus) {
                    await updateDoc(userRef, { [fieldName]: true });
                    if (!currentUserData.mutedChats) currentUserData.mutedChats = {};
                    currentUserData.mutedChats[chatIdForMute] = true;
                    showToast("Đã tắt thông báo cho cuộc trò chuyện này.", "info");
                } else {
                    await updateDoc(userRef, { [fieldName]: deleteField() });
                    if (currentUserData.mutedChats) delete currentUserData.mutedChats[chatIdForMute];
                    showToast("Đã bật thông báo.", "success");
                }
                muteIconOnFriendPanel.style.display = newMutedStatus ? 'none' : 'inline-block';
                muteIconOffFriendPanel.style.display = newMutedStatus ? 'inline-block' : 'none';
                muteBtnTextFriendPanel.textContent = newMutedStatus ? "Bật thông báo" : "Tắt thông báo";
                toggleMuteBtnFriendPanel.title = newMutedStatus ? "Bật thông báo" : "Tắt thông báo";
            } catch (err) { console.error("Lỗi mute:", err); showToast("Lỗi!", "error");}
            finally { toggleMuteBtnFriendPanel.disabled = false; }
        };
    } else {
        console.warn("Missing mute elements in friend info panel.");
    }


    // --- LOAD ẢNH ĐÃ GỬI ---
    sentImagesGridPanel.innerHTML = ''; // Xóa ảnh cũ
    const chatMsgRef = ref(rtdb, `/messages/${[currentUser.uid, friendUid].sort().join('_')}`);
    // Query lấy ảnh mới nhất (ví dụ 9 ảnh)
    const imagesQuery = rtdbQuery(chatMsgRef, orderByChild('timestamp'), limitToLast(9));
    get(imagesQuery).then(snap => { // Dùng get() thay onValue
        sentImagesGridPanel.innerHTML = ''; // Xóa lại lần nữa
        if (!snap.exists()) { sentImagesGridPanel.innerHTML = '<p style="font-size: 13px; color: var(--text-2); text-align: left;">Chưa có ảnh nào.</p>'; return; }
        const imageMsgs = [];
        snap.forEach((child) => { const msg = child.val(); if (msg.imageUrl) imageMsgs.push(msg.imageUrl); });
        imageMsgs.reverse().forEach(url => { // Hiển thị mới nhất trước
            const img = document.createElement('img'); img.src = url; img.alt = "Ảnh đã gửi";
            img.onclick = () => openLightbox(url);
            sentImagesGridPanel.appendChild(img);
        });
         if (imageMsgs.length === 0) {
              sentImagesGridPanel.innerHTML = '<p style="font-size: 13px; color: var(--text-2); text-align: left;">Chưa có ảnh nào.</p>';
         }
    }).catch(err => {
         console.error("Error fetching sent images:", err);
         sentImagesGridPanel.innerHTML = '<p style="color:red;">Lỗi tải ảnh</p>';
    });
}

/**
 * Lắng nghe danh sách lời mời kết bạn đang chờ xử lý (pending) gửi đến user hiện tại.
 * Hiển thị danh sách trong modal và cập nhật chấm đỏ thông báo trên nút bạn bè.
 */
function loadFriendRequests(){
      if (!currentUser) return;
      const q = query(collection(db, 'friend_requests'), where('to_uid', '==', currentUser.uid), where('status', '==', 'pending'));
      
      onSnapshot(q, async (snap)=>{ // Thêm async
        // Cập nhật badge
        const badge = document.getElementById('friend-request-count-badge');
        if(badge){
            badge.textContent = snap.empty ? '0' : snap.docs.length;
            badge.style.display = snap.empty ? 'none' : 'flex';
        }

        // Lấy thông tin chi tiết của người gửi (nếu đang ở trang Lời mời)
        const requestsPage = document.getElementById('friends-page-requests');
        if (requestsPage && requestsPage.classList.contains('active')) {
            if (snap.empty) {
                 renderFriendRequestsPage([]); // Render mảng rỗng
                 return;
            }
            
            // Lấy data chi tiết
            const requestsDataPromises = snap.docs.map(async (docSnap) => {
                 const req = docSnap.data();
                 try {
                     const userDoc = await getDoc(doc(db, 'users', req.from_uid));
                     if (userDoc.exists()) {
                         const userData = userDoc.data();
                         return {
                             id: docSnap.id,
                             ...req,
                             from_displayName: userData.displayName || req.from_email,
                             from_avatar: userData.avatarUrl
                         };
                     }
                 } catch (e) { console.error(e); }
                 return { id: docSnap.id, ...req }; // Fallback
            });
            
            const requestsData = await Promise.all(requestsDataPromises);
            renderFriendRequestsPage(requestsData); // Render với data chi tiết
        }
      });
    }

    // === HÀM MỚI: TẢI DATA CHO TRANG LỜI MỜI (khi click) ===
    async function loadFriendRequestsPage() {
         const listContainer = document.getElementById('friends-requests-list-page');
         if (!listContainer) return;
         listContainer.innerHTML = '<p class="friends-list-placeholder">Đang tải lời mời...</p>';
         
         // Chạy query 1 lần (getDocs) thay vì onSnapshot
         const q = query(collection(db, 'friend_requests'), where('to_uid', '==', currentUser.uid), where('status', '==', 'pending'));
         const snap = await getDocs(q);

         if (snap.empty) {
             renderFriendRequestsPage([]);
             return;
         }

         const requestsDataPromises = snap.docs.map(async (docSnap) => {
             const req = docSnap.data();
             try {
                 const userDoc = await getDoc(doc(db, 'users', req.from_uid));
                 if (userDoc.exists()) {
                     const userData = userDoc.data();
                     return { id: docSnap.id, ...req, from_displayName: userData.displayName || req.from_email, from_avatar: userData.avatarUrl };
                 }
             } catch (e) { console.error(e); }
             return { id: docSnap.id, ...req }; // Fallback
         });
            
         const requestsData = await Promise.all(requestsDataPromises);
         renderFriendRequestsPage(requestsData);
    }
/**
 * Lắng nghe danh sách lời mời kết bạn đang chờ xử lý (pending) gửi đến user hiện tại.
 * Hiển thị danh sách trong modal và cập nhật chấm đỏ thông báo trên nút bạn bè.
 */

 // --- HÀM GỬI LỜI MỜI KẾT BẠN ---
async function sendFriendRequest(targetUid) {
    if (!currentUser || !currentUserData) return Promise.reject(new Error("Chưa đăng nhập."));
    if (targetUid === currentUser.uid) return Promise.reject(new Error("Không thể gửi lời mời cho chính mình."));
    if (currentUserData.friends?.includes(targetUid)) return Promise.reject(new Error("Đã là bạn bè."));

    console.log(`Sending friend request to: ${targetUid}`);

    // Check if a request already exists (either direction)
    const q1 = query(collection(db, 'friend_requests'),
        where('from_uid', '==', currentUser.uid),
        where('to_uid', '==', targetUid),
        where('status', '==', 'pending')
    );
    const q2 = query(collection(db, 'friend_requests'),
        where('from_uid', '==', targetUid),
        where('to_uid', '==', currentUser.uid),
        where('status', '==', 'pending')
    );

    try {
        const [sentSnapshot, receivedSnapshot] = await Promise.all([getDocs(q1), getDocs(q2)]);

        if (!sentSnapshot.empty) {
            console.log("Request already sent.");
            return Promise.reject(new Error("Đã gửi lời mời trước đó."));
        }
        if (!receivedSnapshot.empty) {
            console.log("Request already received.");
            return Promise.reject(new Error("Người này đã gửi lời mời cho bạn. Kiểm tra danh sách lời mời."));
        }

        // No existing pending request, create a new one
        console.log("Creating new friend request document...");
        await addDoc(collection(db, 'friend_requests'), {
            from_uid: currentUser.uid,
            from_email: currentUser.email, // Store sender email for display
            to_uid: targetUid,
            status: 'pending', // 'pending', 'accepted', 'declined'
            timestamp: serverTimestamp()
        });
        console.log("Friend request document created.");
        return Promise.resolve("Đã gửi lời mời kết bạn!"); // Resolve on success

    } catch (error) {
        console.error("Error sending friend request:", error);
        return Promise.reject(new Error("Lỗi gửi lời mời kết bạn: " + error.message)); // Reject on error
    }
}


// Xin quyền hiển thị thông báo của trình duyệt
function requestSimpleNotificationPermission() {
    if (!("Notification" in window)) {
        alert("Trình duyệt này không hỗ trợ thông báo trên màn hình.");
        return;
    }
    // Chỉ xin quyền nếu chưa được cấp hoặc bị từ chối trước đó
    if (Notification.permission !== "granted") {
        Notification.requestPermission().then((permission) => {
            if (permission === "granted") {
                showToast("Đã bật thông báo trình duyệt!", "success");
            } else {
                showToast("Bạn đã không cho phép nhận thông báo.", "error");
            }
        });
    } else {
        showToast("Thông báo trình duyệt đã được bật từ trước.", "info");
    }
}

// Hiển thị thông báo đơn giản của trình duyệt
function showSimpleNotification(senderName, messageText, avatarUrl) {
    if (Notification.permission !== "granted") return; // Chỉ hiện khi đã được cấp quyền

    const options = {
        body: messageText,
        icon: avatarUrl || 'https://placehold.co/96x96?text=Q', // Ảnh đại diện hoặc placeholder
        // tag: 'qola-message', // Optional: Dùng tag để gom thông báo
        // renotify: true,      // Optional: Rung/báo lại nếu tag giống nhau
    };

    // Tạo thông báo mới
    const notification = new Notification(senderName, options);

    // Optional: Đóng thông báo sau vài giây
    setTimeout(notification.close.bind(notification), 5000); // Tự đóng sau 5s

    // Optional: Xử lý khi click vào thông báo (ví dụ: mở cửa sổ chat)
    notification.onclick = () => {
        window.focus(); // Focus vào cửa sổ trình duyệt
        // TODO: Thêm logic chuyển đến đúng cửa sổ chat nếu cần
    };
}

// --- PHẦN 4: PRESENCE & PROFILE WIRING ---

/**
 * Thiết lập trạng thái online/offline cho user hiện tại trong Realtime Database.
 * @param {string} uid User ID của người dùng hiện tại.
 * @param {boolean} [isHidden=false] Nếu true, user sẽ luôn hiển thị offline.
 */
function setupPresence(uid, isHidden = false) {
    const statusRef = ref(rtdb, `/status/${uid}`); // Đường dẫn đến trạng thái của user

    // Nếu người dùng chọn ẩn trạng thái -> Set offline và dừng
    if (isHidden) {
        set(statusRef, { isOnline: false, last_seen: dbServerTimestamp() });
        console.log(`User ${uid} chose to hide status, set to offline.`);
        return; // Dừng hàm tại đây
    }

    // Nếu không ẩn -> Thiết lập logic online/offline bình thường
    const connectedRef = ref(rtdb, '.info/connected'); // Firebase connection status

    onValue(connectedRef, (snap) => {
        // Chỉ thực hiện khi kết nối thành công (snap.val() === true)
        if (snap.val() === false) {
            // Có thể tạm thời set offline ở đây nếu muốn,
            // nhưng onDisconnect đã xử lý khi mất kết nối đột ngột
            return;
        }

        // Khi client mất kết nối (tắt tab, mất mạng), Firebase sẽ tự động set offline
        onDisconnect(statusRef)
            .set({ isOnline: false, last_seen: dbServerTimestamp() })
            .then(() => {
                // Sau khi thiết lập onDisconnect thành công, set trạng thái hiện tại là online
                set(statusRef, { isOnline: true, last_seen: dbServerTimestamp() });
                console.log(`Presence setup complete for ${uid}. Status: Online.`);
            })
            .catch((err) => {
                console.error("Could not establish onDisconnect event:", err);
            });
    });
}

/**
 * Lắng nghe thay đổi dữ liệu của user hiện tại (ví dụ: avatarUrl, hideOnlineStatus)
 * và cập nhật giao diện tương ứng (ví dụ: avatar trên thanh nav).
 */
function wireProfile() {
    if (!currentUser || !navAvatar) {
        console.error("wireProfile: currentUser or navAvatar not available!");
        return; // Dừng nếu thiếu thông tin
    }

    // Lắng nghe thay đổi trên document của user hiện tại trong Firestore
    const userDocRef = doc(db, 'users', currentUser.uid);

    // Sử dụng onSnapshot để tự động cập nhật khi có thay đổi
    onSnapshot(userDocRef, (ds) => {
        if (!ds.exists()) {
            console.error("User document suddenly disappeared!");
            // Có thể xử lý đăng xuất ở đây nếu cần
            return;
        }
        const userData = ds.data() || {}; // Lấy data, phòng trường hợp rỗng

        // Cập nhật avatar trên thanh nav
        const avatarSrc = userData.avatarUrl || `https://placehold.co/48x48/111/fff?text=${(userData.email || '?')[0].toUpperCase()}`;
        navAvatar.src = avatarSrc; // Cập nhật src của img#nav-avatar

        // Cập nhật class 'is-hiding-status' trên body để CSS xử lý ẩn chấm xanh
        // (CSS cần có rule: body.is-hiding-status .status.online { background: #64748b; })
        document.body.classList.toggle('is-hiding-status', userData.hideOnlineStatus === true);

        // QUAN TRỌNG: Không cập nhật currentUserData ở đây nữa
        // Việc cập nhật currentUserData sẽ do listener trong loadAndSortChats xử lý
        // để tránh load lại danh sách chat không cần thiết khi chỉ avatar thay đổi.

    }, (error) => {
        console.error("Error listening to user profile:", error);
        // Có thể hiển thị lỗi cho người dùng ở đây
    });
}

// --- PHẦN 5: LOAD & RENDER DANH SÁCH CHAT ---

/**
 * Hàm chính để bắt đầu quá trình tải và lắng nghe danh sách chat.
 * Gắn listener cho dữ liệu user hiện tại và danh sách nhóm user tham gia.
 * Khi có thay đổi (bạn mới, nhóm mới), sẽ gọi loadAndRebuildChatList.
 */
async function loadAndSortChats() {
    if (!chatListElement || !currentUser || !currentUserData) {
        console.error("loadAndSortChats: Missing required elements or data.");
        return;
    }
    console.log("Running loadAndSortChats...");

    // --- 1. Gắn Listener User (Chỉ 1 lần) ---
    if (!userListenerUnsubscribe) {
        console.log("Attaching user listener...");
        const userDocRef = doc(db, 'users', currentUser.uid);
        userListenerUnsubscribe = onSnapshot(userDocRef, async (userDocSnap) => {
            console.log("User data snapshot received!");
            if (userDocSnap.exists()) {
                const newUserData = userDocSnap.data();
                const oldFriends = JSON.stringify(currentUserData.friends || []);
                const newFriends = JSON.stringify(newUserData.friends || []);
                currentUserData = newUserData; // Cập nhật data mới nhất

                // Lấy dữ liệu chi tiết của bạn bè (quan trọng cho các hàm khác)
                const friendUIDs = currentUserData.friends || [];
                const friendPromises = friendUIDs.map(uid => getDoc(doc(db, 'users', uid)));
                const friendDocs = await Promise.all(friendPromises);
                friends = friendDocs // Cập nhật biến global 'friends'
                    .filter(snap => snap.exists())
                    .map(snap => ({ uid: snap.id, ...snap.data() }));
                currentFriends = currentUserData.friends || []; // Cập nhật mảng UID bạn bè

                // Chỉ load lại list nếu danh sách bạn bè THAY ĐỔI
                if (oldFriends !== newFriends) {
                    console.log("Friend list changed, reloading chat list...");
                    await loadAndRebuildChatList(); // Load lại list khi bạn bè thay đổi
                } else {
                    // Nếu bạn bè không đổi, chỉ cập nhật UI phụ
                    wireProfile(); // Cập nhật avatar nav
                    document.body.classList.toggle('is-hiding-status', currentUserData.hideOnlineStatus === true);
                }
            } else {
                console.error("User document does not exist!");
                await signOut(auth); window.location.href = 'login.html';
            }
        }, (error) => {
            console.error("Error listening to user document:", error);
        });
    }

    // --- 2. Gắn Listener Groups (Chỉ 1 lần) ---
    if (!groupsListenerUnsubscribe) {
        console.log("Attaching groups listener...");
        const groupsQuery = query(collection(db, 'groups'), where('member_uids', 'array-contains', currentUser.uid));
        groupsListenerUnsubscribe = onSnapshot(groupsQuery, async (querySnapshot) => {
            console.log("Groups data snapshot received!");
            // Luôn load lại list khi nhóm thay đổi (tên, thành viên, avatar...)
            await loadAndRebuildChatList();
        }, (error) => {
            console.error("Error listening to groups collection:", error);
        });
    }

    // --- 3. Load và Rebuild List lần đầu ---
    await loadAndRebuildChatList();
}

/**
 * Hàm này lấy dữ liệu bạn bè và nhóm, tạo mảng allChats,
 * sau đó gắn listener cho tin nhắn cuối và trạng thái online của từng chat.
 */
async function loadAndRebuildChatList() {
     if (!chatListElement || !currentUser || !currentUserData || !db || !rtdb) {
         console.error("loadAndRebuildChatList: Missing required elements or data.");
         return;
     }
     console.log("--- Starting loadAndRebuildChatList ---");

     // Hiện skeleton loading
     if (sidebar) sidebar.classList.remove('loaded');
     chatListElement.innerHTML = '<li class="chat-item-placeholder" style="list-style: none; text-align: center; color: var(--text-secondary); padding: 20px;">Đang cập nhật danh sách...</li>';

     // Hủy listener last message & status CŨ
     console.log("Clearing old listeners...");
     Object.entries(chatListeners).forEach(([key, unsub]) => {
         try { unsub(); } catch (e) { console.warn(`Error unsubscribing ${key}:`, e); }
         delete chatListeners[key];
     });
     console.log("Old listeners cleared.");
     allChats = []; // Reset mảng chat

     try {
         // Lấy danh sách bạn bè TỪ currentUserData MỚI NHẤT
         const friendUIDs = currentUserData.friends || [];
         console.log("Friend UIDs from currentUserData:", friendUIDs);

         // Lấy danh sách nhóm TỪ Firestore
         console.log("Fetching groups from Firestore...");
         const groupsQuery = query(collection(db, 'groups'), where('member_uids', 'array-contains', currentUser.uid));
         const groupSnap = await getDocs(groupsQuery);
         console.log("Fetched groups:", groupSnap.docs.length);

         // Tạo danh sách chat ban đầu (Promise cho bạn bè)
         const friendPromises = friendUIDs.map(async (uid) => {
             console.log("Processing friend UID:", uid);
             try {
                 const userDoc = await getDoc(doc(db, 'users', uid));
                 if (userDoc.exists()) {
                     const u = userDoc.data();
                     // Cập nhật cache nếu chưa có hoặc data cũ
                     userCache[uid] = { displayName: u.displayName, avatarUrl: u.avatarUrl, isVerified: u.isVerified };

                     const chatId = [currentUser.uid, uid].sort().join('_');
                     if (!allChats.some(chat => chat.id === chatId)) { // Chống trùng lặp
                         allChats.push({
                             id: chatId,
                             peerUid: uid,
                             name: u.displayName || u.email || 'Người dùng',
                             avatarUrl: u.avatarUrl,
                             isVerified: u.isVerified || false,
                             type: 'direct',
                             lastMessageTimestamp: 0,
                             lastMessagePreview: '...'
                         });
                         console.log("Added direct chat to allChats:", chatId);
                     }
                 } else {
                     console.warn("Friend document does not exist for UID:", uid);
                 }
             } catch (friendError) {
                 console.error("Error fetching friend data for UID:", uid, friendError);
             }
         });

         // Xử lý nhóm
         groupSnap.docs.forEach(docSnap => {
             const g = docSnap.data();
             const groupId = docSnap.id;
             console.log("Processing group ID:", groupId);
             if (!allChats.some(chat => chat.id === groupId)) { // Chống trùng lặp
                 allChats.push({
                     id: groupId,
                     name: g.groupName || 'Nhóm không tên',
                     avatarUrl: g.avatarUrl,
                     type: 'group',
                     isVerified: false,
                     lastMessageTimestamp: 0,
                     lastMessagePreview: '...'
                 });
                 console.log("Added group chat to allChats:", groupId);
             }
         });

         // Chờ tất cả promise lấy thông tin bạn bè hoàn thành
         console.log("Waiting for all friend data promises...");
         await Promise.all(friendPromises);
         console.log("Friend data promises completed.");

         console.log("Final allChats list before attaching listeners:", allChats.map(c=>c.id));

         // Gắn listener last message & status MỚI
         if (allChats.length > 0) {
             console.log("Attaching last message and status listeners...");
             allChats.forEach(chat => {
                 const chatId = chat.id;

                 // --- Listener cho Last Message ---
                 const lastMsgQuery = rtdbQuery(ref(rtdb, `/messages/${chatId}`), orderByChild('timestamp'), limitToLast(1));
                 if (chatListeners[chatId]) chatListeners[chatId](); // Hủy listener cũ nếu còn sót
                 chatListeners[chatId] = onValue(lastMsgQuery, (snap) => {
                     let timestamp = 0; let preview = '...';
                     if (snap.exists()) {
                         const [, lastMsg] = Object.entries(snap.val())[0];
                         timestamp = lastMsg.timestamp || 0;
                         if (lastMsg.recalled) preview = 'Tin nhắn đã thu hồi';
                         else if (lastMsg.text) preview = lastMsg.text;
                         else if (lastMsg.imageUrls?.length) preview = `Đã gửi ${lastMsg.imageUrls.length} ảnh/video`;
                         else if (lastMsg.imageUrl) preview = 'Đã gửi một ảnh';
                         else preview = 'Bắt đầu trò chuyện';
                         const senderPrefix = lastMsg.senderId === currentUser.uid ? 'Bạn: ' : (chat.type === 'group' ? `${(lastMsg.senderName || '?').split(' ')[0]}: ` : '');
                         preview = senderPrefix + preview;
                     }
                     const chatIndex = allChats.findIndex(c => c.id === chatId);
                     if (chatIndex > -1) {
                         if (allChats[chatIndex].lastMessageTimestamp !== timestamp || allChats[chatIndex].lastMessagePreview !== preview) {
                             allChats[chatIndex].lastMessageTimestamp = timestamp;
                             allChats[chatIndex].lastMessagePreview = preview;
                             renderChatList(); // Render lại khi có thay đổi
                         }
                     }
                 }, (error) => {
                     console.error(`Error listening to last message ${chatId}:`, error);
                     if (chatListeners[chatId]) { chatListeners[chatId](); delete chatListeners[chatId]; }
                 });

                 // --- Listener cho Status (nếu là direct chat) ---
             }); // Kết thúc forEach gắn listener
             // Render lần đầu sau khi gắn listener
             renderChatList();
         } else {
             // Nếu không có chat nào cả
             renderChatList(); // Gọi để hiện "Chưa có chat" và tắt skeleton
         }
         console.log("--- Finished loadAndRebuildChatList ---");

     } catch (error) {
         console.error("Fatal error in loadAndRebuildChatList:", error);
         chatListElement.innerHTML = '<li class="chat-item-placeholder" style="list-style: none; text-align: center; color: red; padding: 20px;">Lỗi tải danh sách chat!</li>';
         if (sidebar) sidebar.classList.add('loaded'); // Vẫn tắt skeleton khi lỗi
     }
}

/**
 * Hàm render danh sách chat (allChats) lên sidebar.
 * Sắp xếp theo tin nhắn mới nhất trước.
 */
/**
 * Hàm render danh sách chat (allChats) lên sidebar.
 * Sắp xếp theo tin nhắn mới nhất trước và áp dụng hiệu ứng gradient cho tên user verified.
 */
const renderChatList = () => {
     // Kiểm tra element cần thiết
     if (!chatListElement || !sidebar) {
         console.error("renderChatList: chatListElement or sidebar not found!");
         return;
     }

     // Sắp xếp mảng allChats theo timestamp mới nhất (tin nhắn mới nhất lên đầu)
     allChats.sort((a, b) => (b.lastMessageTimestamp || 0) - (a.lastMessageTimestamp || 0));
     chatListElement.innerHTML = ''; // Xóa nội dung danh sách cũ

     // Xử lý trường hợp không có cuộc trò chuyện nào
     if (allChats.length === 0) {
         chatListElement.innerHTML = '<li class="chat-item-placeholder" style="list-style: none; text-align: center; color: var(--text-secondary); padding: 20px;">Chưa có cuộc trò chuyện nào.</li>';
     } else {
         // Lặp qua từng chat trong mảng đã sắp xếp để tạo item
         allChats.forEach(chat => {
             const li = document.createElement('li');
             li.className = 'item clickable chat-list-item'; // Class chung
             li.dataset.chatId = chat.id; // Lưu chatId

             // Gán sự kiện click để mở chat tương ứng
             li.onclick = () => {
                 if (chat.type === 'direct') {
                     // Lấy data bạn bè (ưu tiên cache)
                     const friendData = friends.find(f => f.uid === chat.peerUid) || { uid: chat.peerUid, displayName: chat.name, avatarUrl: chat.avatarUrl, isVerified: chat.isVerified };
                     startDirectChat(friendData);
                 } else { // Nếu là group chat
                     startGroupChat(chat.id, chat.name);
                 }
                 // Đánh dấu item đang active (optional)
                 document.querySelectorAll('.chat-list-item.active').forEach(item => item.classList.remove('active'));
                 li.classList.add('active');
             };

             // Lấy avatar, tên, và tick xanh
             const avatarPlaceholder = chat.name ? chat.name[0].toUpperCase() : (chat.type === 'group' ? 'G' : '?');
             const avatarSrc = chat.avatarUrl || `https://placehold.co/40x40?text=${avatarPlaceholder}`;
             const verifiedTick = createVerifiedTickHTML(chat.isVerified); // Lấy HTML tick xanh

             // Xác định class cho tên (thêm 'gradient-text' nếu verified)
             const nameClass = chat.isVerified ? 'item-name gradient-text' : 'item-name';
             // Tạo HTML cho tên (không bao gồm tick)
             const nameHtml = `<div class="${nameClass}" id="sidebar-friend-name-${chat.peerUid}">${escapeHtml(chat.name)}</div>`;

             // Tạo HTML hoàn chỉnh cho list item
                li.innerHTML = `
            <div class="item-left">
                <img class="result-avatar" src="${avatarSrc}" alt="Avatar">
                <div style="min-width: 0;">
                    ${nameHtml} ${verifiedTick}
                    <div class="item-last-msg">${escapeHtml(chat.lastMessagePreview || '...')}</div>
                </div>
            </div>
            `;
             chatListElement.appendChild(li); // Thêm item vào danh sách
         });
     }
     // Luôn tắt skeleton SAU KHI render xong (dù có chat hay không)
     sidebar.classList.add('loaded');
};

// --- PHẦN 6: MỞ CỬA SỔ CHAT ---

/**
 * Bắt đầu hoặc chuyển sang cuộc trò chuyện trực tiếp với một người bạn.
 * Lấy thông tin chi tiết của bạn bè, kiểm tra trạng thái (bạn bè, bị chặn),
 * và gọi openChat để hiển thị giao diện. Cập nhật URL.
 * @param {object} friend Object chứa ít nhất uid, displayName, avatarUrl, isVerified của người bạn.
 */
async function startDirectChat(friend) {
    // Kiểm tra thông tin đầu vào và trạng thái đăng nhập
    if (!friend || !friend.uid || !currentUser) {
        console.warn("startDirectChat: Invalid friend data or user not logged in.");
        window.location.href = 'index.html'; // Chuyển về trang chính nếu thiếu thông tin
        return;
    }

    if (friend && friend.uid === currentUser.uid) {
        showToast("Bạn không thể tự trò chuyện với chính mình.", "info");
        // Optional: Reset URL nếu có param ?chat=myuid
        const params = new URLSearchParams(window.location.search);
        if (params.get('chat') === currentUser.uid) {
             history.replaceState(null, '', window.location.pathname); // Xóa param khỏi URL
        }
        // Optional: Reset giao diện chat về placeholder nếu cần
        // resetChatUI(); // Cần tạo hàm này nếu muốn
        return; // Dừng hàm tại đây
    }
    
    // --- Xử lý chuyển trang cho mobile ---
    if (window.innerWidth <= 768) {
        window.location.href = `chat.html?chat=${friend.uid}`;
        return; // Dừng hàm ở đây cho mobile
    }
    // --- Kết thúc xử lý mobile ---

    // Lấy dữ liệu mới nhất của người bạn từ Firestore
    const friendDoc = await getDoc(doc(db, 'users', friend.uid));
    if (!friendDoc.exists()) {
        showToast("Không tìm thấy người dùng này.", "error");
        return; // Dừng nếu user không tồn tại
    }

    const friendData = friendDoc.data();
    currentChatPeerData = friendData; // Lưu lại data đầy đủ của người đang chat cùng

    // Xác định trạng thái chat (active, inactive do bị chặn...)
    let isChatActive = true;
    let inactiveReason = "";
    let isFriend = currentUserData.friends?.includes(friend.uid); // Kiểm tra có phải bạn bè không

    if (currentUserData.blocked?.includes(friend.uid)) {
        inactiveReason = "Bạn đã chặn người này. Hãy bỏ chặn để tiếp tục nhắn tin.";
        isChatActive = false;
    } else if (friendData?.blocked?.includes(currentUser.uid)) {
        inactiveReason = "Bạn không thể gửi tin nhắn cho người này.";
        isChatActive = false;
    } else if (friendData.isDeactivated === true) {
        inactiveReason = "Tài khoản này đã ngừng hoạt động.";
        isChatActive = false;
    }

    // Tạo chatId và cập nhật biến global
    const uids = [currentUser.uid, friend.uid].sort();
    const chatId = uids.join('_');
    currentFriendUid = friend.uid; // Lưu uid của người bạn đang chat

    // Gọi hàm openChat để hiển thị UI
    openChat({
        id: chatId,
        name: friendData.displayName || friendData.email, // Lấy tên hiển thị
        type: 'direct',
        isActive: isChatActive // Trạng thái active/inactive
    });

    // Cập nhật text cho indicator nếu chat inactive
    if (inactiveChatIndicator) inactiveChatIndicator.textContent = inactiveReason;

    // --- CẬP NHẬT UI HEADER CHO NGƯỜI LẠ ---
    const peerInfoExtra = document.getElementById('peer-info-extra');
    const addFriendHeaderBtn = document.getElementById('add-friend-header-btn');

    if (peerInfoExtra && addFriendHeaderBtn) { // Kiểm tra element tồn tại
        // Chỉ hiện khi KHÔNG phải bạn bè, chat đang active và KHÔNG phải chat với chính mình
        if (!isFriend && isChatActive && friend.uid !== currentUser.uid) {
            peerInfoExtra.style.display = 'flex'; // Hiện khối "Người lạ + Kết bạn"

            // Kiểm tra xem đã gửi/nhận lời mời chưa
            addFriendHeaderBtn.disabled = true; addFriendHeaderBtn.textContent = 'Đang tải...';
            const qSent = query(collection(db, 'friend_requests'), where('from_uid', '==', currentUser.uid), where('to_uid', '==', friend.uid), where('status', '==', 'pending'));
            const qReceived = query(collection(db, 'friend_requests'), where('from_uid', '==', friend.uid), where('to_uid', '==', currentUser.uid), where('status', '==', 'pending'));

            try {
                 const [sentSnap, receivedSnap] = await Promise.all([getDocs(qSent), getDocs(qReceived)]);

                 if (!sentSnap.empty) { // Đã gửi lời mời
                     addFriendHeaderBtn.textContent = 'Đã gửi';
                     addFriendHeaderBtn.disabled = true;
                 } else if (!receivedSnap.empty) { // Đã nhận lời mời từ họ
                      addFriendHeaderBtn.textContent = 'Chấp nhận';
                      addFriendHeaderBtn.disabled = false;
                      addFriendHeaderBtn.onclick = async () => { /* ... logic chấp nhận lời mời ... */
                           addFriendHeaderBtn.disabled = true; addFriendHeaderBtn.textContent = 'Đang xử lý...';
                           const reqId = receivedSnap.docs[0].id;
                           try {
                               await handleAcceptFriend(reqId, friend.uid);
                               showToast('Đã chấp nhận lời mời!', 'success');
                               peerInfoExtra.style.display = 'none';
                               isFriend = true; // Cập nhật trạng thái bạn bè
                               if(removeFriendBtn) removeFriendBtn.style.display = 'block';
                           } catch (acceptErr) {
                               console.error("Lỗi chấp nhận:", acceptErr);
                               showToast("Lỗi: " + acceptErr.message, "error");
                               addFriendHeaderBtn.disabled = false; addFriendHeaderBtn.textContent = 'Chấp nhận';
                           }
                      };
                 } else { // Chưa có lời mời nào
                     addFriendHeaderBtn.textContent = 'Kết bạn';
                     addFriendHeaderBtn.disabled = false;
                     addFriendHeaderBtn.onclick = () => { /* ... logic gửi lời mời ... */
                         addFriendHeaderBtn.disabled = true; addFriendHeaderBtn.textContent = 'Đang gửi...';
                         sendFriendRequest(friend.uid)
                             .then(() => {
                                 showToast("Đã gửi lời mời kết bạn!", "success");
                                 addFriendHeaderBtn.textContent = 'Đã gửi';
                             })
                             .catch((err) => {
                                 console.error("Lỗi gửi lời mời:", err);
                                 showToast("Lỗi: " + err.message, "error");
                                 addFriendHeaderBtn.disabled = false; addFriendHeaderBtn.textContent = 'Kết bạn';
                             });
                     };
                 }
            } catch (checkError) {
                 console.error("Lỗi kiểm tra lời mời:", checkError);
                 addFriendHeaderBtn.textContent = 'Lỗi';
                 addFriendHeaderBtn.disabled = true;
            }

        } else {
            peerInfoExtra.style.display = 'none'; // Ẩn đi nếu là bạn bè, không active, hoặc là chính mình
        }
    } else {
        console.warn("Peer info extra elements not found!");
    }
    // --- KẾT THÚC CẬP NHẬT UI NGƯỜI LẠ ---

    // Cập nhật URL (chỉ trên PC)
    history.replaceState(null, '', `?chat=${friend.uid}`);
}

/**
 * Bắt đầu hoặc chuyển sang cuộc trò chuyện nhóm.
 * Lấy thông tin thành viên nhóm và gọi openChat. Cập nhật URL.
 * @param {string} groupId ID của nhóm.
 * @param {string} groupName Tên của nhóm.
 */
async function startGroupChat(groupId, groupName){
    // --- Xử lý chuyển trang cho mobile ---
    if (window.innerWidth <= 768) {
        window.location.href = `chat.html?chat_group=${groupId}`;
        return; // Dừng hàm ở đây cho mobile
    }
    // --- Kết thúc xử lý mobile ---

    // Thông báo Beta (nếu chưa hiện)
    if (!sessionStorage.getItem('groupBetaWarningShown')) {
        showToast('Tính năng Nhóm đang trong giai đoạn thử nghiệm (Beta)...');
        sessionStorage.setItem('groupBetaWarningShown', 'true');
    }

    // Reset trạng thái chat trực tiếp
    currentFriendUid = null;
    currentChatPeerData = null;

    // Lấy thông tin thành viên nhóm trước khi mở chat
    const groupRef = doc(db, "groups", groupId);
    const groupDoc = await getDoc(groupRef);
    if (groupDoc.exists()) {
        const groupData = groupDoc.data();
        const memberUids = groupData.member_uids || [];
        // Kiểm tra xem user hiện tại có còn là thành viên không
        if (!memberUids.includes(currentUser.uid)) {
             showToast("Bạn không còn là thành viên của nhóm này.", "error");
             // Có thể chuyển về trang chính hoặc làm gì đó khác
             // Ví dụ: reset UI chat
             if (currentChatId === groupId) {
                  currentChatFriendName.textContent = "Chọn cuộc trò chuyện";
                  messagesContainer.innerHTML = '';
                  messageInput.disabled = true; sendBtn.disabled = true;
                  currentChatId = null; currentChatType = null;
                  if(currentChatAvatar) currentChatAvatar.style.display = 'none';
                  if(groupInfoBtn) groupInfoBtn.style.display = 'none';
             }
             return; // Dừng nếu không còn là thành viên
        }

        // Lấy thông tin chi tiết các thành viên
        const memberPromises = memberUids.map(uid => getDoc(doc(db, "users", uid)));
        const memberDocs = await Promise.all(memberPromises);
        currentGroupMembers = memberDocs
            .filter(d => d.exists())
            .map(d => {
                const uData = d.data();
                // Cập nhật cache
                userCache[uData.uid] = { displayName: uData.displayName, avatarUrl: uData.avatarUrl, isVerified: uData.isVerified };
                return { uid: uData.uid, displayName: uData.displayName || uData.email, avatarUrl: uData.avatarUrl };
            });

        // Mở chat nhóm
        openChat({id:groupId, name:groupName, type:'group', isActive: true});

        // Cập nhật URL (chỉ trên PC)
        history.replaceState(null, '', `?chat_group=${groupId}`);
    } else {
        showToast("Nhóm không tồn tại.", "error");
        // Reset UI nếu nhóm không tồn tại
        if (currentChatId === groupId) {
             currentChatFriendName.textContent = "Chọn cuộc trò chuyện";
             messagesContainer.innerHTML = '';
             messageInput.disabled = true; sendBtn.disabled = true;
             currentChatId = null; currentChatType = null;
             if(currentChatAvatar) currentChatAvatar.style.display = 'none';
             if(groupInfoBtn) groupInfoBtn.style.display = 'none';
        }
    }
}

/**
 * Hàm cốt lõi để mở giao diện chat, reset UI, gắn listener mới.
 * Được gọi bởi startDirectChat và startGroupChat.
 * Cập nhật header với tên (có gradient nếu verified), avatar, và trạng thái Last Seen.
 * @param {object} chat Object chứa id, name, type ('direct'/'group'), isActive.
 */
function openChat(chat) {
    console.log("Opening chat:", chat); // Log để debug
    // <<< THÊM 3 DÒNG NÀY VÀO ĐẦU HÀM >>>
    const placeholder = document.getElementById('chat-window-placeholder');
    if (placeholder) placeholder.style.display = 'none';
    if (messagesContainer) messagesContainer.style.display = 'flex';

    // --- 1. NGẮT KẾT NỐI CŨ ---
    // Hủy listener tin nhắn cũ
    if (msgsUnsub) {
        try { msgsUnsub(); console.log(`Unsubscribed messages for ${currentChatId}`); } catch(e){ console.warn("Error unsubscribing messages:", e); }
        msgsUnsub = null;
    }
    // Hủy listener typing cũ
    if (typingUnsub) {
        try { typingUnsub(); console.log(`Unsubscribed typing for ${currentChatId}`); } catch(e){ console.warn("Error unsubscribing typing:", e); }
        typingUnsub = null;
    }
    // Hủy listener status cũ (quan trọng)
    if (currentStatusUnsub) {
        try { currentStatusUnsub(); console.log(`Unsubscribed status for ${currentFriendUid}`); } catch(e){ console.warn("Error unsubscribing status:", e); }
        currentStatusUnsub = null;
    }

    // --- 2. RESET TRẠNG THÁI & UI ---
    lastMessageDate = null;          // Reset ngày của tin nhắn cuối
    currentChatId = chat.id;         // Cập nhật ID chat hiện tại
    currentChatType = chat.type;     // Cập nhật loại chat
    // currentGroupMembers đã được cập nhật trong startGroupChat nếu là group
    if (messagesContainer) messagesContainer.innerHTML = ''; // Xóa tin nhắn cũ
    if (typingIndicator) typingIndicator.textContent = '';     // Xóa trạng thái gõ phím
    if (chatInfoPanel) chatInfoPanel.classList.remove('open'); // Đóng panel thông tin
    cancelReply(); cancelEdit(); cancelImagePreview();        // Hủy các trạng thái preview

    // Lấy element hiển thị last seen và reset nó
    const lastSeenElement = document.getElementById('chat-header-last-seen');
    if (lastSeenElement) lastSeenElement.textContent = '';
    // Ẩn phần thông tin người lạ (quan trọng khi chuyển chat)
    if (peerInfoExtra) peerInfoExtra.style.display = 'none';

    // --- 3. CẬP NHẬT HEADER CHAT ---
    // Kiểm tra các element header tồn tại
    if (currentChatFriendName && currentChatAvatar && openInfoBtn && groupInfoBtn) {
        // Lấy tên hiển thị (ưu tiên nickname)
        const chatDisplayName = (chat.type === 'direct' && currentFriendUid && currentUserData.nicknames?.[currentFriendUid])
                                ? currentUserData.nicknames[currentFriendUid]
                                : chat.name;

        // Xử lý tên và hiệu ứng gradient
        currentChatFriendName.classList.remove('gradient-text'); // Xóa class cũ
        const isPeerVerified = chat.type === 'direct' && currentChatPeerData?.isVerified; // Check verified
        if (isPeerVerified) {
            currentChatFriendName.classList.add('gradient-text'); // Thêm class nếu verified
        }
        currentChatFriendName.innerHTML = escapeHtml(chatDisplayName); // Cập nhật tên (không có tick)

        // Thêm tick xanh vào sau tên (nếu có)
        const verifiedTickHTML = createVerifiedTickHTML(isPeerVerified);
        currentChatFriendName.innerHTML += verifiedTickHTML; // Nối chuỗi HTML tick

        // Cập nhật Avatar Header và các nút Info
        if (chat.type === 'direct' && currentChatPeerData) { // Chat trực tiếp
            currentChatAvatar.src = currentChatPeerData.avatarUrl || `https://placehold.co/40x40/EFEFEF/333?text=${escapeHtml(chatDisplayName[0])}`;
            currentChatAvatar.style.display = 'block';
            currentChatAvatar.onclick = () => { if (currentFriendUid) window.open(`profile.html?id=${currentFriendUid}`, '_blank'); };
            groupInfoBtn.style.display = 'none';
            openInfoBtn.style.display = 'block';
            openInfoBtn.onclick = () => { if (currentFriendUid) { showFriendInfo(currentFriendUid); if (chatInfoPanel) chatInfoPanel.classList.add('open'); } };
            // currentFriendUid đã được gán trong startDirectChat
        } else if (chat.type === 'group') { // Chat nhóm
            getDoc(doc(db, "groups", chat.id)).then(groupDoc => { // Lấy avatar nhóm
                let avatarSrc = `https://placehold.co/40x40/1e293b/fff?text=${escapeHtml(chat.name[0])}`;
                if (groupDoc.exists()) { const groupData = groupDoc.data(); avatarSrc = groupData.avatarUrl || avatarSrc; }
                currentChatAvatar.src = avatarSrc;
            }).catch(err => console.error("Error fetching group avatar:", err));
            currentChatAvatar.style.display = 'block';
            currentChatAvatar.onclick = null; // Không cần click avatar nhóm
            openInfoBtn.style.display = 'none';
            groupInfoBtn.style.display = 'block';
            groupInfoBtn.onclick = () => { showGroupInfo(chat.id); if (chatInfoPanel) chatInfoPanel.classList.add('open'); };
            currentFriendUid = null; // Reset friendUid
        } else { // Trạng thái chờ (chưa chọn chat)
            currentChatFriendName.textContent = "Chọn cuộc trò chuyện";
            currentChatAvatar.style.display = 'none';
            openInfoBtn.style.display = 'none';
            groupInfoBtn.style.display = 'none';
            currentFriendUid = null;
        }
    } else {
        console.error("Missing header elements for openChat!");
    }

  // --- XỬ LÝ LISTENER STATUS MỚI (ẨN HOÀN TOÀN) ---
            if (chat.type === 'direct' && currentFriendUid && lastSeenElement) {
                const statusRef = ref(rtdb, `/status/${currentFriendUid}`);
                if (currentStatusUnsub) { try { currentStatusUnsub(); } catch(e){} currentStatusUnsub = null;}

                currentStatusUnsub = onValue(statusRef, (snap) => {
                    const statusData = snap.val() || { isOnline: false, last_seen: null };

                    // Lấy cài đặt ẩn của CẢ HAI NGƯỜI
                    const iAmHidingStatus = currentUserData.hideOnlineStatus === true;
                    const peerIsHidingStatus = currentChatPeerData?.hideOnlineStatus === true; // Lấy từ data người kia

                    // --- LOGIC MỚI: ẨN HOÀN TOÀN ---
                    // Nếu MỘT TRONG HAI người (cậu hoặc họ) bật chế độ ẩn
                    // thì KHÔNG hiển thị bất kỳ thông tin trạng thái nào.
                    if (iAmHidingStatus || peerIsHidingStatus) {
                        lastSeenElement.textContent = ''; // Xóa sạch, không hiển thị gì
                        return; // Dừng hàm onValue tại đây
                    }
                    // --- KẾT THÚC LOGIC ẨN HOÀN TOÀN ---

                    // Chỉ chạy phần còn lại nếu CẢ HAI ĐỀU KHÔNG ẨN
                    const displayAsOnline = statusData.isOnline; // Giờ chỉ cần check status của người kia
                    const showDetailedRecency = true; // Luôn hiện chi tiết nếu không ai ẩn

                    // Format chuỗi trạng thái
                    const statusString = formatLastSeen(displayAsOnline, statusData.last_seen, showDetailedRecency);

                    // Cập nhật UI
                    lastSeenElement.textContent = statusString;

                }, (error) => { // Xử lý lỗi
                    console.error(`Error listening to status ${currentFriendUid}:`, error);
                    lastSeenElement.textContent = "Lỗi tải trạng thái";
                    if (currentStatusUnsub) { try { currentStatusUnsub(); } catch(e){} currentStatusUnsub = null; }
                });

            } else if (lastSeenElement) { // Nếu là group chat hoặc thiếu element
                lastSeenElement.textContent = ''; // Ẩn trạng thái
                if (currentStatusUnsub) { try { currentStatusUnsub(); } catch(e){} currentStatusUnsub = null;}
            }
            // --- KẾT THÚC XỬ LÝ STATUS ---

    // --- 5. KÍCH HOẠT/VÔ HIỆU HÓA INPUT ---
    if (chatInputContainer && inactiveChatIndicator && messageInput) {
        if (chat.isActive) {
            chatInputContainer.style.display = 'flex';
            inactiveChatIndicator.style.display = 'none';
            messageInput.disabled = false;
            messageInput.placeholder = "Nhập tin nhắn...";
            if (!chatInfoPanel || !chatInfoPanel.classList.contains('open')) {
                setTimeout(() => messageInput.focus(), 50); // Delay focus
            }
        } else {
            chatInputContainer.style.display = 'none';
            inactiveChatIndicator.style.display = 'block';
            // inactiveChatIndicator.textContent đã được cập nhật trong startDirectChat
        }
    } else {
        console.error("Missing input area elements for openChat!");
    }

    // --- 6. GẮN LISTENER TYPING ---
    if (typingIndicator) {
        const typingRef = ref(rtdb, `/typing/${chat.id}`);
        typingUnsub = onValue(typingRef, (snap) => {
            const obj = snap.val() || {}; const othersTyping = Object.keys(obj).filter(uid => obj[uid] && uid !== currentUser.uid);
            if (othersTyping.length > 0) { if (chat.type === 'direct') typingIndicator.textContent = 'Đang nhập...'; else { const typerNames = othersTyping.map(uid => currentGroupMembers.find(m => m.uid === uid)?.displayName?.split(' ')[0] || userCache[uid]?.displayName?.split(' ')[0] ||'Ai đó').filter(Boolean); const maxNamesToShow = 2; const displayNames = typerNames.slice(0, maxNamesToShow).join(', '); const remainingCount = typerNames.length - maxNamesToShow; typingIndicator.textContent = `${displayNames}${remainingCount > 0 ? ` và ${remainingCount} người khác` : ''} đang nhập...`; } }
            else typingIndicator.textContent = '';
            if (messagesContainer) { const shouldScrollTyping = messagesContainer.scrollHeight - messagesContainer.scrollTop < messagesContainer.clientHeight + 100; if (typingIndicator.textContent && shouldScrollTyping) setTimeout(() => { messagesContainer.scrollTop = messagesContainer.scrollHeight; }, 50); }
        });
    } else {
        console.error("Typing indicator element not found!");
    }

    // --- 7. GẮN LISTENER MESSAGES ---
    if (messagesContainer) {
        const msgsRef = ref(rtdb, `/messages/${chat.id}`);
        const initialLoadQuery = rtdbQuery(msgsRef, orderByChild('timestamp'), limitToLast(50)); // Tải 50 tin nhắn cuối

        get(initialLoadQuery).then(snap => {
            messagesContainer.innerHTML = ''; // Xóa trước khi render
            currentChatImages = []; // Reset ảnh khi load lại
            if (snap.exists()) {
                const messagesArray = []; snap.forEach(childSnap => { messagesArray.push({ key: childSnap.key, data: childSnap.val() }); });
                // messagesArray.sort((a, b) => a.data.timestamp - b.data.timestamp); // Sort nếu cần
                messagesArray.forEach(msgObj => {
                     renderMessage(msgObj.key, msgObj.data, chat);
                     if (msgObj.data.imageUrl && !msgObj.data.recalled) currentChatImages.push({ url: msgObj.data.imageUrl, key: msgObj.key });
                });
            } else { messagesContainer.innerHTML = '<div style="text-align: center; color: var(--text-2); padding: 20px;">Chưa có tin nhắn nào.</div>'; }
            console.log("Current Chat Images after initial load:", currentChatImages);

            // Chỉ lắng nghe tin nhắn mới nhất và thay đổi sau initial load
            const newMsgsQuery = rtdbQuery(msgsRef, orderByChild('timestamp'), limitToLast(1));
            const unsubChildAdded = onChildAdded(newMsgsQuery, (snap) => { const key = snap.key; const msgData = snap.val(); if (!document.querySelector(`.msg-wrapper[data-key="${key}"]`)) { renderMessage(key, msgData, chat); if (msgData.imageUrl && !msgData.recalled) { currentChatImages.push({ url: msgData.imageUrl, key: key }); console.log("Added new image:", currentChatImages); } } });
            const unsubChildChanged = onChildChanged(msgsRef, (snap) => { const key = snap.key; const msgData = snap.val(); renderMessage(key, msgData, chat); if (msgData.recalled) { const idx = currentChatImages.findIndex(img => img.key === key); if (idx > -1) { currentChatImages.splice(idx, 1); console.log("Removed recalled image:", currentChatImages); if (imageLightbox.classList.contains('show') && currentLightboxIndex === idx) { closeLightbox(); showToast("Ảnh bạn đang xem đã bị thu hồi.", "info"); } else if (imageLightbox.classList.contains('show') && currentLightboxIndex > idx) { currentLightboxIndex--; } } } });
            msgsUnsub = () => { off(newMsgsQuery,'child_added', unsubChildAdded); off(msgsRef, 'child_changed', unsubChildChanged); };
            setTimeout(() => { messagesContainer.scrollTop = messagesContainer.scrollHeight; }, 150);
        }).catch(error => { console.error("Error loading initial messages:", error); messagesContainer.innerHTML = '<div style="text-align: center; color: red; padding: 20px;">Lỗi tải tin nhắn!</div>'; });
    } else {
        console.error("Messages container element not found!");
        showChatPlaceholder();
    }

    // --- 8. GẮN LẠI EVENT CHO IMAGE INPUT ---
    if (imageInput) {
        imageInput.onchange = handleImageSelection;
    }
}

// --- PHẦN 7: RENDER TIN NHẮN & GỬI TIN NHẮN ---

/**
 * Render một tin nhắn lên giao diện hoặc cập nhật tin nhắn đã có.
 * @param {string} key ID của tin nhắn.
 * @param {object} m Dữ liệu tin nhắn từ Firebase.
 * @param {object} chatCtx Thông tin về cuộc trò chuyện hiện tại {id, type}.
 */
function renderMessage(key, m, chatCtx) {
    // 1. Kiểm tra điều kiện thoát sớm (bị chặn, tin nhắn null)
    if (!currentUserData || currentUserData.blocked?.includes(m?.senderId)) return;
    if (!m) {
        const elToRemove = document.querySelector(`.msg-wrapper[data-key="${key}"]`);
        if (elToRemove) elToRemove.remove();
        return;
    }

    const isSent = m.senderId === currentUser.uid;

    // 2. Cập nhật tiêu đề tab nếu có tin nhắn mới khi tab ẩn
    if (!isSent && document.hidden) {
        unreadCount++;
        document.title = `(${unreadCount}) ${originalTitle}`;
    }

    // 3. Lấy hoặc tạo element .msg-wrapper
    let existingEl = document.querySelector(`.msg-wrapper[data-key="${key}"]`);
    const isNewMessage = !existingEl;
    if (isNewMessage) {
        existingEl = document.createElement('div');
        existingEl.className = 'msg-wrapper';
        existingEl.dataset.key = key;
    }

    // 4. Kiểm tra mention và thêm class highlight
    let isMentioned = m.mentions?.includes(currentUser.uid) || m.mentions?.includes('all');
    existingEl.classList.toggle('mentioned-me', isMentioned);

    // 5. Render dải phân cách ngày (chỉ khi là tin mới)
    if (isNewMessage && m.timestamp && messagesContainer) {
        const messageDate = new Date(m.timestamp).toLocaleDateString('vi-VN');
        if (messageDate !== lastMessageDate) {
            const separator = document.createElement('div');
            separator.className = 'message-date-separator';
            separator.textContent = (messageDate === new Date().toLocaleDateString('vi-VN')) ? 'Hôm nay' : messageDate;
            // Chèn vào trước existingEl nếu nó đã có trong DOM, ngược lại append
            if (existingEl.parentNode === messagesContainer) {
                messagesContainer.insertBefore(separator, existingEl);
            } else {
                messagesContainer.appendChild(separator); // Lần đầu
            }
            lastMessageDate = messageDate;
        }
    }

    // 6. Gắn element vào giao diện (nếu là tin mới)
    if (isNewMessage && messagesContainer) {
        messagesContainer.appendChild(existingEl);
    }

    // 7. Tạo HTML cho nội dung tin nhắn
    existingEl.classList.toggle('sent', isSent);
    existingEl.classList.toggle('received', !isSent);

    // -- Avatar --
    let avatarHtml = '';
    if (!isSent) {
        let avatarUrl = ''; let senderUid = '';
        if (chatCtx.type === 'direct' && currentChatPeerData) {
            avatarUrl = currentChatPeerData.avatarUrl || `https://placehold.co/32x32/EFEFEF/333?text=${(currentChatPeerData.displayName || '?')[0]}`;
            senderUid = currentChatPeerData.uid;
        } else if (chatCtx.type === 'group') {
            const member = currentGroupMembers.find(mem => mem.uid === m.senderId) || userCache[m.senderId]; // Fallback to cache
            avatarUrl = member?.avatarUrl || `https://placehold.co/32x32/1e293b/fff?text=${m.senderName ? m.senderName[0].toUpperCase() : '?'}`;
            senderUid = m.senderId;
        }
        if (avatarUrl) avatarHtml = `<img src="${avatarUrl}" class="msg-avatar" data-uid="${senderUid}" alt="Avatar">`;
    }

    // -- Tên người gửi (group chat) --
    let senderNameHtml = '';
    if (!isSent && chatCtx.type === 'group') {
        senderNameHtml = `<div class="msg-sender-name">${escapeHtml(m.senderName) || '...'}</div>`;
    }

    // -- Bong bóng chat --
    let msgBubbleHtml = '';
    if (m.recalled) {
        msgBubbleHtml = `<div class="msg recalled-message">Tin nhắn đã được thu hồi</div>`;
    } else {
        let content = `<div class="msg ${isSent ? 'sent' : ''}" data-sender-name="${escapeHtml(m.senderName || '')}">`; // Lưu tên để reply

        // Quote trả lời
        if (m.replyTo) {
            const repliedWrapper = document.querySelector(`.msg-wrapper[data-key="${m.replyTo}"]`);
            if (repliedWrapper) {
                const repliedEl = repliedWrapper.querySelector('.msg');
                if (repliedEl && !repliedEl.classList.contains('recalled-message')) {
                    const origSender = repliedEl.dataset.senderName || '...';
                    const origText = repliedEl.querySelector('.msg-text')?.textContent || (repliedEl.querySelector('img') ? 'Ảnh' : '...');
                    content += `<div class="reply-quote"><div class="sender">Trả lời ${escapeHtml(origSender)}</div><div class="text">${escapeHtml(origText)}</div></div>`;
                } else content += `<div class="reply-quote"><div class="sender">Trả lời tin nhắn đã thu hồi</div></div>`;
            } else {
                 content += `<div class="reply-quote"><div class="sender">Trả lời tin nhắn không còn tồn tại</div></div>`; // Fallback nếu không tìm thấy tin nhắn gốc
            }
        }

        // Text và mention
        // Text, mention, và LINK
        let msgTextHtml = '';
        if (m.text) {
            let escaped = escapeHtml(m.text); // 1. Escape HTML trước

            // 2. Xử lý mentions (như cũ)
            if (m.mentions && chatCtx.type === 'group') {
                const membersSorted = [...currentGroupMembers, ...(Object.values(userCache))].sort((a, b) => (b.displayName || '').length - (a.displayName || '').length);
                escaped = escaped.replace(/@all/g, '<span class="mention">@all</span>');
                membersSorted.forEach(mem => {
                    if (!mem || !mem.displayName) return;
                    const escName = escapeHtml(`@${mem.displayName}`);
                    const rgx = new RegExp(`(?<![\\w.-])(${escName.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})(?![\\w.-])`, 'g');
                    if (m.mentions.includes(mem.uid)) {
                       escaped = escaped.replace(rgx, `<span class="mention">@${mem.displayName}</span>`);
                    }
                });
            }

            // 3. TÌM VÀ THAY THẾ LINK (ĐOẠN MỚI)
            // Regex để tìm URL (khá cơ bản, có thể cải thiện nếu cần)
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            let processedText = escaped.replace(urlRegex, function(url) {
                let displayUrl = url;
                let fullUrl = url;
                // Nếu link bắt đầu bằng www. thì thêm http:// vào href
                if (!url.match(/^[a-zA-Z]+:\/\//)) {
                    fullUrl = 'http://' + url;
                }
                // Tạo thẻ <a>
                return `<a href="${escapeHtml(fullUrl)}" target="_blank" class="message-link">${escapeHtml(displayUrl)}</a>`;
            });

            // 4. Gán HTML cuối cùng
            msgTextHtml = `<div class="msg-text">${processedText}</div>`; // Thay escaped bằng processedText
        }
        content += msgTextHtml;

        // Ảnh
        if (m.imageUrl) {
         // Thêm data-key vào ảnh để openLightbox có thể tìm index
         content += `<img src="${m.imageUrl}" alt="Ảnh đã gửi" data-key="${key}" style="cursor: pointer;"/>`;
    }
        // Timestamp & Edited
        if (m.timestamp) {
            const d = new Date(m.timestamp);
            const hm = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            const edited = m.edited ? `<span class="edited-label">(sửa)</span>` : '';
            content += `<div class="msg-meta">${hm}${edited}</div>`;
        }

        // Trạng thái Đã gửi/Đã xem
        if (isSent) {
            let status = 'Đã gửi';
            if (chatCtx.type === 'direct') {
                const peerUid = chatCtx.id.split('_').find(id => id !== currentUser.uid);
                if (m.readBy?.[peerUid]) status = 'Đã xem';
            } else if (m.readBy && Object.keys(m.readBy).length > 1) { // Group: xem bởi > 1 người (là mình)
                status = 'Đã xem';
            }
            content += `<div class="msg-status">${status}</div>`;
        }
        content += `</div>`; // Đóng thẻ div.msg
        msgBubbleHtml = content;
    }

    // 8. GHÉP HTML HOÀN CHỈNH
    existingEl.innerHTML = `
        ${avatarHtml}
        <div class="msg-content-wrapper">
            ${senderNameHtml}
            ${msgBubbleHtml}
            </div>
    `; // Chú ý: Bỏ reaction-picker khỏi đây

    // 9. RENDER REACTION PICKER & DISPLAY (Luôn tạo mới/cập nhật)
    let picker = existingEl.querySelector('.reaction-picker');
    const msgContentWrapper = existingEl.querySelector('.msg-content-wrapper'); // Khối chứa bubble chat

    if (!m.recalled && msgContentWrapper) { // Chỉ thêm picker nếu chưa thu hồi
        if (!picker) {
            picker = createReactionPicker(key); // Tạo picker
            msgContentWrapper.appendChild(picker); // Gắn vào wrapper
        }
        // Cập nhật lại vị trí picker nếu cần (sent/received)
        picker.style.top = '-45px'; // Reset vị trí top
        if (isSent) { picker.style.right = '10px'; picker.style.left = 'auto'; }
        else { picker.style.left = '10px'; picker.style.right = 'auto'; }

        // Render Reactions Display
        const reactions = m.reactions || {};
        let reactionsDisplay = existingEl.querySelector('.reactions-display');
        if (Object.keys(reactions).length > 0) {
            if (!reactionsDisplay) {
                reactionsDisplay = document.createElement('div');
                reactionsDisplay.className = 'reactions-display';
                msgContentWrapper.appendChild(reactionsDisplay);
            }
            let reactionsHTML = '';
            for (const emoji in reactions) {
                let count = (emoji === '❤️') ? Object.values(reactions[emoji]).reduce((s, v) => s + (typeof v === 'number' ? v : 1), 0) : Object.keys(reactions[emoji]).length;
                if (count > 0) reactionsHTML += `<span>${emoji} ${count}</span>`;
            }
            reactionsDisplay.innerHTML = reactionsHTML;
            reactionsDisplay.onclick = (e) => { e.stopPropagation(); showReactionsDetails(key); };
             // Cập nhật vị trí display
            if (isSent) { reactionsDisplay.style.right = '10px'; reactionsDisplay.style.left = 'auto'; }
            else { reactionsDisplay.style.left = '0px'; reactionsDisplay.style.right = 'auto'; }

        } else if (reactionsDisplay) {
            reactionsDisplay.remove(); // Xóa display nếu không còn reaction
        }
    } else { // Nếu bị thu hồi
         if (picker) picker.remove(); // Xóa picker
         let reactionsDisplay = existingEl.querySelector('.reactions-display');
         if (reactionsDisplay) reactionsDisplay.remove(); // Xóa display
    }

    // 10. GÁN LẠI CÁC SỰ KIỆN KHÁC
    const imageInMessage = existingEl.querySelector('.msg img');
    if (imageInMessage) {
    // Đảm bảo dataset.key tồn tại trên thẻ img
    if (imageInMessage.dataset.key) {
         imageInMessage.onclick = () => openLightbox(imageInMessage.src, imageInMessage.dataset.key);
    } else {
         console.error("Image in message is missing data-key:", key);
         // Fallback: Mở ảnh mà không có navigation
         imageInMessage.onclick = () => openLightbox(imageInMessage.src, null);
    }
}
    const avatarInMessage = existingEl.querySelector('.msg-avatar');
    if (avatarInMessage?.dataset.uid) avatarInMessage.onclick = () => window.open(`profile.html?id=${avatarInMessage.dataset.uid}`, '_blank');
    existingEl.onclick = () => { // Xử lý chọn tin nhắn bằng chứng
        if (messagesContainer?.classList.contains('selection-mode')) {
            const messageData = { key, ...m };
            const index = selectedEvidence.findIndex(e => e.key === key);
            if (index > -1) { selectedEvidence.splice(index, 1); existingEl.classList.remove('selected'); }
            else { selectedEvidence.push(messageData); existingEl.classList.add('selected'); }
            updateSelectionCount();
        }
    };

    // 11. CẬP NHẬT TRẠNG THÁI "ĐÃ ĐỌC"
    if (!isSent && (!m.readBy || !m.readBy[currentUser.uid])) {
        rtdbUpdate(ref(rtdb, `/messages/${chatCtx.id}/${key}/readBy`), { [currentUser.uid]: true });
    }

    // 12. TỰ ĐỘNG CUỘN XUỐNG DƯỚI
    if (messagesContainer) { // Check messagesContainer tồn tại
        const shouldScroll = messagesContainer.scrollHeight - messagesContainer.scrollTop < messagesContainer.clientHeight + 150 || isSent || isNewMessage;
        if (shouldScroll) {
            setTimeout(() => { messagesContainer.scrollTop = messagesContainer.scrollHeight; }, 50);
        }
    }
}

/**
 * Gửi tin nhắn mới hoặc lưu tin nhắn đã chỉnh sửa.
 * Kiểm tra nội dung vi phạm trước khi gửi. Nếu vi phạm, tăng cảnh báo và không gửi.
 */
async function sendMessage() {
    const text = messageInput ? messageInput.value.trim() : '';
    if (!currentChatId || (!text && !selectedImageFile && !isEditing) || (sendBtn && sendBtn.classList.contains('loading'))) {
        return;
    }

    // --- KIỂM TRA NỘI DUNG VI PHẠM (CHỈ KHI GỬI MỚI) ---
    if (!isEditing && text) {
        const triggerKeywords = ["lôn dũng", "chó dũng", "ái phương", "ái phương đẹp quá", "ái phương đẹp ghê"]; // <<< THAY LIST TỪ KHÓA KÍCH HOẠT
        const forbiddenPraiseTopics = ["ái phương đẹp quá", "ái phương đẹp ghê"]; // <<< THAY LIST CHỦ ĐỀ CẤM KHEN
        const lowerCaseText = text.toLowerCase();

        const hasTriggerKeyword = triggerKeywords.some(k => lowerCaseText.includes(k.toLowerCase()));
        // Kiểm tra "khen" rất cơ bản, có thể sai:
        const seemsLikeForbiddenPraise = forbiddenPraiseTopics.some(topic => lowerCaseText.includes(topic.toLowerCase()) && (lowerCaseText.includes("đẹp") || lowerCaseText.includes("tuyệt") || lowerCaseText.includes("thích"))); // <<< CẦN CẢI THIỆN

        if (hasTriggerKeyword /* && seemsLikeForbiddenPraise */ ) { // Tạm bỏ check khen cho đỡ phức tạp
            console.warn("Potential violation detected:", currentUser.uid, text);

            try {
                const userRef = doc(db, 'users', currentUser.uid);
                // Lấy warning count mới nhất phòng trường hợp client bị stale
                const userSnap = await getDoc(userRef);
                const currentWarnings = userSnap.exists() ? (userSnap.data().warningCount || 0) : 0;
                const newWarningCount = currentWarnings + 1;

                // Cập nhật warning count lên Firestore
                await updateDoc(userRef, {
                    warningCount: newWarningCount
                });

                // Cập nhật local data
                currentUserData.warningCount = newWarningCount;

                // Hiển thị cảnh báo
                showToast(`Cảnh báo ${newWarningCount}/3: Nội dung không phù hợp. Vui lòng tuân thủ quy định.`, "error");

                // Nếu đủ 3 cảnh báo -> Đăng xuất luôn
                if (newWarningCount >= 3) {
                     showToast("Bạn đã nhận đủ 3 cảnh báo. Tài khoản sẽ bị tạm khóa.", "error");
                     // Đợi 1 chút để user đọc toast rồi mới đăng xuất
                     setTimeout(async () => {
                          await signOut(auth);
                          window.location.href = 'login.html';
                     }, 3000); // 3 giây
                }

            } catch (warningError) {
                console.error("Error updating warning count:", warningError);
                showToast("Lỗi xử lý cảnh báo.", "error");
                // Có thể vẫn cho gửi nếu xử lý cảnh báo lỗi? Hoặc vẫn chặn? -> Vẫn chặn cho an toàn
            }

            // KHÔNG GỬI TIN NHẮN NÀY ĐI
            // Reset input nhưng giữ lại text để user sửa
            if (sendBtn) { sendBtn.classList.remove('loading'); sendBtn.disabled = false; }
            if (messageInput) messageInput.disabled = false;
            handleTextInput(); // Cập nhật lại trạng thái nút gửi
            return; // Dừng hàm sendMessage
        }
    }
    // --- KẾT THÚC KIỂM TRA VI PHẠM ---


    // --- Bắt đầu Loading (nếu không vi phạm) ---
    if (sendBtn) { sendBtn.classList.add('loading'); sendBtn.disabled = true; }
    if (messageInput) messageInput.disabled = true;

    try {
        // ... (Phần còn lại của sendMessage: upload ảnh, gửi tin, gửi notif... giữ nguyên như code hoàn chỉnh lần trước) ...
         let imageUrl = null; if (selectedImageFile && !isEditing) imageUrl = await uploadImage(selectedImageFile);
         if (isEditing && editingMessageKey) { const msgRef = ref(rtdb, `/messages/${currentChatId}/${editingMessageKey}`); const updateData = { text: text || null, edited: true, timestamp: dbServerTimestamp() }; await rtdbUpdate(msgRef, updateData); console.log(`Message ${editingMessageKey} edited.`); cancelEdit(); }
         else { let mentions = []; if (currentChatType === 'group' && text) { const rgx = /@(\S+)/g; let match; while ((match = rgx.exec(text)) !== null) { const uname = match[1]; if (uname === 'all') { if (!mentions.includes('all')) mentions.push('all'); } else { const member = currentGroupMembers.find(m => m.displayName === uname) || Object.values(userCache).find(u => u.displayName === uname); if (member && !mentions.includes(member.uid)) mentions.push(member.uid); } } } const newMsgPayload = { senderId: currentUser.uid, senderName: currentUserData.displayName || currentUser.email.split('@')[0], text: text || null, imageUrl: imageUrl, timestamp: Date.now(), readBy: { [currentUser.uid]: true }, replyTo: replyingTo ? replyingTo.key : null, mentions: mentions.length > 0 ? mentions : null }; const newMsgRef = push(ref(rtdb, `/messages/${currentChatId}`)); const newMsgKey = newMsgRef.key; const updates = {}; updates[`/messages/${currentChatId}/${newMsgKey}`] = newMsgPayload; const notifPayload = { from: newMsgPayload.senderName, avatar: currentUserData.avatarUrl, preview: newMsgPayload.text || "Đã gửi một ảnh", chatId: currentChatId, chatType: currentChatType, senderId: currentUser.uid }; if (currentChatType === 'direct') { const recipientId = currentFriendUid; if (recipientId) { const recipientDoc = await getDoc(doc(db, 'users', recipientId)); const recipientData = recipientDoc.exists() ? recipientDoc.data() : {}; if (!recipientData.mutedChats?.[currentChatId]) updates[`/notifications/${recipientId}/${newMsgKey}`] = notifPayload; } } else if (currentChatType === 'group') { const groupRef = doc(db, 'groups', currentChatId); const groupDoc = await getDoc(groupRef); const memberUids = groupDoc.exists() ? groupDoc.data().member_uids || [] : []; for (const recipientId of memberUids) { if (recipientId === currentUser.uid) continue; const recipientDoc = await getDoc(doc(db, 'users', recipientId)); const recipientData = recipientDoc.exists() ? recipientDoc.data() : {}; if (!recipientData.mutedChats?.[currentChatId]) updates[`/notifications/${recipientId}/${newMsgKey}`] = notifPayload; } } if (Object.keys(updates).length > 0) await rtdbUpdate(ref(rtdb), updates); console.log(`New message ${newMsgKey} sent.`); if (messageInput) messageInput.value = ''; if (chatInputContainer) chatInputContainer.classList.remove('has-text'); cancelImagePreview(); cancelReply(); clearTimeout(typingTimer); set(ref(rtdb, `/typing/${currentChatId}/${currentUser.uid}`), false); }

    } catch (e) {
        console.error("Lỗi khi gửi/sửa tin nhắn:", e);
        showToast(`Gửi tin nhắn thất bại: ${e.message}`, 'error');
    } finally {
        // --- Kết thúc Loading ---
        if (sendBtn) { sendBtn.classList.remove('loading'); sendBtn.disabled = false; }
        if (messageInput) { messageInput.disabled = false; }
        handleTextInput(); // Cập nhật lại trạng thái nút gửi
    }
}

/**
 * Xử lý khi người dùng từ chối lời mời kết bạn.
 * Cập nhật trạng thái lời mời thành 'declined'.
 * @param {string} reqId ID của document lời mời kết bạn.
 */
async function handleRejectFriend(reqId) {
    if (!reqId) return; // Kiểm tra reqId
    const reqRef = doc(db, 'friend_requests', reqId);

    try {
        // Cập nhật trạng thái lời mời thành 'declined'
        await updateDoc(reqRef, { status: 'declined' });
        showToast('❌ Đã từ chối lời mời.');
        // Danh sách lời mời sẽ tự cập nhật nhờ onSnapshot trong loadFriendRequests
        // Đóng modal lời mời nếu đang mở
        if (friendReqModal) friendReqModal.style.display = 'none';

    } catch (error) {
        console.error("Lỗi khi từ chối lời mời:", error);
        showToast("Có lỗi xảy ra khi từ chối lời mời.", "error");
    }
}

/**
 * Xử lý khi người dùng chấp nhận lời mời kết bạn.
 * Cập nhật trạng thái lời mời thành 'accepted' và thêm bạn bè cho cả hai người.
 * @param {string} reqId ID của document lời mời kết bạn.
 * @param {string} fromUid UID của người gửi lời mời.
 */
async function handleAcceptFriend(reqId, fromUid) {
    if (!reqId || !fromUid || !currentUser) return; // Kiểm tra dữ liệu
    const reqRef = doc(db, 'friend_requests', reqId);
    const currentUserRef = doc(db, 'users', currentUser.uid);
    const senderUserRef = doc(db, 'users', fromUid);

    try {
        // Cập nhật trạng thái lời mời
        await updateDoc(reqRef, { status: 'accepted' });

        // Thêm bạn bè cho cả hai người (dùng arrayUnion để tránh trùng lặp)
        await updateDoc(currentUserRef, { friends: arrayUnion(fromUid) });
        await updateDoc(senderUserRef, { friends: arrayUnion(currentUser.uid) });

        showToast('Đã chấp nhận lời mời kết bạn!', 'success');
        // Danh sách lời mời sẽ tự cập nhật nhờ onSnapshot trong loadFriendRequests
        // Danh sách chat cũng sẽ tự cập nhật nhờ listener user trong loadAndSortChats
        // Đóng modal lời mời nếu đang mở
        if (friendReqModal) friendReqModal.style.display = 'none';

    } catch (error) {
        console.error("Lỗi khi chấp nhận lời mời:", error);
        showToast("Có lỗi xảy ra khi chấp nhận lời mời.", "error");
    }
}

/**
 * Upload ảnh lên ImgBB.
 * @param {File} file File ảnh cần upload.
 * @returns {Promise<string>} Promise trả về URL của ảnh đã upload.
 * @throws {Error} Nếu thiếu API key hoặc upload thất bại.
 */
async function uploadImage(file){
    if(!IMGBB_API_KEY) throw new Error('Thiếu API Key ImgBB');
    const fd = new FormData();
    fd.append('image', file);
    try {
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:'POST', body:fd});
        const data = await res.json();
        if(data.success) {
            console.log("Image uploaded:", data.data.url);
            return data.data.url; // Trả về URL ảnh
        } else {
            throw new Error(data.error?.message || 'Upload ảnh thất bại không rõ lý do.');
        }
    } catch (error) {
         console.error("ImgBB Upload Error:", error);
         throw new Error('Không thể upload ảnh: ' + error.message); // Ném lỗi để hàm sendMessage xử lý
    }
}

// --- PHẦN 8: TƯƠNG TÁC TIN NHẮN (MENU, RECALL, DELETE, REPLY, EDIT, PREVIEW) ---

/**
 * Hiển thị menu chuột phải cho tin nhắn.
 * @param {MouseEvent} e Sự kiện chuột phải.
 */
function showMessageContextMenu(e) {
    const wrapper = e.target.closest('.msg-wrapper'); // Tìm element .msg-wrapper gần nhất
    if (!wrapper || !wrapper.dataset.key || !messageContextMenu) return; // Thoát nếu không phải tin nhắn hoặc thiếu menu

    e.preventDefault(); // Ngăn menu mặc định của trình duyệt
    const msgKey = wrapper.dataset.key;
    const msgRef = ref(rtdb, `/messages/${currentChatId}/${msgKey}`);

    // Lấy dữ liệu tin nhắn mới nhất để tạo menu chính xác
    get(msgRef).then(snap => {
        if (!snap.exists()) return; // Tin nhắn đã bị xóa khỏi DB
        const msg = snap.val();
        messageContextMenu.innerHTML = ''; // Xóa các nút cũ

        // --- Nút Trả lời (luôn có nếu tin nhắn chưa bị thu hồi) ---
        if (!msg.recalled) {
            const btnReply = document.createElement('button');
            btnReply.className = 'context-menu-btn';
            btnReply.textContent = '↪️ Trả lời';
            btnReply.onclick = () => {
                replyToMessage(msgKey, msg);
                messageContextMenu.style.display = 'none'; // Ẩn menu sau khi chọn
            };
            messageContextMenu.appendChild(btnReply);
        }

        // --- Các nút chỉ dành cho người gửi ---
        if (msg.senderId === currentUser.uid) {
            // Nút Chỉnh sửa (chỉ cho tin nhắn text chưa thu hồi)
            if (msg.text && !msg.recalled) {
                const btnEdit = document.createElement('button');
                btnEdit.className = 'context-menu-btn';
                btnEdit.textContent = '✏️ Chỉnh sửa';
                btnEdit.onclick = () => {
                    startEditMessage(msgKey, msg);
                    messageContextMenu.style.display = 'none';
                };
                messageContextMenu.appendChild(btnEdit);
            }
            // Nút Thu hồi (chỉ trong 3 phút đầu và chưa thu hồi)
            const timeSinceSent = Date.now() - msg.timestamp;
            if (timeSinceSent < 3 * 60 * 1000 && !msg.recalled) {
                const btnRecall = document.createElement('button');
                btnRecall.className = 'context-menu-btn danger'; // Màu đỏ cảnh báo
                btnRecall.textContent = '🗑️ Thu hồi';
                btnRecall.onclick = () => {
                    recallMessage(msgKey);
                    messageContextMenu.style.display = 'none';
                };
                messageContextMenu.appendChild(btnRecall);
            }
        }

        // --- Nút Xóa ở phía bạn (luôn có) ---
        const btnDelete = document.createElement('button');
        btnDelete.className = 'context-menu-btn danger';
        btnDelete.textContent = '❌ Xóa ở phía bạn';
        btnDelete.onclick = () => {
            deleteMessageForSelf(msgKey);
            messageContextMenu.style.display = 'none';
        };
        messageContextMenu.appendChild(btnDelete);

        // Hiển thị menu tại vị trí chuột
        if (messageContextMenu.hasChildNodes()) { // Chỉ hiện nếu có ít nhất 1 nút
             messageContextMenu.style.display = 'block';
             // Tính toán vị trí để không bị tràn màn hình (đơn giản)
             const menuWidth = messageContextMenu.offsetWidth;
             const menuHeight = messageContextMenu.offsetHeight;
             let left = e.pageX;
             let top = e.pageY;
             if (left + menuWidth > window.innerWidth - 10) { left = window.innerWidth - menuWidth - 10; }
             if (top + menuHeight > window.innerHeight - 10) { top = window.innerHeight - menuHeight - 10; }
             messageContextMenu.style.left = `${left}px`;
             messageContextMenu.style.top = `${top}px`;
        }

    }).catch(error => console.error("Error getting message for context menu:", error));
}

/**
 * Thu hồi một tin nhắn (chỉ người gửi làm được).
 * Cập nhật trạng thái 'recalled' và xóa nội dung/ảnh/reply/reactions.
 * @param {string} key ID của tin nhắn cần thu hồi.
 */
function recallMessage(key) {
    if (!currentChatId || !key) return;
    const msgRef = ref(rtdb, `/messages/${currentChatId}/${key}`);
    // Cập nhật nhiều trường cùng lúc
    rtdbUpdate(msgRef, {
        text: null,
        imageUrl: null,
        recalled: true,
        replyTo: null,
        reactions: null, // Xóa reactions khi thu hồi
        edited: deleteField() // Xóa trạng thái edited nếu có
    }).catch(error => {
        console.error("Error recalling message:", error);
        showToast("Thu hồi thất bại!", "error");
    });
}

/**
 * Xóa một tin nhắn chỉ ở phía người dùng hiện tại (khỏi giao diện).
 * @param {string} key ID của tin nhắn cần xóa.
 */
function deleteMessageForSelf(key) {
    const elementToRemove = document.querySelector(`.msg-wrapper[data-key="${key}"]`);
    if (elementToRemove) {
        elementToRemove.remove(); // Xóa khỏi DOM
    }
}


// --- PHẦN 11 (tt): BLOCK/UNBLOCK USER ---

/**
 * Chặn một người dùng khác.
 * Cập nhật Firestore: thêm UID vào list blocked của mình, xóa bạn bè (cả 2 chiều).
 * @param {string} friendUid UID của người cần chặn.
 * @param {string} name Tên hiển thị của người cần chặn (để confirm).
 */
async function blockUser(friendUid, name) {
    if (!currentUser || !friendUid) return;
    const confirmed = await showConfirmation(`Chặn ${escapeHtml(name)}? Bạn sẽ không nhận được tin nhắn từ họ nữa và họ sẽ bị xóa khỏi danh sách bạn bè (nếu có).`);
    if (confirmed) {
        // Lấy nút trong panel info (nếu đang mở)
        const blockBtnPanel = document.getElementById('block-user-btn');
        const unblockBtnPanel = document.getElementById('unblock-user-btn');
        if (blockBtnPanel) blockBtnPanel.disabled = true; // Disable nút ngay

        try {
            const currentUserRef = doc(db, 'users', currentUser.uid);
            const targetUserRef = doc(db, 'users', friendUid);

            // Cập nhật document của mình
            await updateDoc(currentUserRef, {
                blocked: arrayUnion(friendUid), // Thêm vào danh sách chặn
                friends: arrayRemove(friendUid), // Xóa khỏi danh sách bạn bè
                [`nicknames.${friendUid}`]: deleteField() // Xóa nickname nếu có
            });

            // Cập nhật document của người bị chặn (chỉ xóa bạn bè)
            await updateDoc(targetUserRef, {
                friends: arrayRemove(currentUser.uid)
            });

            // Cập nhật dữ liệu local
            currentUserData.blocked = [...(currentUserData.blocked || []), friendUid];
            currentUserData.friends = currentUserData.friends?.filter(id => id !== friendUid);
            if (currentUserData.nicknames) delete currentUserData.nicknames[friendUid];

            showToast(`Đã chặn ${escapeHtml(name)}.`, 'success');
            if (chatInfoPanel) chatInfoPanel.classList.remove('open'); // Đóng panel info

            // Cập nhật UI nếu đang chat với người đó
            const chatIdToCheck = [currentUser.uid, friendUid].sort().join('_');
            if (currentChatId === chatIdToCheck) {
                inactiveChatIndicator.textContent = "Bạn đã chặn người này.";
                inactiveChatIndicator.style.display = 'block';
                if(chatInputContainer) chatInputContainer.style.display = 'none';
                if(blockBtnPanel) blockBtnPanel.style.display = 'none';
                if(unblockBtnPanel) unblockBtnPanel.style.display = 'block'; // Hiện nút bỏ chặn
                // Cập nhật lại isChatActive để hàm openChat xử lý đúng
                const chatObj = allChats.find(c => c.id === currentChatId);
                if(chatObj) chatObj.isActive = false;
            }
             // Cập nhật danh sách chat sidebar (onSnapshot sẽ tự xử lý)

        } catch (err) {
            console.error("Lỗi khi chặn:", err);
            showToast("Có lỗi xảy ra khi chặn người dùng!", "error");
            if (blockBtnPanel) blockBtnPanel.disabled = false; // Enable lại nút nếu lỗi
        }
    }
}

/**
 * Bỏ chặn một người dùng.
 * Cập nhật Firestore: xóa UID khỏi list blocked của mình.
 * @param {string} friendUid UID của người cần bỏ chặn.
 * @param {string} name Tên hiển thị của người cần bỏ chặn (để confirm).
 */
async function unblockUser(friendUid, name) {
    if (!currentUser || !friendUid) return;
    const confirmed = await showConfirmation(`Bỏ chặn ${escapeHtml(name)}?`);
    if (confirmed) {
        const blockBtnPanel = document.getElementById('block-user-btn');
        const unblockBtnPanel = document.getElementById('unblock-user-btn');
        if (unblockBtnPanel) unblockBtnPanel.disabled = true; // Disable nút

        try {
            const currentUserRef = doc(db, 'users', currentUser.uid);
            await updateDoc(currentUserRef, {
                blocked: arrayRemove(friendUid) // Xóa khỏi danh sách chặn
            });

            // Cập nhật dữ liệu local
            currentUserData.blocked = currentUserData.blocked?.filter(id => id !== friendUid);

            showToast(`Đã bỏ chặn ${escapeHtml(name)}.`, 'success');
            if (chatInfoPanel) chatInfoPanel.classList.remove('open');

            // Cập nhật UI nếu đang xem info panel hoặc chat window của người đó
            const chatIdToCheck = [currentUser.uid, friendUid].sort().join('_');
             if (currentChatId === chatIdToCheck) {
                 inactiveChatIndicator.style.display = 'none';
                 if(chatInputContainer) chatInputContainer.style.display = 'flex'; // Mở lại input
                 if(blockBtnPanel) blockBtnPanel.style.display = 'block'; // Hiện nút chặn
                 if(unblockBtnPanel) unblockBtnPanel.style.display = 'none'; // Ẩn nút bỏ chặn
                 // Cập nhật lại isChatActive
                 const chatObj = allChats.find(c => c.id === currentChatId);
                 if(chatObj) chatObj.isActive = true; // Kích hoạt lại chat
            }

        } catch (err) {
            console.error("Lỗi khi bỏ chặn:", err);
            showToast("Có lỗi xảy ra khi bỏ chặn!", "error");
             if (unblockBtnPanel) unblockBtnPanel.disabled = false; // Enable lại nút nếu lỗi
        }
    }
}
/**
 * Bắt đầu trạng thái trả lời tin nhắn.
 * Hiển thị thanh preview và lưu thông tin tin nhắn gốc.
 * @param {string} key ID của tin nhắn được trả lời.
 * @param {object} message Dữ liệu của tin nhắn được trả lời.
 */
function replyToMessage(key, message) {
    if (!replyPreviewContainer || !replyPreviewSender || !replyPreviewText || !messageInput) return;
    replyingTo = { key, message }; // Lưu lại thông tin
    replyPreviewContainer.style.display = 'block'; // Hiện preview
    // Hiển thị tên người gửi gốc (hoặc "chính mình")
    replyPreviewSender.textContent = `Đang trả lời ${message.senderId === currentUser.uid ? 'chính mình' : message.senderName || '...'}`;
    // Hiển thị text hoặc "Ảnh"
    replyPreviewText.textContent = message.text || (message.imageUrl ? 'Một hình ảnh' : '...');
    messageInput.focus(); // Focus vào ô nhập liệu
}

/**
 * Hủy trạng thái trả lời tin nhắn.
 * Ẩn thanh preview và xóa thông tin đã lưu.
 */
function cancelReply() {
    replyingTo = null; // Xóa thông tin
    if (replyPreviewContainer) replyPreviewContainer.style.display = 'none'; // Ẩn preview
}

/**
 * Bắt đầu trạng thái chỉnh sửa tin nhắn (chỉ text).
 * Hiển thị thanh preview sửa, điền text cũ vào input, đổi nút Gửi thành Lưu.
 * @param {string} key ID của tin nhắn cần sửa.
 * @param {object} message Dữ liệu của tin nhắn cần sửa.
 */
function startEditMessage(key, message) {
    if (!editPreviewContainer || !editPreviewText || !messageInput || !sendBtn) return;
    if (replyingTo) cancelReply(); // Hủy reply nếu đang reply
    isEditing = true; // Bật cờ đang sửa
    editingMessageKey = key; // Lưu key tin nhắn đang sửa
    editPreviewText.textContent = message.text; // Hiện text gốc trong preview
    editPreviewContainer.style.display = 'block'; // Hiện preview sửa
    messageInput.value = message.text; // Điền text cũ vào input
    messageInput.focus(); // Focus input
    sendBtn.innerHTML = 'Lưu'; // Đổi text nút Gửi
    // Kích hoạt nút Lưu (vì đã có text)
    if (chatInputContainer) chatInputContainer.classList.add('has-text');
}

/**
 * Hủy trạng thái chỉnh sửa tin nhắn.
 * Ẩn thanh preview, xóa text trong input, đổi nút Lưu thành Gửi.
 */
function cancelEdit() {
    isEditing = false;
    editingMessageKey = null;
    if (editPreviewContainer) editPreviewContainer.style.display = 'none';
    if (messageInput) messageInput.value = ''; // Xóa input
    if (sendBtn) {
        // Trả lại icon gửi (copy SVG từ HTML)
        sendBtn.innerHTML = `<svg class="send-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                           <svg class="spinner-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>`;
    }
    // Hủy kích hoạt nút gửi nếu input rỗng
    if (messageInput && chatInputContainer) {
        chatInputContainer.classList.toggle('has-text', messageInput.value.trim().length > 0 || selectedImageFile != null);
    }
}

/**
 * Hủy việc xem trước ảnh sắp gửi.
 * Ẩn preview, reset input file và biến selectedImageFile.
 */
function cancelImagePreview(){
    selectedImageFile = null;
    if (imageInput) imageInput.value = ''; // Reset input file
    if (imagePreviewContainer) imagePreviewContainer.style.display = 'none';
    if (messageInput) messageInput.placeholder = 'Nhập tin nhắn...';
    // Hủy kích hoạt nút gửi nếu input text cũng rỗng
    if (messageInput && chatInputContainer) {
        chatInputContainer.classList.toggle('has-text', messageInput.value.trim().length > 0);
    }
}
// --- PHẦN 9: XỬ LÝ REACTIONS ---

/**
 * Tạo element div chứa các nút reaction emoji.
 * @param {string} msgKey ID của tin nhắn mà picker này gắn vào.
 * @returns {HTMLDivElement} Element reaction picker.
 */
function createReactionPicker(msgKey) {
    const picker = document.createElement('div');
    picker.className = 'reaction-picker';
    // Danh sách emoji (có thể tùy chỉnh) + nút hủy '🚫'
    ['❤️', '👍', '😂', '😮', '😢', '😡', '🚫'].forEach(emoji => {
        const btn = document.createElement('span');
        btn.className = 'reaction-btn';
        btn.textContent = emoji;
        // Gắn sự kiện click để gọi hàm reactToMessage
        btn.onclick = (e) => {
            e.stopPropagation(); // Ngăn sự kiện click lan ra msg-wrapper
            reactToMessage(msgKey, emoji);
             // Tùy chọn: Ẩn picker ngay sau khi click
             // picker.style.opacity = '0';
             // picker.style.pointerEvents = 'none';
        };
        picker.appendChild(btn);
    });
    return picker;
}

/**
 * Xử lý khi người dùng thả/hủy thả reaction vào tin nhắn.
 * Cập nhật dữ liệu reaction trong Realtime Database.
 * @param {string} msgKey ID của tin nhắn được reaction.
 * @param {string} emoji Emoji được chọn ('🚫' để hủy).
 */
async function reactToMessage(msgKey, emoji) {
    if (!currentChatId || !msgKey || !currentUser) return; // Kiểm tra điều kiện cần thiết

    // Kiểm tra xem tin nhắn có tồn tại và chưa bị thu hồi không
    const checkMsgRef = ref(rtdb, `/messages/${currentChatId}/${msgKey}`);
    const msgSnapshot = await get(checkMsgRef); // Lấy data 1 lần
    if (!msgSnapshot.exists() || msgSnapshot.val().recalled) {
        showToast("Không thể thả cảm xúc vào tin nhắn này.", "success");
        return; // Dừng nếu tin nhắn không hợp lệ
    }

    const pathBase = `/messages/${currentChatId}/${msgKey}/reactions`; // Đường dẫn gốc tới reactions của tin nhắn

    // Xử lý nút Hủy reaction '🚫'
    if (emoji === '🚫') {
        const reactionsRef = ref(rtdb, pathBase);
        get(reactionsRef).then(snap => { // Lấy data reactions 1 lần
            if (snap.exists()) {
                const reactions = snap.val();
                // Duyệt qua tất cả emoji và xóa reaction của user hiện tại
                for (const existingEmoji in reactions) {
                    remove(ref(rtdb, `${pathBase}/${existingEmoji}/${currentUser.uid}`));
                }
                console.log(`Removed all reactions from user ${currentUser.uid} on msg ${msgKey}`);
            }
        }).catch(err => console.error("Error removing reactions:", err));
        return; // Dừng hàm sau khi xử lý hủy
    }

    // Xử lý các emoji khác
    const reactionRef = ref(rtdb, `${pathBase}/${emoji}/${currentUser.uid}`);

    // Lấy trạng thái reaction hiện tại của user cho emoji này
    get(reactionRef).then(snap => {
        if (emoji === '❤️') {
            // Trái tim là bộ đếm -> Tăng lên 1
            const currentCount = snap.val() || 0; // Lấy count hiện tại, mặc định là 0
            set(reactionRef, currentCount + 1); // Tăng count lên 1
            console.log(`User ${currentUser.uid} added heart to msg ${msgKey}. New count: ${currentCount + 1}`);
        } else {
            // Các emoji khác là công tắc bật/tắt
            if (snap.exists()) {
                remove(reactionRef); // Nếu đã react -> Hủy reaction
                console.log(`User ${currentUser.uid} removed ${emoji} from msg ${msgKey}`);
            } else {
                set(reactionRef, true); // Nếu chưa react -> Thêm reaction (giá trị true)
                console.log(`User ${currentUser.uid} added ${emoji} to msg ${msgKey}`);
            }
        }
    }).catch(err => console.error(`Error reacting with ${emoji}:`, err));
}

/**
 * Hiển thị modal chi tiết các lượt reaction cho một tin nhắn.
 * @param {string} msgKey ID của tin nhắn cần xem chi tiết reactions.
 */
async function showReactionsDetails(msgKey) {
    // Kiểm tra các element modal cần thiết
    if (!reactionsModal || !reactionsList || !closeReactionsModal) {
        console.error("Missing reaction modal elements!");
        return;
    }

    // Lấy dữ liệu tin nhắn mới nhất
    const msgRef = ref(rtdb, `/messages/${currentChatId}/${msgKey}`);
    const snap = await get(msgRef); // Lấy data 1 lần
    if (!snap.exists()) {
        showToast("Tin nhắn không còn tồn tại.", "error");
        return;
    }
    const msg = snap.val();
    const reactions = msg.reactions || {}; // Lấy reactions, mặc định là object rỗng

    reactionsList.innerHTML = 'Đang tải thông tin người thả...'; // Hiển thị loading
    reactionsModal.style.display = 'flex'; // Hiện modal

    // Gom tất cả người thả và emoji/count vào một mảng
    let allReactors = [];
    for (const [emoji, reactors] of Object.entries(reactions)) {
        for (const [uid, value] of Object.entries(reactors)) {
            // Tính count (là value nếu là ❤️, ngược lại là 1)
            const count = (emoji === '❤️' && typeof value === 'number') ? value : 1;
            allReactors.push({ uid, emoji, count });
        }
    }

    // Sắp xếp (ví dụ: theo emoji trước, rồi đến tên user) - Tùy chọn
    allReactors.sort((a, b) => a.emoji.localeCompare(b.emoji));

    if (allReactors.length === 0) {
        reactionsList.innerHTML = '<p style="color: var(--text-2); text-align: center;">Chưa có ai bày tỏ cảm xúc.</p>';
        return; // Dừng nếu không có ai thả
    }

    // Tạo HTML cho danh sách người thả
    let html = '';
    // Lấy thông tin user (tên, avatar) cho từng người thả
    const userPromises = allReactors.map(reactor => getDoc(doc(db, 'users', reactor.uid)));
    const userDocs = await Promise.all(userPromises);

    allReactors.forEach((reactor, index) => {
        const userDoc = userDocs[index]; // Lấy userDoc tương ứng
        if (userDoc.exists()) {
            const userData = userDoc.data();
            const displayName = userData.displayName || userData.email || 'Người dùng ẩn danh';
            const avatarUrl = userData.avatarUrl || `https://placehold.co/36x36?text=${displayName[0].toUpperCase()}`;
            const countDisplay = reactor.count > 1 ? ` ${reactor.count}` : ''; // Hiển thị số lượng nếu > 1 (cho tim)
            html += `
                <div class="reaction-user-item">
                    <div class="reaction-user-info">
                        <img class="reaction-user-avatar" src="${avatarUrl}" alt="Avatar">
                        <span class="reaction-user-name">${escapeHtml(displayName)}</span>
                    </div>
                    <span class="reaction-emoji">${reactor.emoji}${countDisplay}</span>
                </div>
            `;
        } else {
             // Xử lý trường hợp không tìm thấy user (ví dụ: user đã xóa tài khoản)
             html += `
                <div class="reaction-user-item">
                    <div class="reaction-user-info">
                        <img class="reaction-user-avatar" src="https://placehold.co/36x36?text=?">
                        <span class="reaction-user-name" style="color: var(--text-2); font-style: italic;">Người dùng không tồn tại</span>
                    </div>
                    <span class="reaction-emoji">${reactor.emoji}${reactor.count > 1 ? ` ${reactor.count}` : ''}</span>
                </div>
            `;
        }
    });

    reactionsList.innerHTML = html; // Cập nhật nội dung danh sách
}

// Gắn sự kiện đóng modal reactions (nếu chưa có trong attachEventListeners)
if (closeReactionsModal) {
    closeReactionsModal.onclick = () => reactionsModal.style.display = 'none';
}
if (reactionsModal) { // Đóng khi bấm ra ngoài
     reactionsModal.onclick = (e) => { if (e.target === reactionsModal) reactionsModal.style.display = 'none'; };
}

// --- PHẦN 10: XỬ LÝ NHÓM CHAT ---

/**
 * Mở modal tạo nhóm mới và hiển thị danh sách bạn bè để mời.
 */
async function openCreateGroupModal() {
    // Kiểm tra các element cần thiết
    if (!createGroupModal || !groupMembersChecklist || !groupNameInput || !confirmCreateGroupBtn) {
        console.error("Missing elements for create group modal!");
        return;
    }

    groupMembersChecklist.innerHTML = '<p style="color: var(--text-2); text-align: center;">Đang tải danh sách bạn bè...</p>'; // Hiển thị loading
    groupNameInput.value = ''; // Reset tên nhóm
    createGroupModal.style.display = 'flex'; // Hiện modal

    // Lấy danh sách bạn bè mới nhất từ Firestore (hoặc dùng biến `friends` đã cache nếu có)
    const meDoc = await getDoc(doc(db, 'users', currentUser.uid));
    const friendUids = meDoc.data()?.friends || [];

    groupMembersChecklist.innerHTML = ''; // Xóa loading/nội dung cũ

    if (friendUids.length === 0) {
        groupMembersChecklist.innerHTML = '<p style="color: var(--text-2); text-align: center;">Bạn chưa có bạn bè để mời vào nhóm.</p>';
        confirmCreateGroupBtn.disabled = true; // Vô hiệu hóa nút tạo nếu không có ai để mời
        return;
    } else {
         confirmCreateGroupBtn.disabled = false; // Bật lại nút tạo
    }

    // Hiển thị danh sách bạn bè với checkbox
    let friendCount = 0;
    for (const friendUid of friendUids) {
        // Ưu tiên lấy data từ cache `friends` nếu có, không thì query Firestore
        const friendData = friends.find(f => f.uid === friendUid);
        let displayName = 'Người dùng ẩn';
        let avatarUrl = 'https://placehold.co/32x32?text=?';

        if (friendData) {
             displayName = friendData.displayName || friendData.email || 'Người dùng ẩn';
             avatarUrl = friendData.avatarUrl || `https://placehold.co/32x32?text=${displayName[0].toUpperCase()}`;
             friendCount++;
        } else {
             // Fallback: Query Firestore nếu không có trong cache (ít xảy ra nếu `loadAndSortChats` chạy đúng)
             try {
                  const friendDoc = await getDoc(doc(db, 'users', friendUid));
                  if (friendDoc.exists()) {
                       const fd = friendDoc.data();
                       displayName = fd.displayName || fd.email || 'Người dùng ẩn';
                       avatarUrl = fd.avatarUrl || `https://placehold.co/32x32?text=${displayName[0].toUpperCase()}`;
                       friendCount++;
                  } else {
                       continue; // Bỏ qua nếu user không tồn tại
                  }
             } catch (err) {
                  console.error("Error fetching friend data for group modal:", friendUid, err);
                  continue; // Bỏ qua nếu lỗi
             }
        }


        // Tạo HTML cho mỗi bạn bè
        const div = document.createElement('div');
        div.innerHTML = `
            <label style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s;">
                <input type="checkbox" class="group-member-checkbox" value="${friendUid}" style="width: 18px; height: 18px; flex-shrink: 0;">
                <img src="${avatarUrl}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(displayName)}</span>
            </label>`;
        const label = div.querySelector('label');
        // Thêm hiệu ứng hover đơn giản
        label.onmouseover = () => label.style.backgroundColor = 'var(--glass)';
        label.onmouseout = () => label.style.backgroundColor = 'transparent';
        groupMembersChecklist.appendChild(div);
    }
     // Nếu sau khi duyệt hết mà không có bạn bè hợp lệ nào
     if (friendCount === 0) {
          groupMembersChecklist.innerHTML = '<p style="color: var(--text-2); text-align: center;">Không tìm thấy bạn bè hợp lệ để mời.</p>';
          confirmCreateGroupBtn.disabled = true;
     }
}

/**
 * Xác nhận tạo nhóm mới sau khi đã nhập tên và chọn thành viên.
 */
async function confirmCreateGroup() {
    if (!groupNameInput || !groupMembersChecklist || !confirmCreateGroupBtn || !createGroupModal) return;

    const groupName = groupNameInput.value.trim();
    if (!groupName) {
        showToast('Vui lòng nhập tên nhóm.', 'error');
        return;
    }

    // Lấy UID của các thành viên được chọn
    const memberCheckboxes = groupMembersChecklist.querySelectorAll('.group-member-checkbox:checked');
    const invitedUids = Array.from(memberCheckboxes).map(cb => cb.value);

    // Bao gồm cả người tạo nhóm
    const memberUids = [currentUser.uid, ...invitedUids];

    // Nhóm phải có ít nhất 2 người (tính cả người tạo)
    if (memberUids.length < 2) {
        showToast('Nhóm phải có ít nhất 2 thành viên.', 'error');
        return;
    }

    // Tạo object roles (người tạo là admin, còn lại là member)
    const roles = { [currentUser.uid]: 'admin' };
    invitedUids.forEach(uid => roles[uid] = 'member');

    confirmCreateGroupBtn.disabled = true; // Vô hiệu hóa nút
    confirmCreateGroupBtn.textContent = 'Đang tạo...';

    try {
        // Thêm document nhóm mới vào Firestore
        const newGroupRef = await addDoc(collection(db, 'groups'), {
            groupName: groupName,
            member_uids: memberUids, // Mảng UID thành viên
            roles: roles,            // Object vai trò
            createdBy: currentUser.uid, // UID người tạo
            createdAt: serverTimestamp(), // Thời gian tạo
            // avatarUrl: null // Có thể thêm avatar mặc định nếu muốn
        });

        showToast(`Đã tạo nhóm "${groupName}"!`, 'success');
        createGroupModal.style.display = 'none'; // Đóng modal
        groupNameInput.value = ''; // Reset form

        // Tùy chọn: Tự động mở chat nhóm vừa tạo
        startGroupChat(newGroupRef.id, groupName);

    } catch (error) {
        console.error("Lỗi khi tạo nhóm:", error);
        showToast("Không thể tạo nhóm: " + error.message, 'error');
    } finally {
        confirmCreateGroupBtn.disabled = false; // Mở lại nút
        confirmCreateGroupBtn.textContent = 'Tạo Nhóm';
    }
}

/**
 * Kick một thành viên ra khỏi nhóm (chỉ Admin/Mod làm được).
 * @param {string} groupId ID của nhóm.
 * @param {string} targetUid UID của thành viên bị kick.
 */
async function kickMember(groupId, targetUid) {
    if (!groupId || !targetUid) return;
    const groupRef = doc(db, 'groups', groupId);
    try {
        // Cập nhật Firestore: Xóa UID khỏi mảng members và xóa role
        await updateDoc(groupRef, {
            member_uids: arrayRemove(targetUid),    // Xóa khỏi mảng thành viên
            [`roles.${targetUid}`]: deleteField() // Xóa vai trò của họ
        });
        showToast('Đã kick thành viên thành công.', 'success');
        // Giao diện sẽ tự cập nhật nhờ onSnapshot trong showGroupInfo
    } catch (error) {
        console.error("Lỗi khi kick thành viên:", error);
        showToast("Có lỗi xảy ra khi kick thành viên.", "error");
    }
}

/**
 * Thay đổi vai trò của thành viên trong nhóm (chỉ Admin làm được).
 * @param {string} groupId ID của nhóm.
 * @param {string} targetUid UID của thành viên cần đổi vai trò.
 * @param {'moderator' | 'member'} newRole Vai trò mới ('moderator' hoặc 'member').
 */
async function changeRole(groupId, targetUid, newRole) {
    if (!groupId || !targetUid || (newRole !== 'moderator' && newRole !== 'member')) return;
    const groupRef = doc(db, 'groups', groupId);
    try {
        // Cập nhật Firestore: Thay đổi giá trị trong object roles
        await updateDoc(groupRef, {
            [`roles.${targetUid}`]: newRole
        });
        showToast(`Đã cập nhật vai trò thành ${newRole === 'moderator' ? 'Phó nhóm' : 'Thành viên'}.`, 'success');
        // Giao diện sẽ tự cập nhật nhờ onSnapshot trong showGroupInfo
    } catch (error) {
        console.error("Lỗi khi thay đổi vai trò:", error);
        showToast("Có lỗi xảy ra khi đổi vai trò.", "error");
    }
}

/**
 * Rời khỏi một nhóm chat.
 * @param {string} groupId ID của nhóm cần rời.
 * @param {string} groupName Tên của nhóm (để hiển thị confirm).
 */
async function leaveGroup(groupId, groupName) {
     if (!groupId || !currentUser) return;
     const confirmed = await showConfirmation(`Bạn có chắc muốn rời khỏi nhóm "${groupName || 'này'}"?`);
     if (confirmed) {
         const groupRef = doc(db, 'groups', groupId);
         leaveGroupBtn.disabled = true; leaveGroupBtn.textContent = 'Đang rời...'; // Cập nhật nút
         try {
             // Cập nhật Firestore: Xóa UID khỏi mảng members và xóa role
             await updateDoc(groupRef, {
                 member_uids: arrayRemove(currentUser.uid),
                 [`roles.${currentUser.uid}`]: deleteField()
             });
             showToast('Đã rời nhóm thành công.', 'success');
             if (chatInfoPanel) chatInfoPanel.classList.remove('open'); // Đóng panel info

             // Reset UI nếu đang xem nhóm vừa rời
             if (currentChatId === groupId) {
                 if(currentChatFriendName) currentChatFriendName.textContent = "Chọn cuộc trò chuyện";
                 if(messagesContainer) messagesContainer.innerHTML = '';
                 if(messageInput) messageInput.disabled = true;
                 if(sendBtn) sendBtn.disabled = true;
                 currentChatId = null; currentChatType = null;
                 if(currentChatAvatar) currentChatAvatar.style.display = 'none';
                 if(groupInfoBtn) groupInfoBtn.style.display = 'none';
                 if(toggleMuteBtnGroup) toggleMuteBtnGroup.style.display = 'none';
             }
             // Tự động load lại list chat (vì onSnapshot của group sẽ được trigger)
             // loadAndSortChats(); // Không cần gọi lại ở đây

         } catch (error) {
             console.error("Lỗi khi rời nhóm:", error);
             showToast("Có lỗi xảy ra khi rời nhóm.", "error");
             leaveGroupBtn.disabled = false; leaveGroupBtn.textContent = 'Rời nhóm'; // Reset nút nếu lỗi
         }
     }
}

/**
 * Giải tán một nhóm chat (chỉ Admin làm được).
 * Xóa document nhóm khỏi Firestore và xóa tin nhắn/typing khỏi RTDB.
 * @param {string} groupId ID của nhóm cần giải tán.
 * @param {string} groupName Tên của nhóm (để hiển thị confirm).
 */
async function disbandGroup(groupId, groupName) {
     if (!groupId || !currentUser) return;
     const confirmed = await showConfirmation(`Bạn có chắc chắn muốn giải tán nhóm "${groupName || 'này'}" không? Hành động này sẽ xóa toàn bộ tin nhắn và KHÔNG THỂ hoàn tác!`);
     if (confirmed) {
         if (!disbandGroupBtn) return; // Kiểm tra nút tồn tại
         disbandGroupBtn.disabled = true; disbandGroupBtn.textContent = 'Đang giải tán...';
         try {
             // 1. Xóa document nhóm khỏi Firestore
             await deleteDoc(doc(db, 'groups', groupId));

             // 2. Xóa dữ liệu tin nhắn khỏi RTDB
             await remove(ref(rtdb, `/messages/${groupId}`));

             // 3. Xóa dữ liệu typing khỏi RTDB
             await remove(ref(rtdb, `/typing/${groupId}`));

             showToast("Đã giải tán nhóm thành công!", "success");
             if (chatInfoPanel) chatInfoPanel.classList.remove('open');

             // Reset UI nếu đang xem nhóm vừa giải tán
             if (currentChatId === groupId) {
                  if(currentChatFriendName) currentChatFriendName.textContent = "Chọn cuộc trò chuyện";
                  if(messagesContainer) messagesContainer.innerHTML = '';
                  if(messageInput) messageInput.disabled = true;
                  if(sendBtn) sendBtn.disabled = true;
                  currentChatId = null; currentChatType = null;
                  if(currentChatAvatar) currentChatAvatar.style.display = 'none';
                  if(groupInfoBtn) groupInfoBtn.style.display = 'none';
                  if(toggleMuteBtnGroup) toggleMuteBtnGroup.style.display = 'none';
             }
             // Tự động load lại list chat (vì onSnapshot của group sẽ được trigger)

         } catch (err) {
             console.error("Lỗi giải tán nhóm:", err);
             showToast("Lỗi khi giải tán nhóm!", "error");
             disbandGroupBtn.disabled = false; disbandGroupBtn.textContent = '🗑️ Giải tán nhóm';
         }
     }
}

// --- PHẦN 11: CÁC HÀM XỬ LÝ KHÁC (SEARCH, URL, NOTIF, MENTION, ETC.) ---

/**
 * Gắn sự kiện input cho ô tìm kiếm chung (sidebar).
 * Tìm kiếm bạn bè, nhóm và hiển thị kết quả trong dropdown.
 */
function attachGlobalSearch() {
    if (!globalSearch || !searchDropdown) return; // Kiểm tra element

    globalSearch.addEventListener('input', async (e) => {
        const searchTerm = e.target.value.trim().toLowerCase();
        // Ẩn dropdown nếu ô tìm kiếm rỗng
        if (!searchTerm) {
            searchDropdown.style.display = 'none';
            searchDropdown.innerHTML = '';
            return;
        }

        searchDropdown.innerHTML = '<div class="result-item"><div class="result-sub">Đang tìm...</div></div>'; // Hiển thị loading
        searchDropdown.style.display = 'block';

        // Lấy danh sách bạn bè và nhóm từ cache (biến `friends` và query Firestore)
        // Lưu ý: Biến `friends` cần được cập nhật trong `loadAndSortChats`
        const friendUIDs = currentUserData.friends || [];
        // const friendsData = friends; // Dùng biến global đã cập nhật

        const qg = query(collection(db, 'groups'), where('member_uids', 'array-contains', currentUser.uid));
        const gs = await getDocs(qg);
        const groupsData = [];
        gs.forEach(d => groupsData.push({ id: d.id, ...d.data() }));

        // Lọc kết quả
        const friendsFiltered = friends.filter(u =>
            (u.displayName || u.email || '').toLowerCase().includes(searchTerm)
        );
        const groupsFiltered = groupsData.filter(g =>
            (g.groupName || '').toLowerCase().includes(searchTerm)
        );
        // Optional: Thêm tìm kiếm người dùng khác (chưa phải bạn bè)
        // const usersQuery = query(collection(db, "users"), where("email", ">=", searchTerm), where("email", "<=", searchTerm + '\uf8ff'), limit(5));
        // const usersSnap = await getDocs(usersQuery);
        // const usersFiltered = usersSnap.docs.map(d => d.data()).filter(u => u.uid !== currentUser.uid && !friendUIDs.includes(u.uid));


        searchDropdown.innerHTML = ''; // Xóa loading

        // Hàm helper để render một mục kết quả
        const renderResultItem = (itemData, type) => {
            const el = document.createElement('div');
            el.className = 'result-item';
            const avatarPlaceholder = (itemData.displayName || itemData.groupName || '?')[0].toUpperCase();
            const avatarSrc = itemData.avatarUrl || `https://placehold.co/32x32?text=${avatarPlaceholder}`;
            const name = type === 'group' ? `👥 ${itemData.groupName}` : (itemData.displayName || itemData.email);
            const verifiedTick = createVerifiedTickHTML(itemData.isVerified);

            el.innerHTML = `
                <div class="result-left">
                    <img class="result-avatar" src="${avatarSrc}" alt="Avatar">
                    <div><div class="result-name">${escapeHtml(name)}${verifiedTick}</div></div>
                </div>
            `;
             // Thêm nút kết bạn nếu là user lạ (chưa làm phần tìm user lạ)
             /* if (type === 'user' && !isFriend) {
                 el.innerHTML += `<div class="result-action"><button class="add-friend-btn" data-uid="${itemData.uid}">Kết bạn</button></div>`;
             } */

            el.onclick = () => {
                if (type === 'direct') startDirectChat(itemData);
                else if (type === 'group') startGroupChat(itemData.id, itemData.groupName);
                // else if (type === 'user') { /* Mở profile user lạ? */ }
                hideDropdown();
            };
            // Gắn sự kiện cho nút kết bạn nếu có
            // const addBtn = el.querySelector('.add-friend-btn');
            // if (addBtn) { addBtn.onclick = (ev) => { ev.stopPropagation(); /* ... logic gửi lời mời ... */ }; }

            return el;
        };

        // Hàm helper để thêm section vào dropdown
        const addSection = (title, items, renderFunc, type) => {
             const st = document.createElement('div'); st.className = 'section-title'; st.textContent = title; searchDropdown.appendChild(st);
             if (!items.length) { const em = document.createElement('div'); em.className = 'result-item'; em.innerHTML = `<div class="result-sub" style="text-align:center;">Không có kết quả</div>`; searchDropdown.appendChild(em); return; }
             items.forEach(x => searchDropdown.appendChild(renderFunc(x, type)));
        };

        // Render các section
        addSection('Bạn bè', friendsFiltered, renderResultItem, 'direct');
        addSection('Nhóm', groupsFiltered, renderResultItem, 'group');
        // addSection('Người dùng khác', usersFiltered, renderResultItem, 'user'); // Nếu có tìm user lạ

        searchDropdown.style.display = 'block'; // Hiển thị dropdown
    });

    // Ẩn dropdown khi click ra ngoài
    const hideDropdown = () => { if (searchDropdown) searchDropdown.style.display = 'none'; };
    document.addEventListener('click', (e) => {
        if (globalSearch && searchDropdown && e.target !== globalSearch && !searchDropdown.contains(e.target)) {
            hideDropdown();
        }
    });
}

/**
 * Xử lý tham số 'chat' hoặc 'chat_group' trong URL khi tải trang.
 * Tự động mở cuộc trò chuyện tương ứng nếu có.
 */
async function handleUrlChat() {
    const params = new URLSearchParams(window.location.search);
    const friendUid = params.get('chat');
    const groupId = params.get('chat_group');

    if (friendUid) {
        try {
            const userDoc = await getDoc(doc(db, 'users', friendUid));
            if (userDoc.exists()) {
                await startDirectChat({ uid: friendUid, ...userDoc.data() }); // Truyền data user vào
            } else {
                 console.warn("User specified in URL not found:", friendUid);
                 history.replaceState(null, '', window.location.pathname); // Xóa param khỏi URL
            }
        } catch (error) {
             console.error("Error handling direct chat URL:", error);
             history.replaceState(null, '', window.location.pathname);
        }
    } else if (groupId) {
         try {
             const groupDoc = await getDoc(doc(db, 'groups', groupId));
             if (groupDoc.exists()) {
                 await startGroupChat(groupId, groupDoc.data().groupName); // Gọi startGroupChat
             } else {
                 console.warn("Group specified in URL not found:", groupId);
                 history.replaceState(null, '', window.location.pathname);
             }
         } catch (error) {
              console.error("Error handling group chat URL:", error);
              history.replaceState(null, '', window.location.pathname);
         }
    }
}

/**
 * Lắng nghe các notification mới được đẩy vào RTDB cho user hiện tại.
 * Hiển thị thông báo trình duyệt nếu chat đó không đang mở và không bị mute.
 */
function listenForNotifications_Optimized() {
    if (!currentUser) return;
    const notifsRef = ref(rtdb, `/notifications/${currentUser.uid}`);
    onChildAdded(notifsRef, async (snapshot) => { // Dùng async để await lấy data mute
        const notification = snapshot.val();
        if (!notification) { remove(snapshot.ref); return; } // Xóa notif rỗng

        try {
            // Lấy trạng thái mute MỚI NHẤT của user hiện tại
            const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
            const latestUserData = userDoc.exists() ? userDoc.data() : {};

            // Kiểm tra xem chat này có bị user hiện tại mute không
            const isMuted = latestUserData.mutedChats?.[notification.chatId] === true;

            // Nếu chat bị mute hoặc đang mở -> Chỉ xóa notif, không hiển thị
            if (isMuted || notification.chatId === currentChatId) {
                remove(snapshot.ref);
                return;
            }

            // Nếu không bị mute và không đang mở -> Hiển thị thông báo
            showSimpleNotification(notification.from, notification.preview, notification.avatar);
            // Optional: Tăng unread count trên tab title nếu cần (có thể trùng với renderMessage)
            // if (document.hidden) { unreadCount++; document.title = `(${unreadCount}) ${originalTitle}`; }

        } catch (error) {
             console.error("Error processing notification:", error);
        } finally {
             // Luôn xóa notification khỏi RTDB sau khi xử lý (hoặc lỗi)
             remove(snapshot.ref);
        }
    });
}

/**
 * Xử lý input để gợi ý mention (@) trong group chat.
 */
function handleMentionInput() {
    if (!mentionSuggestions || !messageInput) return;
    let isMentioning = false; let mentionQuery = '';

    messageInput.addEventListener('input', (e) => {
        const text = messageInput.value; const cursorPos = messageInput.selectionStart; let lastAtPos = -1;
        for (let i = cursorPos - 1; i >= 0; i--) { if (text[i] === '@') { if (i === 0 || /\s/.test(text[i - 1])) { lastAtPos = i; break; } } if (/\s/.test(text[i])) break; }
        if (lastAtPos !== -1 && currentChatType === 'group') { isMentioning = true; mentionQuery = text.substring(lastAtPos + 1, cursorPos).toLowerCase(); showSuggestions(mentionQuery); }
        else { isMentioning = false; mentionSuggestions.style.display = 'none'; }
    });
    // Optional: Add keydown listener for arrow keys/enter

    function showSuggestions(query) {
        mentionSuggestions.innerHTML = ''; let suggestions = [];
        if ('all'.includes(query)) suggestions.push({ type: 'all' });
        if (currentGroupMembers.length > 0) { const filtered = currentGroupMembers.filter(m => m.uid !== currentUser.uid && (m.displayName || '').toLowerCase().includes(query)); suggestions = suggestions.concat(filtered.map(m => ({ ...m, type: 'user' }))); }
        if (suggestions.length === 0) { mentionSuggestions.style.display = 'none'; return; }
        suggestions.forEach(item => { const div = document.createElement('div'); div.className = 'suggestion-item'; if (item.type === 'all') { div.innerHTML = `<span class="all">@all</span>`; div.onclick = () => insertMention('@all', 'all'); } else { const avatar = item.avatarUrl || `https://placehold.co/28x28?text=${(item.displayName||'?')[0]}`; div.innerHTML = `<img src="${avatar}" alt=""><span class="name">${escapeHtml(item.displayName || '')}</span>`; div.onclick = () => insertMention(item.displayName, item.uid); } mentionSuggestions.appendChild(div); });
        mentionSuggestions.style.display = 'block';
    }
    function insertMention(name, uidOrAll) {
        const text = messageInput.value; const cursorPos = messageInput.selectionStart; let lastAtPos = -1;
        for (let i = cursorPos - 1; i >= 0; i--) { if (text[i] === '@') { if (i === 0 || /\s/.test(text[i - 1])) { lastAtPos = i; break; } } if (/\s/.test(text[i])) break; }
        if (lastAtPos !== -1) { const before = text.substring(0, lastAtPos); const after = text.substring(cursorPos); const mentionText = (uidOrAll === 'all') ? '@all' : `@${name}`; messageInput.value = before + mentionText + ' ' + after; messageInput.focus(); const newPos = before.length + mentionText.length + 1; messageInput.setSelectionRange(newPos, newPos); }
        mentionSuggestions.style.display = 'none'; isMentioning = false; messageInput.dispatchEvent(new Event('input')); // Trigger input event
    }
}

function openLightbox(imageUrl, messageKey) {
    console.log("openLightbox called with:", imageUrl, messageKey);
    if (!imageLightbox || !lightboxImg) return;

    imageLightbox.style.display = '';

    // <<< THÊM DÒNG NÀY ĐỂ RENDER TẤT CẢ THUMBNAIL CỦA CHAT HIỆN TẠI >>>
    renderLightboxThumbnails(currentChatImages);

    const index = messageKey ? currentChatImages.findIndex(img => img.key === messageKey) : -1;

    if (index > -1) {
        currentLightboxIndex = index;
        lightboxImg.src = imageUrl;
        // Cập nhật URL cho nút tải
        if (lightboxDownloadBtn) {
            lightboxDownloadBtn.href = imageUrl;
        }
        imageLightbox.classList.add('show');
        updateLightboxNav();
        updateLightboxThumbnails(); // Kích hoạt thumbnail active và cuộn
    } else {
        console.warn("Image key not found or null, opening without navigation.");
        currentLightboxIndex = -1;
        lightboxImg.src = imageUrl;
         if (lightboxDownloadBtn) { lightboxDownloadBtn.href = imageUrl; } // Cập nhật nút tải cho ảnh đơn
        imageLightbox.classList.add('show');
        updateLightboxNav(); // Sẽ ẩn nút nav
        updateLightboxThumbnails(); // Vẫn gọi để xử lý cuộn/active nếu cần
    }
}

// === HÀM RENDER TẤT CẢ THUMBNAIL CỦA CHAT HIỆN TẠI ===
function renderLightboxThumbnails(images) {
    if (!lightboxThumbnailsList) return;

    lightboxThumbnailsList.innerHTML = ''; // Xóa thumbnails cũ
    if (images.length === 0) {
        lightboxThumbnailsContainer.style.display = 'none'; // Ẩn container nếu không có ảnh
        return;
    } else {
        lightboxThumbnailsContainer.style.display = 'flex'; // Hiện container
    }

    images.forEach((imgObj, idx) => {
        const thumbnail = document.createElement('img');
        thumbnail.className = 'lightbox-thumbnail-item';
        thumbnail.src = imgObj.url;
        thumbnail.alt = `Thumbnail ${idx + 1}`;
        thumbnail.dataset.index = idx; // Lưu index để dễ dàng chuyển ảnh

        thumbnail.onclick = () => {
            showLightboxImage(idx); // Bấm thumbnail sẽ chuyển ảnh
        };
        lightboxThumbnailsList.appendChild(thumbnail);
    });
    updateLightboxThumbnails(); // Gọi lần đầu để cuộn và active
}

// === HÀM CẬP NHẬT THUMBNAIL ACTIVE VÀ CUỘN ===
function updateLightboxThumbnails() {
    if (!lightboxThumbnailsList || currentLightboxIndex === -1) {
         lightboxThumbnailsContainer.style.display = 'none'; // Ẩn nếu không có ảnh
        return;
    }

    lightboxThumbnailsContainer.style.display = 'flex'; // Đảm bảo hiện

    const thumbnails = lightboxThumbnailsList.querySelectorAll('.lightbox-thumbnail-item');
    thumbnails.forEach((thumb, idx) => {
        if (idx === currentLightboxIndex) {
            thumb.classList.add('active');
            // Cuộn đến thumbnail đang active
            thumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        } else {
            thumb.classList.remove('active');
        }
    });
}

// === GẮN LẠI SỰ KIỆN ĐÓNG LIGHTBOX ===
// (Đảm bảo là đã có, nếu chưa thì thêm vào)
if (lightboxCloseBtn) lightboxCloseBtn.onclick = closeLightbox;
if (imageLightbox) imageLightbox.onclick = (e) => {
    if (e.target === imageLightbox || e.target.id === 'lightbox-download-btn') { // Không đóng khi bấm nút tải
        // Cần xử lý riêng cho nút tải để nó không đóng overlay
        // Nút tải có target="_blank" nên nó sẽ mở tab mới và không đóng lightbox
        if (e.target.id !== 'lightbox-download-btn') {
             closeLightbox();
        }
    }
};
// Nếu muốn đóng khi bấm vào overlay mà không bao gồm ảnh, chỉ cần:
// if (imageLightbox) imageLightbox.onclick = (e) => {
//     if (e.target.classList.contains('lightbox-overlay')) { // Chỉ đóng khi click trực tiếp vào nền overlay
//         closeLightbox();
//     }
// };


// === Optional: Thêm điều hướng bằng bàn phím (nếu chưa có) ===
document.addEventListener('keydown', (e) => {
    if (imageLightbox.classList.contains('show')) {
        if (e.key === 'ArrowLeft') {
            if (currentLightboxIndex > 0) showLightboxImage(currentLightboxIndex - 1);
        } else if (e.key === 'ArrowRight') {
            if (currentLightboxIndex < currentChatImages.length - 1) showLightboxImage(currentLightboxIndex + 1);
        } else if (e.key === 'Escape') {
            closeLightbox();
        }
    }
});

/**
 * Tải ảnh đang hiển thị trong lightbox về máy người dùng,
 * sử dụng tên file gốc từ URL.
 */
async function downloadCurrentImage() {
    if (!lightboxImg || !lightboxImg.src) {
        showToast("Không có ảnh để tải.", "error");
        return;
    }

    const imageUrl = lightboxImg.src;
    let filename = "image.jpg"; // Tên mặc định

    try {
        // Tách lấy phần cuối cùng của URL sau dấu /
        const urlParts = imageUrl.split('/');
        const lastPart = urlParts[urlParts.length - 1];

        // Tách bỏ phần query string (sau dấu ?) nếu có
        const filenameWithPotentialQuery = lastPart;
        const queryIndex = filenameWithPotentialQuery.indexOf('?');
        const cleanFilename = queryIndex !== -1 ? filenameWithPotentialQuery.substring(0, queryIndex) : filenameWithPotentialQuery;

        // Decode URL encoding (ví dụ: %20 thành dấu cách)
        // Chỉ thực hiện nếu tên file không rỗng sau khi xử lý
        if (cleanFilename) {
            filename = decodeURIComponent(cleanFilename);
        }

        // Optional: Nếu tên file không có phần mở rộng, thử đoán từ blob type
        // (Phần này nâng cao hơn, có thể bỏ qua nếu tên file thường có đuôi)
        const fileExtensionMatch = filename.match(/\.[0-9a-z]+$/i);
        if (!fileExtensionMatch) {
            const response = await fetch(imageUrl);
            const blob = await response.blob();
            const mimeType = blob.type; // e.g., 'image/jpeg'
            const extension = mimeType.split('/')[1] || 'jpg';
            filename = `${filename}.${extension}`;
        }


    } catch (e) {
        console.warn("Could not accurately parse filename from URL, using default:", imageUrl, e);
        // Giữ lại tên mặc định nếu có lỗi
    }


    if(lightboxDownloadBtn) {
        lightboxDownloadBtn.style.pointerEvents = 'none';
        lightboxDownloadBtn.style.opacity = '0.5';
    }

    try {
        const response = await fetch(imageUrl, {
             // Thêm option này nếu gặp lỗi CORS khi fetch ảnh từ domain khác (như ImgBB)
             // mode: 'cors' // Có thể cần hoặc không tùy server ảnh
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const blob = await response.blob();
        const blobUrl = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = blobUrl;
        link.download = filename; // <<< SỬ DỤNG TÊN FILE ĐÃ LẤY ĐƯỢC
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(blobUrl);
    } catch (error) {
        console.error('Lỗi tải ảnh:', error);
        showToast("Không thể tải ảnh này. Lỗi: " + error.message, "error");
        window.open(imageUrl, '_blank'); // Mở tab mới nếu lỗi
    } finally {
        if(lightboxDownloadBtn) {
            lightboxDownloadBtn.style.pointerEvents = 'auto';
            lightboxDownloadBtn.style.opacity = '1';
        }
    }
}

// === HÀM ĐÓNG LIGHTBOX ===
function closeLightbox() {
    if (!imageLightbox) return;
    imageLightbox.classList.remove('show'); // Ẩn lightbox
    currentLightboxIndex = -1; // Reset index
    // Optional: Xóa src để giải phóng bộ nhớ?
    // if (lightboxImg) lightboxImg.src = '';
}

// === HÀM HIỂN THỊ ẢNH THEO INDEX ===
// === HÀM HIỂN THỊ ẢNH THEO INDEX (Cập nhật thumbnail) ===
function showLightboxImage(index) {
    if (!lightboxImg || !currentChatImages || index < 0 || index >= currentChatImages.length) {
        return; // Thoát nếu index không hợp lệ
    }

    currentLightboxIndex = index; // Cập nhật index
    lightboxImg.src = currentChatImages[index].url; // Đổi ảnh

    // Cập nhật URL cho nút tải
    if (lightboxDownloadBtn) {
        lightboxDownloadBtn.href = currentChatImages[index].url;
    }

    updateLightboxNav();           // Cập nhật nút prev/next
    updateLightboxThumbnails();    // <<< THÊM DÒNG NÀY ĐỂ CẬP NHẬT THUMBNAIL
}

// === HÀM CẬP NHẬT HIỂN THỊ NÚT PREV/NEXT ===
function updateLightboxNav() {
    const prevBtn = document.getElementById('lightbox-prev-btn');
    const nextBtn = document.getElementById('lightbox-next-btn');
    if (!prevBtn || !nextBtn) return;

    // Hiện nút Prev nếu không phải ảnh đầu tiên
    prevBtn.style.display = (currentLightboxIndex > 0) ? 'block' : 'none';

    // Hiện nút Next nếu không phải ảnh cuối cùng
    nextBtn.style.display = (currentLightboxIndex > -1 && currentLightboxIndex < currentChatImages.length - 1) ? 'block' : 'none';
}

// === GẮN SỰ KIỆN CHO CÁC NÚT LIGHTBOX MỚI ===
const prevBtn = document.getElementById('lightbox-prev-btn');
const nextBtn = document.getElementById('lightbox-next-btn');
// Nút đóng đã có trong attachEventListeners hoặc thêm ở đây:
if (lightboxCloseBtn) lightboxCloseBtn.onclick = closeLightbox;
// Đóng khi click vào overlay
if (imageLightbox) imageLightbox.onclick = (e) => { if (e.target === imageLightbox) closeLightbox(); };
// Nút Prev
if (prevBtn) prevBtn.onclick = () => showLightboxImage(currentLightboxIndex - 1);
// Nút Next
if (nextBtn) nextBtn.onclick = () => showLightboxImage(currentLightboxIndex + 1);

// Optional: Thêm điều hướng bằng bàn phím
document.addEventListener('keydown', (e) => {
    if (imageLightbox.classList.contains('show')) { // Chỉ xử lý khi lightbox đang mở
        if (e.key === 'ArrowLeft') {
            if (currentLightboxIndex > 0) showLightboxImage(currentLightboxIndex - 1);
        } else if (e.key === 'ArrowRight') {
            if (currentLightboxIndex < currentChatImages.length - 1) showLightboxImage(currentLightboxIndex + 1);
        } else if (e.key === 'Escape') {
            closeLightbox();
        }
    }
});

/**
 * Lưu thay đổi thông tin hồ sơ từ modal chỉnh sửa.
 */
async function saveProfileChanges() {
    if (!profileDisplayName || !profileBio || !profileAvatarUrl || !saveProfileEditBtn || !cancelProfileEditBtn || !editProfileModal) return; // Check elements

    const newDisplayName = profileDisplayName.value.trim();
    const newBio = profileBio.value.trim();
    const newAvatarUrl = profileAvatarUrl.value.trim();

    if (!newDisplayName) return showToast('Tên hiển thị không được để trống.', 'error');
    // Optional: Validate URL avatar cơ bản
    // if (newAvatarUrl && !newAvatarUrl.startsWith('http')) return showToast('URL Avatar không hợp lệ.', 'error');

    saveProfileEditBtn.disabled = true; saveProfileEditBtn.textContent = 'Đang lưu...';

    const userRef = doc(db, 'users', currentUser.uid);
    try {
        await updateDoc(userRef, {
            displayName: newDisplayName,
            bio: newBio || deleteField(), // Xóa field nếu bio rỗng
            avatarUrl: newAvatarUrl || deleteField() // Xóa field nếu avatar rỗng (nên có ảnh mặc định)
        });
        showToast('Cập nhật hồ sơ thành công!', 'success');
        editProfileModal.style.display = 'none'; // Đóng modal
        // Giao diện (avatar nav) sẽ tự cập nhật nhờ listener `wireProfile`
    } catch (error) {
        console.error("Lỗi khi cập nhật hồ sơ:", error);
        showToast('Có lỗi xảy ra, không thể cập nhật.', 'error');
    } finally {
        saveProfileEditBtn.disabled = false; saveProfileEditBtn.textContent = 'Lưu thay đổi';
    }
}

/**
 * Gửi báo cáo người dùng lên Firestore.
 */
async function submitReport() {
    if (!reportingUser || !currentUser || !reportUserModal || !submitReportBtn) return;
    const reasonRadio = document.querySelector('input[name="reportReason"]:checked');
    if (!reasonRadio) return showToast("Vui lòng chọn lý do báo cáo.", "error");
    const reason = reasonRadio.value;
    const details = reportDetails ? reportDetails.value.trim() : '';

    submitReportBtn.disabled = true; submitReportBtn.textContent = 'Đang gửi...';

    try {
        await addDoc(collection(db, "reports"), {
            reporterUid: currentUser.uid,
            reportedUid: reportingUser.uid,
            reason: reason,
            details: details || null, // Lưu null nếu không có chi tiết
            evidence: selectedEvidence.length > 0 ? selectedEvidence : null, // Lưu mảng tin nhắn bằng chứng
            timestamp: serverTimestamp()
            // Optional: Thêm ngữ cảnh như chat ID, group ID
            // chatId: currentChatId,
            // chatType: currentChatType
        });
        showToast("Đã gửi báo cáo thành công. Cảm ơn bạn!", "success");
    } catch (error) {
        console.error("Lỗi khi gửi báo cáo:", error);
        showToast("Có lỗi xảy ra, không thể gửi báo cáo.", "error");
    } finally {
        reportUserModal.style.display = 'none'; // Đóng modal
        if (reportDetails) reportDetails.value = ''; // Reset form
        const defaultReason = document.querySelector('input[name="reportReason"][value="spam"]');
        if(defaultReason) defaultReason.checked = true; // Reset radio
        document.querySelectorAll('.report-reason-row.selected').forEach(r => r.classList.remove('selected')); // Bỏ highlight
        reportingUser = null; // Reset người bị báo cáo
        selectedEvidence = []; // Reset bằng chứng
        if (evidencePreview) evidencePreview.style.display = 'none'; // Ẩn preview bằng chứng
        submitReportBtn.disabled = false; submitReportBtn.textContent = 'Gửi báo cáo'; // Reset nút
    }
}

// Các hàm liên quan đến chọn bằng chứng báo cáo
function enterMessageSelectionMode() { /* ... Giống code trước ... */ }
function exitMessageSelectionMode(saveChanges = false) { /* ... Giống code trước ... */ }
function updateSelectionCount() { /* ... Giống code trước ... */ }

/**
 * Gửi báo cáo lỗi lên Firestore.
 */
async function submitBugReport() {
    if (!bugDescription || !bugSteps || !submitBugReportBtn || !reportBugModal) return;
    const description = bugDescription.value.trim();
    const steps = bugSteps.value.trim();
    if (!description) return showToast("Vui lòng mô tả lỗi.", "error");

    submitBugReportBtn.disabled = true; submitBugReportBtn.textContent = "Đang gửi...";
    try {
        await addDoc(collection(db, "bug_reports"), {
            userId: currentUser?.uid || "unknown",
            email: currentUser?.email || "unknown",
            description: description,
            stepsToReproduce: steps || null,
            timestamp: serverTimestamp(),
            userAgent: navigator.userAgent,
            appVersion: "1.0" // Cập nhật version app của cậu
        });
        showToast("Đã gửi báo cáo lỗi! Cảm ơn bạn.", "success");
        reportBugModal.style.display = 'none';
        bugDescription.value = ''; bugSteps.value = '';
    } catch (error) { console.error("Lỗi gửi báo cáo lỗi:", error); showToast("Gửi báo cáo thất bại: " + error.message, "error"); }
    finally { submitBugReportBtn.disabled = false; submitBugReportBtn.textContent = "Gửi báo cáo"; }
}

/**
 * Tải và hiển thị danh sách bạn bè cho tab "Bạn bè".
 * Lấy danh sách UID từ currentUserData, lấy chi tiết từng người,
 * render lên list và gắn sự kiện filter cho ô tìm kiếm.
 */
function attachFriendsViewListeners() {
    const friendsNavItems = document.querySelectorAll('.friends-nav-item');
    const friendsPages = document.querySelectorAll('.friends-content-page');
    const addFriendBtnPage = document.getElementById('friends-view-add-btn');

    friendsNavItems.forEach(item => {
        item.onclick = () => {
            const pageId = item.dataset.friendsPage;
            if (!pageId) return;

            friendsPages.forEach(page => {
                page.style.display = (page.id === `friends-page-${pageId}`) ? 'flex' : 'none';
                page.classList.toggle('active', page.id === `friends-page-${pageId}`);
            });
            friendsNavItems.forEach(nav => nav.classList.remove('active'));
            item.classList.add('active');

            // Tải/Render dữ liệu cho trang
            if (pageId === 'list') {
                renderFriendsListPage(friends);
                // Gắn lại sự kiện tìm kiếm nếu cần
                 const friendsListSearch = document.getElementById('friends-list-search');
                 if (friendsListSearch) {
                    friendsListSearch.oninput = (e) => {
                       renderFriendsListPage(friends, e.target.value);
                    };
                 }
            } else if (pageId === 'requests') {
                loadFriendRequestsPage();
            } else if (pageId === 'groups') {
                // === THAY ĐỔI Ở ĐÂY ===
                renderGroupsListPage(); // Gọi hàm render danh sách nhóm
                // =======================
            }
        }
    });
}

    // === HÀM MỚI: RENDER TRANG DANH SÁCH BẠN BÈ (Alphabetical) ===
    function renderFriendsListPage(friendsData, filter = '') {
        const listContainer = document.getElementById('friends-list-alphabetical');
        const countTitle = document.getElementById('friends-count-title');
        if (!listContainer || !countTitle) return;

        countTitle.textContent = `Bạn bè (${friendsData.length})`; // Cập nhật tổng số bạn

        const searchTerm = filter.toLowerCase();
        let filteredFriends = friendsData;
        if (searchTerm) {
            filteredFriends = friendsData.filter(f => (f.displayName || f.email || '').toLowerCase().includes(searchTerm));
        }

        if (filteredFriends.length === 0) {
            listContainer.innerHTML = '<p class="friends-list-placeholder">Không tìm thấy bạn bè nào.</p>';
            return;
        }

        // Sắp xếp theo tên A-Z
        filteredFriends.sort((a, b) => (a.displayName || a.email).localeCompare(b.displayName || b.email));

        // Nhóm theo chữ cái
        const groupedFriends = filteredFriends.reduce((acc, friend) => {
            const name = friend.displayName || friend.email || '';
            let firstLetter = name[0] ? name[0].toUpperCase() : '#';
            if (!/[A-Z]/.test(firstLetter)) firstLetter = '#'; // Nhóm số/ký tự lạ vào #
            
            if (!acc[firstLetter]) acc[firstLetter] = [];
            acc[firstLetter].push(friend);
            return acc;
        }, {});

        // Render HTML
        listContainer.innerHTML = ''; // Xóa sạch
        Object.keys(groupedFriends).sort().forEach(letter => { // Sắp xếp chữ cái
            // Thêm dải phân cách chữ cái
            const divider = document.createElement('div');
            divider.className = 'letter-divider';
            divider.textContent = letter;
            listContainer.appendChild(divider);

            // Render từng bạn bè trong nhóm chữ cái đó
            groupedFriends[letter].forEach(u => {
                const item = document.createElement('div');
                item.className = 'friend-list-item';
                item.onclick = () => {
                    const chatNavButton = document.querySelector('.nav-button[data-view="chat"]');
                    if(chatNavButton) chatNavButton.click(); // Chuyển về tab chat
                    startDirectChat(u); // Mở chat
                };

                const avatarSrc = u.avatarUrl || `https://placehold.co/40x40?text=${(u.displayName || '?')[0].toUpperCase()}`;
                const verifiedTick = createVerifiedTickHTML(u.isVerified);
                const friendName = u.displayName || u.email || 'Người dùng';

                item.innerHTML = `
                    <div class="friend-list-left">
                        <img class="friend-list-avatar" src="${avatarSrc}" alt="Avatar">
                        <span class="friend-list-name">${escapeHtml(friendName)}${verifiedTick}</span>
                    </div>
                    <div class="friend-list-actions">
                        <button class="friend-action-btn" title="Tùy chọn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                        </button>
                    </div>
                `;
                // TODO: Gắn sự kiện cho nút 3 chấm
                listContainer.appendChild(item);
            });
        });
    }

    // === HÀM MỚI: RENDER TRANG LỜI MỜI KẾT BẠN ===
    function renderFriendRequestsPage(requestsData) {
        const listContainer = document.getElementById('friends-requests-list-page');
        if (!listContainer) return;

        if (requestsData.length === 0) {
            listContainer.innerHTML = '<p class="friends-list-placeholder">Không có lời mời kết bạn nào.</p>';
            return;
        }

        listContainer.innerHTML = ''; // Xóa placeholder
        requestsData.forEach(req => {
            const item = document.createElement('div');
            item.className = 'friend-req-item'; // Dùng lại style cũ
            item.innerHTML = `
                <div class="friend-list-left"> <img class="friend-list-avatar" src="${req.from_avatar || 'https://placehold.co/40x40?text=?'}" alt="Avatar">
                    <div class="friend-list-name" style="font-size: 15px;">${escapeHtml(req.from_displayName || req.from_email)}</div>
                </div>
                <div class="friend-req-buttons">
                    <button class="friend-req-btn reject-btn" data-req-id="${req.id}">Từ chối</button>
                    <button class="friend-req-btn accept-btn" data-req-id="${req.id}" data-from-uid="${req.from_uid}">Chấp nhận</button>
                </div>
            `;
            listContainer.appendChild(item);
        });

        // Gắn sự kiện cho các nút mới (dùng event delegation)
        listContainer.onclick = (e) => {
            const target = e.target;
            if (target.classList.contains('accept-btn')) {
                target.disabled = true;
                handleAcceptFriend(target.dataset.reqId, target.dataset.fromUid);
            } else if (target.classList.contains('reject-btn')) {
                target.disabled = true;
                handleRejectFriend(target.dataset.reqId);
            }
        };
    }

    // === HÀM MỚI: TẢI DATA CHO TAB BẠN BÈ ===
    async function loadFriendsPageData() {
        if (!currentUserData) return;
        
        // Load danh sách bạn bè (giống hàm cũ, chỉ render)
        const friendUIDs = currentUserData.friends || [];
        // 'friends' (biến global) đã được load trong onAuthStateChanged/loadAndSortChats
        renderFriendsListPage(friends); // Render list mặc định
        
        // Gắn sự kiện filter cho ô search
        const friendsListSearch = document.getElementById('friends-list-search');
        if (friendsListSearch) {
             friendsListSearch.oninput = (e) => {
                 renderFriendsListPage(friends, e.target.value);
             };
        }
    }

/**
 * Render nội dung changelog vào modal từ mảng changelogData.
 */
function renderChangelog() {
    if (!changelogContent || !changelogData) return;
    changelogContent.innerHTML = '';

    changelogData.forEach((entry, index) => {
        const entryBox = document.createElement('div');
        entryBox.className = 'changelog-entry-box';

        // 1. Tạo phần Header (để bấm vào)
        const header = document.createElement('div');
        header.className = 'changelog-header clickable';
        header.innerHTML = `
            <div class="changelog-header-left">
                <h3>Phiên bản ${entry.version}</h3>
                <span>${escapeHtml(entry.subtitle || entry.date)}</span>
            </div>
            <svg class="changelog-chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
        `;

        // 2. Tạo phần Nội dung (bị ẩn)
        const detailsContent = document.createElement('div');
        detailsContent.className = 'changelog-details-content';
        detailsContent.style.display = 'none';

        if (Array.isArray(entry.details)) {
            entry.details.forEach(line => {
                const p = document.createElement('p');
                p.textContent = line;
                detailsContent.appendChild(p);
            });
        } else if (entry.details) {
            const p = document.createElement('p');
            p.textContent = entry.details;
            detailsContent.appendChild(p);
        }

        // 3. Gắn sự kiện Click
        header.onclick = () => {
            const isOpen = detailsContent.style.display === 'block';
            detailsContent.style.display = isOpen ? 'none' : 'block';
            header.classList.toggle('open', !isOpen);
        };

        // 4. Bỏ vào box chính
        entryBox.appendChild(header);
        entryBox.appendChild(detailsContent);
        changelogContent.appendChild(entryBox);
    });
}

/**
 * Xử lý hiển thị popup thông báo (nếu dùng Remote Config).
 * Lấy dữ liệu title, message, image từ Remote Config và hiển thị modal.
 */
function handleAnnouncementPopup() {
    // Chỉ chạy nếu có Remote Config và các element popup
    if (typeof getRemoteConfig === 'undefined' || !announcementOverlay || !announcementTitle || !announcementText || !announcementImage || !closeAnnouncementBtn) {
         console.warn("Remote Config or Announcement elements not available.");
         return;
    }

    try {
        const show = getBoolean(remoteConfig, "show_announcement"); // Key config: show_announcement (Boolean)
        if (show) {
            const title = getValue(remoteConfig, "announcement_title").asString() || "Thông báo"; // Key: announcement_title (String)
            const message = getValue(remoteConfig, "announcement_message").asString(); // Key: announcement_message (String)
            const imageUrl = getValue(remoteConfig, "announcement_image_url").asString(); // Key: announcement_image_url (String)

            if (!message) { // Không hiện nếu không có nội dung
                 console.warn("Announcement message is empty.");
                 return;
            }

            announcementTitle.textContent = title;
            announcementText.textContent = message; // Đã xử lý xuống dòng bằng white-space: pre-wrap

            if (imageUrl) {
                announcementImage.src = imageUrl;
                announcementImage.style.display = 'block'; // Hiện ảnh
            } else {
                announcementImage.style.display = 'none'; // Ẩn ảnh nếu không có URL
            }

            announcementOverlay.classList.add('show'); // Hiện popup với hiệu ứng
        } else {
             announcementOverlay.classList.remove('show'); // Đảm bảo ẩn nếu config là false
        }
    } catch (error) {
         console.error("Error handling announcement popup:", error);
    }
}

/**
 * Hiển thị popup bảo trì (nếu dùng Remote Config).
 * Sử dụng lại modal announcement nhưng ẩn nút đóng.
 */
function showMaintenancePopup() {
    if (!announcementOverlay || !announcementTitle || !announcementText || !announcementImage || !closeAnnouncementBtn) {
         console.warn("Announcement elements not available for maintenance message. Using alert fallback.");
         alert("Ứng dụng đang bảo trì. Vui lòng quay lại sau."); // Fallback
         return;
    }

    try {
        // Lấy thông báo bảo trì từ Remote Config hoặc hardcode
        const maintenanceMsg = getValue(remoteConfig, "maintenance_message")?.asString() || "Ứng dụng đang được bảo trì. Vui lòng kiểm tra lại sau ít phút."; // Key: maintenance_message (String)
        const maintenanceTitle = "Thông báo bảo trì";

        announcementTitle.textContent = maintenanceTitle;
        announcementText.textContent = maintenanceMsg;
        announcementImage.style.display = 'none'; // Luôn ẩn ảnh khi bảo trì
        closeAnnouncementBtn.style.display = 'none'; // Ẩn nút đóng
        announcementOverlay.onclick = null; // Vô hiệu hóa đóng khi click ra ngoài

        announcementOverlay.classList.add('show'); // Hiện popup
    } catch (error) {
         console.error("Error showing maintenance popup:", error);
         alert("Ứng dụng đang bảo trì. Vui lòng quay lại sau."); // Fallback
    }
}

// === HÀM MỚI: RENDER TRANG DANH SÁCH NHÓM (ĐÃ SỬA CLICK) ===
async function renderGroupsListPage() {
    const listContainer = document.getElementById('friends-groups-list');
    const pageContainer = document.getElementById('friends-page-groups');
    if (!listContainer || !pageContainer) {
        console.error("Missing elements for groups list page!");
        return;
    }

    if (pageContainer.classList.contains('active')) {
      listContainer.innerHTML = '<p class="friends-list-placeholder">Đang tải danh sách nhóm...</p>';
    }

    if (!currentUser) {
         listContainer.innerHTML = '<p class="friends-list-placeholder">Lỗi: Chưa đăng nhập.</p>';
         return;
    }

    try {
        const groupsQuery = query(collection(db, 'groups'), where('member_uids', 'array-contains', currentUser.uid));
        const groupSnap = await getDocs(groupsQuery);

        if (groupSnap.empty) {
            listContainer.innerHTML = '<p class="friends-list-placeholder">Bạn chưa tham gia nhóm nào.</p>';
            return;
        }

        listContainer.innerHTML = ''; // Xóa loading

        const groupsData = groupSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        groupsData.sort((a, b) => (a.groupName || '').localeCompare(b.groupName || ''));

        groupsData.forEach(g => {
            const item = document.createElement('div');
            item.className = 'friend-list-item';
            item.style.cursor = 'pointer';

            // --- THAY ĐỔI 1: LƯU DATA VÀO DATASET ---
            // Chúng ta lưu thông tin nhóm vào thẳng HTML
            item.dataset.groupId = g.id;
            item.dataset.groupName = g.groupName;
            // ----------------------------------------

            // --- XÓA item.onclick = ... TẠI ĐÂY ---

            const memberCount = g.member_uids ? g.member_uids.length : 0;
            const avatarSrc = g.avatarUrl || `https://placehold.co/40x40/1e293b/fff?text=${(g.groupName || '?')[0].toUpperCase()}`;
            const groupDisplayName = g.groupName || 'Nhóm không tên';

            item.innerHTML = `
                <div class="friend-list-left">
                    <img class="friend-list-avatar" src="${avatarSrc}" alt="Group Avatar">
                    <div>
                        <span class="friend-list-name">${escapeHtml(groupDisplayName)}</span>
                        <div class="result-sub" style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">${memberCount} thành viên</div>
                    </div>
                </div>
                <div class="friend-list-actions">
                     </div>
            `;
            listContainer.appendChild(item);
        });

        // --- THAY ĐỔI 2: GẮN 1 SỰ KIỆN CLICK CHO CẢ KHUNG CHỨA ---
        listContainer.onclick = (e) => {
            // Tìm xem phần tử cha gần nhất có class 'friend-list-item' là gì
            const clickedItem = e.target.closest('.friend-list-item');

            // Nếu không bấm vào item nào (bấm vào khoảng trống) thì thôi
            if (!clickedItem) return;

            // Lấy data từ dataset chúng ta đã lưu
            const groupId = clickedItem.dataset.groupId;
            const groupName = clickedItem.dataset.groupName;

            if (groupId && groupName) {
                // Dòng log mới để kiểm tra
                console.log("Clicked group item (event delegation):", groupId, groupName);

                const chatNavButton = document.querySelector('.nav-button[data-view="chat"]');
                if (chatNavButton) chatNavButton.click();

                startGroupChat(groupId, groupName);
            } else {
                console.warn("Clicked item missing data:", clickedItem);
            }
        };
        // ---------------------------------------------------------

    } catch (error) {
        console.error("Lỗi khi tải danh sách nhóm:", error);
        listContainer.innerHTML = '<p class="friends-list-placeholder" style="color: red;">Lỗi tải danh sách nhóm!</p>';
    }
}

// --- HÀM GẮN SỰ KIỆN CHÍNH ---
function attachEventListeners() {
    handleMentionInput(); // Kích hoạt gợi ý mention

    // --- NAV CHÍNH ---
    navButtons.forEach(button => {
        button.onclick = (e) => {
            const targetViewId = button.dataset.view;
            if (!targetViewId) return;

            // Cập nhật nút active
            navButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            // Hiển thị view tương ứng
            appViews.forEach(view => {
                view.style.display = (view.dataset.view === targetViewId) ? 'block' : 'none';
                view.classList.toggle('active', view.dataset.view === targetViewId);
            });

            // Logic riêng cho từng view
            if (targetViewId === 'friends') {
                loadFriendsPageData(); // <<< THÊM DÒNG NÀY VÀO
                attachFriendsViewListeners(); // <<< THÊM DÒNG NÀY VÀO
            } else if (targetViewId === 'wall') {
                // Load iframe Wall nếu chưa load
                if (!wallLoaded && currentUser && wallLoader && wallIframe) {
                    wallLoader.style.display = 'flex';
                    wallLoader.innerHTML = '<div style="border: 4px solid var(--glass); border-top: 4px solid var(--accent-1); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>';
                    wallIframe.src = `wall.html?id=${currentUser.uid}`;
                    wallIframe.onload = () => { if (wallLoader) wallLoader.style.display = 'none'; wallLoaded = true; wallIframe.onload = null; wallIframe.onerror = null; };
                    wallIframe.onerror = () => { if(wallLoader) wallLoader.innerHTML = '<p style="color: red;">Lỗi tải Tường nhà!</p>'; wallIframe.onload = null; wallIframe.onerror = null; }
                } else if (wallLoaded && wallLoader) {
                    wallLoader.style.display = 'none';
                }
            } else if (targetViewId === 'chat') {
                // Có thể thêm logic khi quay lại tab chat nếu cần
            }

            // Luôn đóng menu settings khi chuyển tab
            if (navSettingsMenu) navSettingsMenu.style.display = 'none';
        };
    });

    // === THÊM ĐOẠN NÀY VÀO ===
    // Add Member Modal (Fix nút Hủy)
    const cancelAddMemberBtn = document.getElementById('cancel-add-member-btn');
    const addMemberModal = document.getElementById('add-member-modal');
    if (cancelAddMemberBtn && addMemberModal) {
        cancelAddMemberBtn.onclick = () => {
            addMemberModal.style.display = 'none';
        };
    }
    // === KẾT THÚC ĐOẠN THÊM ===

    const downloadBtn = document.getElementById('lightbox-download-btn'); // <<< Lấy nút tải
    // <<< THÊM SỰ KIỆN CHO NÚT TẢI >>>
if (downloadBtn) {
    downloadBtn.onclick = (e) => {
         e.preventDefault(); // Ngăn hành vi mặc định của thẻ <a>
         e.stopPropagation(); // Ngăn sự kiện click lan ra overlay
         downloadCurrentImage(); // Gọi hàm tải ảnh
    };
}

    // --- AVATAR NAV & MENU SETTINGS ---
    if (navAvatar && navSettingsMenu) {
        navAvatar.onclick = (e) => {
            e.stopPropagation();
            if(addMenu) addMenu.style.display = 'none'; // Đóng menu kia
            const isCurrentlyVisible = navSettingsMenu.style.display === 'block';
            navSettingsMenu.style.display = isCurrentlyVisible ? 'none' : 'block';
        };
    }
    // Gắn sự kiện cho các mục trong menu settings
    const profileBtn = document.getElementById('go-to-profile');
    if (profileBtn) profileBtn.onclick = () => { if(currentUser) window.location.href = `profile.html?id=${currentUser.uid}`; if(navSettingsMenu) navSettingsMenu.style.display = 'none'; };
    if (showChangelogBtn && changelogModal) showChangelogBtn.onclick = () => { renderChangelog(); changelogModal.style.display = 'flex'; if(navSettingsMenu) navSettingsMenu.style.display = 'none'; };
    if (openReportBugModalBtn && reportBugModal) openReportBugModalBtn.onclick = () => { reportBugModal.style.display = 'flex'; if(navSettingsMenu) navSettingsMenu.style.display = 'none'; };
    if (openAboutModalBtn && aboutModal) openAboutModalBtn.onclick = () => { aboutModal.style.display = 'flex'; if(navSettingsMenu) navSettingsMenu.style.display = 'none'; };
    const settingsBtn = document.getElementById('go-to-settings');
    if (settingsBtn) settingsBtn.onclick = () => { window.location.href = 'settings.html'; if(navSettingsMenu) navSettingsMenu.style.display = 'none'; };
    const logoutBtn = document.getElementById('go-login');
    if (logoutBtn) logoutBtn.onclick = async () => { await signOut(auth); window.location.href='login.html'; };

    // --- NÚT '+' & MENU ADD ---
    if (addBtn && addMenu) {
        addBtn.onclick = (e) => {
            e.stopPropagation(); // Ngăn lan ra document
            if(navSettingsMenu) navSettingsMenu.style.display = 'none'; // Đóng menu kia
            addMenu.style.display = addMenu.style.display === 'block' ? 'none' : 'block';
        };
    }
    const createGroupMenuBtn = document.getElementById('create-group-from-menu');
    if (createGroupMenuBtn) createGroupMenuBtn.onclick = () => { openCreateGroupModal(); if(addMenu) addMenu.style.display = 'none'; };
    const addFriendMenuBtn = document.getElementById('add-friend-from-menu');
    const addFriendModalElem = document.getElementById('add-friend-modal'); // Đổi tên biến
    if (addFriendMenuBtn && addFriendModalElem) addFriendMenuBtn.onclick = () => { addFriendModalElem.style.display = 'flex'; if(addMenu) addMenu.style.display = 'none'; };


    // --- Gán sự kiện cho các Popup (Modal) ---
    // Add Friend Modal
    const cancelAddFriendBtn = document.getElementById('cancel-add-friend-btn');
    const confirmAddFriendBtn = document.getElementById('confirm-add-friend-btn');
    if (cancelAddFriendBtn && addFriendModalElem) cancelAddFriendBtn.onclick = () => addFriendModalElem.style.display = 'none';
    if (confirmAddFriendBtn) confirmAddFriendBtn.onclick = addFriendByEmail; // Vẫn dùng logic mở profile

    // Friend Request Modal

    // Create Group Modal
    if (closeGroupModalBtn && createGroupModal) closeGroupModalBtn.onclick = () => createGroupModal.style.display = 'none';
    if (confirmCreateGroupBtn) confirmCreateGroupBtn.onclick = confirmCreateGroup;

    // Reactions Modal
    if (closeReactionsModal && reactionsModal) closeReactionsModal.onclick = () => reactionsModal.style.display = 'none';
    if (reactionsModal) reactionsModal.onclick = (e) => { if (e.target === reactionsModal) reactionsModal.style.display = 'none'; };

    // Edit Profile Modal
    const editProfileBtn = document.getElementById('edit-profile-btn'); // Nút mở modal (nếu có)
    if (editProfileBtn && editProfileModal) editProfileBtn.onclick = () => { /* Logic điền form */ editProfileModal.style.display = 'flex';};
    if (cancelProfileEditBtn && editProfileModal) cancelProfileEditBtn.onclick = () => editProfileModal.style.display = 'none';
    if (saveProfileEditBtn) saveProfileEditBtn.onclick = saveProfileChanges;

    // Custom Confirm Modal (đã gán trong showConfirmation)

    // Report User Modal
    if (cancelReportBtn && reportUserModal) cancelReportBtn.onclick = () => { reportUserModal.style.display = 'none'; if(reportDetails) reportDetails.value = ''; /* Reset form */ };
    if (submitReportBtn) submitReportBtn.onclick = submitReport;
    if (attachEvidenceBtn) attachEvidenceBtn.onclick = enterMessageSelectionMode;
    if (cancelSelectionBtn) cancelSelectionBtn.onclick = () => exitMessageSelectionMode(false);
    if (confirmSelectionBtn) confirmSelectionBtn.onclick = () => exitMessageSelectionMode(true);
    // Xử lý radio reasons
    document.querySelectorAll('.report-reason-row').forEach(row => { row.onclick = () => { document.querySelectorAll('.report-reason-row').forEach(r => r.classList.remove('selected')); row.classList.add('selected'); const radio = row.querySelector('input[type="radio"]'); if(radio) radio.checked = true; }; });

    // Edit Group Modal (đã gán trong showGroupInfo)
    // Add Member Modal (đã gán trong showGroupInfo)

    // Changelog Modal
    // Changelog Modal
    const closeChangelogXBtn = document.getElementById('close-changelog-x-btn');
    if (closeChangelogXBtn && changelogModal) closeChangelogXBtn.onclick = () => changelogModal.style.display = 'none';
    if (changelogModal) changelogModal.onclick = (e) => { if (e.target === changelogModal) changelogModal.style.display = 'none'; };
    // Announcement Modal
    if (closeAnnouncementBtn && announcementOverlay) closeAnnouncementBtn.onclick = () => announcementOverlay.classList.remove('show');
    if (announcementOverlay) announcementOverlay.onclick = (e) => { if (e.target === announcementOverlay && closeAnnouncementBtn && closeAnnouncementBtn.style.display !== 'none') announcementOverlay.classList.remove('show'); };

    // Report Bug Modal
    if (cancelReportBugBtn && reportBugModal) cancelReportBugBtn.onclick = () => { reportBugModal.style.display = 'none'; if(bugDescription) bugDescription.value = ''; if(bugSteps) bugSteps.value = ''; };
    if (submitBugReportBtn) submitBugReportBtn.onclick = submitBugReport;
    if (reportBugModal) reportBugModal.onclick = (e) => { if (e.target === reportBugModal) { reportBugModal.style.display = 'none'; if(bugDescription) bugDescription.value = ''; if(bugSteps) bugSteps.value = ''; } };

    // About Modal
    if (closeAboutModalBtn && aboutModal) closeAboutModalBtn.onclick = () => aboutModal.style.display = 'none';
    if (aboutModal) aboutModal.onclick = (e) => { if (e.target === aboutModal) aboutModal.style.display = 'none'; };

    // Join Group Modal (nếu có logic join qua link)
    const cancelJoinBtn = document.getElementById('cancel-join-group-btn');
    const confirmJoinBtn = document.getElementById('confirm-join-group-btn');
    const joinGroupModal = document.getElementById('join-group-modal');
    if(cancelJoinBtn && joinGroupModal) cancelJoinBtn.onclick = () => joinGroupModal.style.display = 'none';
    // if(confirmJoinBtn) confirmJoinBtn.onclick = () => { /* Logic join group */ };

    // --- Gán sự kiện cho các nút trong khu vực Chat ---
    if (sendBtn) sendBtn.onclick = sendMessage;
    if (cancelReplyBtn) cancelReplyBtn.onclick = cancelReply;
    if (cancelEditBtn) cancelEditBtn.onclick = cancelEdit;
    if (cancelPreviewBtn) cancelPreviewBtn.onclick = cancelImagePreview;
    if (closeInfoBtn && chatInfoPanel) closeInfoBtn.onclick = () => chatInfoPanel.classList.remove('open');
    if (toastCloseBtn && toast) toastCloseBtn.onclick = () => toast.style.display = 'none';
    if (lightboxCloseBtn && imageLightbox) lightboxCloseBtn.onclick = () => imageLightbox.style.display = 'none';
    if (imageLightbox) {
        imageLightbox.onclick = (e) => {
            // Chỉ đóng khi click trực tiếp vào element overlay (nền mờ)
            // KHÔNG đóng khi click vào ảnh (img), nút (button), hoặc thumbnail list
            if (e.target === imageLightbox) { // <<< KIỂM TRA TARGET LÀ OVERLAY
                closeLightbox();
            }
        };
    }

    // --- LOGIC INPUT TEXT VÀ CHỌN ẢNH ---
    if (messageInput) {
        messageInput.addEventListener('paste', handlePasteImage);
        messageInput.addEventListener('input', handleTextInput);
        messageInput.addEventListener('keypress', handleEnterSend);
    }
    if (imageInput) imageInput.onchange = handleImageSelection;

    // --- CÁC LISTENER KHÁC (Context Menu, Mouse Over, Visibility) ---
    if (messagesContainer) {
        messagesContainer.addEventListener('contextmenu', showMessageContextMenu);
        messagesContainer.addEventListener('mouseover', handleMouseOverMessage);
    }
    document.addEventListener('visibilitychange', handleVisibilityChange);

    // Đóng các menu khi click ra ngoài
    document.addEventListener('click', (e) => {
        if (navSettingsMenu && !navSettingsMenu.contains(e.target) && e.target !== navAvatar) navSettingsMenu.style.display = 'none';
        if (addMenu && !addMenu.contains(e.target) && e.target !== addBtn) addMenu.style.display = 'none';
        if (messageContextMenu && !messageContextMenu.contains(e.target)) messageContextMenu.style.display = 'none';
         // Đóng dropdown tìm kiếm nếu click ra ngoài
        if (globalSearch && searchDropdown && e.target !== globalSearch && !searchDropdown.contains(e.target)) searchDropdown.style.display = 'none';
    });
}

// --- CÁC HÀM XỬ LÝ SỰ KIỆN INPUT/ẢNH/VISIBILITY ---
function handlePasteImage(event) {
    const items = (event.clipboardData || window.clipboardData).items; let imageFile = null;
    for (let i = 0; i < items.length; i++) { if (items[i].kind === 'file' && items[i].type.startsWith('image/')) { imageFile = items[i].getAsFile(); break; }}
    if (imageFile && imagePreview && imagePreviewContainer && messageInput && chatInputContainer) {
        event.preventDefault(); selectedImageFile = imageFile; const reader = new FileReader();
        reader.onload = (ev) => { if(ev.target?.result) imagePreview.src = ev.target.result; imagePreviewContainer.style.display = 'block'; messageInput.placeholder = 'Thêm chú thích...'; chatInputContainer.classList.add('has-text'); };
        reader.readAsDataURL(imageFile);
    }
}
function handleTextInput() {
    if(!messageInput || !chatInputContainer) return;
    const hasText = messageInput.value.trim().length > 0;
    chatInputContainer.classList.toggle('has-text', hasText || selectedImageFile != null);
    if(!currentChatId || !currentUser) return; const tRef = ref(rtdb, `/typing/${currentChatId}/${currentUser.uid}`);
    set(tRef, true); clearTimeout(typingTimer); typingTimer = setTimeout(() => set(tRef, false), 2000);
}
function handleEnterSend(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
function handleImageSelection(e) {
    const f = e.target.files?.[0]; if (!f || !imagePreview || !imagePreviewContainer || !messageInput || !chatInputContainer) return; selectedImageFile = f; const reader = new FileReader();
    reader.onload = (ev) => { if(ev.target?.result) imagePreview.src = ev.target.result; imagePreviewContainer.style.display = 'block'; messageInput.placeholder = 'Thêm chú thích...'; chatInputContainer.classList.add('has-text'); };
    reader.readAsDataURL(f);
}
/**
 * Hiển thị thông tin chi tiết của nhóm chat trong panel bên phải.
 * ĐÃ FIX LỖI "roleClass is not defined".
 * @param {string} groupId ID của nhóm cần hiển thị thông tin.
 */
async function showGroupInfo(groupId) {
    // Kiểm tra các element panel chính
    if (!friendInfoContent || !groupInfoContent || !chatInfoPanel) {
        console.error("Missing main info panel content elements!");
        return;
    }
    friendInfoContent.style.display = 'none'; // Ẩn panel bạn bè
    groupInfoContent.style.display = 'block'; // Hiện panel nhóm

    const groupRef = doc(db, "groups", groupId); // Tham chiếu đến document nhóm

    // Dùng onSnapshot để lắng nghe thay đổi dữ liệu nhóm theo thời gian thực
    onSnapshot(groupRef, async (groupDoc) => {
        // --- Lấy các DOM elements trong panel nhóm (dùng querySelector bên trong panel) ---
        const groupAvatarPanel = groupInfoContent.querySelector('#group-avatar');
        const groupNameDisplayPanel = groupInfoContent.querySelector('#group-name-display');
        const groupMembersListPanel = groupInfoContent.querySelector('#group-members-list');
        const groupSentImagesGridPanel = groupInfoContent.querySelector('#group-sent-images-grid');
        const addMemberBtnPanel = groupInfoContent.querySelector('#add-group-member-btn');
        const disbandGroupBtnPanel = groupInfoContent.querySelector('#disband-group-btn');
        const leaveGroupBtnPanel = groupInfoContent.querySelector('#leave-group-btn');
        const toggleMuteBtnGroupPanel = groupInfoContent.querySelector('#toggle-mute-btn-group');
        const muteIconOnGroupPanel = groupInfoContent.querySelector('#mute-icon-on-group');
        const muteIconOffGroupPanel = groupInfoContent.querySelector('#mute-icon-off-group');
        const muteBtnTextGroupPanel = groupInfoContent.querySelector('#mute-btn-text-group');

        // Kiểm tra các element quan trọng
        if (!groupAvatarPanel || !groupNameDisplayPanel || !groupMembersListPanel || !groupSentImagesGridPanel || !addMemberBtnPanel || !disbandGroupBtnPanel || !leaveGroupBtnPanel || !toggleMuteBtnGroupPanel) {
            console.error("Missing elements inside group info panel!");
            groupInfoContent.innerHTML = '<p style="color:red; padding: 10px;">Lỗi tải giao diện thông tin nhóm.</p>';
            return;
        }

        // --- Xử lý nếu nhóm không tồn tại (đã bị xóa/giải tán) ---
        if (!groupDoc.exists()) {
            groupNameDisplayPanel.textContent = "Nhóm không tồn tại";
            groupAvatarPanel.src = 'https://placehold.co/95x95';
            groupMembersListPanel.innerHTML = '';
            groupSentImagesGridPanel.innerHTML = '';
            addMemberBtnPanel.style.display = 'none';
            disbandGroupBtnPanel.style.display = 'none';
            toggleMuteBtnGroupPanel.style.display = 'none';
            leaveGroupBtnPanel.style.display = 'none';
            // Vô hiệu hóa khả năng edit
            groupAvatarPanel.classList.remove('editable-group-info');
            groupNameDisplayPanel.classList.remove('editable-group-info');
            groupAvatarPanel.onclick = null;
            groupNameDisplayPanel.onclick = null;
            return; // Dừng hàm
        }

        // --- Lấy dữ liệu nhóm và thông tin vai trò ---
        const groupData = groupDoc.data();
        const groupName = groupData.groupName || 'Nhóm không tên';
        const roles = groupData.roles || {};
        const myRole = roles[currentUser.uid]; // Vai trò của user hiện tại
        const groupAvatarUrl = groupData.avatarUrl;
        const memberUids = groupData.member_uids || [];

        // --- CẬP NHẬT UI PANEL CHÍNH ---
        groupNameDisplayPanel.textContent = groupName;
        groupAvatarPanel.src = groupAvatarUrl || `https://placehold.co/95x95/1e293b/fff?text=${escapeHtml(groupName[0])}`;

        // --- LOGIC NÚT MUTE ---
        if (toggleMuteBtnGroupPanel && muteIconOnGroupPanel && muteIconOffGroupPanel && muteBtnTextGroupPanel) {
            const chatIdForMute = groupId;
            const isMutedGroup = currentUserData.mutedChats?.[chatIdForMute] === true;
            muteIconOnGroupPanel.style.display = isMutedGroup ? 'none' : 'inline-block';
            muteIconOffGroupPanel.style.display = isMutedGroup ? 'inline-block' : 'none';
            muteBtnTextGroupPanel.textContent = isMutedGroup ? "Bật thông báo" : "Tắt thông báo";
            toggleMuteBtnGroupPanel.title = isMutedGroup ? "Bật thông báo" : "Tắt thông báo";
            
            // Gán lại onclick để đảm bảo dùng dữ liệu mute mới nhất
            toggleMuteBtnGroupPanel.onclick = async () => {
                 const currentlyMuted = currentUserData.mutedChats?.[chatIdForMute] === true;
                 const newMutedStatus = !currentlyMuted;
                 toggleMuteBtnGroupPanel.disabled = true;
                 try {
                     const userRef = doc(db, 'users', currentUser.uid);
                     const fieldName = `mutedChats.${chatIdForMute}`;
                     if (newMutedStatus) {
                         await updateDoc(userRef, { [fieldName]: true });
                         if (!currentUserData.mutedChats) currentUserData.mutedChats = {};
                         currentUserData.mutedChats[chatIdForMute] = true;
                         showToast("Đã tắt thông báo cho nhóm này.", "info");
                     } else {
                         await updateDoc(userRef, { [fieldName]: deleteField() });
                         if (currentUserData.mutedChats) delete currentUserData.mutedChats[chatIdForMute];
                         showToast("Đã bật thông báo nhóm.", "success");
                     }
                     // Cập nhật UI ngay lập tức
                     muteIconOnGroupPanel.style.display = newMutedStatus ? 'none' : 'inline-block';
                     muteIconOffGroupPanel.style.display = newMutedStatus ? 'inline-block' : 'none';
                     muteBtnTextGroupPanel.textContent = newMutedStatus ? "Bật thông báo" : "Tắt thông báo";
                     toggleMuteBtnGroupPanel.title = newMutedStatus ? "Bật thông báo" : "Tắt thông báo";
                 } catch (err) { console.error("Lỗi mute group:", err); showToast("Lỗi!", "error");}
                 finally { toggleMuteBtnGroupPanel.disabled = false; }
             };
             toggleMuteBtnGroupPanel.style.display = 'block'; // Đảm bảo nút hiện
        }

        // --- HIỆN/ẨN NÚT GIẢI TÁN CHO ADMIN ---
        if (myRole === 'admin') {
            disbandGroupBtnPanel.style.display = 'block';
            disbandGroupBtnPanel.onclick = () => disbandGroup(groupId, groupName);
        } else {
            disbandGroupBtnPanel.style.display = 'none';
            disbandGroupBtnPanel.onclick = null;
        }

        // --- LOGIC CHO ADMIN/MODERATOR (Sửa nhóm, thêm member) ---
        if (myRole === 'admin' || myRole === 'moderator') {
            // A. CHO PHÉP SỬA TÊN/AVATAR
            groupAvatarPanel.classList.add('editable-group-info');
            groupNameDisplayPanel.classList.add('editable-group-info');
            groupAvatarPanel.title = "Nhấn để đổi thông tin nhóm";
            groupNameDisplayPanel.title = "Nhấn để đổi thông tin nhóm";
            
            const openEditModal = () => {
                 if(!editGroupModal || !editGroupNameInput || !editGroupAvatarInput || !editGroupAvatarPreview || !saveEditGroupBtn || !cancelEditGroupBtn || !groupAvatarUploadInput || !editGroupAvatarLoading) return;
                 editGroupNameInput.value = groupName;
                 editGroupAvatarInput.value = groupAvatarUrl || '';
                 editGroupAvatarPreview.src = groupAvatarUrl || `https://placehold.co/95x95/1e293b/fff?text=${escapeHtml(groupName[0])}`;
                 editGroupAvatarLoading.style.display = 'none';
                 editGroupModal.style.display = 'flex';
                 editGroupModal.classList.add('show');
            };
            groupAvatarPanel.onclick = openEditModal;
            groupNameDisplayPanel.onclick = openEditModal;

             // Gán sự kiện cho các nút modal sửa nhóm (chỉ gán 1 lần)
             if (!saveEditGroupBtn.dataset.listenerAttached) {
                 editGroupAvatarPreview.onclick = () => { if(groupAvatarUploadInput) groupAvatarUploadInput.click(); };
                 groupAvatarUploadInput.onchange = async () => {
                      const file = groupAvatarUploadInput.files[0]; if (!file || !editGroupAvatarLoading || !editGroupAvatarPreview || !editGroupAvatarInput) return;
                      editGroupAvatarLoading.style.display = 'block'; editGroupAvatarPreview.style.opacity = '0.5';
                      try { const newUrl = await uploadImage(file); editGroupAvatarInput.value = newUrl; editGroupAvatarPreview.src = newUrl; showToast("Tải ảnh thành công!", "success"); }
                      catch (err) { console.error("Lỗi upload:", err); showToast("Lỗi upload!", "error"); }
                      finally { editGroupAvatarLoading.style.display = 'none'; editGroupAvatarPreview.style.opacity = '1'; groupAvatarUploadInput.value = ''; }
                  };
                 saveEditGroupBtn.onclick = async () => {
                      const newName = editGroupNameInput.value.trim(); const newAvatar = editGroupAvatarInput.value.trim();
                      if (!newName) return showToast("Tên nhóm trống!", "error");
                      saveEditGroupBtn.disabled = true; saveEditGroupBtn.textContent = 'Đang lưu...';
                      try {
                          const updates = { groupName: newName, avatarUrl: newAvatar || deleteField() };
                          await updateDoc(groupRef, updates); showToast("Cập nhật thành công!", "success"); if(editGroupModal) editGroupModal.style.display = 'none'; // <<< THÊM DÒNG NÀY editGroupModal.classList.remove('show');
                      } catch (err) { console.error("Lỗi lưu:", err); showToast("Lỗi!", "error"); }
                      finally { saveEditGroupBtn.disabled = false; saveEditGroupBtn.textContent = 'Lưu thay đổi'; }
                  };
                 cancelEditGroupBtn.onclick = () => { 
                    if(editGroupModal) {
                        editGroupModal.style.display = 'none'; // <<< THÊM DÒNG NÀY
                        editGroupModal.classList.remove('show'); 
                    }
                    if(groupAvatarUploadInput) groupAvatarUploadInput.value = ''; 
                };
                 saveEditGroupBtn.dataset.listenerAttached = 'true';
             }

            // B. LOGIC THÊM THÀNH VIÊN
            addMemberBtnPanel.style.display = 'block';
            addMemberBtnPanel.onclick = async () => {
                 if(!addMemberModal || !addMemberGroupName || !addMemberFriendList || !confirmAddMemberBtn || !cancelAddMemberBtn) return;
                 const latestGroupDoc = await getDoc(groupRef); if (!latestGroupDoc.exists()) return;
                 const latestGroupData = latestGroupDoc.data(); const latestMemberUids = latestGroupData.member_uids || [];
                 addMemberGroupName.textContent = `Nhóm: ${latestGroupData.groupName}`;
                 addMemberFriendList.innerHTML = 'Đang tải bạn bè...'; addMemberModal.style.display = 'flex'; addMemberModal.classList.add('show');
                 const meDoc = await getDoc(doc(db, 'users', currentUser.uid)); const friendUids = meDoc.data()?.friends || [];
                 const friendsToAdd = friendUids.filter(uid => !latestMemberUids.includes(uid));
                 addMemberFriendList.innerHTML = '';
                 if (friendsToAdd.length === 0) { addMemberFriendList.innerHTML = '<p style="color: var(--text-2); text-align: center;">Tất cả bạn bè đã ở trong nhóm.</p>'; confirmAddMemberBtn.disabled = true; return; }
                 else { confirmAddMemberBtn.disabled = false; }
                 for (const friendUid of friendsToAdd) {
                     const friendDoc = await getDoc(doc(db, 'users', friendUid));
                     if (friendDoc.exists()) {
                          const friendData = friendDoc.data(); const displayName = friendData.displayName || friendData.email;
                          const avatarUrl = friendData.avatarUrl || `https://placehold.co/32x32?text=${displayName[0]}`;
                          const div = document.createElement('div');
                          div.innerHTML = `<label style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s;"><input type="checkbox" class="add-member-checkbox" value="${friendUid}" style="width: 18px; height: 18px; flex-shrink: 0;"><img src="${avatarUrl}" style="width: 32px; height: 32px; border-radius: 50%;"><span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(displayName)}</span></label>`;
                          const label = div.querySelector('label');
                          label.onmouseover = () => label.style.backgroundColor = 'var(--glass)';
                          label.onmouseout = () => label.style.backgroundColor = 'transparent';
                          addMemberFriendList.appendChild(div);
                     }
                 }
            };
             // Gán sự kiện nút trong modal thêm thành viên (chỉ gán 1 lần)
             if (!confirmAddMemberBtn.dataset.listenerAttached) {
                  cancelAddMemberBtn.onclick = () => { 
                    if(addMemberModal) {
                        addMemberModal.style.display = 'none'; // <<< SỬA LỖI
                        addMemberModal.classList.remove('show');
                    }
                };
                  confirmAddMemberBtn.onclick = async () => {
                       const selectedCheckboxes = addMemberFriendList.querySelectorAll('.add-member-checkbox:checked');
                       const uidsToAdd = Array.from(selectedCheckboxes).map(cb => cb.value);
                       if (uidsToAdd.length === 0) return showToast("Vui lòng chọn bạn!", "error");
                       confirmAddMemberBtn.disabled = true; confirmAddMemberBtn.textContent = "Đang thêm...";
                       try {
                           const updates = { member_uids: arrayUnion(...uidsToAdd) };
                           uidsToAdd.forEach(uid => { updates[`roles.${uid}`] = 'member'; });
                           await updateDoc(groupRef, updates); showToast("Đã thêm!", "success"); if(addMemberModal) addMemberModal.style.display = 'none'; // <<< SỬA LỖI addMemberModal.classList.remove('show');
                       } catch (err) { console.error("Lỗi thêm:", err); showToast("Lỗi!", "error"); }
                       finally { confirmAddMemberBtn.disabled = false; confirmAddMemberBtn.textContent = "Thêm vào nhóm"; }
                   };
                   confirmAddMemberBtn.dataset.listenerAttached = 'true';
             }

        } else { // Nếu là MEMBER thường
            addMemberBtnPanel.style.display = 'none';
            groupAvatarPanel.classList.remove('editable-group-info');
            groupNameDisplayPanel.classList.remove('editable-group-info');
            groupAvatarPanel.onclick = null;
            groupNameDisplayPanel.onclick = null;
        }

        // --- RENDER DANH SÁCH THÀNH VIÊN ---
        groupMembersListPanel.innerHTML = '';
        const memberDetailPromises = memberUids.map(uid => getDoc(doc(db, "users", uid)));
        const memberDocs = await Promise.all(memberDetailPromises);

        // <<< KHAI BÁO BIẾN BỊ THIẾU NẰM Ở ĐÂY >>>
        const roleLabels = { admin: 'Trưởng nhóm', moderator: 'Phó nhóm', member: 'Thành viên' };
        const roleClass = { admin: 'role-admin', moderator: 'role-moderator', member: 'role-member' };
        // <<< FIX XONG >>>

        memberDocs.forEach((userDoc, index) => {
             const uid = memberUids[index];
             if (userDoc.exists()) {
                 const userData = userDoc.data();
                 const memberRole = roles[uid] || 'member';
                 let actionButtons = '';
                 
                 // Logic tạo nút Kick/Promote/Demote
                 if (myRole === 'admin' && uid !== currentUser.uid) {
                     actionButtons += `<button data-action="kick" data-uid="${uid}" class="member-action-btn">Kick</button>`;
                     if (memberRole === 'member') actionButtons += `<button data-action="promote-mod" data-uid="${uid}" class="member-action-btn">Bổ Nhiệm Phó</button>`;
                     else if (memberRole === 'moderator') actionButtons += `<button data-action="demote-member" data-uid="${uid}" class="member-action-btn">Giáng xuống Member</button>`;
                 } else if (myRole === 'moderator' && memberRole === 'member' && uid !== currentUser.uid) { // Mod có thể kick member (nhưng không phải chính mình)
                     actionButtons += `<button data-action="kick" data-uid="${uid}" class="member-action-btn">Kick</button>`;
                 }
                 
                 const li = document.createElement('li'); li.className = 'member-item';
                 li.innerHTML = `<div class="member-info"><span class="member-name">${escapeHtml(userData.displayName || userData.email)}</span><span class="member-role ${roleClass[memberRole]}">${roleLabels[memberRole]}</span></div><div class="member-actions">${actionButtons}</div>`;
                 groupMembersListPanel.appendChild(li);
             } else {
                  // Render placeholder nếu user không tồn tại
                  const li = document.createElement('li');
                  li.className = 'member-item';
                  li.innerHTML = `<div class="member-info"><span class="member-name" style="color:var(--text-2); font-style:italic;">Thành viên không tồn tại</span></div>`;
                  groupMembersListPanel.appendChild(li);
             }
        });

        // Gán lại sự kiện cho nút Rời nhóm
        if(leaveGroupBtnPanel) {
            leaveGroupBtnPanel.style.display = 'block'; // Đảm bảo nút rời nhóm luôn hiện
            leaveGroupBtnPanel.onclick = () => leaveGroup(groupId, groupName);
        }

    }, (error) => { // Xử lý lỗi cho onSnapshot
         console.error(`Error listening to group ${groupId}:`, error);
         if(groupInfoContent) groupInfoContent.innerHTML = '<p style="color:red; padding: 10px;">Lỗi tải thông tin nhóm!</p>';
    }); // <-- KẾT THÚC ONSNAPSHOT

    // --- CÁC SỰ KIỆN GÁN 1 LẦN BÊN NGOÀI ONSNAPSHOT ---
    // Gán sự kiện click cho các nút action trong danh sách thành viên (dùng event delegation)
    // Gán sự kiện click cho các nút action trong danh sách thành viên (dùng event delegation)
    if (groupMembersList && !groupMembersList.dataset.listenerAttached) { // Chỉ gán 1 lần
         groupMembersList.onclick = async (e) => { // <<< 1. THÊM async VÀO ĐÂY
              const targetButton = e.target.closest('.member-action-btn');
              if (targetButton && targetButton.dataset.action && targetButton.dataset.uid) {
                   const action = targetButton.dataset.action;
                   const targetUid = targetButton.dataset.uid;
                   const targetName = targetButton.closest('.member-item')?.querySelector('.member-name')?.textContent || 'thành viên này';
                   
                   // <<< 2. SỬA LẠI CÁCH GỌI HÀM CONFIRM
                   if (action === 'kick') { 
                       const confirmed = await showConfirmation(`Bạn có chắc muốn kick ${escapeHtml(targetName)} khỏi nhóm?`);
                       if (confirmed) {
                           kickMember(groupId, targetUid); 
                       }
                   } 
                   else if (action === 'promote-mod') { 
                       const confirmed = await showConfirmation(`Bổ nhiệm ${escapeHtml(targetName)} làm phó nhóm?`);
                       if (confirmed) {
                           changeRole(groupId, targetUid, 'moderator'); 
                       }
                   } 
                   else if (action === 'demote-member') { 
                       const confirmed = await showConfirmation(`Giáng ${escapeHtml(targetName)} xuống làm thành viên?`);
                       if (confirmed) {
                           changeRole(groupId, targetUid, 'member'); 
                       }
                   }
                   // <<< KẾT THÚC SỬA
              }
         };
         groupMembersList.dataset.listenerAttached = 'true'; // Đánh dấu đã gán
    }
    
    // Load ảnh đã gửi 1 lần khi mở panel
    if (groupSentImagesGrid) {
        groupSentImagesGrid.innerHTML = ''; // Xóa ảnh cũ
        const groupMsgsRef = ref(rtdb, `/messages/${groupId}`);
        const imagesQuery = rtdbQuery(groupMsgsRef, orderByChild('timestamp'), limitToLast(9));
        get(imagesQuery).then(snap => {
            groupSentImagesGrid.innerHTML = '';
            if (!snap.exists()) { groupSentImagesGrid.innerHTML = '<p style="font-size: 13px; color: var(--text-2); text-align: left;">Chưa có ảnh nào.</p>'; return; }
            const imageMsgs = [];
            snap.forEach(child => { const msg = child.val(); if (msg.imageUrl) imageMsgs.push(msg.imageUrl); });
            if (imageMsgs.length === 0) { groupSentImagesGrid.innerHTML = '<p style="font-size: 13px; color: var(--text-2); text-align: left;">Chưa có ảnh nào.</p>'; }
            else { imageMsgs.reverse().forEach(url => { const img = document.createElement('img'); img.src = url; img.alt="Ảnh nhóm"; img.onclick = () => openLightbox(url, null); groupSentImagesGrid.appendChild(img); }); }
        }).catch(err => { console.error("Error fetching group images:", err); groupSentImagesGrid.innerHTML = '<p style="color:red;">Lỗi tải ảnh</p>'; });
    }
}

function handleMouseOverMessage(e) {
    const msgWrapper = e.target.closest('.msg-wrapper'); if (!msgWrapper?.dataset.key) return;
    let picker = msgWrapper.querySelector('.reaction-picker');
    const contentWrapper = msgWrapper.querySelector('.msg-content-wrapper'); // Gắn vào đây
    if (!picker && contentWrapper) { picker = createReactionPicker(msgWrapper.dataset.key); contentWrapper.appendChild(picker); }
    // else if (!picker && !contentWrapper) { // Fallback nếu cấu trúc HTML khác
    //      picker = createReactionPicker(msgWrapper.dataset.key);
    //      msgWrapper.appendChild(picker);
    // }
    // Logic hiện/ẩn picker đã được xử lý bằng CSS :hover
}
function handleVisibilityChange() { if (!document.hidden) { unreadCount = 0; document.title = originalTitle; } }

// --- KHỞI ĐỘNG KIỂM TRA AUTH & INIT THEME ---
initTheme(); // Gọi initTheme ngay khi script load
// onAuthStateChanged sẽ tự chạy và gọi initializeAppLogic sau khi user hợp lệ

</script>
</body>
</html>