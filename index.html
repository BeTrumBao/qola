<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Qola Messenger</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');

/* --- BI·∫æN M√ÄU CSS --- */
:root{
  --accent-1:#60a5fa;
  --accent-2:#2563eb;
  --bg-page:linear-gradient(135deg,#0f172a,#1e293b);
  --glass:rgba(255,255,255,0.06);
  --glass-2:rgba(255,255,255,0.08);
  --glass-3:rgba(30, 41, 59, 0.75);
  --text:#e5e7eb; /* Ch·ªØ ch√≠nh trong dark mode */
  --text-2:#cbd5e1; /* Ch·ªØ ph·ª• trong dark mode */
  --border:rgba(255,255,255,0.12);
  --bubble-me: linear-gradient(135deg,#3b82f6,#2563eb);
  --bubble-you: rgba(255,255,255,0.15);
  --input:#0b1220;
  --shadow: 0 18px 60px rgba(0,0,0,.35);
  --recalled-bg: rgba(255,255,255,0.1);
  --skeleton-bg: rgba(255,255,255,0.08);
  --background-1: #1e293b; /* N·ªÅn ch√≠nh content dark */
  --text-1: #f1f5f9;      /* Ch·ªØ ch√≠nh dark */
  --primary: #2563eb;
  --primary-hover: #3b82f6;
  --white: #ffffff;
  --hover-bg: rgba(255, 255, 255, 0.1);
  --glass-border: rgba(255, 255, 255, 0.1);
  --bg-nav: #111827;
  --bg-light: #1e293b; /* Main background dark */
  --bg-dark: #0f172a;
  --text-secondary: #94a3b8;
  --text-primary: #e5e7eb;
  --input-bg: #0b1220;
  --bg-card: rgba(255, 255, 255, 0.05);
}
.light {
  --bg-page: linear-gradient(135deg,#a1c4fd,#c2e9fb);
  --glass: rgba(255,255,255,0.5);
  --glass-2: rgba(255,255,255,0.6);
  --glass-3: rgb(249, 250, 251);
  --text:#0f172a; /* Ch·ªØ ch√≠nh light */
  --text-2:#334155; /* Ch·ªØ ph·ª• light */
  --border: rgba(0,0,0,0.1);
  --bubble-me: linear-gradient(135deg,#007aff,#0056b3);
  --bubble-you: rgba(229,229,234,0.92);
  --input: rgba(255,255,255,0.85);
  --shadow: 0 18px 60px rgba(0,0,0,.2);
  --recalled-bg: rgba(0,0,0,0.05);
  --skeleton-bg: rgba(0,0,0,0.08);
  --background-1: #f9fafb; /* N·ªÅn ch√≠nh content light */
  --text-1: #1f2937;      /* Ch·ªØ ch√≠nh light */
  --hover-bg: rgba(0, 0, 0, 0.05);
  --glass-border: rgba(0, 0, 0, 0.1);
  --bg-nav: #ffffff;
  --bg-light: #f9fafb;
  --bg-dark: #f3f4f6;
  --text-secondary: #6b7280;
  --text-primary: #1f2937;
  --input-bg: #ffffff;
  --bg-card: #ffffff;
}

/* --- Reset & Base --- */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg-page); color:var(--text);
  overflow:hidden; display:flex;
}
button { font-family: inherit; }
input, textarea { font-family: inherit; }
svg { vertical-align: middle; }

/* --- Layout Ch√≠nh --- */
.app-layout { display: flex; width: 100%; height: 100%; }
.app-nav { width: 70px; background-color: var(--bg-nav); border-right: 1px solid var(--glass-border); padding: 15px 0; display: flex; flex-direction: column; align-items: center; gap: 15px; flex-shrink: 0; position: relative; }
.nav-button { background-color: transparent; border: none; width: 48px; height: 48px; border-radius: 15px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; position: relative; }
.nav-button svg { width: 24px; height: 24px; }
.nav-button:hover { background-color: var(--accent-1); color: #fff; border-radius: 12px; }
.nav-button.active { background-color: var(--accent-2); color: #fff; border-radius: 12px; }
.nav-button.active::before { content: ''; position: absolute; left: -10px; top: 5px; bottom: 5px; width: 4px; background-color: #fff; border-radius: 0 4px 4px 0; }
.light .nav-button { background-color: #e5e7eb; color: var(--text-secondary); }
.light .nav-button:hover { background-color: var(--accent-1); color: #fff; }
.light .nav-button.active { background-color: var(--accent-2); color: #fff; }
.light .nav-button.active::before { background-color: var(--accent-2); }
.nav-spacer { flex-grow: 1; }
.nav-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid var(--glass-border); cursor: pointer; margin-bottom: 10px; }
#nav-settings-menu { position: absolute; bottom: 75px; left: 80px; width: 220px; display: none; background: var(--glass-3); backdrop-filter: blur(18px); border: 1px solid var(--glass-border); border-radius: 12px; padding: 10px; box-shadow: var(--shadow); z-index: 101; }
.light #nav-settings-menu .settings-row { color: var(--text-primary); }
.app-main { flex: 1; overflow: hidden; position: relative; background: var(--bg-light); }
.app-view { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: none; height: 100%; width: 100%; }
.app-view.active { display: block; }

/* --- CSS cho Chat View --- */
.chat-view .container { width: 100%; height: 100%; border-radius: 0; border: none; box-shadow: none; margin-top: 0; background: none; backdrop-filter: none; display: flex; }
.chat-view #sidebar { height: 100%; width: 36%; max-width: 420px; background: var(--bg-light); border-right: 1px solid var(--glass-border); padding: 16px; display: flex; flex-direction: column; gap: 14px; position: relative; }
.chat-view #chat-window { height: 100%; flex: 1; padding: 0; display: flex; flex-direction: column; position: relative; background: transparent; }
.chat-view .sidebar-footer { display: none !important; }

/* --- CSS Sidebar --- */
.sidebar-head{ display:flex; align-items:center; gap:12px; padding-bottom: 10px; position:relative }
.sidebar-title{ font-size:22px; font-weight:700 }
#add-btn { background: var(--glass-border); border: none; width: 36px; height: 36px; border-radius: 12px; color: var(--text-secondary); font-size: 24px; font-weight: 500; cursor: pointer; margin-left: auto; transition: all 0.2s; position: relative; z-index: 30; }
#add-btn:hover { background: rgba(255, 255, 255, 0.2); color: var(--text-primary); }
#add-menu { position:absolute; left: auto; right: 16px; top: 60px; width: 180px; height: auto !important; display:none; background:var(--glass-3); border:1px solid var(--border); border-radius:12px; padding:10px; box-shadow:var(--shadow); z-index: 20; backdrop-filter: blur(18px); }
#sidebar-search-container { position: relative; padding-bottom: 10px; }
#global-search{ width: 100%; padding: 12px 16px; border: none; outline: none; border-radius: 12px; background: var(--input); color: var(--text); font-size: 14px; }
#search-dropdown{ position:absolute; top: 50px; left: 0; right: 0; width: auto; margin: 0; background:var(--glass-3); border:1px solid var(--border); border-radius:16px; backdrop-filter:blur(18px); box-shadow:var(--shadow); max-height:52vh; overflow:auto; display:none; padding:6px 6px 10px; z-index: 100; }
.section-title{font-size:12px; opacity:.8; margin:8px 6px}
.result-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:12px; cursor:pointer; }
.result-item:hover{background:var(--glass)}
.result-left{display:flex; align-items:center; gap:10px; min-width:0}
.result-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
.result-name{font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.result-sub{font-size:12px; color:var(--text-2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.result-actions{display:flex; gap:8px}
.result-action { display: flex; align-items: center; justify-content: flex-end; }
.add-friend-btn { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; border: none; padding: 6px 10px; border-radius: 8px; font-size: 13px; cursor: pointer; transition: 0.2s; }
.add-friend-btn:hover { transform: scale(1.05); opacity: 0.9; }
.add-friend-btn:disabled { background: rgba(255,255,255,0.3); cursor: default; opacity: 0.7; transform: none;}
.friend-label { font-size: 13px; opacity: 0.7; }
.list-title{font-size:13px; color:var(--text-2); margin:4px 0}
ul{list-style:none}
#chat-list{ overflow:auto; max-height:calc(100vh - 200px); padding-right:6px }
.item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px; border-radius:12px; cursor:pointer; }
.item:hover{background:var(--glass)}
.item-left{min-width:0; display:flex; align-items:center; gap:10px}
.item-name{ white-space: normal; word-break: break-word; }
.item-last-msg { font-size: 13px; color: var(--text-2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
.beta-tag { font-size: 10px; background-color: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-left: 8px; }
.status{width:10px; height:10px; border-radius:50%; background:#64748b}
.status.online{background:#22c55e}
.sidebar-loader .skeleton-item { display: flex; align-items: center; gap: 10px; padding: 12px; }
.skeleton { background: var(--skeleton-bg); position: relative; overflow: hidden; }
.skeleton-circle { width: 40px; height: 40px; border-radius: 50%; }
.skeleton-line { height: 16px; border-radius: 6px; flex: 1; }
.skeleton::after { content: ''; position: absolute; inset: 0; transform: translateX(-100%); background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent); animation: shimmer 1.5s infinite; }
@keyframes shimmer { 100% { transform: translateX(100%); } }
#sidebar-lists { display: none; }
#sidebar.loaded #sidebar-lists { display: block; }
#sidebar.loaded #sidebar-loader { display: none; }
.settings-menu{ display:none; background:var(--glass-3); border:1px solid var(--border); border-radius:12px; padding:10px; box-shadow:var(--shadow); z-index: 20; backdrop-filter: blur(18px); }
.settings-row{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px; border-radius:10px; cursor:pointer;}
.settings-row:hover{background:var(--glass)}
.switch{position:relative; width:44px; height:24px; background:var(--glass); border:1px solid var(--border); border-radius:999px}
.switch::after{ content:''; position:absolute; width:18px; height:18px; border-radius:50%; background:linear-gradient(135deg,var(--accent-1),var(--accent-2)); top:2px; left:3px; transition:.2s; }
.switch.on::after{left:23px}
#open-friend-req-btn { position: absolute; bottom: 15px; left: 16px; z-index: 50; background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); color: #fff; border: none; border-radius: 16px; width: 48px; height: 48px; font-size: 24px; cursor: pointer; box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
#open-friend-req-btn:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 12px 25px rgba(37, 99, 235, 0.4); }
#open-friend-req-btn::after { content: ''; position: absolute; top: 6px; right: 6px; width: 10px; height: 10px; background-color: #ef4444; border-radius: 50%; border: 2px solid var(--bg-light); transform: scale(0); transition: transform 0.2s ease-in-out; }
#open-friend-req-btn.has-new-request::after { transform: scale(1); }

/* --- CSS CHO HI·ªÜU ·ª®NG GRADIENT TEXT --- */
.gradient-text {
    background: linear-gradient(90deg, var(--accent-1), #a855f7, #ec4899); /* D·∫£i m√†u gradient (Xanh -> T√≠m -> H·ªìng) */
    -webkit-background-clip: text; /* Clip background theo h√¨nh d·∫°ng ch·ªØ (cho tr√¨nh duy·ªát Webkit/Blink) */
    background-clip: text; /* Clip background theo h√¨nh d·∫°ng ch·ªØ (chu·∫©n) */
    -webkit-text-fill-color: transparent; /* ·∫®n m√†u ch·ªØ g·ªëc (cho Webkit/Blink) */
    color: transparent; /* ·∫®n m√†u ch·ªØ g·ªëc (chu·∫©n) */
    display: inline-block; /* C·∫ßn thi·∫øt ƒë·ªÉ background-clip ho·∫°t ƒë·ªông ƒë√∫ng */
}

/* Optional: Style cho theme s√°ng n·∫øu mu·ªën m√†u gradient kh√°c */
.light .gradient-text {
    background: linear-gradient(90deg, #007aff, #5856d6, #ff2d55); /* Gradient kh√°c cho theme s√°ng */
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    color: transparent;
}

/* --- CSS HEADER CHAT --- */
#chat-window { display: flex; flex-direction: column; height: 100%; }
#chat-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid var(--border); flex-shrink: 0; box-sizing: border-box; }
#chat-header-left { display: flex; align-items: center; gap: 12px; min-width: 0; }
#current-chat-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 1px solid var(--border); cursor: pointer; }
#chat-header-info { display: flex; flex-direction: column; min-width: 0; }
#current-chat-friend-name { font-size: 17px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#peer-info-extra { display: none; align-items: center; gap: 8px; margin-top: 2px; }
.stranger-label { font-size: 12px; color: var(--text-2); }
#add-friend-header-btn { padding: 3px 8px; font-size: 11px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; border: none; border-radius: 8px; cursor: pointer; transition: 0.2s; }
#add-friend-header-btn:hover { transform: scale(1.05); opacity: 0.9; }
#add-friend-header-btn:disabled { background: rgba(255,255,255,0.3); cursor: default; opacity: 0.7; transform: none;}
#chat-header-buttons { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
#open-info-btn, #group-info-btn { background: none; border: none; color: var(--text); font-size: 24px; cursor: pointer; padding: 5px; border-radius: 50%; line-height: 1; }
#open-info-btn:hover, #group-info-btn:hover { background-color: var(--glass); }
/* B·ªè n√∫t back kh·ªèi index.html */
/* #mobile-back-btn { display: none; } */

/* --- CSS MESSAGES CONTAINER & INPUT --- */
#messages-container{ flex:1; overflow:auto; display:flex; flex-direction:column; gap:2px; padding:14px 15px; scrollbar-width:thin; }
#messages-container::-webkit-scrollbar{width:8px}
#messages-container::-webkit-scrollbar-thumb{background:var(--glass-3); border-radius:10px}
#messages-container::-webkit-scrollbar-track{background:transparent}
.msg-wrapper { position: relative; margin: 6px 0; align-self: flex-start; max-width: 70%; display: flex; gap: 10px; align-items: flex-end; }
.msg-wrapper:hover .reaction-picker { opacity: 1; transform: translateY(0) scale(1); }
.msg-wrapper.sent { align-self: flex-end; }
.msg-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-bottom: 6px; cursor: pointer; }
.msg-wrapper.sent .msg-avatar { display: none; }
.msg-sender-name { font-size: 13px; font-weight: 500; color: var(--text-2); margin-bottom: 4px; }
.msg { background: var(--bubble-you); color: var(--text); padding: 10px 14px; border-radius: 18px; display: inline-block; word-break: break-word; line-height: 1.4em; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: background 0.3s ease; position: relative; }
.msg.sent { background: var(--bubble-me); color: #fff; box-shadow: 0 2px 8px rgba(37,99,235,0.4); }
.msg img { max-width: 100%; border-radius: 14px; margin-top: 5px; cursor: pointer; }
.msg-meta, .msg-status { font-size: 11px; opacity: 0.7; text-align: right; margin-top: 4px; }
.sent .msg-status { color: rgba(255,255,255,0.7); }
.recalled-message { font-style: italic; color: var(--text-2); background-color: var(--recalled-bg); border: 1px dashed var(--border); padding: 8px 12px; border-radius: 12px; }
.reply-quote { background: var(--glass); padding: 6px 10px; border-left: 3px solid var(--accent-1); margin-bottom: 8px; border-radius: 4px; }
.reply-quote .sender { font-weight: 600; font-size: 13px; }
.reply-quote .text { font-size: 13px; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.edited-label { margin-left: 6px; font-style: italic; opacity: 0.8; font-size: 10px; }
.message-date-separator { text-align: center; margin: 18px 0; font-size: 13px; color: rgba(255,255,255,0.6); font-weight: 500; width: 100%; }
.message-date-separator::before, .message-date-separator::after { content: ""; position: relative; display: inline-block; width: 30%; height: 1px; background: rgba(255,255,255,0.1); top: -3px; margin: 0 8px; }
.msg-wrapper.mentioned-me .msg { background-color: rgba(96, 165, 250, 0.25); border: 1px solid var(--accent-1); }
.light .msg-wrapper.mentioned-me .msg { background-color: rgba(0, 122, 255, 0.15); border: 1px solid var(--accent-2); }
.mention { font-weight: 600; color: var(--accent-1); background-color: rgba(96, 165, 250, 0.15); padding: 1px 4px; border-radius: 4px; }
.chat-input { display: flex; gap: 0; align-items: flex-end; padding: 15px; margin-top: auto; border-top: 1px solid var(--border); flex-shrink: 0; }
#message-input{ transition: width 0.3s ease; flex: 1; border: 1px solid var(--border); border-radius: 16px; padding: 12px 14px; background: var(--input); color: var(--text); margin: 0 10px; }
.image-upload-label{ background: transparent; color: var(--accent-1); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; cursor: pointer; flex-shrink: 0; }
#send-btn { width: 0; padding: 12px 0; margin: 0; border: none; border-radius: 12px; background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); color: #fff; transform: scale(0.8); opacity: 0; overflow: hidden; transition: all 0.3s ease; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
.chat-input.has-text #send-btn { width: 48px; padding: 12px; transform: scale(1); opacity: 1; }
#send-btn[disabled]{ opacity:.6; cursor:not-allowed }
#send-btn .spinner-icon { display: none; }
#send-btn.loading { cursor: wait; }
#send-btn.loading .send-icon { display: none; }
#send-btn.loading .spinner-icon { display: block; animation: spin 1.2s linear infinite; }
@keyframes spin { 100% { transform: rotate(360deg); } }
#typing-indicator{height:22px; font-size:13px; font-style:italic; color:var(--text-2); padding: 0 15px; }
#image-preview-container, #reply-preview-container, #edit-preview-container { display:none; background:var(--glass); border:1px solid var(--border); border-radius:12px; padding: 8px 12px; margin: 0 15px 8px 15px; position:relative; }
#image-preview{max-height:130px; border-radius:8px}
#cancel-preview-btn{position:absolute; right:-6px; top:-6px; width:22px; height:22px; border-radius:50%; border:none; background:#111; color:#fff; cursor:pointer}
#reply-preview-container { border-left: 3px solid var(--accent-1); }
#edit-preview-container { border-left: 3px solid #f59e0b; }
#reply-preview-sender, #edit-preview-title { font-weight: 600; font-size: 13px; }
#edit-preview-title { color: #f59e0b; }
#reply-preview-text, #edit-preview-text { font-size: 13px; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#edit-preview-text { font-style: italic; }
#cancel-reply-btn, #cancel-edit-btn { position:absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-2); cursor: pointer; font-size: 16px; padding: 5px; }
#inactive-chat-indicator { text-align: center; padding: 12px; margin: 15px; border-radius: 12px; background: rgba(0,0,0,0.15); color: var(--text-2); font-style: italic; font-size: 14px; border: 1px solid var(--border); }

/* --- CSS Modals, Lightbox, Context Menu, Reactions etc. --- */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(12px); display: none; /* Changed to none */ justify-content: center; align-items: center; z-index: 5000; }
.modal-content { background: rgba(22, 25, 35, 0.85); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px; padding: 30px 35px; width: min(90vw, 520px); color: #fff; text-align: left; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: fadeIn .3s ease; }
.modal-content h2 { text-align: center; margin-bottom: 25px; font-size: 22px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border); background: -webkit-linear-gradient(45deg, var(--accent-1), #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; justify-content: center; gap: 10px; }
#friend-request-modal .modal-content h2::before { content: 'üë•'; font-size: 24px; display: inline-block; filter: grayscale(100%) contrast(200%); } /* Example icon */
@keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to {opacity:1; transform:scale(1);} }
.btn{ padding:8px 12px; border:none; border-radius:10px; background:linear-gradient(135deg,var(--accent-1),var(--accent-2)); color:#fff; cursor:pointer; }
.btn-ghost, .cancel-btn { background: rgba(255,255,255,0.15); color: #fff; border: none; padding: 10px 14px; border-radius: 10px; cursor: pointer; }
.danger-btn { background: linear-gradient(135deg, #ef4444, #b91c1c); }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
.form-label { font-size: 14px; color: var(--text-2); margin-bottom: 6px; display: block; }
.modal-content input, .modal-content textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--input); color: var(--text); outline: none; font-size: 14px; margin-bottom: 15px; }
.clickable{cursor:pointer}
.hidden{display:none}
.verified-tick { display: inline-block; width: 1.1em; height: 1.1em; margin-left: 5px; vertical-align: -0.2em; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2360a5fa'%3E%3Cpath fill-rule='evenodd' d='M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.06 0l4-5.5z' clip-rule='evenodd' /%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; background-position: center; }
.suggestion-popup { position: absolute; bottom: 75px; left: 15px; right: 15px; max-height: 200px; overflow-y: auto; background: var(--glass-3); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); border-radius: 14px; box-shadow: 0 -8px 20px rgba(0,0,0,0.2); z-index: 100; display: none; padding: 6px; scrollbar-width: thin; }
.suggestion-popup::-webkit-scrollbar{ width: 6px; }
.suggestion-popup::-webkit-scrollbar-thumb{ background: var(--glass); border-radius: 6px; }
.suggestion-item { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 10px; cursor: pointer; color: var(--text-primary); transition: background-color 0.2s; }
.suggestion-item:hover { background-color: var(--glass); }
.suggestion-item img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
.suggestion-item .name { font-weight: 500; }
.suggestion-item .all { font-weight: 600; color: var(--accent-1); }
.lightbox-overlay { position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); display: none; /* Changed */ justify-content: center; align-items: center; animation: fadeIn 0.3s; }
.lightbox-content { max-width: 90%; max-height: 90%; object-fit: contain; }
.lightbox-close-btn { position: absolute; top: 20px; right: 35px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; transition: 0.2s; }
.lightbox-close-btn:hover { color: #bbb; }
#friend-request-list { max-height: 350px; min-height: 200px; overflow-y: auto; margin: 15px 0; display: flex; align-items: center; justify-content: center; }
.friend-req-btn { padding: 8px 14px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; transition: .2s; }
.friend-req-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px 12px; margin-bottom: 8px; transition: background .2s; }
.friend-req-item:hover { background: rgba(255,255,255,0.1); }
.friend-req-name { font-weight: 500; text-align: left; }
.friend-req-buttons { display: flex; gap: 6px; }
.accept-btn { background: linear-gradient(135deg,#22c55e,#15803d); color: #fff; }
.reject-btn { background: rgba(239,68,68,0.9); color: #fff; }
.msg-content-wrapper { position: relative; }
#group-members-checklist { max-height: 200px; overflow-y: auto; text-align: left; border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin: 10px 0 20px; background: var(--input); }
#group-members-checklist label { display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 8px; cursor: pointer; }
#group-members-checklist label:hover { background-color: var(--glass); }
#group-members-checklist input[type="checkbox"] { width: 18px; height: 18px; }
#message-context-menu { position: fixed; display: none; background: var(--glass-3); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 12px; padding: 8px; box-shadow: var(--shadow); z-index: 9999; }
.context-menu-btn { display: block; width: 100%; text-align: left; background: none; border: none; color: var(--text); padding: 10px 14px; border-radius: 8px; cursor: pointer; }
.context-menu-btn:hover { background: var(--glass); }
.context-menu-btn.danger { color: #f43f5e; }
.reaction-picker { position: absolute; top: -45px; background: var(--glass-3); backdrop-filter: blur(10px); border-radius: 20px; padding: 6px; display: flex; gap: 8px; box-shadow: var(--shadow); opacity: 0; transition: opacity 0.2s, transform 0.2s; pointer-events: none; z-index: 100; }
.msg-wrapper.sent .reaction-picker { right: 10px; }
.msg-wrapper.received .reaction-picker { left: 10px; }
.msg-wrapper:hover .reaction-picker { opacity: 1; transform: scale(1); pointer-events: all; }
.reaction-btn { font-size: 22px; cursor: pointer; transition: transform 0.15s; }
.reaction-btn:hover { transform: scale(1.2); }
.reactions-display { position: absolute; bottom: -10px; background: var(--glass-2); border-radius: 10px; padding: 2px 5px; display: flex; gap: 3px; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); cursor: pointer; }
.msg-wrapper.sent .reactions-display { right: 10px; }
.msg-wrapper.received .reactions-display { left: 0px; }
#reactions-modal .modal-content { text-align: center; width: 380px; }
#reactions-list { max-height: 300px; overflow-y: auto; margin: 15px 0; }
.reaction-user-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 8px; }
.reaction-user-item:hover { background: var(--glass); }
.reaction-user-info { display: flex; align-items: center; gap: 10px; }
.reaction-user-avatar { width: 36px; height: 36px; border-radius: 50%; }
.reaction-user-name { font-weight: 500; }
.reaction-emoji { font-size: 20px; }
#toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(22, 25, 35, 0.85); color: white; padding: 20px 30px; border-radius: 12px; z-index: 10000; backdrop-filter: blur(10px); border: 1px solid var(--border); box-shadow: var(--shadow); text-align: center; display: none; animation: fadeIn .3s ease; }
#toast-message { margin-bottom: 15px; }
#toast-close-btn { background: var(--accent-1); color: white; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; }
.report-form .form-label { text-align: left; margin-bottom: 10px; }
.report-reason-row { display: flex; align-items: center; padding: 12px; border-radius: 10px; border: 1px solid transparent; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
.report-reason-row:hover { background-color: var(--glass); }
.report-reason-row input[type="radio"] { display: none; }
.report-reason-row .custom-radio { width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 50%; margin-right: 12px; display: inline-block; position: relative; transition: border-color 0.2s; }
.report-reason-row input[type="radio"]:checked + .custom-radio { border-color: var(--accent-1); }
.report-reason-row input[type="radio"]:checked + .custom-radio::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 10px; height: 10px; border-radius: 50%; background-color: var(--accent-1); }
.report-reason-row.selected { background-color: var(--glass); border-color: var(--accent-1); }
#messages-container.selection-mode .msg-wrapper { cursor: pointer; padding: 4px; border-radius: 14px; border: 2px solid transparent; transition: border-color 0.2s, background-color 0.2s; }
#messages-container.selection-mode .msg-wrapper:hover { background-color: var(--glass); }
#messages-container.selection-mode .msg-wrapper.selected { border-color: var(--accent-1); background-color: rgba(96, 165, 250, 0.2); }

/* --- CSS Chat Info Panel --- */
#open-info-btn, #group-info-btn { border:1px solid var(--border); background:transparent; color:var(--text); border-radius:12px; padding:8px 12px; cursor:pointer; }
#chat-info-panel { position: absolute; right: 0; top: 0; width: 320px; height: 100%; background: rgba(22, 25, 35, 0.85); backdrop-filter: blur(20px); border-left: 1px solid rgba(255,255,255,0.08); box-shadow: -8px 0 25px rgba(0,0,0,0.4); color: #f3f4f6; transform: translateX(340px); transition: transform .3s ease; display: flex; flex-direction: column; z-index: 1000; }
#chat-info-panel.open { transform: translateX(0); }
#chat-info-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); }
#chat-info-header h3 { font-size: 18px; font-weight: 600; color: #fff; }
#close-info-btn { background: rgba(255,255,255,0.2); border: none; border-radius: 8px; width: 30px; height: 30px; color: #fff; cursor: pointer; transition: .2s; }
#close-info-btn:hover { background: rgba(255,255,255,0.4); }
.chat-info-body { flex: 1; overflow-y: auto; padding: 16px; }
.chat-info-section { text-align: center; margin-bottom: 25px; }
.chat-info-avatar { width: 95px; height: 95px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); box-shadow: 0 0 15px rgba(59,130,246,0.3); object-fit: cover; }
.chat-info-name { font-size: 18px; font-weight: 600; margin: 10px 0; }
.chat-info-body h5 { font-size: 14px; text-transform: uppercase; letter-spacing: .5px; color: rgba(255,255,255,0.75); margin-bottom: 10px; text-align: left; }
.sent-images-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 25px; }
.sent-images-grid img { width: 100%; border-radius: 8px; cursor: pointer; transition: 0.2s; }
.sent-images-grid img:hover { transform: scale(1.06); box-shadow: 0 4px 10px rgba(59,130,246,0.5); }
.chat-actions button { width: 100%; padding: 11px; border: none; border-radius: 10px; font-size: 15px; color: #fff; cursor: pointer; margin-top: 10px; transition: 0.25s; }
#block-user-btn, #unblock-user-btn { background: linear-gradient(135deg, #ef4444, #b91c1c); }
#unblock-user-btn { background: linear-gradient(135deg, #22c55e, #16a34a); display:none; }
#block-user-btn:hover, #unblock-user-btn:hover { filter: brightness(1.1); }
#remove-friend-btn { background: linear-gradient(135deg, #6b7280, #4b5563); opacity: 0.9; }
#remove-friend-btn:hover { opacity: 1; filter: brightness(1.1); }
#leave-group-btn { background: linear-gradient(135deg, #ef4444, #b91c1c); }
#group-members-list {list-style: none; padding: 0; margin-bottom: 20px; display: flex; flex-direction: column; gap: 8px;}
.member-item { display: flex; justify-content: space-between; align-items: center; background: var(--glass); padding: 8px 12px; border-radius: 8px; }
.member-info { display: flex; flex-direction: column; align-items: flex-start; }
.member-name { font-weight: 500; }
.member-role { font-size: 12px; opacity: 0.7; padding: 2px 6px; border-radius: 6px; color: white; } /* Common color */
.role-admin { background-color: #a855f7; }
.role-moderator { background-color: #2563eb; }
.role-member { background-color: #4b5563; }
.member-actions button { background: none; border: 1px solid var(--border); color: var(--text-2); padding: 4px 8px; font-size: 11px; border-radius: 6px; cursor: pointer; margin-left: 4px; }
.member-actions button:hover { background: var(--glass-3); }
#group-avatar.editable-group-info, #group-name-display.editable-group-info { cursor: pointer; transition: opacity 0.2s; }
#group-avatar.editable-group-info:hover, #group-name-display.editable-group-info:hover { opacity: 0.7; }
/* Fix Edit Group Modal Quirks */
#edit-group-modal .modal-content { width: min(90vw, 520px) !important; box-sizing: border-box !important; padding: 30px 35px !important; }
#edit-group-modal .modal-content > div:first-of-type { display: flex !important; align-items: flex-start !important; gap: 20px !important; margin-bottom: 20px !important; box-sizing: border-box !important; }
#edit-group-modal .modal-content > div:first-of-type > div:first-child { flex-shrink: 0 !important; text-align: center !important; box-sizing: border-box !important; }
#edit-group-modal #edit-group-avatar-preview { width: 95px !important; height: 95px !important; border-radius: 50% !important; object-fit: cover !important; border: 2px solid var(--border) !important; cursor: pointer !important; transition: opacity 0.2s !important; display: block !important; margin: 0 auto !important; }
#edit-group-modal #edit-group-avatar-loading { font-size: 13px !important; color: var(--accent-1) !important; display: none; margin-top: 5px !important; }
#edit-group-modal .modal-content > div:first-of-type > div:last-child { flex-grow: 1 !important; min-width: 0 !important; box-sizing: border-box !important; }
#edit-group-modal .modal-content label.form-label { display: block !important; text-align: left !important; margin-bottom: 6px !important; font-size: 14px !important; color: var(--text-2) !important; box-sizing: border-box !important; }
#edit-group-modal .modal-content input[type="text"] { width: 100% !important; padding: 10px !important; border-radius: 8px !important; border: 1px solid var(--border) !important; background: var(--input) !important; color: var(--text) !important; outline: none !important; font-size: 14px !important; margin-bottom: 15px !important; box-sizing: border-box !important; }
#edit-group-modal .modal-content label[for="edit-group-avatar-input"] { margin-top: 15px !important; }
#edit-group-modal .modal-actions { display: flex !important; justify-content: flex-end !important; gap: 10px !important; margin-top: 20px !important; box-sizing: border-box !important; }

/* --- CSS Tab B·∫°n b√® --- */
.friends-view { padding: 20px; height: 100%; overflow-y: auto; }
.friends-container h1 { font-size: 24px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--glass-border); }
#friends-search-input { width: 100%; padding: 12px 16px; border-radius: 10px; border: 1px solid var(--glass-border); background: var(--input-bg); color: var(--text-primary); outline: none; font-size: 15px; margin-bottom: 20px; }
#friends-tab-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 10px; }
.friend-item { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 12px 15px; border-radius: 12px; cursor: pointer; background-color: var(--bg-nav); transition: background-color 0.2s ease; }
.friend-item:hover { background-color: var(--hover-bg); }
.friend-item-left { display: flex; align-items: center; gap: 12px; min-width: 0; }
.friend-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 1px solid var(--glass-border); flex-shrink: 0; }
.friend-name { font-weight: 600; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.friend-status { width: 10px; height: 10px; border-radius: 50%; background: #64748b; flex-shrink: 0; margin-left: auto; }
.friend-status.online { background: #22c55e; }
.friend-item-placeholder { color: var(--text-secondary); text-align: center; padding: 20px; }
.light .friend-item { background-color: var(--bg-card); }
.light .friend-item:hover { background-color: var(--hover-bg); }
.light #friends-search-input { background: var(--input-bg); border-color: var(--glass-border); }

/* --- CSS Tab Wall --- */
.wall-view { background-color: var(--bg-dark); } /* Assume wall has dark bg */
#wall-iframe { width: 100%; height: 100%; border: none; }
#wall-loader { position: absolute; inset: 0; background: var(--bg-dark); display: none; /* JS will show */ justify-content: center; align-items: center; z-index: 10; }

/* --- CSS Changelog Modal --- */
#changelog-content { scrollbar-width: thin; }
#changelog-content::-webkit-scrollbar { width: 6px; }
#changelog-content::-webkit-scrollbar-thumb { background: var(--glass); border-radius: 3px; }
.changelog-entry { margin-bottom: 20px; }
.changelog-meta { display: flex; align-items: baseline; gap: 8px; margin-bottom: 8px; }
.changelog-meta h3 { font-size: 1.1em; font-weight: 600; color: var(--accent-1); margin: 0; }
.changelog-meta span { font-size: 0.85em; color: var(--text-secondary); }
.changelog-desc p { margin-bottom: 8px; line-height: 1.6; color: var(--text-primary); }
.changelog-desc p::before { content: "- "; margin-right: 4px; }
.changelog-image { display: block; max-width: 80%; height: auto; border-radius: 8px; margin: 15px auto 10px auto; border: 1px solid var(--glass-border); }
hr.changelog-divider { border: none; height: 1px; background-color: var(--glass-border); margin: 25px 0; }
#changelog-content .changelog-entry:last-child + hr.changelog-divider { display: none; }

/* --- CSS Announcement Popup --- */
#announcement-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); display: none; /* Changed */ align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
#announcement-overlay.show { opacity: 1; visibility: visible; display: flex; }
#announcement-popup { background: var(--glass-3, rgba(30, 41, 59, 0.9)); padding: 25px 30px; border-radius: 16px; border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.1)); box-shadow: var(--shadow, 0 10px 30px rgba(0,0,0,0.3)); width: min(90vw, 450px); text-align: center; transform: scale(0.9); transition: transform 0.3s ease; }
#announcement-overlay.show #announcement-popup { transform: scale(1); }
#announcement-title { font-size: 20px; font-weight: 600; margin-bottom: 15px; color: var(--text-primary); }
#announcement-image { max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 15px; object-fit: contain; }
#announcement-text { font-size: 15px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px; white-space: pre-wrap; }
#close-announcement-btn { display: inline-block; width: auto; padding: 10px 25px; background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 500; margin-top: 0; }
.light #announcement-popup { background: var(--glass-3, rgba(255, 255, 255, 0.95)); border-color: var(--glass-border, rgba(0, 0, 0, 0.1)); }
.light #announcement-title { color: var(--text-primary); }
.light #announcement-text { color: var(--text-secondary); }

/* --- CSS Responsive (@media) --- */
@media (max-width: 768px) {
    body { padding: 0; align-items: stretch; }
    .app-main { padding-bottom: 60px !important; }
    .app-nav { display: flex !important; flex-direction: row !important; align-items: center; width: 100%; height: 60px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; padding: 0 15px; background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(18px); border-top: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 -4px 15px rgba(0,0,0,0.2); }
    .app-nav .nav-avatar { display: block; width: 40px !important; height: 40px !important; margin: 0; padding: 0; border-radius: 50%; overflow: hidden; border: 2px solid transparent; transition: border-color 0.2s ease; flex-shrink: 0; cursor: pointer; }
    .app-nav .nav-avatar img { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
    .app-nav .nav-avatar:hover { border-color: var(--glass); }
    .app-nav .nav-button { flex: 1; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); border-radius: 12px; transition: background-color 0.2s ease, color 0.2s ease; background-color: transparent; border: none; cursor: pointer; }
    .app-nav .nav-button:hover { background-color: var(--glass); color: var(--text); }
    .app-nav .nav-button.active { background-color: var(--accent-1); color: #fff; }
    .app-nav .nav-button.active::before { display: none; }
    .app-nav .nav-button svg { width: 24px; height: 24px; }
    .app-nav .nav-spacer { display: none !important; }
    #nav-settings-menu { position: fixed !important; bottom: 70px !important; left: 15px !important; right: auto !important; width: 200px !important; z-index: 1010 !important; display: none; background: var(--glass-3); backdrop-filter: blur(18px); border: 1px solid var(--glass-border); border-radius: 12px; padding: 10px; box-shadow: var(--shadow); top: auto !important; }
    .chat-view .container#app { width: 100% !important; display: flex !important; }
    .chat-view #sidebar, .chat-view #chat-window { width: 100% !important; max-width: none !important; height: 100%; padding: 10px; box-sizing: border-box; border-right: none; flex-shrink: 0; }
    #chat-placeholder { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: var(--text-secondary); font-size: 16px; padding: 20px; }
    body:not(.mobile-chat-active) .chat-view #chat-window { display: none !important; }
    body:not(.mobile-chat-active) .chat-view #chat-placeholder { display: none !important; }
    body:not(.mobile-chat-active) .chat-view #sidebar { display: flex !important; }
    body.mobile-chat-active .chat-view #sidebar { display: none !important; }
    body.mobile-chat-active .chat-view #chat-window { display: flex !important; }
    body.mobile-chat-active .chat-view #chat-placeholder { display: none !important; }
    #chat-header { padding: 8px 10px; gap: 8px; }
    #current-chat-friend-name { font-size: 16px; }
    #current-chat-avatar { width: 36px; height: 36px; }
    #open-info-btn, #group-info-btn { font-size: 22px; padding: 3px;}
    .chat-input { gap: 8px; align-items: flex-end; padding: 10px; }
    #message-input { padding: 10px 12px; margin: 0; flex: 1; transition: none; }
    .image-upload-label { padding: 10px 14px; }
    #send-btn { display: none; width: 44px; height: 44px; padding: 0; margin: 0; border-radius: 50%; flex-shrink: 0; align-items: center; justify-content: center; }
    .chat-input.has-text #send-btn { display: flex !important; }
    .chat-input.has-text #send-btn:not(.loading) .send-icon { display: block !important; margin: auto; }
    .chat-input.has-text #send-btn:not(.loading) .spinner-icon { display: none !important; }
    #send-btn.loading .send-icon { display: none !important; }
    #send-btn.loading .spinner-icon { display: block !important; margin: auto; animation: spin 1.2s linear infinite; }
    #chat-info-panel { display: none !important; }
    #open-friend-req-btn { display: none; }
    .modal-content { width: min(90vw, 420px); padding: 20px 25px; }
    .modal-content h2 { font-size: 20px; }
    .modal-actions button { font-size: 15px; padding: 10px 18px; }
    .friends-view { padding: 15px; }
    .friends-container h1 { font-size: 20px; margin-bottom: 10px; }
    #friends-search-input { padding: 10px 14px; font-size: 14px; margin-bottom: 15px; }
    .friend-item { padding: 10px; gap: 10px; }
    .friend-avatar { width: 40px; height: 40px; }
    .friend-name { font-size: 15px; }
} /* K·∫øt th√∫c @media */

#nav-settings-menu {
    position: absolute;
    bottom: 75px;
    left: 80px;
    width: 220px;
    display: none;
    background: var(--glass-3);
    backdrop-filter: blur(18px);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 10px;
    box-shadow: var(--shadow);
    z-index: 1010; /* <<< TƒÇNG GI√Å TR·ªä N√ÄY L√äN */
}

/* ƒê·∫£m b·∫£o z-index cho mobile c≈©ng cao */
@media (max-width: 768px) {
    #nav-settings-menu {
        position: fixed !important;
        bottom: 70px !important;
        left: 15px !important;
        right: auto !important;
        width: 200px !important;
        z-index: 1010 !important; /* <<< ƒê·∫¢M B·∫¢O GI√Å TR·ªä N√ÄY CAO */
    }
}

/* --- CSS CHO LINK TRONG TIN NH·∫ÆN --- */
.message-link {
    color: var(--accent-1); /* M√†u xanh accent */
    text-decoration: underline;
    cursor: pointer;
}
.message-link:hover {
    color: var(--accent-2); /* M√†u xanh ƒë·∫≠m h∆°n khi hover */
}
/* Style cho theme s√°ng (n·∫øu c·∫ßn m√†u kh√°c) */
.light .message-link {
     color: #007aff; /* M√†u xanh d∆∞∆°ng cho theme s√°ng */
}
.light .message-link:hover {
     color: #0056b3;
}

</style>
</head>
<body>

<nav class="app-nav">
    <button class="nav-button active" data-view="chat" title="Tr√≤ chuy·ªán">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
    </button>
    <button class="nav-button" data-view="friends" title="B·∫°n b√®">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    </button>
    <button class="nav-button" data-view="wall" title="T∆∞·ªùng nh√†">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
    </button>
    <div class="nav-spacer"></div>
    <img id="nav-avatar" class="nav-avatar" src="https://placehold.co/48x48" alt="avatar" title="C√†i ƒë·∫∑t & H·ªì s∆°">
    <div class="settings-menu" id="nav-settings-menu">
        <div class="settings-row clickable" id="go-to-profile">C√° nh√¢n</div>
        <div class="settings-row clickable" id="show-changelog-btn">Nh·∫≠t k√Ω thay ƒë·ªïi</div>
        <div class="settings-row clickable" id="open-report-bug-modal">B√°o l·ªói</div>
        <div class="settings-row clickable" id="open-about-modal">Th√¥ng tin t√°c gi·∫£</div>
        <div class="settings-row clickable" id="go-to-settings">C√†i ƒë·∫∑t</div>
        <div class="settings-row clickable" id="go-login">ƒêƒÉng xu·∫•t</div>
    </div>
</nav>

<div class="app-layout">
    <main class="app-main">

        <div class="app-view chat-view active" data-view="chat">
            <div id="toast" style="display:none;"><div id="toast-message"></div><button id="toast-close-btn">OK</button></div>
            <div id="message-context-menu" style="display:none;"></div>
            <div id="image-lightbox" class="lightbox-overlay"><span class="lightbox-close-btn">&times;</span><img class="lightbox-content" id="lightbox-img"></div>
            <div id="friend-request-modal" class="modal-overlay"><div class="modal-content"><h2>L·ªùi M·ªùi K·∫øt B·∫°n</h2><div id="friend-request-list"></div><button id="close-friend-req-modal" class="cancel-btn">ƒê√≥ng</button></div></div>
            <div id="create-group-modal" class="modal-overlay"><div class="modal-content"><h2>T·∫°o nh√≥m m·ªõi</h2><input type="text" id="group-name-input" placeholder="Nh·∫≠p t√™n nh√≥m..."><h4>M·ªùi b·∫°n b√®</h4><div id="group-members-checklist"></div><div class="modal-actions"><button id="close-group-modal-btn" class="btn-ghost">H·ªßy</button><button id="confirm-create-group-btn" class="btn">T·∫°o Nh√≥m</button></div></div></div>
            <div id="reactions-modal" class="modal-overlay"><div class="modal-content"><h2>L∆∞·ª£t b√†y t·ªè c·∫£m x√∫c</h2><div id="reactions-list"></div><button id="close-reactions-modal" class="btn-ghost" style="margin-top: 15px;">ƒê√≥ng</button></div></div>
            <div id="edit-profile-modal" class="modal-overlay"><div class="modal-content"><h2>Ch·ªânh s·ª≠a h·ªì s∆°</h2><label class="form-label" for="profile-display-name">T√™n hi·ªÉn th·ªã</label><input type="text" id="profile-display-name" placeholder="T√™n c·ªßa b·∫°n..."><label class="form-label" for="profile-bio">Gi·ªõi thi·ªáu (Bio)</label><textarea id="profile-bio" rows="3" placeholder="Vi·∫øt g√¨ ƒë√≥ v·ªÅ b·∫°n..."></textarea><label class="form-label" for="profile-avatar-url">URL ·∫¢nh ƒë·∫°i di·ªán</label><input type="text" id="profile-avatar-url" placeholder="https://example.com/avatar.png"><div class="modal-actions"><button id="cancel-profile-edit-btn" class="btn-ghost">H·ªßy</button><button id="save-profile-edit-btn" class="btn">L∆∞u thay ƒë·ªïi</button></div></div></div>
            <div id="custom-confirm-modal" class="modal-overlay"><div class="modal-content" style="width: 400px; text-align: center;"><h2 id="confirm-title">X√°c nh·∫≠n h√†nh ƒë·ªông</h2><p id="confirm-message" style="margin: 15px 0; color: var(--text-2); font-size: 15px;"></p><div class="modal-actions" style="justify-content: center;"><button id="confirm-cancel-btn" class="btn-ghost">H·ªßy</button><button id="confirm-ok-btn" class="btn danger-btn">OK</button></div></div></div>
            <div id="report-user-modal" class="modal-overlay"><div class="modal-content"><h2>B√°o c√°o ng∆∞·ªùi d√πng</h2><p id="reporting-user-name" style="color: var(--text-2); margin-bottom: 20px;"></p><div id="report-form" class="form report-form"><label class="form-label">L√Ω do b√°o c√°o:</label><label class="report-reason-row"><input type="radio" name="reportReason" value="spam" checked><span class="custom-radio"></span>G·ª≠i tin nh·∫Øn r√°c (Spam)</label><label class="report-reason-row"><input type="radio" name="reportReason" value="harassment"><span class="custom-radio"></span>Qu·∫•y r·ªëi, b·∫Øt n·∫°t</label><label class="report-reason-row"><input type="radio" name="reportReason" value="inappropriate"><span class="custom-radio"></span>N·ªôi dung kh√¥ng ph√π h·ª£p</label><label class="report-reason-row"><input type="radio" name="reportReason" value="impersonation"><span class="custom-radio"></span>M·∫°o danh</label><label for="report-details" class="form-label" style="margin-top: 15px;">M√¥ t·∫£ th√™m (n·∫øu c√≥):</label><textarea id="report-details" rows="3" placeholder="Cung c·∫•p th√™m chi ti·∫øt v·ªÅ h√†nh vi..."></textarea><button id="attach-evidence-btn" class="btn-ghost" style="margin-top: 15px;">‚ûï ƒê√≠nh k√®m b·∫±ng ch·ª©ng (tin nh·∫Øn)</button><div id="evidence-preview" style="font-size: 13px; color: var(--text-2); margin-top: 8px; display: none;"></div></div><div class="modal-actions"><button id="cancel-report-btn" class="btn-ghost">H·ªßy</button><button id="submit-report-btn" class="btn danger-btn">G·ª≠i b√°o c√°o</button></div></div></div>
            <div id="force-update-profile-modal" class="modal-overlay" style="z-index: 9998;"><div class="modal-content"><h2 style="text-align: center;">Ho√†n t·∫•t h·ªì s∆° c·ªßa b·∫°n</h2><p style="color: var(--text-2); text-align: center; margin-bottom: 20px; font-size: 15px;">Vui l√≤ng c·∫≠p nh·∫≠t th√¥ng tin ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán.</p><label class="form-label" for="force-name-input">T√™n hi·ªÉn th·ªã (B·∫Øt bu·ªôc)</label><input type="text" id="force-name-input" placeholder="T√™n c·ªßa b·∫°n..."><label class="form-label" for="force-avatar-input">URL ·∫¢nh ƒë·∫°i di·ªán (B·∫Øt bu·ªôc)</label><input type="text" id="force-avatar-input" placeholder="https://example.com/avatar.png"><label class="form-label" for="force-bio-input">Gi·ªõi thi·ªáu (Bio)</label><textarea id="force-bio-input" rows="2" placeholder="Vi·∫øt g√¨ ƒë√≥ v·ªÅ b·∫°n..."></textarea><label class="form-label" for="force-cover-input">URL ·∫¢nh b√¨a</label><input type="text" id="force-cover-input" placeholder="https://example.com/cover.png"><div class="modal-actions" style="margin-top: 25px;"><button id="force-save-btn" class="btn">C·∫≠p nh·∫≠t v√† B·∫Øt ƒë·∫ßu</button></div></div></div>
            <div id="edit-group-modal" class="modal-overlay"><div class="modal-content"><h2>C·∫≠p nh·∫≠t th√¥ng tin nh√≥m</h2><div style="display: flex; align-items: flex-start; gap: 20px; margin-bottom: 20px;"><div style="flex-shrink: 0; text-align: center;"><label class="form-label" style="margin-bottom: 10px;">·∫¢nh ƒë·∫°i di·ªán</label><img id="edit-group-avatar-preview" src="https://placehold.co/95x95" style="width: 95px; height: 95px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border); cursor: pointer; transition: opacity 0.2s;" title="Nh·∫•n ƒë·ªÉ t·∫£i ·∫£nh l√™n"><div id="edit-group-avatar-loading" style="font-size: 13px; color: var(--accent-1); display: none; margin-top: 5px;">ƒêang t·∫£i...</div></div><div style="flex-grow: 1; min-width: 0;"><label class="form-label" for="edit-group-name-input">T√™n nh√≥m</label><input type="text" id="edit-group-name-input" placeholder="T√™n nh√≥m m·ªõi..."><label class="form-label" for="edit-group-avatar-input" style="margin-top: 15px;">Ho·∫∑c d√°n URL Avatar</label><input type="text" id="edit-group-avatar-input" placeholder="https://.../avatar.png"></div></div><div class="modal-actions"><button id="cancel-edit-group-btn" class="btn-ghost">H·ªßy</button><button id="save-edit-group-btn" class="btn">L∆∞u thay ƒë·ªïi</button></div></div></div>
            <div id="add-member-modal" class="modal-overlay"><div class="modal-content"><h2>Th√™m th√†nh vi√™n v√†o nh√≥m</h2><p id="add-member-group-name" style="color: var(--text-2); margin-bottom: 20px; text-align: center;"></p><label class="form-label">Ch·ªçn b·∫°n b√® ƒë·ªÉ th√™m:</label><div id="add-member-friend-list" style="max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin-bottom: 20px; background: var(--input);"></div><div class="modal-actions"><button id="cancel-add-member-btn" class="btn-ghost">H·ªßy</button><button id="confirm-add-member-btn" class="btn">Th√™m v√†o nh√≥m</button></div></div></div>
            <div id="changelog-modal" class="modal-overlay" style="z-index: 9999;"><div class="modal-content" style="width: min(90vw, 650px); text-align: left;"><h2 style="text-align: center; margin-bottom: 25px;">Nh·∫≠t K√Ω Thay ƒê·ªïi</h2><div id="changelog-content" style="max-height: 60vh; overflow-y: auto; padding-right: 15px; margin-bottom: 25px;"></div><div class="modal-actions" style="justify-content: center;"><button id="close-changelog-modal" class="btn-ghost">ƒê√≥ng</button></div></div></div>
            <div id="announcement-overlay"><div id="announcement-popup"><h2 id="announcement-title">Th√¥ng b√°o</h2><img id="announcement-image" src="" alt="Th√¥ng b√°o" style="display: none;"><p id="announcement-text"></p><button id="close-announcement-btn">ƒê√£ hi·ªÉu</button></div></div>
            <div id="report-bug-modal" class="modal-overlay"><div class="modal-content"><h2>B√°o l·ªói</h2><p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 20px;">C·∫£m ∆°n b·∫°n ƒë√£ gi√∫p c·∫£i thi·ªán Qola! Vui l√≤ng m√¥ t·∫£ l·ªói b·∫°n g·∫∑p ph·∫£i.</p><div class="form"><label class="form-label" for="bug-description">M√¥ t·∫£ l·ªói:</label><textarea id="bug-description" rows="4" placeholder="..."></textarea><label class="form-label" for="bug-steps">C√°c b∆∞·ªõc t√°i hi·ªán ra l·ªói : </label><textarea id="bug-steps" rows="3" placeholder="..."></textarea></div><div class="modal-actions"><button id="cancel-report-bug-btn" class="btn-ghost">H·ªßy</button><button id="submit-bug-report-btn" class="btn">G·ª≠i b√°o c√°o</button></div></div></div>
            <div id="about-modal" class="modal-overlay"><div class="modal-content" style="text-align: center;"><h2>Th√¥ng tin t√°c gi·∫£</h2><img src="https://i.ibb.co/xtQ6WDy8/z7088478191410-b16d303436bd2300dd9a3700a9db92ea-1.jpg" alt="T√°c gi·∫£" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 10px auto; border: 2px solid var(--glass-border);"><p style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">ƒê∆∞·ª£c ph√°t tri·ªÉn b·ªüi <span style="color: var(--accent-1);">QiQi</span></p><p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">Ver.1.0 </p><p style="font-size: 14px; line-height: 1.6;">Qola Messenger - ƒê√©o bt ƒë·ªÉ c√¢u j. <br>Li√™n h·ªá: <a href="mailto:betrumbaodeptraivippro@gmail.com" style="color: var(--accent-1);">betrumbaodeptraivippro@gmail.com</a></p><div class="modal-actions" style="justify-content: center;"><button id="close-about-modal-btn" class="btn-ghost">ƒê√≥ng</button></div></div></div>
            <div id="join-group-modal" class="modal-overlay"><div class="modal-content" style="text-align: center;"><div class="chat-info-section" style="margin-bottom: 15px;"><img id="join-group-avatar" class="chat-info-avatar" src="https://placehold.co/80x80" alt="avatar nh√≥m"><h3 id="join-group-name" class="chat-info-name" style="margin-top: 10px; margin-bottom: 5px; font-size: 20px;">T√™n nh√≥m</h3><p id="join-group-member-count" style="color: var(--text-2); font-size: 14px; margin: 0;">... th√†nh vi√™n</p></div><p style="margin: 15px 0; color: var(--text-2);">B·∫°n c√≥ mu·ªën tham gia nh√≥m n√†y kh√¥ng?</p><div class="modal-actions" style="justify-content: center;"><button id="cancel-join-group-btn" class="btn-ghost">H·ªßy</button><button id="confirm-join-group-btn" class="btn">Tham gia ngay</button></div></div></div>
            <div id="add-friend-modal" class="modal-overlay"><div class="modal-content"><h2>Th√™m b·∫°n b√®</h2><label for="add-friend-email-input" class="form-label">Nh·∫≠p email c·ªßa ng∆∞·ªùi b·∫°n mu·ªën k·∫øt b·∫°n:</label><input type="email" id="add-friend-email-input" placeholder="nhapemail@qola.com"><div class="modal-actions"><button id="cancel-add-friend-btn" class="btn-ghost">H·ªßy</button><button id="confirm-add-friend-btn" class="btn">T√¨m ki·∫øm</button></div></div></div>
            <input type="file" id="group-avatar-upload-input" accept="image/*" style="display:none;">

            <div class="container" id="app" style="display:none;">
                <div id="sidebar">
                    <div class="sidebar-head">
                        <div class="sidebar-title">Qola</div>
                        <button id="add-btn" title="T√πy ch·ªçn m·ªõi">+</button>
                        <div class="settings-menu" id="add-menu">
                            <div class="settings-row clickable" id="create-group-from-menu">T·∫°o nh√≥m m·ªõi</div>
                            <div class="settings-row clickable" id="add-friend-from-menu">Th√™m b·∫°n b√®</div>
                        </div>
                    </div>
                    <div id="sidebar-search-container">
                        <input id="global-search" placeholder="T√¨m m·ªçi th·ª©: ng∆∞·ªùi d√πng, b·∫°n b√®, nh√≥m..." />
                        <div id="search-dropdown"></div>
                    </div>
                    <div id="sidebar-loader">
                        <div class="list-title">B·∫°n b√®</div>
                        <div class="skeleton-item"><div class="skeleton skeleton-circle"></div><div class="skeleton skeleton-line"></div></div>
                        <div class="skeleton-item"><div class="skeleton skeleton-circle"></div><div class="skeleton skeleton-line"></div></div>
                        <div class="list-title">Nh√≥m</div>
                        <div class="skeleton-item"><div class="skeleton skeleton-circle"></div><div class="skeleton skeleton-line"></div></div>
                    </div>
                    <div id="sidebar-lists">
                        <ul id="chat-list"></ul>
                    </div>
                    <button id="open-friend-req-btn" title="L·ªùi m·ªùi k·∫øt b·∫°n"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg></button>
                </div>

                <div id="chat-window">
                    <div id="chat-header">
                        <div id="chat-header-left">
                            <img id="current-chat-avatar" src="https://placehold.co/40x40" alt="avatar">
                            <div id="chat-header-info">
                                <div id="current-chat-friend-name">Ch·ªçn cu·ªôc tr√≤ chuy·ªán</div>
                                <div id="peer-info-extra" style="display: none;">
                                    <span class="stranger-label">Ng∆∞·ªùi l·∫°</span>
                                    <button id="add-friend-header-btn" class="add-friend-btn">K·∫øt b·∫°n</button>
                                </div>
                            </div>
                        </div>
                        <div id="chat-header-buttons">
                            <button id="open-info-btn" title="Th√¥ng tin">‚ò∞</button>
                            <button id="group-info-btn" title="Th√¥ng tin nh√≥m">‚ò∞</button>
                        </div>
                    </div>

                    <div id="messages-container"></div>
                    <div id="typing-indicator"></div>

                    <div id="reply-preview-container" style="display: none;"><div id="reply-preview-sender"></div><div id="reply-preview-text"></div><button id="cancel-reply-btn">‚úñ</button></div>
                    <div id="edit-preview-container" style="display: none;"><div id="edit-preview-title">ƒêang ch·ªânh s·ª≠a</div><div id="edit-preview-text"></div><button id="cancel-edit-btn">‚úñ</button></div>
                    <div id="image-preview-container" style="display: none;"><img id="image-preview" /><button id="cancel-preview-btn">‚úñ</button></div>
                    <div id="selection-bar" style="display: none; padding: 10px; background: var(--glass-3); border-top: 1px solid var(--border); text-align: right;"><span id="selection-count" style="margin-right: 15px; color: var(--text-2);">ƒê√£ ch·ªçn: 0</span><button id="cancel-selection-btn" class="btn-ghost">H·ªßy</button><button id="confirm-selection-btn" class="btn">Xong</button></div>
                    <div id="mention-suggestions" class="suggestion-popup"></div>

                    <div class="chat-input">
                        <label for="image-input" class="image-upload-label"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg></label>
                        <input id="image-input" type="file" accept="image/*" style="display:none" />
                        <input id="message-input" placeholder="Nh·∫≠p tin nh·∫Øn..."/>
                        <button id="send-btn">
                            <svg class="send-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                            <svg class="spinner-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>
                        </button>
                    </div>
                    <div id="inactive-chat-indicator" style="display: none;">Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn cho ng∆∞·ªùi n√†y.</div>
                </div>

                 <div id="chat-info-panel">
                      <div id="chat-info-header"><h3>Th√¥ng tin</h3><button id="close-info-btn">‚úñ</button></div>
                      <div class="chat-info-body">
                          <div id="friend-info-content" style="display:none;"><div class="chat-info-section"><img id="chat-friend-avatar-info" class="chat-info-avatar" src="https://placehold.co/80x80"><div id="friend-name-display-area" class="chat-info-name" style="display: flex; align-items: center; justify-content: center; gap: 8px;"><h4 id="chat-friend-name-info" style="margin: 0; font-size: 18px; font-weight: 600;">Ch∆∞a ch·ªçn</h4><button id="edit-nickname-btn" class="btn-ghost" title="ƒê·∫∑t bi·ªát danh" style="padding: 4px 8px; font-size: 14px; margin-top: 0; width: auto; flex-shrink: 0;">‚úèÔ∏è</button></div><div id="friend-name-edit-area" style="display: none; margin-top: 10px; width: 100%;"><label class="form-label" for="nickname-input" style="text-align: left; margin: 0 0 6px 0; color: var(--text-2);">ƒê·∫∑t bi·ªát danh</label><input type="text" id="nickname-input" placeholder="Nh·∫≠p bi·ªát danh..." style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input); color: var(--text);"><div style="display: flex; gap: 8px; margin-top: 8px;"><button id="cancel-nickname-btn" class="btn-ghost" style="width: 100%; margin-top: 0; padding: 8px;">H·ªßy</button><button id="save-nickname-btn" class="btn" style="width: 100%; margin-top: 0; padding: 8px;">L∆∞u</button></div></div></div><h5>·∫¢nh ƒë√£ g·ª≠i</h5><div id="sent-images-grid" class="sent-images-grid"></div><div class="chat-actions"><button id="toggle-mute-btn-friend" title="T·∫Øt th√¥ng b√°o" style="border:1px solid var(--border); background:var(--glass-border); color:var(--text); border-radius:10px; padding: 11px; cursor:pointer; display: block; width: 100%; margin-bottom: 10px;"><svg id="mute-icon-on-friend" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="display: inline-block; vertical-align: middle; margin-right: 5px;"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h6.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/></svg><svg id="mute-icon-off-friend" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="display: none; vertical-align: middle; margin-right: 5px;"><path d="M5.161 14.016A2 2 0 0 0 8 16a2 2 0 0 0 2.828-1.984l-5.667-5.667zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h1.967l1.08-1.08A5.002 5.002 0 0 1 8 1.917zM14.22 12c.223.447.481.801.78 1H8.914l-1-1-.31-.31L1.053 2.379a.5.5 0 1 1 .708-.708L14.707 14.707a.5.5 0 0 1-.708.708l-1.61-1.61zM13 6c0-.88.32-4.2 1.22-6l-1.08 1.08A5.002 5.002 0 0 0 8 1.018a5.002 5.002 0 0 0-4.141 2.997l-1.08-1.08C3.68 3.8 4 5.12 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258H13z"/></svg><span id="mute-btn-text-friend">T·∫Øt th√¥ng b√°o</span></button><button id="block-user-btn">Ch·∫∑n ng∆∞·ªùi n√†y</button><button id="unblock-user-btn">B·ªè ch·∫∑n ng∆∞·ªùi n√†y</button><button id="remove-friend-btn">X√≥a b·∫°n b√®</button><button id="report-user-btn" style="background: #a16207;">B√°o c√°o ng∆∞·ªùi n√†y</button></div></div>
                          <div id="group-info-content" style="display:none;"><div class="chat-info-section"><img id="group-avatar" class="chat-info-avatar editable-group-info" src="https://placehold.co/80x80/EFEFEF/333333?text=G" alt="avatar nh√≥m"><h4 id="group-name-display" class="chat-info-name editable-group-info">T√™n nh√≥m</h4></div><h5>Th√†nh vi√™n</h5><ul id="group-members-list"></ul><button id="add-group-member-btn" class="btn primary-btn" style="width: auto; padding: 6px 12px; font-size: 13px; margin: 10px 0 15px 0; display: none;">‚ûï Th√™m th√†nh vi√™n</button><h5>·∫¢nh ƒë√£ g·ª≠i</h5><div id="group-sent-images-grid" class="sent-images-grid"></div><div class="chat-actions"><button id="toggle-mute-btn-group" title="T·∫Øt th√¥ng b√°o" style="border:1px solid var(--border); background:var(--glass-border); color:var(--text); border-radius:10px; padding: 11px; cursor:pointer; display: block; width: 100%; margin-bottom: 10px;"><svg id="mute-icon-on-group" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="display: inline-block; vertical-align: middle; margin-right: 5px;"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h6.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/></svg><svg id="mute-icon-off-group" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="display: none; vertical-align: middle; margin-right: 5px;"><path d="M5.161 14.016A2 2 0 0 0 8 16a2 2 0 0 0 2.828-1.984l-5.667-5.667zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h1.967l1.08-1.08A5.002 5.002 0 0 1 8 1.917zM14.22 12c.223.447.481.801.78 1H8.914l-1-1-.31-.31L1.053 2.379a.5.5 0 1 1 .708-.708L14.707 14.707a.5.5 0 0 1-.708.708l-1.61-1.61zM13 6c0-.88.32-4.2 1.22-6l-1.08 1.08A5.002 5.002 0 0 0 8 1.018a5.002 5.002 0 0 0-4.141 2.997l-1.08-1.08C3.68 3.8 4 5.12 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258H13z"/></svg><span id="mute-btn-text-group">T·∫Øt th√¥ng b√°o</span></button><button id="disband-group-btn" class="danger-btn" style="display: none;">Gi·∫£i t√°n nh√≥m</button><button id="leave-group-btn">R·ªùi nh√≥m</button></div></div>
                      </div>
                 </div>
            </div>
        </div>

        <div class="app-view friends-view" data-view="friends">
             <div class="friends-container">
                 <h1>B·∫°n b√®</h1>
                 <input id="friends-search-input" type="text" placeholder="T√¨m ki·∫øm b·∫°n b√®...">
                 <ul id="friends-tab-list">
                     <li class="friend-item-placeholder">ƒêang t·∫£i...</li>
                 </ul>
             </div>
        </div>

        <div class="app-view wall-view" data-view="wall">
            <div id="wall-loader"><div style="border: 4px solid var(--glass); border-top: 4px solid var(--accent-1); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div></div>
            <iframe id="wall-iframe" src="about:blank" frameborder="0"></iframe>
        </div>

    </main>
</div>

</body>
<script type="module">
// --- PH·∫¶N 1: KH·ªûI T·∫†O FIREBASE & BI·∫æN TO√ÄN C·ª§C ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, getDocs, setDoc, updateDoc, addDoc,
  collection, query, where, onSnapshot, serverTimestamp, limit, arrayUnion, arrayRemove, deleteField, deleteDoc
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
import {
  getDatabase, ref, onValue, onChildAdded, onChildChanged, push, update as rtdbUpdate,
  set, onDisconnect, serverTimestamp as dbServerTimestamp, off, remove,
  query as rtdbQuery, orderByChild, limitToLast, get
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
// import { getRemoteConfig, fetchAndActivate, getBoolean, getValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-remote-config.js"; // N·∫øu d√πng Remote Config

const firebaseConfig = {
    apiKey: "AIzaSyBuGG9WKYZHb1qbmihpJFjCBsTB_VJ_LvU",
    authDomain: "qola-web.firebaseapp.com",
    databaseURL: "https://qola-web-default-rtdb.firebaseio.com",
    projectId: "qola-web",
    storageBucket: "qola-web.firebasestorage.app",
    messagingSenderId: "477682993077",
    appId: "1:477682993077:web:7dce15eb2c365729173bfc"
};
const IMGBB_API_KEY = "e6c2724ff8344c073410da4876c3d35f"; // API Key ImgBB

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const rtdb = getDatabase(app);
// const remoteConfig = getRemoteConfig(app); // N·∫øu d√πng

// --- DOM Elements ---
const appRoot = document.getElementById('app');
const navButtons = document.querySelectorAll('.app-nav .nav-button');
const appViews = document.querySelectorAll('.app-main .app-view');
const wallIframe = document.getElementById('wall-iframe');
const navAvatar = document.getElementById('nav-avatar');
const navSettingsMenu = document.getElementById('nav-settings-menu');
const sidebar = document.getElementById('sidebar');
const chatListElement = document.getElementById('chat-list');
const addBtn = document.getElementById('add-btn');
const addMenu = document.getElementById('add-menu');
const globalSearch = document.getElementById('global-search');
const searchDropdown = document.getElementById('search-dropdown');
const openFriendReqBtn = document.getElementById('open-friend-req-btn');
const chatWindow = document.getElementById('chat-window');
const chatHeader = document.getElementById('chat-header');
const currentChatAvatar = document.getElementById('current-chat-avatar');
const currentChatFriendName = document.getElementById('current-chat-friend-name');
const peerInfoExtra = document.getElementById('peer-info-extra');
const addFriendHeaderBtn = document.getElementById('add-friend-header-btn');
const messagesContainer = document.getElementById('messages-container');
const typingIndicator = document.getElementById('typing-indicator');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const imageInput = document.getElementById('image-input');
const chatInputContainer = document.querySelector('.chat-input');
const chatInfoPanel = document.getElementById('chat-info-panel');
const openInfoBtn = document.getElementById('open-info-btn');
const groupInfoBtn = document.getElementById('group-info-btn');
const closeInfoBtn = document.getElementById('close-info-btn');
const imagePreviewContainer = document.getElementById('image-preview-container');
const imagePreview = document.getElementById('image-preview');
const cancelPreviewBtn = document.getElementById('cancel-preview-btn');
const replyPreviewContainer = document.getElementById('reply-preview-container');
const replyPreviewSender = document.getElementById('reply-preview-sender');
const replyPreviewText = document.getElementById('reply-preview-text');
const cancelReplyBtn = document.getElementById('cancel-reply-btn');
const editPreviewContainer = document.getElementById('edit-preview-container');
const editPreviewText = document.getElementById('edit-preview-text');
const cancelEditBtn = document.getElementById('cancel-edit-btn');
const inactiveChatIndicator = document.getElementById('inactive-chat-indicator');
const messageContextMenu = document.getElementById('message-context-menu');
const imageLightbox = document.getElementById('image-lightbox');
const lightboxImg = document.getElementById('lightbox-img');
const lightboxCloseBtn = document.querySelector('.lightbox-close-btn');
const toast = document.getElementById('toast');
const toastMessage = document.getElementById('toast-message');
const toastCloseBtn = document.getElementById('toast-close-btn');
const mentionSuggestions = document.getElementById('mention-suggestions');
const reactionsModal = document.getElementById('reactions-modal');
const reactionsList = document.getElementById('reactions-list');
const closeReactionsModal = document.getElementById('close-reactions-modal');
const friendReqModal = document.getElementById('friend-request-modal');
const friendReqList = document.getElementById('friend-request-list');
const closeFriendReqModal = document.getElementById('close-friend-req-modal');
const createGroupModal = document.getElementById('create-group-modal');
const closeGroupModalBtn = document.getElementById('close-group-modal-btn');
const groupNameInput = document.getElementById('group-name-input');
const groupMembersChecklist = document.getElementById('group-members-checklist');
const confirmCreateGroupBtn = document.getElementById('confirm-create-group-btn');
const editProfileModal = document.getElementById('edit-profile-modal');
const profileDisplayName = document.getElementById('profile-display-name');
const profileBio = document.getElementById('profile-bio');
const profileAvatarUrl = document.getElementById('profile-avatar-url');
const saveProfileEditBtn = document.getElementById('save-profile-edit-btn');
const cancelProfileEditBtn = document.getElementById('cancel-profile-edit-btn');
const confirmModal = document.getElementById('custom-confirm-modal');
const confirmMessage = document.getElementById('confirm-message');
const confirmOkBtn = document.getElementById('confirm-ok-btn');
const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
const reportUserModal = document.getElementById('report-user-modal');
const reportingUserName = document.getElementById('reporting-user-name');
const submitReportBtn = document.getElementById('submit-report-btn');
const cancelReportBtn = document.getElementById('cancel-report-btn');
const reportDetails = document.getElementById('report-details');
const attachEvidenceBtn = document.getElementById('attach-evidence-btn');
const evidencePreview = document.getElementById('evidence-preview');
const selectionBar = document.getElementById('selection-bar');
const selectionCount = document.getElementById('selection-count');
const cancelSelectionBtn = document.getElementById('cancel-selection-btn');
const confirmSelectionBtn = document.getElementById('confirm-selection-btn');
const friendInfoContent = document.getElementById('friend-info-content');
const friendAvatarInfo = document.getElementById('chat-friend-avatar-info');
const friendNameInfo = document.getElementById('chat-friend-name-info');
const sentImagesGrid = document.getElementById('sent-images-grid');
const blockUserBtn = document.getElementById('block-user-btn');
const unblockUserBtn = document.getElementById('unblock-user-btn');
const removeFriendBtn = document.getElementById('remove-friend-btn');
const groupInfoContent = document.getElementById('group-info-content');
const groupAvatarInfo = document.getElementById('group-avatar');
const groupNameDisplayInfo = document.getElementById('group-name-display');
const groupMembersList = document.getElementById('group-members-list');
const groupSentImagesGrid = document.getElementById('group-sent-images-grid');
const leaveGroupBtn = document.getElementById('leave-group-btn');
const changelogModal = document.getElementById('changelog-modal');
const changelogContent = document.getElementById('changelog-content');
const closeChangelogModalBtn = document.getElementById('close-changelog-modal');
const showChangelogBtn = document.getElementById('show-changelog-btn');
const announcementOverlay = document.getElementById('announcement-overlay');
const announcementPopup = document.getElementById('announcement-popup');
const announcementTitle = document.getElementById('announcement-title');
const announcementImage = document.getElementById('announcement-image');
const announcementText = document.getElementById('announcement-text');
const closeAnnouncementBtn = document.getElementById('close-announcement-btn');
const reportBugModal = document.getElementById('report-bug-modal');
const openReportBugModalBtn = document.getElementById('open-report-bug-modal');
const cancelReportBugBtn = document.getElementById('cancel-report-bug-btn');
const submitBugReportBtn = document.getElementById('submit-bug-report-btn');
const bugDescription = document.getElementById('bug-description');
const bugSteps = document.getElementById('bug-steps');
const aboutModal = document.getElementById('about-modal');
const openAboutModalBtn = document.getElementById('open-about-modal');
const closeAboutModalBtn = document.getElementById('close-about-modal-btn');
const editNicknameBtn = document.getElementById('edit-nickname-btn');
const friendNameDisplayArea = document.getElementById('friend-name-display-area');
const friendNameEditArea = document.getElementById('friend-name-edit-area');
const nicknameInput = document.getElementById('nickname-input');
const saveNicknameBtn = document.getElementById('save-nickname-btn');
const cancelNicknameBtn = document.getElementById('cancel-nickname-btn');
const toggleMuteBtnFriend = document.getElementById('toggle-mute-btn-friend');
const muteIconOnFriend = document.getElementById('mute-icon-on-friend');
const muteIconOffFriend = document.getElementById('mute-icon-off-friend');
const muteBtnTextFriend = document.getElementById('mute-btn-text-friend');
const toggleMuteBtnGroup = document.getElementById('toggle-mute-btn-group');
const muteIconOnGroup = document.getElementById('mute-icon-on-group');
const muteIconOffGroup = document.getElementById('mute-icon-off-group');
const muteBtnTextGroup = document.getElementById('mute-btn-text-group');
const editGroupModal = document.getElementById('edit-group-modal');
const editGroupNameInput = document.getElementById('edit-group-name-input');
const editGroupAvatarInput = document.getElementById('edit-group-avatar-input');
const editGroupAvatarPreview = document.getElementById('edit-group-avatar-preview');
const editGroupAvatarLoading = document.getElementById('edit-group-avatar-loading');
const groupAvatarUploadInput = document.getElementById('group-avatar-upload-input');
const saveEditGroupBtn = document.getElementById('save-edit-group-btn');
const cancelEditGroupBtn = document.getElementById('cancel-edit-group-btn');
const addMemberBtn = document.getElementById('add-group-member-btn');
const addMemberModal = document.getElementById('add-member-modal');
const addMemberGroupName = document.getElementById('add-member-group-name');
const addMemberFriendList = document.getElementById('add-member-friend-list');
const confirmAddMemberBtn = document.getElementById('confirm-add-member-btn');
const cancelAddMemberBtn = document.getElementById('cancel-add-member-btn');
const disbandGroupBtn = document.getElementById('disband-group-btn');
const wallLoader = document.getElementById('wall-loader');
const friendsListElement = document.getElementById('friends-tab-list');
const friendsSearchInput = document.getElementById('friends-search-input');

// --- State Variables ---
let currentUser = null;
let currentUserData = {};
let currentFriends = []; // M·∫£ng UID b·∫°n b√®
let friends = []; // M·∫£ng object b·∫°n b√® ƒë·∫ßy ƒë·ªß th√¥ng tin
let currentChatId = null;
let currentChatType = null;
let currentFriendUid = null;
let currentChatPeerData = null; // Data c·ªßa ng∆∞·ªùi ƒëang chat c√πng (direct)
let typingTimer;
let typingUnsub = null;
let msgsUnsub = null;
let currentGroupMembers = []; // Th√†nh vi√™n nh√≥m hi·ªán t·∫°i
let selectedImageFile = null;
let replyingTo = null;
let editingMessageKey = null;
let isEditing = false;
let lastMessageDate = null;
let unreadCount = 0;
const originalTitle = document.title;
let userListenerUnsubscribe = null; // Listener cho data user hi·ªán t·∫°i
let groupsListenerUnsubscribe = null; // Listener cho danh s√°ch nh√≥m user tham gia
let allChats = []; // M·∫£ng ch·ª©a th√¥ng tin t·∫•t c·∫£ chat (direct + group) ƒë·ªÉ sort
let chatListeners = {}; // L∆∞u c√°c listener c·ªßa last message v√† status
let wallLoaded = false; // C·ªù check xem wall ƒë√£ load l·∫ßn n√†o ch∆∞a
let reportingUser = null; // L∆∞u th√¥ng tin ng∆∞·ªùi b·ªã b√°o c√°o
let selectedEvidence = []; // L∆∞u tin nh·∫Øn b·∫±ng ch·ª©ng khi b√°o c√°o
const userCache = {}; // Cache th√¥ng tin user

// === D·ªÆ LI·ªÜU CHANGELOG ===
const changelogData = [
    { version: "1.0", date: "18/10/2025", description: ["Qola ƒë√£ ch√≠nh th·ª©c ra m·∫Øt !", "B·∫°n c√≥ th·ªÉ chat v·ªõi b·∫°n b√® v√† tham gia c√°c nh√≥m chat !. "] }
];

// --- PH·∫¶N 2: KH·ªûI ƒê·ªòNG APP & AUTHENTICATION ---

// H√†m kh·ªüi ƒë·ªông c√°c th√†nh ph·∫ßn ch√≠nh c·ªßa app sau khi x√°c th·ª±c v√† ki·ªÉm tra h·ªì s∆°
function initializeAppLogic(user, userData) {
    if (!appRoot) { console.error("initializeAppLogic: appRoot not found!"); return; }
    appRoot.style.display = 'flex'; // Hi·ªán giao di·ªán ch√≠nh

    setupPresence(user.uid, userData.hideOnlineStatus); // Thi·∫øt l·∫≠p tr·∫°ng th√°i online/offline
    wireProfile(); // C·∫≠p nh·∫≠t avatar tr√™n thanh nav
    loadAndSortChats(); // T·∫£i danh s√°ch chat ban ƒë·∫ßu
    attachEventListeners(); // G·∫Øn c√°c s·ª± ki·ªán click, input...
    attachGlobalSearch(); // K√≠ch ho·∫°t thanh t√¨m ki·∫øm
    handleUrlChat(); // X·ª≠ l√Ω n·∫øu c√≥ link chat tr·ª±c ti·∫øp trong URL
    listenForNotifications_Optimized(); // B·∫Øt ƒë·∫ßu l·∫Øng nghe th√¥ng b√°o m·ªõi
    loadFriendRequests(); // T·∫£i l·ªùi m·ªùi k·∫øt b·∫°n (ƒë·ªÉ hi·ªán ch·∫•m ƒë·ªè n·∫øu c√≥)

    // M·ªü kh√≥a c√°c th√†nh ph·∫ßn UI
    if (messageInput) {
        messageInput.disabled = false;
        messageInput.placeholder = "Nh·∫≠p tin nh·∫Øn...";
    }
    if(sidebar) {
        sidebar.style.pointerEvents = 'auto'; // Cho ph√©p click tr√™n sidebar
    }
    // G·ªçi h√†m x·ª≠ l√Ω popup th√¥ng b√°o n·∫øu c√≥
    // handleAnnouncementPopup(); // B·ªè comment n·∫øu c·∫≠u d√πng Remote Config
}

// L·∫Øng nghe thay ƒë·ªïi tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
onAuthStateChanged(auth, async (user) => {
    // 1. Ch∆∞a ƒëƒÉng nh·∫≠p -> V·ªÅ trang login
    if (!user) {
        window.location.href = 'login.html';
        return;
    }

    // 2. L·∫•y d·ªØ li·ªáu user t·ª´ Firestore
    const userDocRef = doc(db, 'users', user.uid);
    const userDocSnap = await getDoc(userDocRef);

    // 3. User kh√¥ng t·ªìn t·∫°i trong DB, b·ªã kh√≥a, ho·∫∑c c·∫ßn setup -> V·ªÅ trang login/setup
    if (!userDocSnap.exists() || userDocSnap.data().isDeactivated === true || userDocSnap.data().needsSetup === true) {
        await signOut(auth); // ƒêƒÉng xu·∫•t tr∆∞·ªõc khi chuy·ªÉn trang
        // N·∫øu c·∫ßn setup th√¨ chuy·ªÉn sang setup.html, c√≤n l·∫°i v·ªÅ login
        if (userDocSnap.exists() && userDocSnap.data().needsSetup === true) {
            window.location.href = 'setup.html';
        } else {
            window.location.href = 'login.html';
        }
        return;
    }

    // 4. G√°n bi·∫øn global khi user h·ª£p l·ªá
    const userData = userDocSnap.data();
    currentUser = user;
    currentUserData = userData;

    // // Optional: X·ª≠ l√Ω Remote Config (n·∫øu d√πng)
    // try {
    //     await fetchAndActivate(remoteConfig);
    //     const isMaintenance = getBoolean(remoteConfig, "is_maintenance_mode");
    //     if (isMaintenance) {
    //         showMaintenancePopup(); // Hi·ªán popup b·∫£o tr√¨ v√† d·ª´ng
    //         return;
    //     }
    // } catch (err) {
    //     console.error("Error fetching remote config:", err);
    // }

    // 5. Ki·ªÉm tra h·ªì s∆° c√≥ ƒë·∫ßy ƒë·ªß kh√¥ng (T√™n hi·ªÉn th·ªã & Avatar)
    const isProfileIncomplete = !userData.displayName || !userData.avatarUrl;

    if (isProfileIncomplete) {
        // --- H·ªí S∆† THI·∫æU -> HI·ªÜN MODAL C·∫¨P NH·∫¨T ---
        if (!appRoot) return;
        appRoot.style.display = 'flex'; // V·∫´n hi·ªán UI m·ªù ·∫£o ph√≠a sau

        // Kh√≥a c√°c ch·ª©c nƒÉng ch√≠nh
        if (messageInput) {
            messageInput.disabled = true;
            messageInput.placeholder = "Vui l√≤ng c·∫≠p nh·∫≠t h·ªì s∆° ƒë·ªÉ chat...";
        }
        if (sidebar) sidebar.style.pointerEvents = 'none';

        // L·∫•y c√°c element c·ªßa modal force update
        const modal = document.getElementById('force-update-profile-modal');
        const forceNameInput = document.getElementById('force-name-input');
        const forceAvatarInput = document.getElementById('force-avatar-input');
        const forceBioInput = document.getElementById('force-bio-input');
        const forceCoverInput = document.getElementById('force-cover-input');
        const forceSaveBtn = document.getElementById('force-save-btn');

        // Ki·ªÉm tra t·∫•t c·∫£ element t·ªìn t·∫°i tr∆∞·ªõc khi thao t√°c
        if (modal && forceNameInput && forceAvatarInput && forceBioInput && forceCoverInput && forceSaveBtn) {
            modal.style.display = 'flex'; // Hi·ªán modal

            // ƒêi·ªÅn th√¥ng tin c≈© v√†o form
            forceNameInput.value = userData.displayName || '';
            forceAvatarInput.value = userData.avatarUrl || '';
            forceBioInput.value = userData.bio || '';
            forceCoverInput.value = userData.coverUrl || '';

            // G·∫Øn s·ª± ki·ªán cho n√∫t L∆∞u
            forceSaveBtn.onclick = async () => {
                 const newName = forceNameInput.value.trim();
                 const newAvatar = forceAvatarInput.value.trim();
                 const newBio = forceBioInput.value.trim();
                 const newCover = forceCoverInput.value.trim();

                 // Ki·ªÉm tra tr∆∞·ªùng b·∫Øt bu·ªôc
                 if (!newName || !newAvatar) {
                     showToast("Vui l√≤ng nh·∫≠p T√™n hi·ªÉn th·ªã v√† URL Avatar.", "error");
                     return;
                 }

                 forceSaveBtn.disabled = true; forceSaveBtn.textContent = "ƒêang l∆∞u...";

                 try {
                     // C·∫≠p nh·∫≠t l√™n Firestore
                     await updateDoc(userDocRef, {
                         displayName: newName,
                         avatarUrl: newAvatar,
                         bio: newBio,
                         coverUrl: newCover || deleteField() // X√≥a n·∫øu r·ªóng
                     });

                     // C·∫≠p nh·∫≠t l·∫°i bi·∫øn currentUserData ngay l·∫≠p t·ª©c
                     currentUserData.displayName = newName;
                     currentUserData.avatarUrl = newAvatar;
                     currentUserData.bio = newBio;
                     currentUserData.coverUrl = newCover || undefined; // C·∫≠p nh·∫≠t ho·∫∑c x√≥a

                     modal.style.display = 'none'; // ·∫®n modal
                     showToast("C·∫≠p nh·∫≠t th√†nh c√¥ng!", "success");

                     // Kh·ªüi ƒë·ªông app v·ªõi d·ªØ li·ªáu m·ªõi
                     initializeAppLogic(user, currentUserData);

                 } catch (err) {
                     showToast("L·ªói khi l∆∞u: " + err.message, "error");
                     forceSaveBtn.disabled = false; forceSaveBtn.textContent = "C·∫≠p nh·∫≠t";
                 }
            };
        } else {
            console.error("Missing elements for force update profile modal!");
        }

        // Ch·ªâ ch·∫°y 2 h√†m n√†y ƒë·ªÉ hi·ªán avatar nav trong l√∫c ch·ªù c·∫≠p nh·∫≠t
        setupPresence(user.uid, userData.hideOnlineStatus);
        wireProfile();

    } else {
        // --- H·ªí S∆† ƒê·∫¶Y ƒê·ª¶ -> KH·ªûI ƒê·ªòNG APP ---
        initializeAppLogic(user, userData);
    }
});

// --- PH·∫¶N 3: C√ÅC H√ÄM TI·ªÜN √çCH ---

// Kh·ªüi t·∫°o theme (dark/light) d·ª±a v√†o localStorage
function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'dark'; // M·∫∑c ƒë·ªãnh l√† dark

}

// Chuy·ªÉn ƒë·ªïi k√Ω t·ª± ƒë·∫∑c bi·ªát HTML th√†nh d·∫°ng an to√†n
function escapeHtml(unsafeString) {
    if (typeof unsafeString !== 'string') {
        return ''; // Tr·∫£ v·ªÅ chu·ªói r·ªóng n·∫øu ƒë·∫ßu v√†o kh√¥ng ph·∫£i string
    }
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;' // Ho·∫∑c &apos;
    };
    return unsafeString.replace(/[&<>"']/g, char => map[char]);
}

// T·∫°o HTML cho d·∫•u tick xanh (n·∫øu user ƒë√£ x√°c minh)
function createVerifiedTickHTML(isVerified) {
    return isVerified ? '<span class="verified-tick"></span>' : '';
}

// Hi·ªÉn th·ªã th√¥ng b√°o toast ng·∫Øn g·ªçn
function showToast(message, type = 'info') {
    if (!toast || !toastMessage) {
        console.warn("Toast elements not found, using alert instead.");
        alert(message); // Fallback n·∫øu kh√¥ng c√≥ toast
        return;
    }
    toastMessage.textContent = message;
    // Optional: Th√™m class ƒë·ªÉ ƒë·ªïi m√†u d·ª±a v√†o type (success, error, info)
    toast.className = `toast-${type}`; // V√≠ d·ª•: toast-success, toast-error
    toast.style.display = 'block';
    // Optional: T·ª± ƒë·ªông ·∫©n sau v√†i gi√¢y
    // setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

// Hi·ªÉn th·ªã modal x√°c nh·∫≠n (Yes/No) v√† tr·∫£ v·ªÅ Promise (true/false)
function showConfirmation(message) {
    return new Promise(resolve => {
        // ∆Øu ti√™n d√πng modal n·∫øu c√≥
        if (confirmMessage && confirmModal && confirmOkBtn && confirmCancelBtn) {
            confirmMessage.textContent = message;
            confirmModal.style.display = 'flex'; // Hi·ªán modal

            // G√°n s·ª± ki·ªán ch·ªâ ch·∫°y 1 l·∫ßn cho n√∫t OK v√† Cancel
            confirmOkBtn.onclick = () => {
                confirmModal.style.display = 'none'; // ·∫®n modal
                resolve(true); // Tr·∫£ v·ªÅ true khi b·∫•m OK
            };
            confirmCancelBtn.onclick = () => {
                confirmModal.style.display = 'none'; // ·∫®n modal
                resolve(false); // Tr·∫£ v·ªÅ false khi b·∫•m Cancel
            };
            // Optional: ƒê√≥ng khi b·∫•m ra ngo√†i modal overlay
            confirmModal.onclick = (e) => {
                 if (e.target === confirmModal) {
                      confirmModal.style.display = 'none';
                      resolve(false); // Coi nh∆∞ b·∫•m Cancel
                 }
            };
        } else {
            // Fallback: D√πng window.confirm c·ªßa tr√¨nh duy·ªát
            console.warn("Confirmation modal elements not found, using window.confirm.");
            resolve(window.confirm(message));
        }
    });
}

// --- H√ÄM T√åM KI·∫æM & M·ªû PROFILE KHI TH√äM B·∫†N B√à B·∫∞NG EMAIL ---
async function addFriendByEmail() {
    // 1. L·∫•y DOM elements
    const emailInput = document.getElementById('add-friend-email-input');
    const addFriendModal = document.getElementById('add-friend-modal'); // ƒê·∫£m b·∫£o ID n√†y ƒë√∫ng
    const confirmBtn = document.getElementById('confirm-add-friend-btn');

    // Ki·ªÉm tra elements t·ªìn t·∫°i
    if (!emailInput || !addFriendModal || !confirmBtn) {
        console.error("Missing elements for add friend modal!");
        showToast("L·ªói giao di·ªán, kh√¥ng th·ªÉ th√™m b·∫°n b√®.", "error");
        return;
    }

    const email = emailInput.value.trim().toLowerCase();

    if (!email) {
        showToast("Vui l√≤ng nh·∫≠p email.", "error");
        return;
    }

    // --- B·∫ÆT ƒê·∫¶U LOGIC T√åM KI·∫æM ---
    confirmBtn.disabled = true;
    confirmBtn.textContent = "ƒêang t√¨m...";

    try {
        const q = query(collection(db, "users"), where("email", "==", email));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
            showToast("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng v·ªõi email n√†y.", "error");
        } else {
            const targetUser = querySnapshot.docs[0].data();
            const targetUid = querySnapshot.docs[0].id; // L·∫•y UID t·ª´ doc ID

            if (targetUid === currentUser.uid) {
                showToast("ƒê√¢y l√† email c·ªßa b·∫°n.", "error");
            } else {
                // M·ªü trang profile trong tab m·ªõi
                window.open(`profile.html?id=${targetUid}`, '_blank');

                // D·ªçn d·∫πp modal
                emailInput.value = '';
                addFriendModal.style.display = 'none';
            }
        }
    } catch (err) {
        console.error("L·ªói khi t√¨m b·∫°n:", err);
        showToast("ƒê√£ x·∫£y ra l·ªói khi t√¨m ki·∫øm.", "error");
    } finally { // D√πng finally ƒë·ªÉ ƒë·∫£m b·∫£o n√∫t ƒë∆∞·ª£c reset
        // Ch·ªâ reset n·∫øu modal ch∆∞a b·ªã ƒë√≥ng (tr∆∞·ªùng h·ª£p t√¨m th·∫•y v√† m·ªü tab m·ªõi)
        if (addFriendModal.style.display !== 'none') {
             confirmBtn.disabled = false;
             confirmBtn.textContent = "T√¨m ki·∫øm";
        } else {
             // N·∫øu modal ƒë√£ ƒë√≥ng, v·∫´n n√™n reset tr·∫°ng th√°i n√∫t ph√≤ng tr∆∞·ªùng h·ª£p m·ªü l·∫°i
             confirmBtn.disabled = false;
             confirmBtn.textContent = "T√¨m ki·∫øm";
        }
    }
}

/**
 * Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt c·ªßa b·∫°n b√® trong panel b√™n ph·∫£i.
 * Bao g·ªìm avatar, t√™n, bi·ªát danh (n·∫øu c√≥), ·∫£nh ƒë√£ g·ª≠i, n√∫t mute, ch·∫∑n, x√≥a b·∫°n, b√°o c√°o.
 * @param {string} friendUid UID c·ªßa ng∆∞·ªùi b·∫°n c·∫ßn hi·ªÉn th·ªã th√¥ng tin.
 */
async function showFriendInfo(friendUid) {
    if (!friendInfoContent || !groupInfoContent) { console.error("Missing info panel content elements!"); return; }
    groupInfoContent.style.display = 'none'; // ·∫®n panel nh√≥m
    friendInfoContent.style.display = 'block'; // Hi·ªán panel b·∫°n b√®

    // L·∫•y c√°c DOM element c·∫ßn thi·∫øt trong panel (c·∫©n th·∫≠n tr√πng t√™n v·ªõi bi·∫øn global)
    const friendAvatarPanel = friendInfoContent.querySelector('.chat-info-avatar'); // ƒê·ªïi t√™n bi·∫øn local
    const friendNamePanel = friendInfoContent.querySelector('#chat-friend-name-info'); // ƒê·ªïi t√™n bi·∫øn local
    const nameDisplayAreaPanel = friendInfoContent.querySelector('#friend-name-display-area');
    const nameEditAreaPanel = friendInfoContent.querySelector('#friend-name-edit-area');
    const editNicknameBtnPanel = friendInfoContent.querySelector('#edit-nickname-btn');
    const nicknameInputPanel = friendInfoContent.querySelector('#nickname-input');
    const saveNicknameBtnPanel = friendInfoContent.querySelector('#save-nickname-btn');
    const cancelNicknameBtnPanel = friendInfoContent.querySelector('#cancel-nickname-btn');
    const sentImagesGridPanel = friendInfoContent.querySelector('#sent-images-grid');
    const toggleMuteBtnFriendPanel = friendInfoContent.querySelector('#toggle-mute-btn-friend');
    const muteIconOnFriendPanel = friendInfoContent.querySelector('#mute-icon-on-friend');
    const muteIconOffFriendPanel = friendInfoContent.querySelector('#mute-icon-off-friend');
    const muteBtnTextFriendPanel = friendInfoContent.querySelector('#mute-btn-text-friend');
    const blockUserBtnPanel = friendInfoContent.querySelector('#block-user-btn');
    const unblockUserBtnPanel = friendInfoContent.querySelector('#unblock-user-btn');
    const removeFriendBtnPanel = friendInfoContent.querySelector('#remove-friend-btn');
    const reportUserBtnPanel = friendInfoContent.querySelector('#report-user-btn');


    // Ki·ªÉm tra c√°c element quan tr·ªçng
    if (!friendAvatarPanel || !friendNamePanel || !blockUserBtnPanel || !unblockUserBtnPanel || !removeFriendBtnPanel || !reportUserBtnPanel || !sentImagesGridPanel || !toggleMuteBtnFriendPanel) {
        console.error("Missing elements inside friend info panel!");
        return;
    }

    // M·∫∑c ƒë·ªãnh ·∫©n v√πng s·ª≠a t√™n
    if (nameDisplayAreaPanel) nameDisplayAreaPanel.style.display = 'flex';
    if (nameEditAreaPanel) nameEditAreaPanel.style.display = 'none';

    // Reset UI tr∆∞·ªõc khi load data m·ªõi
    friendNamePanel.innerHTML = 'ƒêang t·∫£i...';
    friendAvatarPanel.src = 'https://placehold.co/95x95';
    sentImagesGridPanel.innerHTML = '';
    blockUserBtnPanel.style.display = 'none';
    unblockUserBtnPanel.style.display = 'none';
    removeFriendBtnPanel.style.display = 'none';
    toggleMuteBtnFriendPanel.style.display = 'none';
    reportUserBtnPanel.style.display = 'none';


    // L·∫•y th√¥ng tin ng∆∞·ªùi b·∫°n m·ªõi nh·∫•t
    const friendDoc = await getDoc(doc(db, "users", friendUid));
    if (!friendDoc.exists()) {
        friendNamePanel.innerHTML = "Kh√¥ng t√¨m th·∫•y user";
        return; // D·ª´ng n·∫øu kh√¥ng c√≥ user
    }

    const d = friendDoc.data();
    const isFriend = currentUserData.friends?.includes(friendUid);
    const isBlocked = currentUserData.blocked?.includes(friendUid);
    const verifiedTick = createVerifiedTickHTML(d.isVerified);
    const currentNickname = currentUserData.nicknames?.[friendUid];
    const displayName = currentNickname || d.displayName || d.email;
    const realName = d.displayName || d.email; // Lu√¥n gi·ªØ t√™n th·∫≠t

    // Hi·ªÉn th·ªã th√¥ng tin c∆° b·∫£n
    friendNamePanel.innerHTML = `${escapeHtml(displayName)} ${verifiedTick}`;
    friendAvatarPanel.src = d.avatarUrl || `https://placehold.co/95x95/EFEFEF/333?text=${escapeHtml(realName[0].toUpperCase())}`;

    // Hi·ªán/·∫©n n√∫t ch·∫∑n/b·ªè ch·∫∑n/x√≥a b·∫°n
    removeFriendBtnPanel.style.display = isFriend ? 'block' : 'none';
    blockUserBtnPanel.style.display = !isBlocked ? 'block' : 'none';
    unblockUserBtnPanel.style.display = isBlocked ? 'block' : 'none';
    reportUserBtnPanel.style.display = 'block'; // N√∫t b√°o c√°o lu√¥n hi·ªán
    toggleMuteBtnFriendPanel.style.display = 'block'; // N√∫t mute lu√¥n hi·ªán

    // G√°n s·ª± ki·ªán cho c√°c n√∫t h√†nh ƒë·ªông c∆° b·∫£n
    blockUserBtnPanel.onclick = () => blockUser(friendUid, displayName);
    unblockUserBtnPanel.onclick = () => unblockUser(friendUid, displayName);
    reportUserBtnPanel.onclick = () => {
        reportingUser = { uid: friendUid, name: realName }; // B√°o c√°o b·∫±ng t√™n th·∫≠t
        if (reportingUserName && reportUserModal) {
             reportingUserName.textContent = `B·∫°n ƒëang b√°o c√°o ${escapeHtml(realName)}.`;
             reportUserModal.style.display = 'flex';
        }
    };
    removeFriendBtnPanel.onclick = async () => { /* ... logic x√≥a b·∫°n ... */
        const confirmed = await showConfirmation(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a "${escapeHtml(displayName)}" kh·ªèi danh s√°ch b·∫°n b√®?`);
        if (confirmed) {
            const meRef = doc(db, 'users', currentUser.uid);
            const friendRef = doc(db, 'users', friendUid);
            try {
                await updateDoc(meRef, { friends: arrayRemove(friendUid), [`nicknames.${friendUid}`]: deleteField() });
                await updateDoc(friendRef, { friends: arrayRemove(currentUser.uid) });
                showToast("ƒê√£ x√≥a b·∫°n.", 'success');
                if (chatInfoPanel) chatInfoPanel.classList.remove('open');
                const chatIdToRemove = [currentUser.uid, friendUid].sort().join('_');
                if (currentChatId === chatIdToRemove) { /* Reset chat UI */
                    if(currentChatFriendName) currentChatFriendName.textContent = "Ch·ªçn cu·ªôc tr√≤ chuy·ªán";
                    if(messagesContainer) messagesContainer.innerHTML = '';
                    if(messageInput) messageInput.disabled = true; if(sendBtn) sendBtn.disabled = true;
                    currentChatId = null; currentChatType = null;
                    if(currentChatAvatar) currentChatAvatar.style.display = 'none';
                    if(openInfoBtn) openInfoBtn.style.display = 'none';
                    if(toggleMuteBtnFriendPanel) toggleMuteBtnFriendPanel.style.display = 'none';
                }
                // loadAndSortChats s·∫Ω t·ª± c·∫≠p nh·∫≠t sidebar
            } catch(error) { console.error("L·ªói khi x√≥a b·∫°n:", error); showToast("C√≥ l·ªói x·∫£y ra khi x√≥a b·∫°n."); }
        }
    };

    // --- LOGIC BI·ªÜT DANH ---
    if (editNicknameBtnPanel && nameDisplayAreaPanel && nameEditAreaPanel && nicknameInputPanel && saveNicknameBtnPanel && cancelNicknameBtnPanel) {
        editNicknameBtnPanel.onclick = () => {
            nameDisplayAreaPanel.style.display = 'none';
            nameEditAreaPanel.style.display = 'block';
            nicknameInputPanel.value = currentNickname || '';
            nicknameInputPanel.placeholder = `ƒê·∫∑t bi·ªát danh cho ${escapeHtml(realName)}`;
            nicknameInputPanel.focus();
        };
        cancelNicknameBtnPanel.onclick = () => {
            nameDisplayAreaPanel.style.display = 'flex';
            nameEditAreaPanel.style.display = 'none';
        };
        saveNicknameBtnPanel.onclick = async () => { /* ... logic l∆∞u nickname ... */
            const newNickname = nicknameInputPanel.value.trim();
            saveNicknameBtnPanel.disabled = true; saveNicknameBtnPanel.textContent = 'L∆∞u...';
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                const fieldName = `nicknames.${friendUid}`;
                if (newNickname) {
                    await updateDoc(userRef, { [fieldName]: newNickname });
                    if (!currentUserData.nicknames) currentUserData.nicknames = {};
                    currentUserData.nicknames[friendUid] = newNickname;
                    showToast("ƒê√£ l∆∞u bi·ªát danh!", "success");
                } else {
                    await updateDoc(userRef, { [fieldName]: deleteField() });
                    if (currentUserData.nicknames) delete currentUserData.nicknames[friendUid];
                    showToast("ƒê√£ x√≥a bi·ªát danh.", "info");
                }
                const finalName = newNickname || realName;
                friendNamePanel.innerHTML = `${escapeHtml(finalName)} ${verifiedTick}`; // C·∫≠p nh·∫≠t t√™n trong panel
                // C·∫≠p nh·∫≠t t√™n tr√™n header n·∫øu ƒëang chat v·ªõi ng∆∞·ªùi n√†y
                const chatIdToCheck = [currentUser.uid, friendUid].sort().join('_');
                if (currentChatId === chatIdToCheck && currentChatFriendName) {
                    currentChatFriendName.innerHTML = `${escapeHtml(finalName)} ${verifiedTick}`;
                }
                // C·∫≠p nh·∫≠t t√™n tr√™n sidebar n·∫øu c√≥
                const sidebarNameEl = document.getElementById(`sidebar-friend-name-${friendUid}`);
                if (sidebarNameEl) { sidebarNameEl.innerHTML = `${escapeHtml(finalName)} ${verifiedTick}`; }
                nameDisplayAreaPanel.style.display = 'flex'; nameEditAreaPanel.style.display = 'none'; // ƒê√≥ng v√πng s·ª≠a
            } catch (err) { console.error("L·ªói l∆∞u nickname: ", err); showToast("L·ªói!", "error"); }
            finally { saveNicknameBtnPanel.disabled = false; saveNicknameBtnPanel.textContent = 'L∆∞u'; }
        };
    } else {
        console.warn("Missing nickname elements in friend info panel.");
    }


    // --- LOGIC N√öT MUTE ---
    if (toggleMuteBtnFriendPanel && muteIconOnFriendPanel && muteIconOffFriendPanel && muteBtnTextFriendPanel) {
        const chatIdForMute = [currentUser.uid, friendUid].sort().join('_');
        const isMutedFriend = currentUserData.mutedChats?.[chatIdForMute] === true;
        muteIconOnFriendPanel.style.display = isMutedFriend ? 'none' : 'inline-block';
        muteIconOffFriendPanel.style.display = isMutedFriend ? 'inline-block' : 'none';
        muteBtnTextFriendPanel.textContent = isMutedFriend ? "B·∫≠t th√¥ng b√°o" : "T·∫Øt th√¥ng b√°o";
        toggleMuteBtnFriendPanel.title = isMutedFriend ? "B·∫≠t th√¥ng b√°o" : "T·∫Øt th√¥ng b√°o";

        toggleMuteBtnFriendPanel.onclick = async () => { /* ... logic mute ... */
            const currentlyMuted = currentUserData.mutedChats?.[chatIdForMute] === true;
            const newMutedStatus = !currentlyMuted;
            toggleMuteBtnFriendPanel.disabled = true;
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                const fieldName = `mutedChats.${chatIdForMute}`;
                if (newMutedStatus) {
                    await updateDoc(userRef, { [fieldName]: true });
                    if (!currentUserData.mutedChats) currentUserData.mutedChats = {};
                    currentUserData.mutedChats[chatIdForMute] = true;
                    showToast("ƒê√£ t·∫Øt th√¥ng b√°o cho cu·ªôc tr√≤ chuy·ªán n√†y.", "info");
                } else {
                    await updateDoc(userRef, { [fieldName]: deleteField() });
                    if (currentUserData.mutedChats) delete currentUserData.mutedChats[chatIdForMute];
                    showToast("ƒê√£ b·∫≠t th√¥ng b√°o.", "success");
                }
                muteIconOnFriendPanel.style.display = newMutedStatus ? 'none' : 'inline-block';
                muteIconOffFriendPanel.style.display = newMutedStatus ? 'inline-block' : 'none';
                muteBtnTextFriendPanel.textContent = newMutedStatus ? "B·∫≠t th√¥ng b√°o" : "T·∫Øt th√¥ng b√°o";
                toggleMuteBtnFriendPanel.title = newMutedStatus ? "B·∫≠t th√¥ng b√°o" : "T·∫Øt th√¥ng b√°o";
            } catch (err) { console.error("L·ªói mute:", err); showToast("L·ªói!", "error");}
            finally { toggleMuteBtnFriendPanel.disabled = false; }
        };
    } else {
        console.warn("Missing mute elements in friend info panel.");
    }


    // --- LOAD ·∫¢NH ƒê√É G·ª¨I ---
    sentImagesGridPanel.innerHTML = ''; // X√≥a ·∫£nh c≈©
    const chatMsgRef = ref(rtdb, `/messages/${[currentUser.uid, friendUid].sort().join('_')}`);
    // Query l·∫•y ·∫£nh m·ªõi nh·∫•t (v√≠ d·ª• 9 ·∫£nh)
    const imagesQuery = rtdbQuery(chatMsgRef, orderByChild('timestamp'), limitToLast(9));
    get(imagesQuery).then(snap => { // D√πng get() thay onValue
        sentImagesGridPanel.innerHTML = ''; // X√≥a l·∫°i l·∫ßn n·ªØa
        if (!snap.exists()) { sentImagesGridPanel.innerHTML = '<p style="font-size: 13px; color: var(--text-2); text-align: left;">Ch∆∞a c√≥ ·∫£nh n√†o.</p>'; return; }
        const imageMsgs = [];
        snap.forEach((child) => { const msg = child.val(); if (msg.imageUrl) imageMsgs.push(msg.imageUrl); });
        imageMsgs.reverse().forEach(url => { // Hi·ªÉn th·ªã m·ªõi nh·∫•t tr∆∞·ªõc
            const img = document.createElement('img'); img.src = url; img.alt = "·∫¢nh ƒë√£ g·ª≠i";
            img.onclick = () => openLightbox(url);
            sentImagesGridPanel.appendChild(img);
        });
         if (imageMsgs.length === 0) {
              sentImagesGridPanel.innerHTML = '<p style="font-size: 13px; color: var(--text-2); text-align: left;">Ch∆∞a c√≥ ·∫£nh n√†o.</p>';
         }
    }).catch(err => {
         console.error("Error fetching sent images:", err);
         sentImagesGridPanel.innerHTML = '<p style="color:red;">L·ªói t·∫£i ·∫£nh</p>';
    });
}

/**
 * L·∫Øng nghe danh s√°ch l·ªùi m·ªùi k·∫øt b·∫°n ƒëang ch·ªù x·ª≠ l√Ω (pending) g·ª≠i ƒë·∫øn user hi·ªán t·∫°i.
 * Hi·ªÉn th·ªã danh s√°ch trong modal v√† c·∫≠p nh·∫≠t ch·∫•m ƒë·ªè th√¥ng b√°o tr√™n n√∫t b·∫°n b√®.
 */
function loadFriendRequests(){
    if (!currentUser || !friendReqList || !openFriendReqBtn) {
        console.warn("Missing elements or user data for friend requests.");
        return;
    }
    const q = query(collection(db, 'friend_requests'),
                    where('to_uid', '==', currentUser.uid),
                    where('status', '==', 'pending')); // Ch·ªâ l·∫•y l·ªùi m·ªùi ƒëang ch·ªù

    // D√πng onSnapshot ƒë·ªÉ t·ª± c·∫≠p nh·∫≠t danh s√°ch khi c√≥ l·ªùi m·ªùi m·ªõi ho·∫∑c ƒë∆∞·ª£c x·ª≠ l√Ω
    onSnapshot(q, (snap)=>{
        // C·∫≠p nh·∫≠t ch·∫•m ƒë·ªè th√¥ng b√°o
        openFriendReqBtn.classList.toggle('has-new-request', !snap.empty);

        // Hi·ªÉn th·ªã danh s√°ch l·ªùi m·ªùi trong modal
        friendReqList.innerHTML = ''; // X√≥a danh s√°ch c≈©
        if(snap.empty){
          friendReqList.innerHTML = `<p style="opacity:0.7; color: var(--text-2); text-align: center;">Kh√¥ng c√≥ l·ªùi m·ªùi n√†o ƒëang ch·ªù.</p>`; // Th√¥ng b√°o kh√¥ng c√≥ l·ªùi m·ªùi
          return;
        }

        snap.forEach(docSnap => {
          const req = docSnap.data();
          const item = document.createElement('div');
          item.className = 'friend-req-item'; // Class cho t·ª´ng d√≤ng l·ªùi m·ªùi
          // Hi·ªÉn th·ªã email ng∆∞·ªùi g·ª≠i v√† n√∫t Ch·∫•p nh·∫≠n/T·ª´ ch·ªëi
          item.innerHTML = `
              <div class="friend-req-name">${escapeHtml(req.from_email || 'Ng∆∞·ªùi d√πng ·∫©n')}</div>
              <div class="friend-req-buttons">
                  <button class="friend-req-btn accept-btn">Ch·∫•p nh·∫≠n</button>
                  <button class="friend-req-btn reject-btn">T·ª´ ch·ªëi</button>
              </div>`;

          // G·∫Øn s·ª± ki·ªán cho n√∫t Ch·∫•p nh·∫≠n v√† T·ª´ ch·ªëi
          const [acceptBtn, rejectBtn] = item.querySelectorAll('button');
          if (acceptBtn) acceptBtn.onclick = ()=> handleAcceptFriend(docSnap.id, req.from_uid);
          if (rejectBtn) rejectBtn.onclick = ()=> handleRejectFriend(docSnap.id);

          friendReqList.appendChild(item); // Th√™m d√≤ng l·ªùi m·ªùi v√†o danh s√°ch
        });
    }, (error) => {
        console.error("Error listening to friend requests:", error);
        friendReqList.innerHTML = `<p style="color:red; text-align: center;">L·ªói t·∫£i l·ªùi m·ªùi!</p>`; // Hi·ªÉn th·ªã l·ªói
        openFriendReqBtn.classList.remove('has-new-request'); // ·∫®n ch·∫•m ƒë·ªè n·∫øu l·ªói
    });
}

/**
 * L·∫Øng nghe danh s√°ch l·ªùi m·ªùi k·∫øt b·∫°n ƒëang ch·ªù x·ª≠ l√Ω (pending) g·ª≠i ƒë·∫øn user hi·ªán t·∫°i.
 * Hi·ªÉn th·ªã danh s√°ch trong modal v√† c·∫≠p nh·∫≠t ch·∫•m ƒë·ªè th√¥ng b√°o tr√™n n√∫t b·∫°n b√®.
 */

 // --- H√ÄM G·ª¨I L·ªúI M·ªúI K·∫æT B·∫†N ---
async function sendFriendRequest(targetUid) {
    if (!currentUser || !currentUserData) return Promise.reject(new Error("Ch∆∞a ƒëƒÉng nh·∫≠p."));
    if (targetUid === currentUser.uid) return Promise.reject(new Error("Kh√¥ng th·ªÉ g·ª≠i l·ªùi m·ªùi cho ch√≠nh m√¨nh."));
    if (currentUserData.friends?.includes(targetUid)) return Promise.reject(new Error("ƒê√£ l√† b·∫°n b√®."));

    console.log(`Sending friend request to: ${targetUid}`);

    // Check if a request already exists (either direction)
    const q1 = query(collection(db, 'friend_requests'),
        where('from_uid', '==', currentUser.uid),
        where('to_uid', '==', targetUid),
        where('status', '==', 'pending')
    );
    const q2 = query(collection(db, 'friend_requests'),
        where('from_uid', '==', targetUid),
        where('to_uid', '==', currentUser.uid),
        where('status', '==', 'pending')
    );

    try {
        const [sentSnapshot, receivedSnapshot] = await Promise.all([getDocs(q1), getDocs(q2)]);

        if (!sentSnapshot.empty) {
            console.log("Request already sent.");
            return Promise.reject(new Error("ƒê√£ g·ª≠i l·ªùi m·ªùi tr∆∞·ªõc ƒë√≥."));
        }
        if (!receivedSnapshot.empty) {
            console.log("Request already received.");
            return Promise.reject(new Error("Ng∆∞·ªùi n√†y ƒë√£ g·ª≠i l·ªùi m·ªùi cho b·∫°n. Ki·ªÉm tra danh s√°ch l·ªùi m·ªùi."));
        }

        // No existing pending request, create a new one
        console.log("Creating new friend request document...");
        await addDoc(collection(db, 'friend_requests'), {
            from_uid: currentUser.uid,
            from_email: currentUser.email, // Store sender email for display
            to_uid: targetUid,
            status: 'pending', // 'pending', 'accepted', 'declined'
            timestamp: serverTimestamp()
        });
        console.log("Friend request document created.");
        return Promise.resolve("ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n!"); // Resolve on success

    } catch (error) {
        console.error("Error sending friend request:", error);
        return Promise.reject(new Error("L·ªói g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n: " + error.message)); // Reject on error
    }
}


// Xin quy·ªÅn hi·ªÉn th·ªã th√¥ng b√°o c·ªßa tr√¨nh duy·ªát
function requestSimpleNotificationPermission() {
    if (!("Notification" in window)) {
        alert("Tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ th√¥ng b√°o tr√™n m√†n h√¨nh.");
        return;
    }
    // Ch·ªâ xin quy·ªÅn n·∫øu ch∆∞a ƒë∆∞·ª£c c·∫•p ho·∫∑c b·ªã t·ª´ ch·ªëi tr∆∞·ªõc ƒë√≥
    if (Notification.permission !== "granted") {
        Notification.requestPermission().then((permission) => {
            if (permission === "granted") {
                showToast("ƒê√£ b·∫≠t th√¥ng b√°o tr√¨nh duy·ªát!", "success");
            } else {
                showToast("B·∫°n ƒë√£ kh√¥ng cho ph√©p nh·∫≠n th√¥ng b√°o.", "error");
            }
        });
    } else {
        showToast("Th√¥ng b√°o tr√¨nh duy·ªát ƒë√£ ƒë∆∞·ª£c b·∫≠t t·ª´ tr∆∞·ªõc.", "info");
    }
}

// Hi·ªÉn th·ªã th√¥ng b√°o ƒë∆°n gi·∫£n c·ªßa tr√¨nh duy·ªát
function showSimpleNotification(senderName, messageText, avatarUrl) {
    if (Notification.permission !== "granted") return; // Ch·ªâ hi·ªán khi ƒë√£ ƒë∆∞·ª£c c·∫•p quy·ªÅn

    const options = {
        body: messageText,
        icon: avatarUrl || 'https://placehold.co/96x96?text=Q', // ·∫¢nh ƒë·∫°i di·ªán ho·∫∑c placeholder
        // tag: 'qola-message', // Optional: D√πng tag ƒë·ªÉ gom th√¥ng b√°o
        // renotify: true,      // Optional: Rung/b√°o l·∫°i n·∫øu tag gi·ªëng nhau
    };

    // T·∫°o th√¥ng b√°o m·ªõi
    const notification = new Notification(senderName, options);

    // Optional: ƒê√≥ng th√¥ng b√°o sau v√†i gi√¢y
    setTimeout(notification.close.bind(notification), 5000); // T·ª± ƒë√≥ng sau 5s

    // Optional: X·ª≠ l√Ω khi click v√†o th√¥ng b√°o (v√≠ d·ª•: m·ªü c·ª≠a s·ªï chat)
    notification.onclick = () => {
        window.focus(); // Focus v√†o c·ª≠a s·ªï tr√¨nh duy·ªát
        // TODO: Th√™m logic chuy·ªÉn ƒë·∫øn ƒë√∫ng c·ª≠a s·ªï chat n·∫øu c·∫ßn
    };
}

// --- PH·∫¶N 4: PRESENCE & PROFILE WIRING ---

/**
 * Thi·∫øt l·∫≠p tr·∫°ng th√°i online/offline cho user hi·ªán t·∫°i trong Realtime Database.
 * @param {string} uid User ID c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i.
 * @param {boolean} [isHidden=false] N·∫øu true, user s·∫Ω lu√¥n hi·ªÉn th·ªã offline.
 */
function setupPresence(uid, isHidden = false) {
    const statusRef = ref(rtdb, `/status/${uid}`); // ƒê∆∞·ªùng d·∫´n ƒë·∫øn tr·∫°ng th√°i c·ªßa user

    // N·∫øu ng∆∞·ªùi d√πng ch·ªçn ·∫©n tr·∫°ng th√°i -> Set offline v√† d·ª´ng
    if (isHidden) {
        set(statusRef, { isOnline: false, last_seen: dbServerTimestamp() });
        console.log(`User ${uid} chose to hide status, set to offline.`);
        return; // D·ª´ng h√†m t·∫°i ƒë√¢y
    }

    // N·∫øu kh√¥ng ·∫©n -> Thi·∫øt l·∫≠p logic online/offline b√¨nh th∆∞·ªùng
    const connectedRef = ref(rtdb, '.info/connected'); // Firebase connection status

    onValue(connectedRef, (snap) => {
        // Ch·ªâ th·ª±c hi·ªán khi k·∫øt n·ªëi th√†nh c√¥ng (snap.val() === true)
        if (snap.val() === false) {
            // C√≥ th·ªÉ t·∫°m th·ªùi set offline ·ªü ƒë√¢y n·∫øu mu·ªën,
            // nh∆∞ng onDisconnect ƒë√£ x·ª≠ l√Ω khi m·∫•t k·∫øt n·ªëi ƒë·ªôt ng·ªôt
            return;
        }

        // Khi client m·∫•t k·∫øt n·ªëi (t·∫Øt tab, m·∫•t m·∫°ng), Firebase s·∫Ω t·ª± ƒë·ªông set offline
        onDisconnect(statusRef)
            .set({ isOnline: false, last_seen: dbServerTimestamp() })
            .then(() => {
                // Sau khi thi·∫øt l·∫≠p onDisconnect th√†nh c√¥ng, set tr·∫°ng th√°i hi·ªán t·∫°i l√† online
                set(statusRef, { isOnline: true, last_seen: dbServerTimestamp() });
                console.log(`Presence setup complete for ${uid}. Status: Online.`);
            })
            .catch((err) => {
                console.error("Could not establish onDisconnect event:", err);
            });
    });
}

/**
 * L·∫Øng nghe thay ƒë·ªïi d·ªØ li·ªáu c·ªßa user hi·ªán t·∫°i (v√≠ d·ª•: avatarUrl, hideOnlineStatus)
 * v√† c·∫≠p nh·∫≠t giao di·ªán t∆∞∆°ng ·ª©ng (v√≠ d·ª•: avatar tr√™n thanh nav).
 */
function wireProfile() {
    if (!currentUser || !navAvatar) {
        console.error("wireProfile: currentUser or navAvatar not available!");
        return; // D·ª´ng n·∫øu thi·∫øu th√¥ng tin
    }

    // L·∫Øng nghe thay ƒë·ªïi tr√™n document c·ªßa user hi·ªán t·∫°i trong Firestore
    const userDocRef = doc(db, 'users', currentUser.uid);

    // S·ª≠ d·ª•ng onSnapshot ƒë·ªÉ t·ª± ƒë·ªông c·∫≠p nh·∫≠t khi c√≥ thay ƒë·ªïi
    onSnapshot(userDocRef, (ds) => {
        if (!ds.exists()) {
            console.error("User document suddenly disappeared!");
            // C√≥ th·ªÉ x·ª≠ l√Ω ƒëƒÉng xu·∫•t ·ªü ƒë√¢y n·∫øu c·∫ßn
            return;
        }
        const userData = ds.data() || {}; // L·∫•y data, ph√≤ng tr∆∞·ªùng h·ª£p r·ªóng

        // C·∫≠p nh·∫≠t avatar tr√™n thanh nav
        const avatarSrc = userData.avatarUrl || `https://placehold.co/48x48/111/fff?text=${(userData.email || '?')[0].toUpperCase()}`;
        navAvatar.src = avatarSrc; // C·∫≠p nh·∫≠t src c·ªßa img#nav-avatar

        // C·∫≠p nh·∫≠t class 'is-hiding-status' tr√™n body ƒë·ªÉ CSS x·ª≠ l√Ω ·∫©n ch·∫•m xanh
        // (CSS c·∫ßn c√≥ rule: body.is-hiding-status .status.online { background: #64748b; })
        document.body.classList.toggle('is-hiding-status', userData.hideOnlineStatus === true);

        // QUAN TR·ªåNG: Kh√¥ng c·∫≠p nh·∫≠t currentUserData ·ªü ƒë√¢y n·ªØa
        // Vi·ªác c·∫≠p nh·∫≠t currentUserData s·∫Ω do listener trong loadAndSortChats x·ª≠ l√Ω
        // ƒë·ªÉ tr√°nh load l·∫°i danh s√°ch chat kh√¥ng c·∫ßn thi·∫øt khi ch·ªâ avatar thay ƒë·ªïi.

    }, (error) => {
        console.error("Error listening to user profile:", error);
        // C√≥ th·ªÉ hi·ªÉn th·ªã l·ªói cho ng∆∞·ªùi d√πng ·ªü ƒë√¢y
    });
}

// --- PH·∫¶N 5: LOAD & RENDER DANH S√ÅCH CHAT ---

/**
 * H√†m ch√≠nh ƒë·ªÉ b·∫Øt ƒë·∫ßu qu√° tr√¨nh t·∫£i v√† l·∫Øng nghe danh s√°ch chat.
 * G·∫Øn listener cho d·ªØ li·ªáu user hi·ªán t·∫°i v√† danh s√°ch nh√≥m user tham gia.
 * Khi c√≥ thay ƒë·ªïi (b·∫°n m·ªõi, nh√≥m m·ªõi), s·∫Ω g·ªçi loadAndRebuildChatList.
 */
async function loadAndSortChats() {
    if (!chatListElement || !currentUser || !currentUserData) {
        console.error("loadAndSortChats: Missing required elements or data.");
        return;
    }
    console.log("Running loadAndSortChats...");

    // --- 1. G·∫Øn Listener User (Ch·ªâ 1 l·∫ßn) ---
    if (!userListenerUnsubscribe) {
        console.log("Attaching user listener...");
        const userDocRef = doc(db, 'users', currentUser.uid);
        userListenerUnsubscribe = onSnapshot(userDocRef, async (userDocSnap) => {
            console.log("User data snapshot received!");
            if (userDocSnap.exists()) {
                const newUserData = userDocSnap.data();
                const oldFriends = JSON.stringify(currentUserData.friends || []);
                const newFriends = JSON.stringify(newUserData.friends || []);
                currentUserData = newUserData; // C·∫≠p nh·∫≠t data m·ªõi nh·∫•t

                // L·∫•y d·ªØ li·ªáu chi ti·∫øt c·ªßa b·∫°n b√® (quan tr·ªçng cho c√°c h√†m kh√°c)
                const friendUIDs = currentUserData.friends || [];
                const friendPromises = friendUIDs.map(uid => getDoc(doc(db, 'users', uid)));
                const friendDocs = await Promise.all(friendPromises);
                friends = friendDocs // C·∫≠p nh·∫≠t bi·∫øn global 'friends'
                    .filter(snap => snap.exists())
                    .map(snap => ({ uid: snap.id, ...snap.data() }));
                currentFriends = currentUserData.friends || []; // C·∫≠p nh·∫≠t m·∫£ng UID b·∫°n b√®

                // Ch·ªâ load l·∫°i list n·∫øu danh s√°ch b·∫°n b√® THAY ƒê·ªîI
                if (oldFriends !== newFriends) {
                    console.log("Friend list changed, reloading chat list...");
                    await loadAndRebuildChatList(); // Load l·∫°i list khi b·∫°n b√® thay ƒë·ªïi
                } else {
                    // N·∫øu b·∫°n b√® kh√¥ng ƒë·ªïi, ch·ªâ c·∫≠p nh·∫≠t UI ph·ª•
                    wireProfile(); // C·∫≠p nh·∫≠t avatar nav
                    document.body.classList.toggle('is-hiding-status', currentUserData.hideOnlineStatus === true);
                }
            } else {
                console.error("User document does not exist!");
                await signOut(auth); window.location.href = 'login.html';
            }
        }, (error) => {
            console.error("Error listening to user document:", error);
        });
    }

    // --- 2. G·∫Øn Listener Groups (Ch·ªâ 1 l·∫ßn) ---
    if (!groupsListenerUnsubscribe) {
        console.log("Attaching groups listener...");
        const groupsQuery = query(collection(db, 'groups'), where('member_uids', 'array-contains', currentUser.uid));
        groupsListenerUnsubscribe = onSnapshot(groupsQuery, async (querySnapshot) => {
            console.log("Groups data snapshot received!");
            // Lu√¥n load l·∫°i list khi nh√≥m thay ƒë·ªïi (t√™n, th√†nh vi√™n, avatar...)
            await loadAndRebuildChatList();
        }, (error) => {
            console.error("Error listening to groups collection:", error);
        });
    }

    // --- 3. Load v√† Rebuild List l·∫ßn ƒë·∫ßu ---
    await loadAndRebuildChatList();
}

/**
 * H√†m n√†y l·∫•y d·ªØ li·ªáu b·∫°n b√® v√† nh√≥m, t·∫°o m·∫£ng allChats,
 * sau ƒë√≥ g·∫Øn listener cho tin nh·∫Øn cu·ªëi v√† tr·∫°ng th√°i online c·ªßa t·ª´ng chat.
 */
async function loadAndRebuildChatList() {
     if (!chatListElement || !currentUser || !currentUserData || !db || !rtdb) {
         console.error("loadAndRebuildChatList: Missing required elements or data.");
         return;
     }
     console.log("--- Starting loadAndRebuildChatList ---");

     // Hi·ªán skeleton loading
     if (sidebar) sidebar.classList.remove('loaded');
     chatListElement.innerHTML = '<li class="chat-item-placeholder" style="list-style: none; text-align: center; color: var(--text-secondary); padding: 20px;">ƒêang c·∫≠p nh·∫≠t danh s√°ch...</li>';

     // H·ªßy listener last message & status C≈®
     console.log("Clearing old listeners...");
     Object.entries(chatListeners).forEach(([key, unsub]) => {
         try { unsub(); } catch (e) { console.warn(`Error unsubscribing ${key}:`, e); }
         delete chatListeners[key];
     });
     console.log("Old listeners cleared.");
     allChats = []; // Reset m·∫£ng chat

     try {
         // L·∫•y danh s√°ch b·∫°n b√® T·ª™ currentUserData M·ªöI NH·∫§T
         const friendUIDs = currentUserData.friends || [];
         console.log("Friend UIDs from currentUserData:", friendUIDs);

         // L·∫•y danh s√°ch nh√≥m T·ª™ Firestore
         console.log("Fetching groups from Firestore...");
         const groupsQuery = query(collection(db, 'groups'), where('member_uids', 'array-contains', currentUser.uid));
         const groupSnap = await getDocs(groupsQuery);
         console.log("Fetched groups:", groupSnap.docs.length);

         // T·∫°o danh s√°ch chat ban ƒë·∫ßu (Promise cho b·∫°n b√®)
         const friendPromises = friendUIDs.map(async (uid) => {
             console.log("Processing friend UID:", uid);
             try {
                 const userDoc = await getDoc(doc(db, 'users', uid));
                 if (userDoc.exists()) {
                     const u = userDoc.data();
                     // C·∫≠p nh·∫≠t cache n·∫øu ch∆∞a c√≥ ho·∫∑c data c≈©
                     userCache[uid] = { displayName: u.displayName, avatarUrl: u.avatarUrl, isVerified: u.isVerified };

                     const chatId = [currentUser.uid, uid].sort().join('_');
                     if (!allChats.some(chat => chat.id === chatId)) { // Ch·ªëng tr√πng l·∫∑p
                         allChats.push({
                             id: chatId,
                             peerUid: uid,
                             name: u.displayName || u.email || 'Ng∆∞·ªùi d√πng',
                             avatarUrl: u.avatarUrl,
                             isVerified: u.isVerified || false,
                             type: 'direct',
                             lastMessageTimestamp: 0,
                             lastMessagePreview: '...'
                         });
                         console.log("Added direct chat to allChats:", chatId);
                     }
                 } else {
                     console.warn("Friend document does not exist for UID:", uid);
                 }
             } catch (friendError) {
                 console.error("Error fetching friend data for UID:", uid, friendError);
             }
         });

         // X·ª≠ l√Ω nh√≥m
         groupSnap.docs.forEach(docSnap => {
             const g = docSnap.data();
             const groupId = docSnap.id;
             console.log("Processing group ID:", groupId);
             if (!allChats.some(chat => chat.id === groupId)) { // Ch·ªëng tr√πng l·∫∑p
                 allChats.push({
                     id: groupId,
                     name: g.groupName || 'Nh√≥m kh√¥ng t√™n',
                     avatarUrl: g.avatarUrl,
                     type: 'group',
                     isVerified: false,
                     lastMessageTimestamp: 0,
                     lastMessagePreview: '...'
                 });
                 console.log("Added group chat to allChats:", groupId);
             }
         });

         // Ch·ªù t·∫•t c·∫£ promise l·∫•y th√¥ng tin b·∫°n b√® ho√†n th√†nh
         console.log("Waiting for all friend data promises...");
         await Promise.all(friendPromises);
         console.log("Friend data promises completed.");

         console.log("Final allChats list before attaching listeners:", allChats.map(c=>c.id));

         // G·∫Øn listener last message & status M·ªöI
         if (allChats.length > 0) {
             console.log("Attaching last message and status listeners...");
             allChats.forEach(chat => {
                 const chatId = chat.id;

                 // --- Listener cho Last Message ---
                 const lastMsgQuery = rtdbQuery(ref(rtdb, `/messages/${chatId}`), orderByChild('timestamp'), limitToLast(1));
                 if (chatListeners[chatId]) chatListeners[chatId](); // H·ªßy listener c≈© n·∫øu c√≤n s√≥t
                 chatListeners[chatId] = onValue(lastMsgQuery, (snap) => {
                     let timestamp = 0; let preview = '...';
                     if (snap.exists()) {
                         const [, lastMsg] = Object.entries(snap.val())[0];
                         timestamp = lastMsg.timestamp || 0;
                         if (lastMsg.recalled) preview = 'Tin nh·∫Øn ƒë√£ thu h·ªìi';
                         else if (lastMsg.text) preview = lastMsg.text;
                         else if (lastMsg.imageUrls?.length) preview = `ƒê√£ g·ª≠i ${lastMsg.imageUrls.length} ·∫£nh/video`;
                         else if (lastMsg.imageUrl) preview = 'ƒê√£ g·ª≠i m·ªôt ·∫£nh';
                         else preview = 'B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán';
                         const senderPrefix = lastMsg.senderId === currentUser.uid ? 'B·∫°n: ' : (chat.type === 'group' ? `${(lastMsg.senderName || '?').split(' ')[0]}: ` : '');
                         preview = senderPrefix + preview;
                     }
                     const chatIndex = allChats.findIndex(c => c.id === chatId);
                     if (chatIndex > -1) {
                         if (allChats[chatIndex].lastMessageTimestamp !== timestamp || allChats[chatIndex].lastMessagePreview !== preview) {
                             allChats[chatIndex].lastMessageTimestamp = timestamp;
                             allChats[chatIndex].lastMessagePreview = preview;
                             renderChatList(); // Render l·∫°i khi c√≥ thay ƒë·ªïi
                         }
                     }
                 }, (error) => {
                     console.error(`Error listening to last message ${chatId}:`, error);
                     if (chatListeners[chatId]) { chatListeners[chatId](); delete chatListeners[chatId]; }
                 });

                 // --- Listener cho Status (n·∫øu l√† direct chat) ---
                 if (chat.type === 'direct' && chat.peerUid) {
                     const statusRef = ref(rtdb, `/status/${chat.peerUid}`);
                     const statusKey = `status_${chat.peerUid}`;
                     if (chatListeners[statusKey]) chatListeners[statusKey]();
                     chatListeners[statusKey] = onValue(statusRef, (s) => {
                         const statusEl = document.getElementById(`st-${chat.peerUid}`);
                         if (statusEl) statusEl.classList.toggle('online', !!s.val()?.isOnline);
                     }, (error) => {
                         console.error(`Error listening to status ${chat.peerUid}:`, error);
                         if (chatListeners[statusKey]) { chatListeners[statusKey](); delete chatListeners[statusKey]; }
                     });
                 }
             }); // K·∫øt th√∫c forEach g·∫Øn listener
             // Render l·∫ßn ƒë·∫ßu sau khi g·∫Øn listener
             renderChatList();
         } else {
             // N·∫øu kh√¥ng c√≥ chat n√†o c·∫£
             renderChatList(); // G·ªçi ƒë·ªÉ hi·ªán "Ch∆∞a c√≥ chat" v√† t·∫Øt skeleton
         }
         console.log("--- Finished loadAndRebuildChatList ---");

     } catch (error) {
         console.error("Fatal error in loadAndRebuildChatList:", error);
         chatListElement.innerHTML = '<li class="chat-item-placeholder" style="list-style: none; text-align: center; color: red; padding: 20px;">L·ªói t·∫£i danh s√°ch chat!</li>';
         if (sidebar) sidebar.classList.add('loaded'); // V·∫´n t·∫Øt skeleton khi l·ªói
     }
}

/**
 * H√†m render danh s√°ch chat (allChats) l√™n sidebar.
 * S·∫Øp x·∫øp theo tin nh·∫Øn m·ªõi nh·∫•t tr∆∞·ªõc.
 */
/**
 * H√†m render danh s√°ch chat (allChats) l√™n sidebar.
 * S·∫Øp x·∫øp theo tin nh·∫Øn m·ªõi nh·∫•t tr∆∞·ªõc v√† √°p d·ª•ng hi·ªáu ·ª©ng gradient cho t√™n user verified.
 */
const renderChatList = () => {
     // Ki·ªÉm tra element c·∫ßn thi·∫øt
     if (!chatListElement || !sidebar) {
         console.error("renderChatList: chatListElement or sidebar not found!");
         return;
     }

     // S·∫Øp x·∫øp m·∫£ng allChats theo timestamp m·ªõi nh·∫•t (tin nh·∫Øn m·ªõi nh·∫•t l√™n ƒë·∫ßu)
     allChats.sort((a, b) => (b.lastMessageTimestamp || 0) - (a.lastMessageTimestamp || 0));
     chatListElement.innerHTML = ''; // X√≥a n·ªôi dung danh s√°ch c≈©

     // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p kh√¥ng c√≥ cu·ªôc tr√≤ chuy·ªán n√†o
     if (allChats.length === 0) {
         chatListElement.innerHTML = '<li class="chat-item-placeholder" style="list-style: none; text-align: center; color: var(--text-secondary); padding: 20px;">Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o.</li>';
     } else {
         // L·∫∑p qua t·ª´ng chat trong m·∫£ng ƒë√£ s·∫Øp x·∫øp ƒë·ªÉ t·∫°o item
         allChats.forEach(chat => {
             const li = document.createElement('li');
             li.className = 'item clickable chat-list-item'; // Class chung
             li.dataset.chatId = chat.id; // L∆∞u chatId

             // G√°n s·ª± ki·ªán click ƒë·ªÉ m·ªü chat t∆∞∆°ng ·ª©ng
             li.onclick = () => {
                 if (chat.type === 'direct') {
                     // L·∫•y data b·∫°n b√® (∆∞u ti√™n cache)
                     const friendData = friends.find(f => f.uid === chat.peerUid) || { uid: chat.peerUid, displayName: chat.name, avatarUrl: chat.avatarUrl, isVerified: chat.isVerified };
                     startDirectChat(friendData);
                 } else { // N·∫øu l√† group chat
                     startGroupChat(chat.id, chat.name);
                 }
                 // ƒê√°nh d·∫•u item ƒëang active (optional)
                 document.querySelectorAll('.chat-list-item.active').forEach(item => item.classList.remove('active'));
                 li.classList.add('active');
             };

             // L·∫•y avatar, t√™n, v√† tick xanh
             const avatarPlaceholder = chat.name ? chat.name[0].toUpperCase() : (chat.type === 'group' ? 'G' : '?');
             const avatarSrc = chat.avatarUrl || `https://placehold.co/40x40?text=${avatarPlaceholder}`;
             const verifiedTick = createVerifiedTickHTML(chat.isVerified); // L·∫•y HTML tick xanh

             // X√°c ƒë·ªãnh class cho t√™n (th√™m 'gradient-text' n·∫øu verified)
             const nameClass = chat.isVerified ? 'item-name gradient-text' : 'item-name';
             // T·∫°o HTML cho t√™n (kh√¥ng bao g·ªìm tick)
             const nameHtml = `<div class="${nameClass}" id="sidebar-friend-name-${chat.peerUid}">${escapeHtml(chat.name)}</div>`;

             // T·∫°o HTML ho√†n ch·ªânh cho list item
             li.innerHTML = `
                 <div class="item-left">
                     <img class="result-avatar" src="${avatarSrc}" alt="Avatar">
                     <div style="min-width: 0;">
                         ${nameHtml} ${verifiedTick} <div class="item-last-msg">${escapeHtml(chat.lastMessagePreview || '...')}</div>
                     </div>
                 </div>
                 ${chat.type === 'direct' ? `<div class="status" id="st-${chat.peerUid}"></div>` : ''} `;
             chatListElement.appendChild(li); // Th√™m item v√†o danh s√°ch

             // C·∫≠p nh·∫≠t l·∫°i status dot (l·∫•y gi√° tr·ªã hi·ªán t·∫°i 1 l·∫ßn)
             if (chat.type === 'direct' && chat.peerUid) {
                 const statusRef = ref(rtdb, `/status/${chat.peerUid}`);
                 get(statusRef).then(s => {
                     const statusEl = document.getElementById(`st-${chat.peerUid}`);
                     if (statusEl) statusEl.classList.toggle('online', !!s.val()?.isOnline);
                 }).catch(err => console.warn("Error getting status on render:", err));
             }
         });
     }
     // Lu√¥n t·∫Øt skeleton SAU KHI render xong (d√π c√≥ chat hay kh√¥ng)
     sidebar.classList.add('loaded');
};

// --- PH·∫¶N 6: M·ªû C·ª¨A S·ªî CHAT ---

/**
 * B·∫Øt ƒë·∫ßu ho·∫∑c chuy·ªÉn sang cu·ªôc tr√≤ chuy·ªán tr·ª±c ti·∫øp v·ªõi m·ªôt ng∆∞·ªùi b·∫°n.
 * L·∫•y th√¥ng tin chi ti·∫øt c·ªßa b·∫°n b√®, ki·ªÉm tra tr·∫°ng th√°i (b·∫°n b√®, b·ªã ch·∫∑n),
 * v√† g·ªçi openChat ƒë·ªÉ hi·ªÉn th·ªã giao di·ªán. C·∫≠p nh·∫≠t URL.
 * @param {object} friend Object ch·ª©a √≠t nh·∫•t uid, displayName, avatarUrl, isVerified c·ªßa ng∆∞·ªùi b·∫°n.
 */
async function startDirectChat(friend) {
    // Ki·ªÉm tra th√¥ng tin ƒë·∫ßu v√†o v√† tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
    if (!friend || !friend.uid || !currentUser) {
        console.warn("startDirectChat: Invalid friend data or user not logged in.");
        window.location.href = 'index.html'; // Chuy·ªÉn v·ªÅ trang ch√≠nh n·∫øu thi·∫øu th√¥ng tin
        return;
    }

    // --- X·ª≠ l√Ω chuy·ªÉn trang cho mobile ---
    if (window.innerWidth <= 768) {
        window.location.href = `chat.html?chat=${friend.uid}`;
        return; // D·ª´ng h√†m ·ªü ƒë√¢y cho mobile
    }
    // --- K·∫øt th√∫c x·ª≠ l√Ω mobile ---

    // L·∫•y d·ªØ li·ªáu m·ªõi nh·∫•t c·ªßa ng∆∞·ªùi b·∫°n t·ª´ Firestore
    const friendDoc = await getDoc(doc(db, 'users', friend.uid));
    if (!friendDoc.exists()) {
        showToast("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†y.", "error");
        return; // D·ª´ng n·∫øu user kh√¥ng t·ªìn t·∫°i
    }

    const friendData = friendDoc.data();
    currentChatPeerData = friendData; // L∆∞u l·∫°i data ƒë·∫ßy ƒë·ªß c·ªßa ng∆∞·ªùi ƒëang chat c√πng

    // X√°c ƒë·ªãnh tr·∫°ng th√°i chat (active, inactive do b·ªã ch·∫∑n...)
    let isChatActive = true;
    let inactiveReason = "";
    let isFriend = currentUserData.friends?.includes(friend.uid); // Ki·ªÉm tra c√≥ ph·∫£i b·∫°n b√® kh√¥ng

    if (currentUserData.blocked?.includes(friend.uid)) {
        inactiveReason = "B·∫°n ƒë√£ ch·∫∑n ng∆∞·ªùi n√†y. H√£y b·ªè ch·∫∑n ƒë·ªÉ ti·∫øp t·ª•c nh·∫Øn tin.";
        isChatActive = false;
    } else if (friendData?.blocked?.includes(currentUser.uid)) {
        inactiveReason = "B·∫°n kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn cho ng∆∞·ªùi n√†y.";
        isChatActive = false;
    } else if (friendData.isDeactivated === true) {
        inactiveReason = "T√†i kho·∫£n n√†y ƒë√£ ng·ª´ng ho·∫°t ƒë·ªông.";
        isChatActive = false;
    }

    // T·∫°o chatId v√† c·∫≠p nh·∫≠t bi·∫øn global
    const uids = [currentUser.uid, friend.uid].sort();
    const chatId = uids.join('_');
    currentFriendUid = friend.uid; // L∆∞u uid c·ªßa ng∆∞·ªùi b·∫°n ƒëang chat

    // G·ªçi h√†m openChat ƒë·ªÉ hi·ªÉn th·ªã UI
    openChat({
        id: chatId,
        name: friendData.displayName || friendData.email, // L·∫•y t√™n hi·ªÉn th·ªã
        type: 'direct',
        isActive: isChatActive // Tr·∫°ng th√°i active/inactive
    });

    // C·∫≠p nh·∫≠t text cho indicator n·∫øu chat inactive
    if (inactiveChatIndicator) inactiveChatIndicator.textContent = inactiveReason;

    // --- C·∫¨P NH·∫¨T UI HEADER CHO NG∆Ø·ªúI L·∫† ---
    const peerInfoExtra = document.getElementById('peer-info-extra');
    const addFriendHeaderBtn = document.getElementById('add-friend-header-btn');

    if (peerInfoExtra && addFriendHeaderBtn) { // Ki·ªÉm tra element t·ªìn t·∫°i
        // Ch·ªâ hi·ªán khi KH√îNG ph·∫£i b·∫°n b√®, chat ƒëang active v√† KH√îNG ph·∫£i chat v·ªõi ch√≠nh m√¨nh
        if (!isFriend && isChatActive && friend.uid !== currentUser.uid) {
            peerInfoExtra.style.display = 'flex'; // Hi·ªán kh·ªëi "Ng∆∞·ªùi l·∫° + K·∫øt b·∫°n"

            // Ki·ªÉm tra xem ƒë√£ g·ª≠i/nh·∫≠n l·ªùi m·ªùi ch∆∞a
            addFriendHeaderBtn.disabled = true; addFriendHeaderBtn.textContent = 'ƒêang t·∫£i...';
            const qSent = query(collection(db, 'friend_requests'), where('from_uid', '==', currentUser.uid), where('to_uid', '==', friend.uid), where('status', '==', 'pending'));
            const qReceived = query(collection(db, 'friend_requests'), where('from_uid', '==', friend.uid), where('to_uid', '==', currentUser.uid), where('status', '==', 'pending'));

            try {
                 const [sentSnap, receivedSnap] = await Promise.all([getDocs(qSent), getDocs(qReceived)]);

                 if (!sentSnap.empty) { // ƒê√£ g·ª≠i l·ªùi m·ªùi
                     addFriendHeaderBtn.textContent = 'ƒê√£ g·ª≠i';
                     addFriendHeaderBtn.disabled = true;
                 } else if (!receivedSnap.empty) { // ƒê√£ nh·∫≠n l·ªùi m·ªùi t·ª´ h·ªç
                      addFriendHeaderBtn.textContent = 'Ch·∫•p nh·∫≠n';
                      addFriendHeaderBtn.disabled = false;
                      addFriendHeaderBtn.onclick = async () => { /* ... logic ch·∫•p nh·∫≠n l·ªùi m·ªùi ... */
                           addFriendHeaderBtn.disabled = true; addFriendHeaderBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
                           const reqId = receivedSnap.docs[0].id;
                           try {
                               await handleAcceptFriend(reqId, friend.uid);
                               showToast('ƒê√£ ch·∫•p nh·∫≠n l·ªùi m·ªùi!', 'success');
                               peerInfoExtra.style.display = 'none';
                               isFriend = true; // C·∫≠p nh·∫≠t tr·∫°ng th√°i b·∫°n b√®
                               if(removeFriendBtn) removeFriendBtn.style.display = 'block';
                           } catch (acceptErr) {
                               console.error("L·ªói ch·∫•p nh·∫≠n:", acceptErr);
                               showToast("L·ªói: " + acceptErr.message, "error");
                               addFriendHeaderBtn.disabled = false; addFriendHeaderBtn.textContent = 'Ch·∫•p nh·∫≠n';
                           }
                      };
                 } else { // Ch∆∞a c√≥ l·ªùi m·ªùi n√†o
                     addFriendHeaderBtn.textContent = 'K·∫øt b·∫°n';
                     addFriendHeaderBtn.disabled = false;
                     addFriendHeaderBtn.onclick = () => { /* ... logic g·ª≠i l·ªùi m·ªùi ... */
                         addFriendHeaderBtn.disabled = true; addFriendHeaderBtn.textContent = 'ƒêang g·ª≠i...';
                         sendFriendRequest(friend.uid)
                             .then(() => {
                                 showToast("ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n!", "success");
                                 addFriendHeaderBtn.textContent = 'ƒê√£ g·ª≠i';
                             })
                             .catch((err) => {
                                 console.error("L·ªói g·ª≠i l·ªùi m·ªùi:", err);
                                 showToast("L·ªói: " + err.message, "error");
                                 addFriendHeaderBtn.disabled = false; addFriendHeaderBtn.textContent = 'K·∫øt b·∫°n';
                             });
                     };
                 }
            } catch (checkError) {
                 console.error("L·ªói ki·ªÉm tra l·ªùi m·ªùi:", checkError);
                 addFriendHeaderBtn.textContent = 'L·ªói';
                 addFriendHeaderBtn.disabled = true;
            }

        } else {
            peerInfoExtra.style.display = 'none'; // ·∫®n ƒëi n·∫øu l√† b·∫°n b√®, kh√¥ng active, ho·∫∑c l√† ch√≠nh m√¨nh
        }
    } else {
        console.warn("Peer info extra elements not found!");
    }
    // --- K·∫æT TH√öC C·∫¨P NH·∫¨T UI NG∆Ø·ªúI L·∫† ---

    // C·∫≠p nh·∫≠t URL (ch·ªâ tr√™n PC)
    history.replaceState(null, '', `?chat=${friend.uid}`);
}

/**
 * B·∫Øt ƒë·∫ßu ho·∫∑c chuy·ªÉn sang cu·ªôc tr√≤ chuy·ªán nh√≥m.
 * L·∫•y th√¥ng tin th√†nh vi√™n nh√≥m v√† g·ªçi openChat. C·∫≠p nh·∫≠t URL.
 * @param {string} groupId ID c·ªßa nh√≥m.
 * @param {string} groupName T√™n c·ªßa nh√≥m.
 */
async function startGroupChat(groupId, groupName){
    // --- X·ª≠ l√Ω chuy·ªÉn trang cho mobile ---
    if (window.innerWidth <= 768) {
        window.location.href = `chat.html?chat_group=${groupId}`;
        return; // D·ª´ng h√†m ·ªü ƒë√¢y cho mobile
    }
    // --- K·∫øt th√∫c x·ª≠ l√Ω mobile ---

    // Th√¥ng b√°o Beta (n·∫øu ch∆∞a hi·ªán)
    if (!sessionStorage.getItem('groupBetaWarningShown')) {
        showToast('T√≠nh nƒÉng Nh√≥m ƒëang trong giai ƒëo·∫°n th·ª≠ nghi·ªám (Beta)...');
        sessionStorage.setItem('groupBetaWarningShown', 'true');
    }

    // Reset tr·∫°ng th√°i chat tr·ª±c ti·∫øp
    currentFriendUid = null;
    currentChatPeerData = null;

    // L·∫•y th√¥ng tin th√†nh vi√™n nh√≥m tr∆∞·ªõc khi m·ªü chat
    const groupRef = doc(db, "groups", groupId);
    const groupDoc = await getDoc(groupRef);
    if (groupDoc.exists()) {
        const groupData = groupDoc.data();
        const memberUids = groupData.member_uids || [];
        // Ki·ªÉm tra xem user hi·ªán t·∫°i c√≥ c√≤n l√† th√†nh vi√™n kh√¥ng
        if (!memberUids.includes(currentUser.uid)) {
             showToast("B·∫°n kh√¥ng c√≤n l√† th√†nh vi√™n c·ªßa nh√≥m n√†y.", "error");
             // C√≥ th·ªÉ chuy·ªÉn v·ªÅ trang ch√≠nh ho·∫∑c l√†m g√¨ ƒë√≥ kh√°c
             // V√≠ d·ª•: reset UI chat
             if (currentChatId === groupId) {
                  currentChatFriendName.textContent = "Ch·ªçn cu·ªôc tr√≤ chuy·ªán";
                  messagesContainer.innerHTML = '';
                  messageInput.disabled = true; sendBtn.disabled = true;
                  currentChatId = null; currentChatType = null;
                  if(currentChatAvatar) currentChatAvatar.style.display = 'none';
                  if(groupInfoBtn) groupInfoBtn.style.display = 'none';
             }
             return; // D·ª´ng n·∫øu kh√¥ng c√≤n l√† th√†nh vi√™n
        }

        // L·∫•y th√¥ng tin chi ti·∫øt c√°c th√†nh vi√™n
        const memberPromises = memberUids.map(uid => getDoc(doc(db, "users", uid)));
        const memberDocs = await Promise.all(memberPromises);
        currentGroupMembers = memberDocs
            .filter(d => d.exists())
            .map(d => {
                const uData = d.data();
                // C·∫≠p nh·∫≠t cache
                userCache[uData.uid] = { displayName: uData.displayName, avatarUrl: uData.avatarUrl, isVerified: uData.isVerified };
                return { uid: uData.uid, displayName: uData.displayName || uData.email, avatarUrl: uData.avatarUrl };
            });

        // M·ªü chat nh√≥m
        openChat({id:groupId, name:groupName, type:'group', isActive: true});

        // C·∫≠p nh·∫≠t URL (ch·ªâ tr√™n PC)
        history.replaceState(null, '', `?chat_group=${groupId}`);
    } else {
        showToast("Nh√≥m kh√¥ng t·ªìn t·∫°i.", "error");
        // Reset UI n·∫øu nh√≥m kh√¥ng t·ªìn t·∫°i
        if (currentChatId === groupId) {
             currentChatFriendName.textContent = "Ch·ªçn cu·ªôc tr√≤ chuy·ªán";
             messagesContainer.innerHTML = '';
             messageInput.disabled = true; sendBtn.disabled = true;
             currentChatId = null; currentChatType = null;
             if(currentChatAvatar) currentChatAvatar.style.display = 'none';
             if(groupInfoBtn) groupInfoBtn.style.display = 'none';
        }
    }
}

/**
 * H√†m c·ªët l√µi ƒë·ªÉ m·ªü giao di·ªán chat, reset UI, g·∫Øn listener m·ªõi.
 * ƒê∆∞·ª£c g·ªçi b·ªüi startDirectChat v√† startGroupChat.
 * @param {object} chat Object ch·ª©a id, name, type ('direct'/'group'), isActive.
 */
/**
 * H√†m c·ªët l√µi ƒë·ªÉ m·ªü giao di·ªán chat, reset UI, g·∫Øn listener m·ªõi.
 * ƒê∆∞·ª£c g·ªçi b·ªüi startDirectChat v√† startGroupChat.
 * C·∫≠p nh·∫≠t header v·ªõi t√™n (c√≥ gradient n·∫øu verified) v√† avatar.
 * @param {object} chat Object ch·ª©a id, name, type ('direct'/'group'), isActive.
 */
function openChat(chat) {
    console.log("Opening chat:", chat);
    // 1. NG·∫ÆT K·∫æT N·ªêI C≈®
    if (msgsUnsub) { try { msgsUnsub(); } catch(e){ console.warn("Error unsubscribing msgs:", e); } msgsUnsub = null; }
    if (typingUnsub) { try { typingUnsub(); } catch(e){ console.warn("Error unsubscribing typing:", e); } typingUnsub = null; }

    // 2. Reset tr·∫°ng th√°i v√† UI
    lastMessageDate = null;
    currentChatId = chat.id;
    currentChatType = chat.type;
    // currentGroupMembers ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong startGroupChat n·∫øu l√† group
    if(messagesContainer) messagesContainer.innerHTML = ''; // X√≥a tin nh·∫Øn c≈©
    if(typingIndicator) typingIndicator.textContent = ''; // X√≥a tr·∫°ng th√°i g√µ ph√≠m
    if(chatInfoPanel) chatInfoPanel.classList.remove('open'); // ƒê√≥ng panel th√¥ng tin
    cancelReply(); cancelEdit(); cancelImagePreview(); // H·ªßy c√°c tr·∫°ng th√°i preview

    // ·∫®n ph·∫ßn ng∆∞·ªùi l·∫° tr∆∞·ªõc khi c·∫≠p nh·∫≠t header
    if (peerInfoExtra) peerInfoExtra.style.display = 'none';

    // 3. C·∫≠p nh·∫≠t Header Chat
    if (currentChatFriendName && currentChatAvatar && openInfoBtn && groupInfoBtn) { // Check elements t·ªìn t·∫°i
        // L·∫•y t√™n hi·ªÉn th·ªã (∆∞u ti√™n nickname)
        const chatDisplayName = (chat.type === 'direct' && currentFriendUid && currentUserData.nicknames?.[currentFriendUid])
                                ? currentUserData.nicknames[currentFriendUid]
                                : chat.name;

        // X·ª≠ l√Ω t√™n v√† hi·ªáu ·ª©ng gradient
        currentChatFriendName.classList.remove('gradient-text'); // X√≥a class c≈© tr∆∞·ªõc
        const isPeerVerified = chat.type === 'direct' && currentChatPeerData?.isVerified; // Check verified
        if (isPeerVerified) {
            currentChatFriendName.classList.add('gradient-text'); // Th√™m class n·∫øu verified
        }
        currentChatFriendName.innerHTML = escapeHtml(chatDisplayName); // C·∫≠p nh·∫≠t t√™n

        // Th√™m tick xanh v√†o sau t√™n (n·∫øu c√≥)
        const verifiedTickHTML = createVerifiedTickHTML(isPeerVerified);
        currentChatFriendName.innerHTML += verifiedTickHTML; // N·ªëi chu·ªói HTML tick v√†o

        // C·∫≠p nh·∫≠t Avatar Header v√† c√°c n√∫t Info
        if (chat.type === 'direct' && currentChatPeerData) {
            currentChatAvatar.src = currentChatPeerData.avatarUrl || `https://placehold.co/40x40/EFEFEF/333?text=${escapeHtml(chatDisplayName[0])}`;
            currentChatAvatar.style.display = 'block';
            currentChatAvatar.onclick = () => { if (currentFriendUid) window.open(`profile.html?id=${currentFriendUid}`, '_blank'); };
            groupInfoBtn.style.display = 'none';
            openInfoBtn.style.display = 'block';
            openInfoBtn.onclick = () => { if (currentFriendUid) { showFriendInfo(currentFriendUid); chatInfoPanel.classList.add('open'); } };
            // currentFriendUid ƒë√£ ƒë∆∞·ª£c g√°n trong startDirectChat
        } else if (chat.type === 'group') {
            // L·∫•y avatar th·ª±c
            getDoc(doc(db, "groups", chat.id)).then(groupDoc => {
                let avatarSrc = `https://placehold.co/40x40/1e293b/fff?text=${escapeHtml(chat.name[0])}`; // Default
                if (groupDoc.exists()) {
                    const groupData = groupDoc.data();
                    avatarSrc = groupData.avatarUrl || avatarSrc;
                }
                currentChatAvatar.src = avatarSrc;
            }).catch(err => console.error("Error fetching group avatar for header:", err));
            currentChatAvatar.style.display = 'block';
            currentChatAvatar.onclick = null;
            openInfoBtn.style.display = 'none';
            groupInfoBtn.style.display = 'block';
            groupInfoBtn.onclick = () => { showGroupInfo(chat.id); chatInfoPanel.classList.add('open'); };
            currentFriendUid = null; // Reset friendUid khi v√†o group chat
        } else { // Placeholder state
            currentChatFriendName.textContent = "Ch·ªçn cu·ªôc tr√≤ chuy·ªán";
            currentChatAvatar.style.display = 'none';
            openInfoBtn.style.display = 'none';
            groupInfoBtn.style.display = 'none';
            currentFriendUid = null;
        }
    } else {
        console.error("Missing header elements for openChat!");
    }

    // 4. K√≠ch ho·∫°t/V√¥ hi·ªáu h√≥a thanh nh·∫≠p li·ªáu (Gi·ªØ nguy√™n)
    if (chatInputContainer && inactiveChatIndicator && messageInput) {
        if (chat.isActive) {
            chatInputContainer.style.display = 'flex';
            inactiveChatIndicator.style.display = 'none';
            messageInput.disabled = false;
            messageInput.placeholder = "Nh·∫≠p tin nh·∫Øn...";
            if (!chatInfoPanel || !chatInfoPanel.classList.contains('open')) {
                setTimeout(() => messageInput.focus(), 50);
            }
        } else {
            chatInputContainer.style.display = 'none';
            inactiveChatIndicator.style.display = 'block';
            inactiveChatIndicator.textContent = inactiveChatIndicator.textContent || "Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn.";
        }
    } else {
        console.error("Missing input area elements for openChat!");
    }

    // 5. G·∫Øn listener m·ªõi cho tr·∫°ng th√°i g√µ ph√≠m (Gi·ªØ nguy√™n)
    if (typingIndicator) {
        const typingRef = ref(rtdb, `/typing/${chat.id}`);
        typingUnsub = onValue(typingRef, (snap) => {
            const obj = snap.val() || {}; const othersTyping = Object.keys(obj).filter(uid => obj[uid] && uid !== currentUser.uid);
            if (othersTyping.length > 0) { if (chat.type === 'direct') typingIndicator.textContent = 'ƒêang nh·∫≠p...'; else { const typerNames = othersTyping.map(uid => currentGroupMembers.find(m => m.uid === uid)?.displayName?.split(' ')[0] || userCache[uid]?.displayName?.split(' ')[0] ||'Ai ƒë√≥').filter(Boolean); const maxNamesToShow = 2; const displayNames = typerNames.slice(0, maxNamesToShow).join(', '); const remainingCount = typerNames.length - maxNamesToShow; typingIndicator.textContent = `${displayNames}${remainingCount > 0 ? ` v√† ${remainingCount} ng∆∞·ªùi kh√°c` : ''} ƒëang nh·∫≠p...`; } }
            else typingIndicator.textContent = '';
            if (messagesContainer) { const shouldScrollTyping = messagesContainer.scrollHeight - messagesContainer.scrollTop < messagesContainer.clientHeight + 100; if (typingIndicator.textContent && shouldScrollTyping) setTimeout(() => { messagesContainer.scrollTop = messagesContainer.scrollHeight; }, 50); }
        });
    } else {
        console.error("Typing indicator element not found!");
    }

    // 6. G·∫Øn listener m·ªõi cho tin nh·∫Øn (Gi·ªØ nguy√™n)
    if (messagesContainer) {
        const msgsRef = ref(rtdb, `/messages/${chat.id}`);
        const initialLoadQuery = rtdbQuery(msgsRef, orderByChild('timestamp'), limitToLast(30));
        get(initialLoadQuery).then(snap => {
            messagesContainer.innerHTML = '';
            if (snap.exists()) { snap.forEach(childSnap => renderMessage(childSnap.key, childSnap.val(), chat)); }
            else { messagesContainer.innerHTML = '<div style="text-align: center; color: var(--text-2); padding: 20px;">Ch∆∞a c√≥ tin nh·∫Øn n√†o.</div>'; }
            const newMsgsQuery = rtdbQuery(msgsRef, orderByChild('timestamp'), limitToLast(1));
            const unsubChildAdded = onChildAdded(newMsgsQuery, (snap) => { if (!document.querySelector(`.msg-wrapper[data-key="${snap.key}"]`)) renderMessage(snap.key, snap.val(), chat); });
            const unsubChildChanged = onChildChanged(msgsRef, (snap) => renderMessage(snap.key, snap.val(), chat));
            msgsUnsub = () => { off(newMsgsQuery,'child_added', unsubChildAdded); off(msgsRef, 'child_changed', unsubChildChanged); };
            setTimeout(() => { messagesContainer.scrollTop = messagesContainer.scrollHeight; }, 150);
        }).catch(error => { console.error("Error loading initial messages:", error); messagesContainer.innerHTML = '<div style="text-align: center; color: red; padding: 20px;">L·ªói t·∫£i tin nh·∫Øn!</div>'; });
    } else {
        console.error("Messages container element not found!");
    }

    // 7. G√°n l·∫°i s·ª± ki·ªán cho n√∫t ch·ªçn ·∫£nh (Gi·ªØ nguy√™n)
    if (imageInput) {
        imageInput.onchange = handleImageSelection;
    }
}

// --- PH·∫¶N 7: RENDER TIN NH·∫ÆN & G·ª¨I TIN NH·∫ÆN ---

/**
 * Render m·ªôt tin nh·∫Øn l√™n giao di·ªán ho·∫∑c c·∫≠p nh·∫≠t tin nh·∫Øn ƒë√£ c√≥.
 * @param {string} key ID c·ªßa tin nh·∫Øn.
 * @param {object} m D·ªØ li·ªáu tin nh·∫Øn t·ª´ Firebase.
 * @param {object} chatCtx Th√¥ng tin v·ªÅ cu·ªôc tr√≤ chuy·ªán hi·ªán t·∫°i {id, type}.
 */
function renderMessage(key, m, chatCtx) {
    // 1. Ki·ªÉm tra ƒëi·ªÅu ki·ªán tho√°t s·ªõm (b·ªã ch·∫∑n, tin nh·∫Øn null)
    if (!currentUserData || currentUserData.blocked?.includes(m?.senderId)) return;
    if (!m) {
        const elToRemove = document.querySelector(`.msg-wrapper[data-key="${key}"]`);
        if (elToRemove) elToRemove.remove();
        return;
    }

    const isSent = m.senderId === currentUser.uid;

    // 2. C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ tab n·∫øu c√≥ tin nh·∫Øn m·ªõi khi tab ·∫©n
    if (!isSent && document.hidden) {
        unreadCount++;
        document.title = `(${unreadCount}) ${originalTitle}`;
    }

    // 3. L·∫•y ho·∫∑c t·∫°o element .msg-wrapper
    let existingEl = document.querySelector(`.msg-wrapper[data-key="${key}"]`);
    const isNewMessage = !existingEl;
    if (isNewMessage) {
        existingEl = document.createElement('div');
        existingEl.className = 'msg-wrapper';
        existingEl.dataset.key = key;
    }

    // 4. Ki·ªÉm tra mention v√† th√™m class highlight
    let isMentioned = m.mentions?.includes(currentUser.uid) || m.mentions?.includes('all');
    existingEl.classList.toggle('mentioned-me', isMentioned);

    // 5. Render d·∫£i ph√¢n c√°ch ng√†y (ch·ªâ khi l√† tin m·ªõi)
    if (isNewMessage && m.timestamp && messagesContainer) {
        const messageDate = new Date(m.timestamp).toLocaleDateString('vi-VN');
        if (messageDate !== lastMessageDate) {
            const separator = document.createElement('div');
            separator.className = 'message-date-separator';
            separator.textContent = (messageDate === new Date().toLocaleDateString('vi-VN')) ? 'H√¥m nay' : messageDate;
            // Ch√®n v√†o tr∆∞·ªõc existingEl n·∫øu n√≥ ƒë√£ c√≥ trong DOM, ng∆∞·ª£c l·∫°i append
            if (existingEl.parentNode === messagesContainer) {
                messagesContainer.insertBefore(separator, existingEl);
            } else {
                messagesContainer.appendChild(separator); // L·∫ßn ƒë·∫ßu
            }
            lastMessageDate = messageDate;
        }
    }

    // 6. G·∫Øn element v√†o giao di·ªán (n·∫øu l√† tin m·ªõi)
    if (isNewMessage && messagesContainer) {
        messagesContainer.appendChild(existingEl);
    }

    // 7. T·∫°o HTML cho n·ªôi dung tin nh·∫Øn
    existingEl.classList.toggle('sent', isSent);
    existingEl.classList.toggle('received', !isSent);

    // -- Avatar --
    let avatarHtml = '';
    if (!isSent) {
        let avatarUrl = ''; let senderUid = '';
        if (chatCtx.type === 'direct' && currentChatPeerData) {
            avatarUrl = currentChatPeerData.avatarUrl || `https://placehold.co/32x32/EFEFEF/333?text=${(currentChatPeerData.displayName || '?')[0]}`;
            senderUid = currentChatPeerData.uid;
        } else if (chatCtx.type === 'group') {
            const member = currentGroupMembers.find(mem => mem.uid === m.senderId) || userCache[m.senderId]; // Fallback to cache
            avatarUrl = member?.avatarUrl || `https://placehold.co/32x32/1e293b/fff?text=${m.senderName ? m.senderName[0].toUpperCase() : '?'}`;
            senderUid = m.senderId;
        }
        if (avatarUrl) avatarHtml = `<img src="${avatarUrl}" class="msg-avatar" data-uid="${senderUid}" alt="Avatar">`;
    }

    // -- T√™n ng∆∞·ªùi g·ª≠i (group chat) --
    let senderNameHtml = '';
    if (!isSent && chatCtx.type === 'group') {
        senderNameHtml = `<div class="msg-sender-name">${escapeHtml(m.senderName) || '...'}</div>`;
    }

    // -- Bong b√≥ng chat --
    let msgBubbleHtml = '';
    if (m.recalled) {
        msgBubbleHtml = `<div class="msg recalled-message">Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi</div>`;
    } else {
        let content = `<div class="msg ${isSent ? 'sent' : ''}" data-sender-name="${escapeHtml(m.senderName || '')}">`; // L∆∞u t√™n ƒë·ªÉ reply

        // Quote tr·∫£ l·ªùi
        if (m.replyTo) {
            const repliedWrapper = document.querySelector(`.msg-wrapper[data-key="${m.replyTo}"]`);
            if (repliedWrapper) {
                const repliedEl = repliedWrapper.querySelector('.msg');
                if (repliedEl && !repliedEl.classList.contains('recalled-message')) {
                    const origSender = repliedEl.dataset.senderName || '...';
                    const origText = repliedEl.querySelector('.msg-text')?.textContent || (repliedEl.querySelector('img') ? '·∫¢nh' : '...');
                    content += `<div class="reply-quote"><div class="sender">Tr·∫£ l·ªùi ${escapeHtml(origSender)}</div><div class="text">${escapeHtml(origText)}</div></div>`;
                } else content += `<div class="reply-quote"><div class="sender">Tr·∫£ l·ªùi tin nh·∫Øn ƒë√£ thu h·ªìi</div></div>`;
            } else {
                 content += `<div class="reply-quote"><div class="sender">Tr·∫£ l·ªùi tin nh·∫Øn kh√¥ng c√≤n t·ªìn t·∫°i</div></div>`; // Fallback n·∫øu kh√¥ng t√¨m th·∫•y tin nh·∫Øn g·ªëc
            }
        }

        // Text v√† mention
        // Text, mention, v√† LINK
        let msgTextHtml = '';
        if (m.text) {
            let escaped = escapeHtml(m.text); // 1. Escape HTML tr∆∞·ªõc

            // 2. X·ª≠ l√Ω mentions (nh∆∞ c≈©)
            if (m.mentions && chatCtx.type === 'group') {
                const membersSorted = [...currentGroupMembers, ...(Object.values(userCache))].sort((a, b) => (b.displayName || '').length - (a.displayName || '').length);
                escaped = escaped.replace(/@all/g, '<span class="mention">@all</span>');
                membersSorted.forEach(mem => {
                    if (!mem || !mem.displayName) return;
                    const escName = escapeHtml(`@${mem.displayName}`);
                    const rgx = new RegExp(`(?<![\\w.-])(${escName.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})(?![\\w.-])`, 'g');
                    if (m.mentions.includes(mem.uid)) {
                       escaped = escaped.replace(rgx, `<span class="mention">@${mem.displayName}</span>`);
                    }
                });
            }

            // 3. T√åM V√Ä THAY TH·∫æ LINK (ƒêO·∫†N M·ªöI)
            // Regex ƒë·ªÉ t√¨m URL (kh√° c∆° b·∫£n, c√≥ th·ªÉ c·∫£i thi·ªán n·∫øu c·∫ßn)
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            let processedText = escaped.replace(urlRegex, function(url) {
                let displayUrl = url;
                let fullUrl = url;
                // N·∫øu link b·∫Øt ƒë·∫ßu b·∫±ng www. th√¨ th√™m http:// v√†o href
                if (!url.match(/^[a-zA-Z]+:\/\//)) {
                    fullUrl = 'http://' + url;
                }
                // T·∫°o th·∫ª <a>
                return `<a href="${escapeHtml(fullUrl)}" target="_blank" class="message-link">${escapeHtml(displayUrl)}</a>`;
            });

            // 4. G√°n HTML cu·ªëi c√πng
            msgTextHtml = `<div class="msg-text">${processedText}</div>`; // Thay escaped b·∫±ng processedText
        }
        content += msgTextHtml;

        // ·∫¢nh
        if (m.imageUrl) content += `<img src="${m.imageUrl}" alt="·∫¢nh ƒë√£ g·ª≠i"/>`;

        // Timestamp & Edited
        if (m.timestamp) {
            const d = new Date(m.timestamp);
            const hm = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            const edited = m.edited ? `<span class="edited-label">(s·ª≠a)</span>` : '';
            content += `<div class="msg-meta">${hm}${edited}</div>`;
        }

        // Tr·∫°ng th√°i ƒê√£ g·ª≠i/ƒê√£ xem
        if (isSent) {
            let status = 'ƒê√£ g·ª≠i';
            if (chatCtx.type === 'direct') {
                const peerUid = chatCtx.id.split('_').find(id => id !== currentUser.uid);
                if (m.readBy?.[peerUid]) status = 'ƒê√£ xem';
            } else if (m.readBy && Object.keys(m.readBy).length > 1) { // Group: xem b·ªüi > 1 ng∆∞·ªùi (l√† m√¨nh)
                status = 'ƒê√£ xem';
            }
            content += `<div class="msg-status">${status}</div>`;
        }
        content += `</div>`; // ƒê√≥ng th·∫ª div.msg
        msgBubbleHtml = content;
    }

    // 8. GH√âP HTML HO√ÄN CH·ªàNH
    existingEl.innerHTML = `
        ${avatarHtml}
        <div class="msg-content-wrapper">
            ${senderNameHtml}
            ${msgBubbleHtml}
            </div>
    `; // Ch√∫ √Ω: B·ªè reaction-picker kh·ªèi ƒë√¢y

    // 9. RENDER REACTION PICKER & DISPLAY (Lu√¥n t·∫°o m·ªõi/c·∫≠p nh·∫≠t)
    let picker = existingEl.querySelector('.reaction-picker');
    const msgContentWrapper = existingEl.querySelector('.msg-content-wrapper'); // Kh·ªëi ch·ª©a bubble chat

    if (!m.recalled && msgContentWrapper) { // Ch·ªâ th√™m picker n·∫øu ch∆∞a thu h·ªìi
        if (!picker) {
            picker = createReactionPicker(key); // T·∫°o picker
            msgContentWrapper.appendChild(picker); // G·∫Øn v√†o wrapper
        }
        // C·∫≠p nh·∫≠t l·∫°i v·ªã tr√≠ picker n·∫øu c·∫ßn (sent/received)
        picker.style.top = '-45px'; // Reset v·ªã tr√≠ top
        if (isSent) { picker.style.right = '10px'; picker.style.left = 'auto'; }
        else { picker.style.left = '10px'; picker.style.right = 'auto'; }

        // Render Reactions Display
        const reactions = m.reactions || {};
        let reactionsDisplay = existingEl.querySelector('.reactions-display');
        if (Object.keys(reactions).length > 0) {
            if (!reactionsDisplay) {
                reactionsDisplay = document.createElement('div');
                reactionsDisplay.className = 'reactions-display';
                msgContentWrapper.appendChild(reactionsDisplay);
            }
            let reactionsHTML = '';
            for (const emoji in reactions) {
                let count = (emoji === '‚ù§Ô∏è') ? Object.values(reactions[emoji]).reduce((s, v) => s + (typeof v === 'number' ? v : 1), 0) : Object.keys(reactions[emoji]).length;
                if (count > 0) reactionsHTML += `<span>${emoji} ${count}</span>`;
            }
            reactionsDisplay.innerHTML = reactionsHTML;
            reactionsDisplay.onclick = (e) => { e.stopPropagation(); showReactionsDetails(key); };
             // C·∫≠p nh·∫≠t v·ªã tr√≠ display
            if (isSent) { reactionsDisplay.style.right = '10px'; reactionsDisplay.style.left = 'auto'; }
            else { reactionsDisplay.style.left = '0px'; reactionsDisplay.style.right = 'auto'; }

        } else if (reactionsDisplay) {
            reactionsDisplay.remove(); // X√≥a display n·∫øu kh√¥ng c√≤n reaction
        }
    } else { // N·∫øu b·ªã thu h·ªìi
         if (picker) picker.remove(); // X√≥a picker
         let reactionsDisplay = existingEl.querySelector('.reactions-display');
         if (reactionsDisplay) reactionsDisplay.remove(); // X√≥a display
    }

    // 10. G√ÅN L·∫†I C√ÅC S·ª∞ KI·ªÜN KH√ÅC
    const imageInMessage = existingEl.querySelector('.msg img');
    if (imageInMessage) imageInMessage.onclick = () => openLightbox(imageInMessage.src);
    const avatarInMessage = existingEl.querySelector('.msg-avatar');
    if (avatarInMessage?.dataset.uid) avatarInMessage.onclick = () => window.open(`profile.html?id=${avatarInMessage.dataset.uid}`, '_blank');
    existingEl.onclick = () => { // X·ª≠ l√Ω ch·ªçn tin nh·∫Øn b·∫±ng ch·ª©ng
        if (messagesContainer?.classList.contains('selection-mode')) {
            const messageData = { key, ...m };
            const index = selectedEvidence.findIndex(e => e.key === key);
            if (index > -1) { selectedEvidence.splice(index, 1); existingEl.classList.remove('selected'); }
            else { selectedEvidence.push(messageData); existingEl.classList.add('selected'); }
            updateSelectionCount();
        }
    };

    // 11. C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI "ƒê√É ƒê·ªåC"
    if (!isSent && (!m.readBy || !m.readBy[currentUser.uid])) {
        rtdbUpdate(ref(rtdb, `/messages/${chatCtx.id}/${key}/readBy`), { [currentUser.uid]: true });
    }

    // 12. T·ª∞ ƒê·ªòNG CU·ªòN XU·ªêNG D∆Ø·ªöI
    if (messagesContainer) { // Check messagesContainer t·ªìn t·∫°i
        const shouldScroll = messagesContainer.scrollHeight - messagesContainer.scrollTop < messagesContainer.clientHeight + 150 || isSent || isNewMessage;
        if (shouldScroll) {
            setTimeout(() => { messagesContainer.scrollTop = messagesContainer.scrollHeight; }, 50);
        }
    }
}

async function sendMessage() {
    const text = messageInput ? messageInput.value.trim() : '';
    // Tho√°t n·∫øu kh√¥ng c√≥ g√¨ ƒë·ªÉ g·ª≠i/l∆∞u HO·∫∂C ƒëang loading
    if (!currentChatId || (!text && !selectedImageFile && !isEditing) || (sendBtn && sendBtn.classList.contains('loading'))) {
        return;
    }

    // --- B·∫Øt ƒë·∫ßu Loading ---
    if (sendBtn) { sendBtn.classList.add('loading'); sendBtn.disabled = true; }
    if (messageInput) messageInput.disabled = true;

    try {
        let imageUrl = null;
        // Upload ·∫£nh (ch·ªâ khi g·ª≠i m·ªõi)
        if (selectedImageFile && !isEditing) {
            imageUrl = await uploadImage(selectedImageFile);
        }

        // --- Logic S·ª≠a Tin Nh·∫Øn ---
        if (isEditing && editingMessageKey) {
            const msgRef = ref(rtdb, `/messages/${currentChatId}/${editingMessageKey}`);
            // D·ªØ li·ªáu c·∫ßn c·∫≠p nh·∫≠t khi s·ª≠a
            const updateData = {
                text: text || null, // C·∫≠p nh·∫≠t text m·ªõi (ho·∫∑c null n·∫øu x√≥a h·∫øt)
                edited: true,       // ƒê√°nh d·∫•u ƒë√£ s·ª≠a
                timestamp: dbServerTimestamp() // C·∫≠p nh·∫≠t timestamp server
                // Kh√¥ng c·∫≠p nh·∫≠t sender, imageUrl, replyTo, mentions khi s·ª≠a
            };
            await rtdbUpdate(msgRef, updateData); // G·ª≠i l·ªánh c·∫≠p nh·∫≠t
            console.log(`Message ${editingMessageKey} edited.`);
            cancelEdit(); // Reset tr·∫°ng th√°i s·ª≠a sau khi th√†nh c√¥ng

        // --- Logic G·ª≠i Tin Nh·∫Øn M·ªõi ---
        } else {
            // X·ª≠ l√Ω mentions (ch·ªâ khi g·ª≠i m·ªõi v√† l√† group)
            let mentions = [];
            if (currentChatType === 'group' && text) {
                const mentionRegex = /@(\S+)/g; let match;
                while ((match = mentionRegex.exec(text)) !== null) {
                    const username = match[1];
                    if (username === 'all') { if (!mentions.includes('all')) mentions.push('all'); }
                    else {
                        // T√¨m th√†nh vi√™n kh·ªõp t√™n (∆∞u ti√™n cache)
                        const mentionedMember = currentGroupMembers.find(m => m.displayName === username) || Object.values(userCache).find(u => u.displayName === username);
                        if (mentionedMember && !mentions.includes(mentionedMember.uid)) mentions.push(mentionedMember.uid);
                    }
                }
            }

            // T·∫°o payload cho tin nh·∫Øn m·ªõi (KH√îNG c√≥ tr∆∞·ªùng 'edited')
            const newMsgPayload = {
                senderId: currentUser.uid,
                senderName: currentUserData.displayName || currentUser.email.split('@')[0],
                text: text || null,
                imageUrl: imageUrl, // L√† URL ho·∫∑c null
                timestamp: Date.now(), // D√πng client timestamp ban ƒë·∫ßu cho tin m·ªõi
                readBy: { [currentUser.uid]: true },
                replyTo: replyingTo ? replyingTo.key : null,
                mentions: mentions.length > 0 ? mentions : null
            };

            // T·∫°o key m·ªõi v√† chu·∫©n b·ªã batch update (tin nh·∫Øn + notification)
            const newMsgRef = push(ref(rtdb, `/messages/${currentChatId}`));
            const newMsgKey = newMsgRef.key;
            const updates = {};
            updates[`/messages/${currentChatId}/${newMsgKey}`] = newMsgPayload;

            // T·∫°o payload notification
            const notifPayload = {
                from: newMsgPayload.senderName, avatar: currentUserData.avatarUrl,
                preview: newMsgPayload.text || "ƒê√£ g·ª≠i m·ªôt ·∫£nh", chatId: currentChatId,
                chatType: currentChatType, senderId: currentUser.uid,
            };

            // X√°c ƒë·ªãnh ng∆∞·ªùi nh·∫≠n notification v√† th√™m v√†o batch updates (logic check mute gi·ªØ nguy√™n)
            if (currentChatType === 'direct') {
                const recipientId = currentFriendUid;
                if (recipientId) {
                    const recipientDoc = await getDoc(doc(db, 'users', recipientId));
                    const recipientData = recipientDoc.exists() ? recipientDoc.data() : {};
                    if (!recipientData.mutedChats?.[currentChatId]) {
                        updates[`/notifications/${recipientId}/${newMsgKey}`] = notifPayload;
                    }
                }
            } else if (currentChatType === 'group') {
                const groupRef = doc(db, 'groups', currentChatId);
                const groupDoc = await getDoc(groupRef);
                const memberUids = groupDoc.exists() ? groupDoc.data().member_uids || [] : [];
                for (const recipientId of memberUids) {
                    if (recipientId === currentUser.uid) continue;
                    const recipientDoc = await getDoc(doc(db, 'users', recipientId));
                    const recipientData = recipientDoc.exists() ? recipientDoc.data() : {};
                    if (!recipientData.mutedChats?.[currentChatId]) {
                        updates[`/notifications/${recipientId}/${newMsgKey}`] = notifPayload;
                    }
                }
            }

            // G·ª≠i batch update l√™n Firebase
            if (Object.keys(updates).length > 0) {
                await rtdbUpdate(ref(rtdb), updates);
                console.log(`New message ${newMsgKey} sent.`);
            }

            // D·ªçn d·∫πp UI sau khi g·ª≠i m·ªõi th√†nh c√¥ng
            if (messageInput) messageInput.value = '';
            if (chatInputContainer) chatInputContainer.classList.remove('has-text');
            cancelImagePreview();
            cancelReply();
            clearTimeout(typingTimer); // D·ª´ng timer typing
            set(ref(rtdb, `/typing/${currentChatId}/${currentUser.uid}`), false); // Set typing l√† false
        }

    } catch (e) {
        console.error("L·ªói khi g·ª≠i/s·ª≠a tin nh·∫Øn:", e);
        showToast(`G·ª≠i tin nh·∫Øn th·∫•t b·∫°i: ${e.message}`, 'error');
    } finally {
        // --- K·∫øt th√∫c Loading ---
        if (sendBtn) { sendBtn.classList.remove('loading'); sendBtn.disabled = false; }
        if (messageInput) {
             messageInput.disabled = false;
             // Ch·ªâ focus n·∫øu chat c√≤n m·ªü v√† kh√¥ng ph·∫£i ƒëang s·ª≠a (v√¨ cancelEdit ƒë√£ x√≥a input)
             if (currentChatId && !isEditing) {
                  // setTimeout(() => messageInput.focus(), 0); // C√≥ th·ªÉ b·ªè focus t·ª± ƒë·ªông
             }
        }
        // G·ªçi l·∫°i handleTextInput ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t g·ª≠i ph√≤ng tr∆∞·ªùng h·ª£p input c√≤n ch·ªØ sau l·ªói
         handleTextInput();
    }
}

/**
 * X·ª≠ l√Ω khi ng∆∞·ªùi d√πng t·ª´ ch·ªëi l·ªùi m·ªùi k·∫øt b·∫°n.
 * C·∫≠p nh·∫≠t tr·∫°ng th√°i l·ªùi m·ªùi th√†nh 'declined'.
 * @param {string} reqId ID c·ªßa document l·ªùi m·ªùi k·∫øt b·∫°n.
 */
async function handleRejectFriend(reqId) {
    if (!reqId) return; // Ki·ªÉm tra reqId
    const reqRef = doc(db, 'friend_requests', reqId);

    try {
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i l·ªùi m·ªùi th√†nh 'declined'
        await updateDoc(reqRef, { status: 'declined' });
        showToast('‚ùå ƒê√£ t·ª´ ch·ªëi l·ªùi m·ªùi.');
        // Danh s√°ch l·ªùi m·ªùi s·∫Ω t·ª± c·∫≠p nh·∫≠t nh·ªù onSnapshot trong loadFriendRequests
        // ƒê√≥ng modal l·ªùi m·ªùi n·∫øu ƒëang m·ªü
        if (friendReqModal) friendReqModal.style.display = 'none';

    } catch (error) {
        console.error("L·ªói khi t·ª´ ch·ªëi l·ªùi m·ªùi:", error);
        showToast("C√≥ l·ªói x·∫£y ra khi t·ª´ ch·ªëi l·ªùi m·ªùi.", "error");
    }
}

/**
 * X·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch·∫•p nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n.
 * C·∫≠p nh·∫≠t tr·∫°ng th√°i l·ªùi m·ªùi th√†nh 'accepted' v√† th√™m b·∫°n b√® cho c·∫£ hai ng∆∞·ªùi.
 * @param {string} reqId ID c·ªßa document l·ªùi m·ªùi k·∫øt b·∫°n.
 * @param {string} fromUid UID c·ªßa ng∆∞·ªùi g·ª≠i l·ªùi m·ªùi.
 */
async function handleAcceptFriend(reqId, fromUid) {
    if (!reqId || !fromUid || !currentUser) return; // Ki·ªÉm tra d·ªØ li·ªáu
    const reqRef = doc(db, 'friend_requests', reqId);
    const currentUserRef = doc(db, 'users', currentUser.uid);
    const senderUserRef = doc(db, 'users', fromUid);

    try {
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i l·ªùi m·ªùi
        await updateDoc(reqRef, { status: 'accepted' });

        // Th√™m b·∫°n b√® cho c·∫£ hai ng∆∞·ªùi (d√πng arrayUnion ƒë·ªÉ tr√°nh tr√πng l·∫∑p)
        await updateDoc(currentUserRef, { friends: arrayUnion(fromUid) });
        await updateDoc(senderUserRef, { friends: arrayUnion(currentUser.uid) });

        showToast('‚úÖ ƒê√£ ch·∫•p nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n!', 'success');
        // Danh s√°ch l·ªùi m·ªùi s·∫Ω t·ª± c·∫≠p nh·∫≠t nh·ªù onSnapshot trong loadFriendRequests
        // Danh s√°ch chat c≈©ng s·∫Ω t·ª± c·∫≠p nh·∫≠t nh·ªù listener user trong loadAndSortChats
        // ƒê√≥ng modal l·ªùi m·ªùi n·∫øu ƒëang m·ªü
        if (friendReqModal) friendReqModal.style.display = 'none';

    } catch (error) {
        console.error("L·ªói khi ch·∫•p nh·∫≠n l·ªùi m·ªùi:", error);
        showToast("C√≥ l·ªói x·∫£y ra khi ch·∫•p nh·∫≠n l·ªùi m·ªùi.", "error");
    }
}

/**
 * Upload ·∫£nh l√™n ImgBB.
 * @param {File} file File ·∫£nh c·∫ßn upload.
 * @returns {Promise<string>} Promise tr·∫£ v·ªÅ URL c·ªßa ·∫£nh ƒë√£ upload.
 * @throws {Error} N·∫øu thi·∫øu API key ho·∫∑c upload th·∫•t b·∫°i.
 */
async function uploadImage(file){
    if(!IMGBB_API_KEY) throw new Error('Thi·∫øu API Key ImgBB');
    const fd = new FormData();
    fd.append('image', file);
    try {
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:'POST', body:fd});
        const data = await res.json();
        if(data.success) {
            console.log("Image uploaded:", data.data.url);
            return data.data.url; // Tr·∫£ v·ªÅ URL ·∫£nh
        } else {
            throw new Error(data.error?.message || 'Upload ·∫£nh th·∫•t b·∫°i kh√¥ng r√µ l√Ω do.');
        }
    } catch (error) {
         console.error("ImgBB Upload Error:", error);
         throw new Error('Kh√¥ng th·ªÉ upload ·∫£nh: ' + error.message); // N√©m l·ªói ƒë·ªÉ h√†m sendMessage x·ª≠ l√Ω
    }
}

// --- PH·∫¶N 8: T∆Ø∆†NG T√ÅC TIN NH·∫ÆN (MENU, RECALL, DELETE, REPLY, EDIT, PREVIEW) ---

/**
 * Hi·ªÉn th·ªã menu chu·ªôt ph·∫£i cho tin nh·∫Øn.
 * @param {MouseEvent} e S·ª± ki·ªán chu·ªôt ph·∫£i.
 */
function showMessageContextMenu(e) {
    const wrapper = e.target.closest('.msg-wrapper'); // T√¨m element .msg-wrapper g·∫ßn nh·∫•t
    if (!wrapper || !wrapper.dataset.key || !messageContextMenu) return; // Tho√°t n·∫øu kh√¥ng ph·∫£i tin nh·∫Øn ho·∫∑c thi·∫øu menu

    e.preventDefault(); // NgƒÉn menu m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát
    const msgKey = wrapper.dataset.key;
    const msgRef = ref(rtdb, `/messages/${currentChatId}/${msgKey}`);

    // L·∫•y d·ªØ li·ªáu tin nh·∫Øn m·ªõi nh·∫•t ƒë·ªÉ t·∫°o menu ch√≠nh x√°c
    get(msgRef).then(snap => {
        if (!snap.exists()) return; // Tin nh·∫Øn ƒë√£ b·ªã x√≥a kh·ªèi DB
        const msg = snap.val();
        messageContextMenu.innerHTML = ''; // X√≥a c√°c n√∫t c≈©

        // --- N√∫t Tr·∫£ l·ªùi (lu√¥n c√≥ n·∫øu tin nh·∫Øn ch∆∞a b·ªã thu h·ªìi) ---
        if (!msg.recalled) {
            const btnReply = document.createElement('button');
            btnReply.className = 'context-menu-btn';
            btnReply.textContent = '‚Ü™Ô∏è Tr·∫£ l·ªùi';
            btnReply.onclick = () => {
                replyToMessage(msgKey, msg);
                messageContextMenu.style.display = 'none'; // ·∫®n menu sau khi ch·ªçn
            };
            messageContextMenu.appendChild(btnReply);
        }

        // --- C√°c n√∫t ch·ªâ d√†nh cho ng∆∞·ªùi g·ª≠i ---
        if (msg.senderId === currentUser.uid) {
            // N√∫t Ch·ªânh s·ª≠a (ch·ªâ cho tin nh·∫Øn text ch∆∞a thu h·ªìi)
            if (msg.text && !msg.recalled) {
                const btnEdit = document.createElement('button');
                btnEdit.className = 'context-menu-btn';
                btnEdit.textContent = '‚úèÔ∏è Ch·ªânh s·ª≠a';
                btnEdit.onclick = () => {
                    startEditMessage(msgKey, msg);
                    messageContextMenu.style.display = 'none';
                };
                messageContextMenu.appendChild(btnEdit);
            }
            // N√∫t Thu h·ªìi (ch·ªâ trong 3 ph√∫t ƒë·∫ßu v√† ch∆∞a thu h·ªìi)
            const timeSinceSent = Date.now() - msg.timestamp;
            if (timeSinceSent < 3 * 60 * 1000 && !msg.recalled) {
                const btnRecall = document.createElement('button');
                btnRecall.className = 'context-menu-btn danger'; // M√†u ƒë·ªè c·∫£nh b√°o
                btnRecall.textContent = 'üóëÔ∏è Thu h·ªìi';
                btnRecall.onclick = () => {
                    recallMessage(msgKey);
                    messageContextMenu.style.display = 'none';
                };
                messageContextMenu.appendChild(btnRecall);
            }
        }

        // --- N√∫t X√≥a ·ªü ph√≠a b·∫°n (lu√¥n c√≥) ---
        const btnDelete = document.createElement('button');
        btnDelete.className = 'context-menu-btn danger';
        btnDelete.textContent = '‚ùå X√≥a ·ªü ph√≠a b·∫°n';
        btnDelete.onclick = () => {
            deleteMessageForSelf(msgKey);
            messageContextMenu.style.display = 'none';
        };
        messageContextMenu.appendChild(btnDelete);

        // Hi·ªÉn th·ªã menu t·∫°i v·ªã tr√≠ chu·ªôt
        if (messageContextMenu.hasChildNodes()) { // Ch·ªâ hi·ªán n·∫øu c√≥ √≠t nh·∫•t 1 n√∫t
             messageContextMenu.style.display = 'block';
             // T√≠nh to√°n v·ªã tr√≠ ƒë·ªÉ kh√¥ng b·ªã tr√†n m√†n h√¨nh (ƒë∆°n gi·∫£n)
             const menuWidth = messageContextMenu.offsetWidth;
             const menuHeight = messageContextMenu.offsetHeight;
             let left = e.pageX;
             let top = e.pageY;
             if (left + menuWidth > window.innerWidth - 10) { left = window.innerWidth - menuWidth - 10; }
             if (top + menuHeight > window.innerHeight - 10) { top = window.innerHeight - menuHeight - 10; }
             messageContextMenu.style.left = `${left}px`;
             messageContextMenu.style.top = `${top}px`;
        }

    }).catch(error => console.error("Error getting message for context menu:", error));
}

/**
 * Thu h·ªìi m·ªôt tin nh·∫Øn (ch·ªâ ng∆∞·ªùi g·ª≠i l√†m ƒë∆∞·ª£c).
 * C·∫≠p nh·∫≠t tr·∫°ng th√°i 'recalled' v√† x√≥a n·ªôi dung/·∫£nh/reply/reactions.
 * @param {string} key ID c·ªßa tin nh·∫Øn c·∫ßn thu h·ªìi.
 */
function recallMessage(key) {
    if (!currentChatId || !key) return;
    const msgRef = ref(rtdb, `/messages/${currentChatId}/${key}`);
    // C·∫≠p nh·∫≠t nhi·ªÅu tr∆∞·ªùng c√πng l√∫c
    rtdbUpdate(msgRef, {
        text: null,
        imageUrl: null,
        recalled: true,
        replyTo: null,
        reactions: null, // X√≥a reactions khi thu h·ªìi
        edited: deleteField() // X√≥a tr·∫°ng th√°i edited n·∫øu c√≥
    }).catch(error => {
        console.error("Error recalling message:", error);
        showToast("Thu h·ªìi th·∫•t b·∫°i!", "error");
    });
}

/**
 * X√≥a m·ªôt tin nh·∫Øn ch·ªâ ·ªü ph√≠a ng∆∞·ªùi d√πng hi·ªán t·∫°i (kh·ªèi giao di·ªán).
 * @param {string} key ID c·ªßa tin nh·∫Øn c·∫ßn x√≥a.
 */
function deleteMessageForSelf(key) {
    const elementToRemove = document.querySelector(`.msg-wrapper[data-key="${key}"]`);
    if (elementToRemove) {
        elementToRemove.remove(); // X√≥a kh·ªèi DOM
        showToast("ƒê√£ x√≥a tin nh·∫Øn ·ªü ph√≠a b·∫°n.", "info");
    }
}

/**
 * B·∫Øt ƒë·∫ßu tr·∫°ng th√°i tr·∫£ l·ªùi tin nh·∫Øn.
 * Hi·ªÉn th·ªã thanh preview v√† l∆∞u th√¥ng tin tin nh·∫Øn g·ªëc.
 * @param {string} key ID c·ªßa tin nh·∫Øn ƒë∆∞·ª£c tr·∫£ l·ªùi.
 * @param {object} message D·ªØ li·ªáu c·ªßa tin nh·∫Øn ƒë∆∞·ª£c tr·∫£ l·ªùi.
 */
function replyToMessage(key, message) {
    if (!replyPreviewContainer || !replyPreviewSender || !replyPreviewText || !messageInput) return;
    replyingTo = { key, message }; // L∆∞u l·∫°i th√¥ng tin
    replyPreviewContainer.style.display = 'block'; // Hi·ªán preview
    // Hi·ªÉn th·ªã t√™n ng∆∞·ªùi g·ª≠i g·ªëc (ho·∫∑c "ch√≠nh m√¨nh")
    replyPreviewSender.textContent = `ƒêang tr·∫£ l·ªùi ${message.senderId === currentUser.uid ? 'ch√≠nh m√¨nh' : message.senderName || '...'}`;
    // Hi·ªÉn th·ªã text ho·∫∑c "·∫¢nh"
    replyPreviewText.textContent = message.text || (message.imageUrl ? 'M·ªôt h√¨nh ·∫£nh' : '...');
    messageInput.focus(); // Focus v√†o √¥ nh·∫≠p li·ªáu
}

/**
 * H·ªßy tr·∫°ng th√°i tr·∫£ l·ªùi tin nh·∫Øn.
 * ·∫®n thanh preview v√† x√≥a th√¥ng tin ƒë√£ l∆∞u.
 */
function cancelReply() {
    replyingTo = null; // X√≥a th√¥ng tin
    if (replyPreviewContainer) replyPreviewContainer.style.display = 'none'; // ·∫®n preview
}

/**
 * B·∫Øt ƒë·∫ßu tr·∫°ng th√°i ch·ªânh s·ª≠a tin nh·∫Øn (ch·ªâ text).
 * Hi·ªÉn th·ªã thanh preview s·ª≠a, ƒëi·ªÅn text c≈© v√†o input, ƒë·ªïi n√∫t G·ª≠i th√†nh L∆∞u.
 * @param {string} key ID c·ªßa tin nh·∫Øn c·∫ßn s·ª≠a.
 * @param {object} message D·ªØ li·ªáu c·ªßa tin nh·∫Øn c·∫ßn s·ª≠a.
 */
function startEditMessage(key, message) {
    if (!editPreviewContainer || !editPreviewText || !messageInput || !sendBtn) return;
    if (replyingTo) cancelReply(); // H·ªßy reply n·∫øu ƒëang reply
    isEditing = true; // B·∫≠t c·ªù ƒëang s·ª≠a
    editingMessageKey = key; // L∆∞u key tin nh·∫Øn ƒëang s·ª≠a
    editPreviewText.textContent = message.text; // Hi·ªán text g·ªëc trong preview
    editPreviewContainer.style.display = 'block'; // Hi·ªán preview s·ª≠a
    messageInput.value = message.text; // ƒêi·ªÅn text c≈© v√†o input
    messageInput.focus(); // Focus input
    sendBtn.innerHTML = 'L∆∞u'; // ƒê·ªïi text n√∫t G·ª≠i
    // K√≠ch ho·∫°t n√∫t L∆∞u (v√¨ ƒë√£ c√≥ text)
    if (chatInputContainer) chatInputContainer.classList.add('has-text');
}

/**
 * H·ªßy tr·∫°ng th√°i ch·ªânh s·ª≠a tin nh·∫Øn.
 * ·∫®n thanh preview, x√≥a text trong input, ƒë·ªïi n√∫t L∆∞u th√†nh G·ª≠i.
 */
function cancelEdit() {
    isEditing = false;
    editingMessageKey = null;
    if (editPreviewContainer) editPreviewContainer.style.display = 'none';
    if (messageInput) messageInput.value = ''; // X√≥a input
    if (sendBtn) {
        // Tr·∫£ l·∫°i icon g·ª≠i (copy SVG t·ª´ HTML)
        sendBtn.innerHTML = `<svg class="send-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                           <svg class="spinner-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>`;
    }
    // H·ªßy k√≠ch ho·∫°t n√∫t g·ª≠i n·∫øu input r·ªóng
    if (messageInput && chatInputContainer) {
        chatInputContainer.classList.toggle('has-text', messageInput.value.trim().length > 0 || selectedImageFile != null);
    }
}

/**
 * H·ªßy vi·ªác xem tr∆∞·ªõc ·∫£nh s·∫Øp g·ª≠i.
 * ·∫®n preview, reset input file v√† bi·∫øn selectedImageFile.
 */
function cancelImagePreview(){
    selectedImageFile = null;
    if (imageInput) imageInput.value = ''; // Reset input file
    if (imagePreviewContainer) imagePreviewContainer.style.display = 'none';
    if (messageInput) messageInput.placeholder = 'Nh·∫≠p tin nh·∫Øn...';
    // H·ªßy k√≠ch ho·∫°t n√∫t g·ª≠i n·∫øu input text c≈©ng r·ªóng
    if (messageInput && chatInputContainer) {
        chatInputContainer.classList.toggle('has-text', messageInput.value.trim().length > 0);
    }
}
// --- PH·∫¶N 9: X·ª¨ L√ù REACTIONS ---

/**
 * T·∫°o element div ch·ª©a c√°c n√∫t reaction emoji.
 * @param {string} msgKey ID c·ªßa tin nh·∫Øn m√† picker n√†y g·∫Øn v√†o.
 * @returns {HTMLDivElement} Element reaction picker.
 */
function createReactionPicker(msgKey) {
    const picker = document.createElement('div');
    picker.className = 'reaction-picker';
    // Danh s√°ch emoji (c√≥ th·ªÉ t√πy ch·ªânh) + n√∫t h·ªßy 'üö´'
    ['‚ù§Ô∏è', 'üëç', 'üòÇ', 'üòÆ', 'üò¢', 'üò°', 'üö´'].forEach(emoji => {
        const btn = document.createElement('span');
        btn.className = 'reaction-btn';
        btn.textContent = emoji;
        // G·∫Øn s·ª± ki·ªán click ƒë·ªÉ g·ªçi h√†m reactToMessage
        btn.onclick = (e) => {
            e.stopPropagation(); // NgƒÉn s·ª± ki·ªán click lan ra msg-wrapper
            reactToMessage(msgKey, emoji);
             // T√πy ch·ªçn: ·∫®n picker ngay sau khi click
             // picker.style.opacity = '0';
             // picker.style.pointerEvents = 'none';
        };
        picker.appendChild(btn);
    });
    return picker;
}

/**
 * X·ª≠ l√Ω khi ng∆∞·ªùi d√πng th·∫£/h·ªßy th·∫£ reaction v√†o tin nh·∫Øn.
 * C·∫≠p nh·∫≠t d·ªØ li·ªáu reaction trong Realtime Database.
 * @param {string} msgKey ID c·ªßa tin nh·∫Øn ƒë∆∞·ª£c reaction.
 * @param {string} emoji Emoji ƒë∆∞·ª£c ch·ªçn ('üö´' ƒë·ªÉ h·ªßy).
 */
async function reactToMessage(msgKey, emoji) {
    if (!currentChatId || !msgKey || !currentUser) return; // Ki·ªÉm tra ƒëi·ªÅu ki·ªán c·∫ßn thi·∫øt

    // Ki·ªÉm tra xem tin nh·∫Øn c√≥ t·ªìn t·∫°i v√† ch∆∞a b·ªã thu h·ªìi kh√¥ng
    const checkMsgRef = ref(rtdb, `/messages/${currentChatId}/${msgKey}`);
    const msgSnapshot = await get(checkMsgRef); // L·∫•y data 1 l·∫ßn
    if (!msgSnapshot.exists() || msgSnapshot.val().recalled) {
        showToast("Kh√¥ng th·ªÉ th·∫£ c·∫£m x√∫c v√†o tin nh·∫Øn n√†y.", "success");
        return; // D·ª´ng n·∫øu tin nh·∫Øn kh√¥ng h·ª£p l·ªá
    }

    const pathBase = `/messages/${currentChatId}/${msgKey}/reactions`; // ƒê∆∞·ªùng d·∫´n g·ªëc t·ªõi reactions c·ªßa tin nh·∫Øn

    // X·ª≠ l√Ω n√∫t H·ªßy reaction 'üö´'
    if (emoji === 'üö´') {
        const reactionsRef = ref(rtdb, pathBase);
        get(reactionsRef).then(snap => { // L·∫•y data reactions 1 l·∫ßn
            if (snap.exists()) {
                const reactions = snap.val();
                // Duy·ªát qua t·∫•t c·∫£ emoji v√† x√≥a reaction c·ªßa user hi·ªán t·∫°i
                for (const existingEmoji in reactions) {
                    remove(ref(rtdb, `${pathBase}/${existingEmoji}/${currentUser.uid}`));
                }
                console.log(`Removed all reactions from user ${currentUser.uid} on msg ${msgKey}`);
            }
        }).catch(err => console.error("Error removing reactions:", err));
        return; // D·ª´ng h√†m sau khi x·ª≠ l√Ω h·ªßy
    }

    // X·ª≠ l√Ω c√°c emoji kh√°c
    const reactionRef = ref(rtdb, `${pathBase}/${emoji}/${currentUser.uid}`);

    // L·∫•y tr·∫°ng th√°i reaction hi·ªán t·∫°i c·ªßa user cho emoji n√†y
    get(reactionRef).then(snap => {
        if (emoji === '‚ù§Ô∏è') {
            // Tr√°i tim l√† b·ªô ƒë·∫øm -> TƒÉng l√™n 1
            const currentCount = snap.val() || 0; // L·∫•y count hi·ªán t·∫°i, m·∫∑c ƒë·ªãnh l√† 0
            set(reactionRef, currentCount + 1); // TƒÉng count l√™n 1
            console.log(`User ${currentUser.uid} added heart to msg ${msgKey}. New count: ${currentCount + 1}`);
        } else {
            // C√°c emoji kh√°c l√† c√¥ng t·∫Øc b·∫≠t/t·∫Øt
            if (snap.exists()) {
                remove(reactionRef); // N·∫øu ƒë√£ react -> H·ªßy reaction
                console.log(`User ${currentUser.uid} removed ${emoji} from msg ${msgKey}`);
            } else {
                set(reactionRef, true); // N·∫øu ch∆∞a react -> Th√™m reaction (gi√° tr·ªã true)
                console.log(`User ${currentUser.uid} added ${emoji} to msg ${msgKey}`);
            }
        }
    }).catch(err => console.error(`Error reacting with ${emoji}:`, err));
}

/**
 * Hi·ªÉn th·ªã modal chi ti·∫øt c√°c l∆∞·ª£t reaction cho m·ªôt tin nh·∫Øn.
 * @param {string} msgKey ID c·ªßa tin nh·∫Øn c·∫ßn xem chi ti·∫øt reactions.
 */
async function showReactionsDetails(msgKey) {
    // Ki·ªÉm tra c√°c element modal c·∫ßn thi·∫øt
    if (!reactionsModal || !reactionsList || !closeReactionsModal) {
        console.error("Missing reaction modal elements!");
        return;
    }

    // L·∫•y d·ªØ li·ªáu tin nh·∫Øn m·ªõi nh·∫•t
    const msgRef = ref(rtdb, `/messages/${currentChatId}/${msgKey}`);
    const snap = await get(msgRef); // L·∫•y data 1 l·∫ßn
    if (!snap.exists()) {
        showToast("Tin nh·∫Øn kh√¥ng c√≤n t·ªìn t·∫°i.", "error");
        return;
    }
    const msg = snap.val();
    const reactions = msg.reactions || {}; // L·∫•y reactions, m·∫∑c ƒë·ªãnh l√† object r·ªóng

    reactionsList.innerHTML = 'ƒêang t·∫£i th√¥ng tin ng∆∞·ªùi th·∫£...'; // Hi·ªÉn th·ªã loading
    reactionsModal.style.display = 'flex'; // Hi·ªán modal

    // Gom t·∫•t c·∫£ ng∆∞·ªùi th·∫£ v√† emoji/count v√†o m·ªôt m·∫£ng
    let allReactors = [];
    for (const [emoji, reactors] of Object.entries(reactions)) {
        for (const [uid, value] of Object.entries(reactors)) {
            // T√≠nh count (l√† value n·∫øu l√† ‚ù§Ô∏è, ng∆∞·ª£c l·∫°i l√† 1)
            const count = (emoji === '‚ù§Ô∏è' && typeof value === 'number') ? value : 1;
            allReactors.push({ uid, emoji, count });
        }
    }

    // S·∫Øp x·∫øp (v√≠ d·ª•: theo emoji tr∆∞·ªõc, r·ªìi ƒë·∫øn t√™n user) - T√πy ch·ªçn
    allReactors.sort((a, b) => a.emoji.localeCompare(b.emoji));

    if (allReactors.length === 0) {
        reactionsList.innerHTML = '<p style="color: var(--text-2); text-align: center;">Ch∆∞a c√≥ ai b√†y t·ªè c·∫£m x√∫c.</p>';
        return; // D·ª´ng n·∫øu kh√¥ng c√≥ ai th·∫£
    }

    // T·∫°o HTML cho danh s√°ch ng∆∞·ªùi th·∫£
    let html = '';
    // L·∫•y th√¥ng tin user (t√™n, avatar) cho t·ª´ng ng∆∞·ªùi th·∫£
    const userPromises = allReactors.map(reactor => getDoc(doc(db, 'users', reactor.uid)));
    const userDocs = await Promise.all(userPromises);

    allReactors.forEach((reactor, index) => {
        const userDoc = userDocs[index]; // L·∫•y userDoc t∆∞∆°ng ·ª©ng
        if (userDoc.exists()) {
            const userData = userDoc.data();
            const displayName = userData.displayName || userData.email || 'Ng∆∞·ªùi d√πng ·∫©n danh';
            const avatarUrl = userData.avatarUrl || `https://placehold.co/36x36?text=${displayName[0].toUpperCase()}`;
            const countDisplay = reactor.count > 1 ? ` ${reactor.count}` : ''; // Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng n·∫øu > 1 (cho tim)
            html += `
                <div class="reaction-user-item">
                    <div class="reaction-user-info">
                        <img class="reaction-user-avatar" src="${avatarUrl}" alt="Avatar">
                        <span class="reaction-user-name">${escapeHtml(displayName)}</span>
                    </div>
                    <span class="reaction-emoji">${reactor.emoji}${countDisplay}</span>
                </div>
            `;
        } else {
             // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p kh√¥ng t√¨m th·∫•y user (v√≠ d·ª•: user ƒë√£ x√≥a t√†i kho·∫£n)
             html += `
                <div class="reaction-user-item">
                    <div class="reaction-user-info">
                        <img class="reaction-user-avatar" src="https://placehold.co/36x36?text=?">
                        <span class="reaction-user-name" style="color: var(--text-2); font-style: italic;">Ng∆∞·ªùi d√πng kh√¥ng t·ªìn t·∫°i</span>
                    </div>
                    <span class="reaction-emoji">${reactor.emoji}${reactor.count > 1 ? ` ${reactor.count}` : ''}</span>
                </div>
            `;
        }
    });

    reactionsList.innerHTML = html; // C·∫≠p nh·∫≠t n·ªôi dung danh s√°ch
}

// G·∫Øn s·ª± ki·ªán ƒë√≥ng modal reactions (n·∫øu ch∆∞a c√≥ trong attachEventListeners)
if (closeReactionsModal) {
    closeReactionsModal.onclick = () => reactionsModal.style.display = 'none';
}
if (reactionsModal) { // ƒê√≥ng khi b·∫•m ra ngo√†i
     reactionsModal.onclick = (e) => { if (e.target === reactionsModal) reactionsModal.style.display = 'none'; };
}

// --- PH·∫¶N 10: X·ª¨ L√ù NH√ìM CHAT ---

/**
 * M·ªü modal t·∫°o nh√≥m m·ªõi v√† hi·ªÉn th·ªã danh s√°ch b·∫°n b√® ƒë·ªÉ m·ªùi.
 */
async function openCreateGroupModal() {
    // Ki·ªÉm tra c√°c element c·∫ßn thi·∫øt
    if (!createGroupModal || !groupMembersChecklist || !groupNameInput || !confirmCreateGroupBtn) {
        console.error("Missing elements for create group modal!");
        return;
    }

    groupMembersChecklist.innerHTML = '<p style="color: var(--text-2); text-align: center;">ƒêang t·∫£i danh s√°ch b·∫°n b√®...</p>'; // Hi·ªÉn th·ªã loading
    groupNameInput.value = ''; // Reset t√™n nh√≥m
    createGroupModal.style.display = 'flex'; // Hi·ªán modal

    // L·∫•y danh s√°ch b·∫°n b√® m·ªõi nh·∫•t t·ª´ Firestore (ho·∫∑c d√πng bi·∫øn `friends` ƒë√£ cache n·∫øu c√≥)
    const meDoc = await getDoc(doc(db, 'users', currentUser.uid));
    const friendUids = meDoc.data()?.friends || [];

    groupMembersChecklist.innerHTML = ''; // X√≥a loading/n·ªôi dung c≈©

    if (friendUids.length === 0) {
        groupMembersChecklist.innerHTML = '<p style="color: var(--text-2); text-align: center;">B·∫°n ch∆∞a c√≥ b·∫°n b√® ƒë·ªÉ m·ªùi v√†o nh√≥m.</p>';
        confirmCreateGroupBtn.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t t·∫°o n·∫øu kh√¥ng c√≥ ai ƒë·ªÉ m·ªùi
        return;
    } else {
         confirmCreateGroupBtn.disabled = false; // B·∫≠t l·∫°i n√∫t t·∫°o
    }

    // Hi·ªÉn th·ªã danh s√°ch b·∫°n b√® v·ªõi checkbox
    let friendCount = 0;
    for (const friendUid of friendUids) {
        // ∆Øu ti√™n l·∫•y data t·ª´ cache `friends` n·∫øu c√≥, kh√¥ng th√¨ query Firestore
        const friendData = friends.find(f => f.uid === friendUid);
        let displayName = 'Ng∆∞·ªùi d√πng ·∫©n';
        let avatarUrl = 'https://placehold.co/32x32?text=?';

        if (friendData) {
             displayName = friendData.displayName || friendData.email || 'Ng∆∞·ªùi d√πng ·∫©n';
             avatarUrl = friendData.avatarUrl || `https://placehold.co/32x32?text=${displayName[0].toUpperCase()}`;
             friendCount++;
        } else {
             // Fallback: Query Firestore n·∫øu kh√¥ng c√≥ trong cache (√≠t x·∫£y ra n·∫øu `loadAndSortChats` ch·∫°y ƒë√∫ng)
             try {
                  const friendDoc = await getDoc(doc(db, 'users', friendUid));
                  if (friendDoc.exists()) {
                       const fd = friendDoc.data();
                       displayName = fd.displayName || fd.email || 'Ng∆∞·ªùi d√πng ·∫©n';
                       avatarUrl = fd.avatarUrl || `https://placehold.co/32x32?text=${displayName[0].toUpperCase()}`;
                       friendCount++;
                  } else {
                       continue; // B·ªè qua n·∫øu user kh√¥ng t·ªìn t·∫°i
                  }
             } catch (err) {
                  console.error("Error fetching friend data for group modal:", friendUid, err);
                  continue; // B·ªè qua n·∫øu l·ªói
             }
        }


        // T·∫°o HTML cho m·ªói b·∫°n b√®
        const div = document.createElement('div');
        div.innerHTML = `
            <label style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s;">
                <input type="checkbox" class="group-member-checkbox" value="${friendUid}" style="width: 18px; height: 18px; flex-shrink: 0;">
                <img src="${avatarUrl}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(displayName)}</span>
            </label>`;
        const label = div.querySelector('label');
        // Th√™m hi·ªáu ·ª©ng hover ƒë∆°n gi·∫£n
        label.onmouseover = () => label.style.backgroundColor = 'var(--glass)';
        label.onmouseout = () => label.style.backgroundColor = 'transparent';
        groupMembersChecklist.appendChild(div);
    }
     // N·∫øu sau khi duy·ªát h·∫øt m√† kh√¥ng c√≥ b·∫°n b√® h·ª£p l·ªá n√†o
     if (friendCount === 0) {
          groupMembersChecklist.innerHTML = '<p style="color: var(--text-2); text-align: center;">Kh√¥ng t√¨m th·∫•y b·∫°n b√® h·ª£p l·ªá ƒë·ªÉ m·ªùi.</p>';
          confirmCreateGroupBtn.disabled = true;
     }
}

/**
 * X√°c nh·∫≠n t·∫°o nh√≥m m·ªõi sau khi ƒë√£ nh·∫≠p t√™n v√† ch·ªçn th√†nh vi√™n.
 */
async function confirmCreateGroup() {
    if (!groupNameInput || !groupMembersChecklist || !confirmCreateGroupBtn || !createGroupModal) return;

    const groupName = groupNameInput.value.trim();
    if (!groupName) {
        showToast('Vui l√≤ng nh·∫≠p t√™n nh√≥m.', 'error');
        return;
    }

    // L·∫•y UID c·ªßa c√°c th√†nh vi√™n ƒë∆∞·ª£c ch·ªçn
    const memberCheckboxes = groupMembersChecklist.querySelectorAll('.group-member-checkbox:checked');
    const invitedUids = Array.from(memberCheckboxes).map(cb => cb.value);

    // Bao g·ªìm c·∫£ ng∆∞·ªùi t·∫°o nh√≥m
    const memberUids = [currentUser.uid, ...invitedUids];

    // Nh√≥m ph·∫£i c√≥ √≠t nh·∫•t 2 ng∆∞·ªùi (t√≠nh c·∫£ ng∆∞·ªùi t·∫°o)
    if (memberUids.length < 2) {
        showToast('Nh√≥m ph·∫£i c√≥ √≠t nh·∫•t 2 th√†nh vi√™n.', 'error');
        return;
    }

    // T·∫°o object roles (ng∆∞·ªùi t·∫°o l√† admin, c√≤n l·∫°i l√† member)
    const roles = { [currentUser.uid]: 'admin' };
    invitedUids.forEach(uid => roles[uid] = 'member');

    confirmCreateGroupBtn.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t
    confirmCreateGroupBtn.textContent = 'ƒêang t·∫°o...';

    try {
        // Th√™m document nh√≥m m·ªõi v√†o Firestore
        const newGroupRef = await addDoc(collection(db, 'groups'), {
            groupName: groupName,
            member_uids: memberUids, // M·∫£ng UID th√†nh vi√™n
            roles: roles,            // Object vai tr√≤
            createdBy: currentUser.uid, // UID ng∆∞·ªùi t·∫°o
            createdAt: serverTimestamp(), // Th·ªùi gian t·∫°o
            // avatarUrl: null // C√≥ th·ªÉ th√™m avatar m·∫∑c ƒë·ªãnh n·∫øu mu·ªën
        });

        showToast(`ƒê√£ t·∫°o nh√≥m "${groupName}"!`, 'success');
        createGroupModal.style.display = 'none'; // ƒê√≥ng modal
        groupNameInput.value = ''; // Reset form

        // T√πy ch·ªçn: T·ª± ƒë·ªông m·ªü chat nh√≥m v·ª´a t·∫°o
        startGroupChat(newGroupRef.id, groupName);

    } catch (error) {
        console.error("L·ªói khi t·∫°o nh√≥m:", error);
        showToast("Kh√¥ng th·ªÉ t·∫°o nh√≥m: " + error.message, 'error');
    } finally {
        confirmCreateGroupBtn.disabled = false; // M·ªü l·∫°i n√∫t
        confirmCreateGroupBtn.textContent = 'T·∫°o Nh√≥m';
    }
}

/**
 * Kick m·ªôt th√†nh vi√™n ra kh·ªèi nh√≥m (ch·ªâ Admin/Mod l√†m ƒë∆∞·ª£c).
 * @param {string} groupId ID c·ªßa nh√≥m.
 * @param {string} targetUid UID c·ªßa th√†nh vi√™n b·ªã kick.
 */
async function kickMember(groupId, targetUid) {
    if (!groupId || !targetUid) return;
    const groupRef = doc(db, 'groups', groupId);
    try {
        // C·∫≠p nh·∫≠t Firestore: X√≥a UID kh·ªèi m·∫£ng members v√† x√≥a role
        await updateDoc(groupRef, {
            member_uids: arrayRemove(targetUid),    // X√≥a kh·ªèi m·∫£ng th√†nh vi√™n
            [`roles.${targetUid}`]: deleteField() // X√≥a vai tr√≤ c·ªßa h·ªç
        });
        showToast('ƒê√£ kick th√†nh vi√™n th√†nh c√¥ng.', 'success');
        // Giao di·ªán s·∫Ω t·ª± c·∫≠p nh·∫≠t nh·ªù onSnapshot trong showGroupInfo
    } catch (error) {
        console.error("L·ªói khi kick th√†nh vi√™n:", error);
        showToast("C√≥ l·ªói x·∫£y ra khi kick th√†nh vi√™n.", "error");
    }
}

/**
 * Thay ƒë·ªïi vai tr√≤ c·ªßa th√†nh vi√™n trong nh√≥m (ch·ªâ Admin l√†m ƒë∆∞·ª£c).
 * @param {string} groupId ID c·ªßa nh√≥m.
 * @param {string} targetUid UID c·ªßa th√†nh vi√™n c·∫ßn ƒë·ªïi vai tr√≤.
 * @param {'moderator' | 'member'} newRole Vai tr√≤ m·ªõi ('moderator' ho·∫∑c 'member').
 */
async function changeRole(groupId, targetUid, newRole) {
    if (!groupId || !targetUid || (newRole !== 'moderator' && newRole !== 'member')) return;
    const groupRef = doc(db, 'groups', groupId);
    try {
        // C·∫≠p nh·∫≠t Firestore: Thay ƒë·ªïi gi√° tr·ªã trong object roles
        await updateDoc(groupRef, {
            [`roles.${targetUid}`]: newRole
        });
        showToast(`ƒê√£ c·∫≠p nh·∫≠t vai tr√≤ th√†nh ${newRole === 'moderator' ? 'Ph√≥ nh√≥m' : 'Th√†nh vi√™n'}.`, 'success');
        // Giao di·ªán s·∫Ω t·ª± c·∫≠p nh·∫≠t nh·ªù onSnapshot trong showGroupInfo
    } catch (error) {
        console.error("L·ªói khi thay ƒë·ªïi vai tr√≤:", error);
        showToast("C√≥ l·ªói x·∫£y ra khi ƒë·ªïi vai tr√≤.", "error");
    }
}

/**
 * R·ªùi kh·ªèi m·ªôt nh√≥m chat.
 * @param {string} groupId ID c·ªßa nh√≥m c·∫ßn r·ªùi.
 * @param {string} groupName T√™n c·ªßa nh√≥m (ƒë·ªÉ hi·ªÉn th·ªã confirm).
 */
async function leaveGroup(groupId, groupName) {
     if (!groupId || !currentUser) return;
     const confirmed = await showConfirmation(`B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi kh·ªèi nh√≥m "${groupName || 'n√†y'}"?`);
     if (confirmed) {
         const groupRef = doc(db, 'groups', groupId);
         leaveGroupBtn.disabled = true; leaveGroupBtn.textContent = 'ƒêang r·ªùi...'; // C·∫≠p nh·∫≠t n√∫t
         try {
             // C·∫≠p nh·∫≠t Firestore: X√≥a UID kh·ªèi m·∫£ng members v√† x√≥a role
             await updateDoc(groupRef, {
                 member_uids: arrayRemove(currentUser.uid),
                 [`roles.${currentUser.uid}`]: deleteField()
             });
             showToast('ƒê√£ r·ªùi nh√≥m th√†nh c√¥ng.', 'success');
             if (chatInfoPanel) chatInfoPanel.classList.remove('open'); // ƒê√≥ng panel info

             // Reset UI n·∫øu ƒëang xem nh√≥m v·ª´a r·ªùi
             if (currentChatId === groupId) {
                 if(currentChatFriendName) currentChatFriendName.textContent = "Ch·ªçn cu·ªôc tr√≤ chuy·ªán";
                 if(messagesContainer) messagesContainer.innerHTML = '';
                 if(messageInput) messageInput.disabled = true;
                 if(sendBtn) sendBtn.disabled = true;
                 currentChatId = null; currentChatType = null;
                 if(currentChatAvatar) currentChatAvatar.style.display = 'none';
                 if(groupInfoBtn) groupInfoBtn.style.display = 'none';
                 if(toggleMuteBtnGroup) toggleMuteBtnGroup.style.display = 'none';
             }
             // T·ª± ƒë·ªông load l·∫°i list chat (v√¨ onSnapshot c·ªßa group s·∫Ω ƒë∆∞·ª£c trigger)
             // loadAndSortChats(); // Kh√¥ng c·∫ßn g·ªçi l·∫°i ·ªü ƒë√¢y

         } catch (error) {
             console.error("L·ªói khi r·ªùi nh√≥m:", error);
             showToast("C√≥ l·ªói x·∫£y ra khi r·ªùi nh√≥m.", "error");
             leaveGroupBtn.disabled = false; leaveGroupBtn.textContent = 'R·ªùi nh√≥m'; // Reset n√∫t n·∫øu l·ªói
         }
     }
}

/**
 * Gi·∫£i t√°n m·ªôt nh√≥m chat (ch·ªâ Admin l√†m ƒë∆∞·ª£c).
 * X√≥a document nh√≥m kh·ªèi Firestore v√† x√≥a tin nh·∫Øn/typing kh·ªèi RTDB.
 * @param {string} groupId ID c·ªßa nh√≥m c·∫ßn gi·∫£i t√°n.
 * @param {string} groupName T√™n c·ªßa nh√≥m (ƒë·ªÉ hi·ªÉn th·ªã confirm).
 */
async function disbandGroup(groupId, groupName) {
     if (!groupId || !currentUser) return;
     const confirmed = await showConfirmation(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën gi·∫£i t√°n nh√≥m "${groupName || 'n√†y'}" kh√¥ng? H√†nh ƒë·ªông n√†y s·∫Ω x√≥a to√†n b·ªô tin nh·∫Øn v√† KH√îNG TH·ªÇ ho√†n t√°c!`);
     if (confirmed) {
         if (!disbandGroupBtn) return; // Ki·ªÉm tra n√∫t t·ªìn t·∫°i
         disbandGroupBtn.disabled = true; disbandGroupBtn.textContent = 'ƒêang gi·∫£i t√°n...';
         try {
             // 1. X√≥a document nh√≥m kh·ªèi Firestore
             await deleteDoc(doc(db, 'groups', groupId));

             // 2. X√≥a d·ªØ li·ªáu tin nh·∫Øn kh·ªèi RTDB
             await remove(ref(rtdb, `/messages/${groupId}`));

             // 3. X√≥a d·ªØ li·ªáu typing kh·ªèi RTDB
             await remove(ref(rtdb, `/typing/${groupId}`));

             showToast("ƒê√£ gi·∫£i t√°n nh√≥m th√†nh c√¥ng!", "success");
             if (chatInfoPanel) chatInfoPanel.classList.remove('open');

             // Reset UI n·∫øu ƒëang xem nh√≥m v·ª´a gi·∫£i t√°n
             if (currentChatId === groupId) {
                  if(currentChatFriendName) currentChatFriendName.textContent = "Ch·ªçn cu·ªôc tr√≤ chuy·ªán";
                  if(messagesContainer) messagesContainer.innerHTML = '';
                  if(messageInput) messageInput.disabled = true;
                  if(sendBtn) sendBtn.disabled = true;
                  currentChatId = null; currentChatType = null;
                  if(currentChatAvatar) currentChatAvatar.style.display = 'none';
                  if(groupInfoBtn) groupInfoBtn.style.display = 'none';
                  if(toggleMuteBtnGroup) toggleMuteBtnGroup.style.display = 'none';
             }
             // T·ª± ƒë·ªông load l·∫°i list chat (v√¨ onSnapshot c·ªßa group s·∫Ω ƒë∆∞·ª£c trigger)

         } catch (err) {
             console.error("L·ªói gi·∫£i t√°n nh√≥m:", err);
             showToast("L·ªói khi gi·∫£i t√°n nh√≥m!", "error");
             disbandGroupBtn.disabled = false; disbandGroupBtn.textContent = 'üóëÔ∏è Gi·∫£i t√°n nh√≥m';
         }
     }
}

// --- PH·∫¶N 11: C√ÅC H√ÄM X·ª¨ L√ù KH√ÅC (SEARCH, URL, NOTIF, MENTION, ETC.) ---

/**
 * G·∫Øn s·ª± ki·ªán input cho √¥ t√¨m ki·∫øm chung (sidebar).
 * T√¨m ki·∫øm b·∫°n b√®, nh√≥m v√† hi·ªÉn th·ªã k·∫øt qu·∫£ trong dropdown.
 */
function attachGlobalSearch() {
    if (!globalSearch || !searchDropdown) return; // Ki·ªÉm tra element

    globalSearch.addEventListener('input', async (e) => {
        const searchTerm = e.target.value.trim().toLowerCase();
        // ·∫®n dropdown n·∫øu √¥ t√¨m ki·∫øm r·ªóng
        if (!searchTerm) {
            searchDropdown.style.display = 'none';
            searchDropdown.innerHTML = '';
            return;
        }

        searchDropdown.innerHTML = '<div class="result-item"><div class="result-sub">ƒêang t√¨m...</div></div>'; // Hi·ªÉn th·ªã loading
        searchDropdown.style.display = 'block';

        // L·∫•y danh s√°ch b·∫°n b√® v√† nh√≥m t·ª´ cache (bi·∫øn `friends` v√† query Firestore)
        // L∆∞u √Ω: Bi·∫øn `friends` c·∫ßn ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong `loadAndSortChats`
        const friendUIDs = currentUserData.friends || [];
        // const friendsData = friends; // D√πng bi·∫øn global ƒë√£ c·∫≠p nh·∫≠t

        const qg = query(collection(db, 'groups'), where('member_uids', 'array-contains', currentUser.uid));
        const gs = await getDocs(qg);
        const groupsData = [];
        gs.forEach(d => groupsData.push({ id: d.id, ...d.data() }));

        // L·ªçc k·∫øt qu·∫£
        const friendsFiltered = friends.filter(u =>
            (u.displayName || u.email || '').toLowerCase().includes(searchTerm)
        );
        const groupsFiltered = groupsData.filter(g =>
            (g.groupName || '').toLowerCase().includes(searchTerm)
        );
        // Optional: Th√™m t√¨m ki·∫øm ng∆∞·ªùi d√πng kh√°c (ch∆∞a ph·∫£i b·∫°n b√®)
        // const usersQuery = query(collection(db, "users"), where("email", ">=", searchTerm), where("email", "<=", searchTerm + '\uf8ff'), limit(5));
        // const usersSnap = await getDocs(usersQuery);
        // const usersFiltered = usersSnap.docs.map(d => d.data()).filter(u => u.uid !== currentUser.uid && !friendUIDs.includes(u.uid));


        searchDropdown.innerHTML = ''; // X√≥a loading

        // H√†m helper ƒë·ªÉ render m·ªôt m·ª•c k·∫øt qu·∫£
        const renderResultItem = (itemData, type) => {
            const el = document.createElement('div');
            el.className = 'result-item';
            const avatarPlaceholder = (itemData.displayName || itemData.groupName || '?')[0].toUpperCase();
            const avatarSrc = itemData.avatarUrl || `https://placehold.co/32x32?text=${avatarPlaceholder}`;
            const name = type === 'group' ? `üë• ${itemData.groupName}` : (itemData.displayName || itemData.email);
            const verifiedTick = createVerifiedTickHTML(itemData.isVerified);

            el.innerHTML = `
                <div class="result-left">
                    <img class="result-avatar" src="${avatarSrc}" alt="Avatar">
                    <div><div class="result-name">${escapeHtml(name)}${verifiedTick}</div></div>
                </div>
            `;
             // Th√™m n√∫t k·∫øt b·∫°n n·∫øu l√† user l·∫° (ch∆∞a l√†m ph·∫ßn t√¨m user l·∫°)
             /* if (type === 'user' && !isFriend) {
                 el.innerHTML += `<div class="result-action"><button class="add-friend-btn" data-uid="${itemData.uid}">K·∫øt b·∫°n</button></div>`;
             } */

            el.onclick = () => {
                if (type === 'direct') startDirectChat(itemData);
                else if (type === 'group') startGroupChat(itemData.id, itemData.groupName);
                // else if (type === 'user') { /* M·ªü profile user l·∫°? */ }
                hideDropdown();
            };
            // G·∫Øn s·ª± ki·ªán cho n√∫t k·∫øt b·∫°n n·∫øu c√≥
            // const addBtn = el.querySelector('.add-friend-btn');
            // if (addBtn) { addBtn.onclick = (ev) => { ev.stopPropagation(); /* ... logic g·ª≠i l·ªùi m·ªùi ... */ }; }

            return el;
        };

        // H√†m helper ƒë·ªÉ th√™m section v√†o dropdown
        const addSection = (title, items, renderFunc, type) => {
             const st = document.createElement('div'); st.className = 'section-title'; st.textContent = title; searchDropdown.appendChild(st);
             if (!items.length) { const em = document.createElement('div'); em.className = 'result-item'; em.innerHTML = `<div class="result-sub" style="text-align:center;">Kh√¥ng c√≥ k·∫øt qu·∫£</div>`; searchDropdown.appendChild(em); return; }
             items.forEach(x => searchDropdown.appendChild(renderFunc(x, type)));
        };

        // Render c√°c section
        addSection('B·∫°n b√®', friendsFiltered, renderResultItem, 'direct');
        addSection('Nh√≥m', groupsFiltered, renderResultItem, 'group');
        // addSection('Ng∆∞·ªùi d√πng kh√°c', usersFiltered, renderResultItem, 'user'); // N·∫øu c√≥ t√¨m user l·∫°

        searchDropdown.style.display = 'block'; // Hi·ªÉn th·ªã dropdown
    });

    // ·∫®n dropdown khi click ra ngo√†i
    const hideDropdown = () => { if (searchDropdown) searchDropdown.style.display = 'none'; };
    document.addEventListener('click', (e) => {
        if (globalSearch && searchDropdown && e.target !== globalSearch && !searchDropdown.contains(e.target)) {
            hideDropdown();
        }
    });
}

/**
 * X·ª≠ l√Ω tham s·ªë 'chat' ho·∫∑c 'chat_group' trong URL khi t·∫£i trang.
 * T·ª± ƒë·ªông m·ªü cu·ªôc tr√≤ chuy·ªán t∆∞∆°ng ·ª©ng n·∫øu c√≥.
 */
async function handleUrlChat() {
    const params = new URLSearchParams(window.location.search);
    const friendUid = params.get('chat');
    const groupId = params.get('chat_group');

    if (friendUid) {
        try {
            const userDoc = await getDoc(doc(db, 'users', friendUid));
            if (userDoc.exists()) {
                await startDirectChat({ uid: friendUid, ...userDoc.data() }); // Truy·ªÅn data user v√†o
            } else {
                 console.warn("User specified in URL not found:", friendUid);
                 history.replaceState(null, '', window.location.pathname); // X√≥a param kh·ªèi URL
            }
        } catch (error) {
             console.error("Error handling direct chat URL:", error);
             history.replaceState(null, '', window.location.pathname);
        }
    } else if (groupId) {
         try {
             const groupDoc = await getDoc(doc(db, 'groups', groupId));
             if (groupDoc.exists()) {
                 await startGroupChat(groupId, groupDoc.data().groupName); // G·ªçi startGroupChat
             } else {
                 console.warn("Group specified in URL not found:", groupId);
                 history.replaceState(null, '', window.location.pathname);
             }
         } catch (error) {
              console.error("Error handling group chat URL:", error);
              history.replaceState(null, '', window.location.pathname);
         }
    }
}

/**
 * L·∫Øng nghe c√°c notification m·ªõi ƒë∆∞·ª£c ƒë·∫©y v√†o RTDB cho user hi·ªán t·∫°i.
 * Hi·ªÉn th·ªã th√¥ng b√°o tr√¨nh duy·ªát n·∫øu chat ƒë√≥ kh√¥ng ƒëang m·ªü v√† kh√¥ng b·ªã mute.
 */
function listenForNotifications_Optimized() {
    if (!currentUser) return;
    const notifsRef = ref(rtdb, `/notifications/${currentUser.uid}`);
    onChildAdded(notifsRef, async (snapshot) => { // D√πng async ƒë·ªÉ await l·∫•y data mute
        const notification = snapshot.val();
        if (!notification) { remove(snapshot.ref); return; } // X√≥a notif r·ªóng

        try {
            // L·∫•y tr·∫°ng th√°i mute M·ªöI NH·∫§T c·ªßa user hi·ªán t·∫°i
            const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
            const latestUserData = userDoc.exists() ? userDoc.data() : {};

            // Ki·ªÉm tra xem chat n√†y c√≥ b·ªã user hi·ªán t·∫°i mute kh√¥ng
            const isMuted = latestUserData.mutedChats?.[notification.chatId] === true;

            // N·∫øu chat b·ªã mute ho·∫∑c ƒëang m·ªü -> Ch·ªâ x√≥a notif, kh√¥ng hi·ªÉn th·ªã
            if (isMuted || notification.chatId === currentChatId) {
                remove(snapshot.ref);
                return;
            }

            // N·∫øu kh√¥ng b·ªã mute v√† kh√¥ng ƒëang m·ªü -> Hi·ªÉn th·ªã th√¥ng b√°o
            showSimpleNotification(notification.from, notification.preview, notification.avatar);
            // Optional: TƒÉng unread count tr√™n tab title n·∫øu c·∫ßn (c√≥ th·ªÉ tr√πng v·ªõi renderMessage)
            // if (document.hidden) { unreadCount++; document.title = `(${unreadCount}) ${originalTitle}`; }

        } catch (error) {
             console.error("Error processing notification:", error);
        } finally {
             // Lu√¥n x√≥a notification kh·ªèi RTDB sau khi x·ª≠ l√Ω (ho·∫∑c l·ªói)
             remove(snapshot.ref);
        }
    });
}

/**
 * X·ª≠ l√Ω input ƒë·ªÉ g·ª£i √Ω mention (@) trong group chat.
 */
function handleMentionInput() {
    if (!mentionSuggestions || !messageInput) return;
    let isMentioning = false; let mentionQuery = '';

    messageInput.addEventListener('input', (e) => {
        const text = messageInput.value; const cursorPos = messageInput.selectionStart; let lastAtPos = -1;
        for (let i = cursorPos - 1; i >= 0; i--) { if (text[i] === '@') { if (i === 0 || /\s/.test(text[i - 1])) { lastAtPos = i; break; } } if (/\s/.test(text[i])) break; }
        if (lastAtPos !== -1 && currentChatType === 'group') { isMentioning = true; mentionQuery = text.substring(lastAtPos + 1, cursorPos).toLowerCase(); showSuggestions(mentionQuery); }
        else { isMentioning = false; mentionSuggestions.style.display = 'none'; }
    });
    // Optional: Add keydown listener for arrow keys/enter

    function showSuggestions(query) {
        mentionSuggestions.innerHTML = ''; let suggestions = [];
        if ('all'.includes(query)) suggestions.push({ type: 'all' });
        if (currentGroupMembers.length > 0) { const filtered = currentGroupMembers.filter(m => m.uid !== currentUser.uid && (m.displayName || '').toLowerCase().includes(query)); suggestions = suggestions.concat(filtered.map(m => ({ ...m, type: 'user' }))); }
        if (suggestions.length === 0) { mentionSuggestions.style.display = 'none'; return; }
        suggestions.forEach(item => { const div = document.createElement('div'); div.className = 'suggestion-item'; if (item.type === 'all') { div.innerHTML = `<span class="all">@all</span>`; div.onclick = () => insertMention('@all', 'all'); } else { const avatar = item.avatarUrl || `https://placehold.co/28x28?text=${(item.displayName||'?')[0]}`; div.innerHTML = `<img src="${avatar}" alt=""><span class="name">${escapeHtml(item.displayName || '')}</span>`; div.onclick = () => insertMention(item.displayName, item.uid); } mentionSuggestions.appendChild(div); });
        mentionSuggestions.style.display = 'block';
    }
    function insertMention(name, uidOrAll) {
        const text = messageInput.value; const cursorPos = messageInput.selectionStart; let lastAtPos = -1;
        for (let i = cursorPos - 1; i >= 0; i--) { if (text[i] === '@') { if (i === 0 || /\s/.test(text[i - 1])) { lastAtPos = i; break; } } if (/\s/.test(text[i])) break; }
        if (lastAtPos !== -1) { const before = text.substring(0, lastAtPos); const after = text.substring(cursorPos); const mentionText = (uidOrAll === 'all') ? '@all' : `@${name}`; messageInput.value = before + mentionText + ' ' + after; messageInput.focus(); const newPos = before.length + mentionText.length + 1; messageInput.setSelectionRange(newPos, newPos); }
        mentionSuggestions.style.display = 'none'; isMentioning = false; messageInput.dispatchEvent(new Event('input')); // Trigger input event
    }
}

/**
 * M·ªü ·∫£nh trong lightbox (popup xem ·∫£nh l·ªõn).
 * @param {string} imageUrl URL c·ªßa ·∫£nh c·∫ßn hi·ªÉn th·ªã.
 */
function openLightbox(imageUrl) {
    if (lightboxImg && imageLightbox) { // Check elements
        lightboxImg.src = imageUrl;
        imageLightbox.style.display = 'flex'; // Hi·ªán overlay
    }
}

/**
 * L∆∞u thay ƒë·ªïi th√¥ng tin h·ªì s∆° t·ª´ modal ch·ªânh s·ª≠a.
 */
async function saveProfileChanges() {
    if (!profileDisplayName || !profileBio || !profileAvatarUrl || !saveProfileEditBtn || !cancelProfileEditBtn || !editProfileModal) return; // Check elements

    const newDisplayName = profileDisplayName.value.trim();
    const newBio = profileBio.value.trim();
    const newAvatarUrl = profileAvatarUrl.value.trim();

    if (!newDisplayName) return showToast('T√™n hi·ªÉn th·ªã kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.', 'error');
    // Optional: Validate URL avatar c∆° b·∫£n
    // if (newAvatarUrl && !newAvatarUrl.startsWith('http')) return showToast('URL Avatar kh√¥ng h·ª£p l·ªá.', 'error');

    saveProfileEditBtn.disabled = true; saveProfileEditBtn.textContent = 'ƒêang l∆∞u...';

    const userRef = doc(db, 'users', currentUser.uid);
    try {
        await updateDoc(userRef, {
            displayName: newDisplayName,
            bio: newBio || deleteField(), // X√≥a field n·∫øu bio r·ªóng
            avatarUrl: newAvatarUrl || deleteField() // X√≥a field n·∫øu avatar r·ªóng (n√™n c√≥ ·∫£nh m·∫∑c ƒë·ªãnh)
        });
        showToast('C·∫≠p nh·∫≠t h·ªì s∆° th√†nh c√¥ng!', 'success');
        editProfileModal.style.display = 'none'; // ƒê√≥ng modal
        // Giao di·ªán (avatar nav) s·∫Ω t·ª± c·∫≠p nh·∫≠t nh·ªù listener `wireProfile`
    } catch (error) {
        console.error("L·ªói khi c·∫≠p nh·∫≠t h·ªì s∆°:", error);
        showToast('C√≥ l·ªói x·∫£y ra, kh√¥ng th·ªÉ c·∫≠p nh·∫≠t.', 'error');
    } finally {
        saveProfileEditBtn.disabled = false; saveProfileEditBtn.textContent = 'L∆∞u thay ƒë·ªïi';
    }
}

/**
 * G·ª≠i b√°o c√°o ng∆∞·ªùi d√πng l√™n Firestore.
 */
async function submitReport() {
    if (!reportingUser || !currentUser || !reportUserModal || !submitReportBtn) return;
    const reasonRadio = document.querySelector('input[name="reportReason"]:checked');
    if (!reasonRadio) return showToast("Vui l√≤ng ch·ªçn l√Ω do b√°o c√°o.", "error");
    const reason = reasonRadio.value;
    const details = reportDetails ? reportDetails.value.trim() : '';

    submitReportBtn.disabled = true; submitReportBtn.textContent = 'ƒêang g·ª≠i...';

    try {
        await addDoc(collection(db, "reports"), {
            reporterUid: currentUser.uid,
            reportedUid: reportingUser.uid,
            reason: reason,
            details: details || null, // L∆∞u null n·∫øu kh√¥ng c√≥ chi ti·∫øt
            evidence: selectedEvidence.length > 0 ? selectedEvidence : null, // L∆∞u m·∫£ng tin nh·∫Øn b·∫±ng ch·ª©ng
            timestamp: serverTimestamp()
            // Optional: Th√™m ng·ªØ c·∫£nh nh∆∞ chat ID, group ID
            // chatId: currentChatId,
            // chatType: currentChatType
        });
        showToast("ƒê√£ g·ª≠i b√°o c√°o th√†nh c√¥ng. C·∫£m ∆°n b·∫°n!", "success");
    } catch (error) {
        console.error("L·ªói khi g·ª≠i b√°o c√°o:", error);
        showToast("C√≥ l·ªói x·∫£y ra, kh√¥ng th·ªÉ g·ª≠i b√°o c√°o.", "error");
    } finally {
        reportUserModal.style.display = 'none'; // ƒê√≥ng modal
        if (reportDetails) reportDetails.value = ''; // Reset form
        const defaultReason = document.querySelector('input[name="reportReason"][value="spam"]');
        if(defaultReason) defaultReason.checked = true; // Reset radio
        document.querySelectorAll('.report-reason-row.selected').forEach(r => r.classList.remove('selected')); // B·ªè highlight
        reportingUser = null; // Reset ng∆∞·ªùi b·ªã b√°o c√°o
        selectedEvidence = []; // Reset b·∫±ng ch·ª©ng
        if (evidencePreview) evidencePreview.style.display = 'none'; // ·∫®n preview b·∫±ng ch·ª©ng
        submitReportBtn.disabled = false; submitReportBtn.textContent = 'G·ª≠i b√°o c√°o'; // Reset n√∫t
    }
}

// C√°c h√†m li√™n quan ƒë·∫øn ch·ªçn b·∫±ng ch·ª©ng b√°o c√°o
function enterMessageSelectionMode() { /* ... Gi·ªëng code tr∆∞·ªõc ... */ }
function exitMessageSelectionMode(saveChanges = false) { /* ... Gi·ªëng code tr∆∞·ªõc ... */ }
function updateSelectionCount() { /* ... Gi·ªëng code tr∆∞·ªõc ... */ }

/**
 * G·ª≠i b√°o c√°o l·ªói l√™n Firestore.
 */
async function submitBugReport() {
    if (!bugDescription || !bugSteps || !submitBugReportBtn || !reportBugModal) return;
    const description = bugDescription.value.trim();
    const steps = bugSteps.value.trim();
    if (!description) return showToast("Vui l√≤ng m√¥ t·∫£ l·ªói.", "error");

    submitBugReportBtn.disabled = true; submitBugReportBtn.textContent = "ƒêang g·ª≠i...";
    try {
        await addDoc(collection(db, "bug_reports"), {
            userId: currentUser?.uid || "unknown",
            email: currentUser?.email || "unknown",
            description: description,
            stepsToReproduce: steps || null,
            timestamp: serverTimestamp(),
            userAgent: navigator.userAgent,
            appVersion: "1.0" // C·∫≠p nh·∫≠t version app c·ªßa c·∫≠u
        });
        showToast("ƒê√£ g·ª≠i b√°o c√°o l·ªói! C·∫£m ∆°n b·∫°n.", "success");
        reportBugModal.style.display = 'none';
        bugDescription.value = ''; bugSteps.value = '';
    } catch (error) { console.error("L·ªói g·ª≠i b√°o c√°o l·ªói:", error); showToast("G·ª≠i b√°o c√°o th·∫•t b·∫°i: " + error.message, "error"); }
    finally { submitBugReportBtn.disabled = false; submitBugReportBtn.textContent = "G·ª≠i b√°o c√°o"; }
}

/**
 * T·∫£i v√† hi·ªÉn th·ªã danh s√°ch b·∫°n b√® cho tab "B·∫°n b√®".
 * L·∫•y danh s√°ch UID t·ª´ currentUserData, l·∫•y chi ti·∫øt t·ª´ng ng∆∞·ªùi,
 * render l√™n list v√† g·∫Øn s·ª± ki·ªán filter cho √¥ t√¨m ki·∫øm.
 */
async function loadFriendsTabList() {
    // Ki·ªÉm tra c√°c element c·∫ßn thi·∫øt
    if (!friendsListElement || !currentUserData || !friendsSearchInput) {
        console.warn("Missing elements for Friends Tab.");
        if(friendsListElement) friendsListElement.innerHTML = '<li class="friend-item-placeholder" style="color:red;">L·ªói t·∫£i giao di·ªán!</li>';
        return;
    }

    friendsListElement.innerHTML = '<li class="friend-item-placeholder">ƒêang t·∫£i danh s√°ch b·∫°n b√®...</li>'; // Loading

    const friendUIDs = currentUserData.friends || []; // L·∫•y m·∫£ng UID

    if (friendUIDs.length === 0) {
        friendsListElement.innerHTML = '<li class="friend-item-placeholder">B·∫°n ch∆∞a c√≥ b·∫°n b√® n√†o.</li>';
        return; // D·ª´ng n·∫øu ch∆∞a c√≥ b·∫°n
    }

    // L·∫•y th√¥ng tin chi ti·∫øt b·∫°n b√® (∆∞u ti√™n cache 'friends' n·∫øu c√≥)
    let friendsData = [];
    if (friends.length === friendUIDs.length) { // Check cache kh·ªõp kh√¥ng
        friendsData = friends; // D√πng cache
    } else { // N·∫øu cache kh√¥ng kh·ªõp ho·∫∑c ch∆∞a c√≥, query l·∫°i
        const friendPromises = friendUIDs.map(async (uid) => {
            try {
                const userDoc = await getDoc(doc(db, 'users', uid));
                if (userDoc.exists()) {
                    return { uid: uid, ...userDoc.data() };
                }
            } catch (err) { console.error("Error fetching friend details for tab:", uid, err); }
            return null; // Tr·∫£ v·ªÅ null n·∫øu l·ªói ho·∫∑c kh√¥ng t·ªìn t·∫°i
        });
        friendsData = (await Promise.all(friendPromises)).filter(Boolean); // L·ªçc b·ªè null
    }


    // H√†m render danh s√°ch (c√≥ filter)
    const renderList = (filter = '') => {
        friendsListElement.innerHTML = ''; // X√≥a s·∫°ch tr∆∞·ªõc khi render
        const searchTerm = filter.toLowerCase();
        const filteredFriends = friendsData.filter(f =>
            (f.displayName || f.email || '').toLowerCase().includes(searchTerm)
        );

        if (filteredFriends.length === 0) {
            friendsListElement.innerHTML = '<li class="friend-item-placeholder">Kh√¥ng t√¨m th·∫•y b·∫°n b√® n√†o kh·ªõp.</li>';
            return;
        }

        filteredFriends.forEach(u => {
            const li = document.createElement('li');
            li.className = 'friend-item'; // Class m·ªõi
            li.onclick = () => {
                // Chuy·ªÉn sang tab chat v√† m·ªü chat
                const chatNavButton = document.querySelector('.nav-button[data-view="chat"]');
                if(chatNavButton) chatNavButton.click(); // Gi·∫£ l·∫≠p click v√†o n√∫t chat
                startDirectChat(u); // M·ªü chat v·ªõi data ƒë·∫ßy ƒë·ªß
            };

            const avatarSrc = u.avatarUrl || `https://placehold.co/45x45?text=${(u.displayName || '?')[0].toUpperCase()}`;
            const verifiedTick = createVerifiedTickHTML(u.isVerified);
            const friendName = u.displayName || u.email || 'Ng∆∞·ªùi d√πng';

            li.innerHTML = `
                <div class="friend-item-left">
                    <img class="friend-avatar" src="${avatarSrc}" alt="Avatar">
                    <span class="friend-name">${escapeHtml(friendName)}${verifiedTick}</span>
                </div>
                <div class="friend-status" id="friend-tab-st-${u.uid}"></div> `;
            friendsListElement.appendChild(li);

            // L·∫Øng nghe tr·∫°ng th√°i online
            const statusRef = ref(rtdb, `/status/${u.uid}`);
            // G·∫Øn listener m·ªõi (c√≥ th·ªÉ c·∫ßn qu·∫£n l√Ω vi·ªác h·ªßy listener n·∫øu tab b·ªã ·∫©n/ƒë√≥ng)
            onValue(statusRef, (s) => {
                const statusEl = document.getElementById(`friend-tab-st-${u.uid}`);
                if (statusEl) {
                    statusEl.classList.toggle('online', !!s.val()?.isOnline);
                }
            }, { onlyOnce: false }); // L·∫Øng nghe li√™n t·ª•c
        });
    };

    // Render l·∫ßn ƒë·∫ßu
    renderList(friendsSearchInput.value); // Render v·ªõi gi√° tr·ªã search hi·ªán t·∫°i (n·∫øu c√≥)

    // G·∫Øn s·ª± ki·ªán filter cho √¥ search (ch·ªâ g·∫Øn 1 l·∫ßn)
    if (!friendsSearchInput.dataset.listenerAttached) { // D√πng data attribute ƒë·ªÉ tr√°nh g·∫Øn nhi·ªÅu l·∫ßn
        friendsSearchInput.oninput = (e) => {
            renderList(e.target.value);
        };
        friendsSearchInput.dataset.listenerAttached = 'true';
    }
}

/**
 * Render n·ªôi dung changelog v√†o modal t·ª´ m·∫£ng changelogData.
 */
function renderChangelog() {
    if (!changelogContent || !changelogData) return; // Ki·ªÉm tra element v√† data
    changelogContent.innerHTML = ''; // X√≥a n·ªôi dung c≈©

    changelogData.forEach((entry, index) => {
        const entryDiv = document.createElement('div');
        entryDiv.className = 'changelog-entry';

        // Ph·∫ßn Meta (Version + Date)
        const metaDiv = document.createElement('div');
        metaDiv.className = 'changelog-meta';
        const versionH3 = document.createElement('h3');
        versionH3.textContent = `Phi√™n b·∫£n ${entry.version}`;
        const dateSpan = document.createElement('span');
        dateSpan.textContent = `- ${entry.date}`;
        metaDiv.appendChild(versionH3);
        metaDiv.appendChild(dateSpan);

        // Ph·∫ßn Description
        const descDiv = document.createElement('div');
        descDiv.className = 'changelog-desc';
        if (Array.isArray(entry.description)) { // Ki·ªÉm tra n·∫øu l√† m·∫£ng
            entry.description.forEach(line => {
                const p = document.createElement('p');
                p.textContent = line; // G√°n text
                descDiv.appendChild(p);
            });
        } else if (typeof entry.description === 'string') { // N·∫øu ch·ªâ l√† 1 d√≤ng text
             const p = document.createElement('p');
             p.textContent = entry.description;
             descDiv.appendChild(p);
        }


        // Ph·∫ßn Image (n·∫øu c√≥)
        if (entry.imageUrl) {
            const img = document.createElement('img');
            img.className = 'changelog-image';
            img.src = entry.imageUrl;
            img.alt = `Minh h·ªça cho v${entry.version}`;
            descDiv.appendChild(img); // Th√™m ·∫£nh v√†o description
        }

        entryDiv.appendChild(metaDiv);
        entryDiv.appendChild(descDiv);
        changelogContent.appendChild(entryDiv);

        // Th√™m ƒë∆∞·ªùng k·∫ª ngang ngƒÉn c√°ch (tr·ª´ m·ª•c cu·ªëi)
        if (index < changelogData.length - 1) {
            const hr = document.createElement('hr');
            hr.className = 'changelog-divider';
            changelogContent.appendChild(hr);
        }
    });
}

/**
 * X·ª≠ l√Ω hi·ªÉn th·ªã popup th√¥ng b√°o (n·∫øu d√πng Remote Config).
 * L·∫•y d·ªØ li·ªáu title, message, image t·ª´ Remote Config v√† hi·ªÉn th·ªã modal.
 */
function handleAnnouncementPopup() {
    // Ch·ªâ ch·∫°y n·∫øu c√≥ Remote Config v√† c√°c element popup
    if (typeof getRemoteConfig === 'undefined' || !announcementOverlay || !announcementTitle || !announcementText || !announcementImage || !closeAnnouncementBtn) {
         console.warn("Remote Config or Announcement elements not available.");
         return;
    }

    try {
        const show = getBoolean(remoteConfig, "show_announcement"); // Key config: show_announcement (Boolean)
        if (show) {
            const title = getValue(remoteConfig, "announcement_title").asString() || "Th√¥ng b√°o"; // Key: announcement_title (String)
            const message = getValue(remoteConfig, "announcement_message").asString(); // Key: announcement_message (String)
            const imageUrl = getValue(remoteConfig, "announcement_image_url").asString(); // Key: announcement_image_url (String)

            if (!message) { // Kh√¥ng hi·ªán n·∫øu kh√¥ng c√≥ n·ªôi dung
                 console.warn("Announcement message is empty.");
                 return;
            }

            announcementTitle.textContent = title;
            announcementText.textContent = message; // ƒê√£ x·ª≠ l√Ω xu·ªëng d√≤ng b·∫±ng white-space: pre-wrap

            if (imageUrl) {
                announcementImage.src = imageUrl;
                announcementImage.style.display = 'block'; // Hi·ªán ·∫£nh
            } else {
                announcementImage.style.display = 'none'; // ·∫®n ·∫£nh n·∫øu kh√¥ng c√≥ URL
            }

            announcementOverlay.classList.add('show'); // Hi·ªán popup v·ªõi hi·ªáu ·ª©ng
        } else {
             announcementOverlay.classList.remove('show'); // ƒê·∫£m b·∫£o ·∫©n n·∫øu config l√† false
        }
    } catch (error) {
         console.error("Error handling announcement popup:", error);
    }
}

/**
 * Hi·ªÉn th·ªã popup b·∫£o tr√¨ (n·∫øu d√πng Remote Config).
 * S·ª≠ d·ª•ng l·∫°i modal announcement nh∆∞ng ·∫©n n√∫t ƒë√≥ng.
 */
function showMaintenancePopup() {
    if (!announcementOverlay || !announcementTitle || !announcementText || !announcementImage || !closeAnnouncementBtn) {
         console.warn("Announcement elements not available for maintenance message. Using alert fallback.");
         alert("·ª®ng d·ª•ng ƒëang b·∫£o tr√¨. Vui l√≤ng quay l·∫°i sau."); // Fallback
         return;
    }

    try {
        // L·∫•y th√¥ng b√°o b·∫£o tr√¨ t·ª´ Remote Config ho·∫∑c hardcode
        const maintenanceMsg = getValue(remoteConfig, "maintenance_message")?.asString() || "·ª®ng d·ª•ng ƒëang ƒë∆∞·ª£c b·∫£o tr√¨. Vui l√≤ng ki·ªÉm tra l·∫°i sau √≠t ph√∫t."; // Key: maintenance_message (String)
        const maintenanceTitle = "Th√¥ng b√°o b·∫£o tr√¨";

        announcementTitle.textContent = maintenanceTitle;
        announcementText.textContent = maintenanceMsg;
        announcementImage.style.display = 'none'; // Lu√¥n ·∫©n ·∫£nh khi b·∫£o tr√¨
        closeAnnouncementBtn.style.display = 'none'; // ·∫®n n√∫t ƒë√≥ng
        announcementOverlay.onclick = null; // V√¥ hi·ªáu h√≥a ƒë√≥ng khi click ra ngo√†i

        announcementOverlay.classList.add('show'); // Hi·ªán popup
    } catch (error) {
         console.error("Error showing maintenance popup:", error);
         alert("·ª®ng d·ª•ng ƒëang b·∫£o tr√¨. Vui l√≤ng quay l·∫°i sau."); // Fallback
    }
}

// --- H√ÄM G·∫ÆN S·ª∞ KI·ªÜN CH√çNH ---
function attachEventListeners() {
    handleMentionInput(); // K√≠ch ho·∫°t g·ª£i √Ω mention

    // --- NAV CH√çNH ---
    navButtons.forEach(button => {
        button.onclick = (e) => {
            const targetViewId = button.dataset.view;
            if (!targetViewId) return;

            // C·∫≠p nh·∫≠t n√∫t active
            navButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            // Hi·ªÉn th·ªã view t∆∞∆°ng ·ª©ng
            appViews.forEach(view => {
                view.style.display = (view.dataset.view === targetViewId) ? 'block' : 'none';
                view.classList.toggle('active', view.dataset.view === targetViewId);
            });

            // Logic ri√™ng cho t·ª´ng view
            if (targetViewId === 'friends') {
                loadFriendsTabList(); // T·∫£i danh s√°ch b·∫°n b√® khi v√†o tab
            } else if (targetViewId === 'wall') {
                // Load iframe Wall n·∫øu ch∆∞a load
                if (!wallLoaded && currentUser && wallLoader && wallIframe) {
                    wallLoader.style.display = 'flex';
                    wallLoader.innerHTML = '<div style="border: 4px solid var(--glass); border-top: 4px solid var(--accent-1); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>';
                    wallIframe.src = `wall.html?id=${currentUser.uid}`;
                    wallIframe.onload = () => { if (wallLoader) wallLoader.style.display = 'none'; wallLoaded = true; wallIframe.onload = null; wallIframe.onerror = null; };
                    wallIframe.onerror = () => { if(wallLoader) wallLoader.innerHTML = '<p style="color: red;">L·ªói t·∫£i T∆∞·ªùng nh√†!</p>'; wallIframe.onload = null; wallIframe.onerror = null; }
                } else if (wallLoaded && wallLoader) {
                    wallLoader.style.display = 'none';
                }
            } else if (targetViewId === 'chat') {
                // C√≥ th·ªÉ th√™m logic khi quay l·∫°i tab chat n·∫øu c·∫ßn
            }

            // Lu√¥n ƒë√≥ng menu settings khi chuy·ªÉn tab
            if (navSettingsMenu) navSettingsMenu.style.display = 'none';
        };
    });

    // --- AVATAR NAV & MENU SETTINGS ---
    if (navAvatar && navSettingsMenu) {
        navAvatar.onclick = (e) => {
            e.stopPropagation();
            if(addMenu) addMenu.style.display = 'none'; // ƒê√≥ng menu kia
            const isCurrentlyVisible = navSettingsMenu.style.display === 'block';
            navSettingsMenu.style.display = isCurrentlyVisible ? 'none' : 'block';
        };
    }
    // G·∫Øn s·ª± ki·ªán cho c√°c m·ª•c trong menu settings
    const profileBtn = document.getElementById('go-to-profile');
    if (profileBtn) profileBtn.onclick = () => { if(currentUser) window.location.href = `profile.html?id=${currentUser.uid}`; if(navSettingsMenu) navSettingsMenu.style.display = 'none'; };
    if (showChangelogBtn && changelogModal) showChangelogBtn.onclick = () => { renderChangelog(); changelogModal.style.display = 'flex'; if(navSettingsMenu) navSettingsMenu.style.display = 'none'; };
    if (openReportBugModalBtn && reportBugModal) openReportBugModalBtn.onclick = () => { reportBugModal.style.display = 'flex'; if(navSettingsMenu) navSettingsMenu.style.display = 'none'; };
    if (openAboutModalBtn && aboutModal) openAboutModalBtn.onclick = () => { aboutModal.style.display = 'flex'; if(navSettingsMenu) navSettingsMenu.style.display = 'none'; };
    const settingsBtn = document.getElementById('go-to-settings');
    if (settingsBtn) settingsBtn.onclick = () => { window.location.href = 'settings.html'; if(navSettingsMenu) navSettingsMenu.style.display = 'none'; };
    const logoutBtn = document.getElementById('go-login');
    if (logoutBtn) logoutBtn.onclick = async () => { await signOut(auth); window.location.href='login.html'; };

    // --- N√öT '+' & MENU ADD ---
    if (addBtn && addMenu) {
        addBtn.onclick = (e) => {
            e.stopPropagation(); // NgƒÉn lan ra document
            if(navSettingsMenu) navSettingsMenu.style.display = 'none'; // ƒê√≥ng menu kia
            addMenu.style.display = addMenu.style.display === 'block' ? 'none' : 'block';
        };
    }
    const createGroupMenuBtn = document.getElementById('create-group-from-menu');
    if (createGroupMenuBtn) createGroupMenuBtn.onclick = () => { openCreateGroupModal(); if(addMenu) addMenu.style.display = 'none'; };
    const addFriendMenuBtn = document.getElementById('add-friend-from-menu');
    const addFriendModalElem = document.getElementById('add-friend-modal'); // ƒê·ªïi t√™n bi·∫øn
    if (addFriendMenuBtn && addFriendModalElem) addFriendMenuBtn.onclick = () => { addFriendModalElem.style.display = 'flex'; if(addMenu) addMenu.style.display = 'none'; };


    // --- G√°n s·ª± ki·ªán cho c√°c Popup (Modal) ---
    // Add Friend Modal
    const cancelAddFriendBtn = document.getElementById('cancel-add-friend-btn');
    const confirmAddFriendBtn = document.getElementById('confirm-add-friend-btn');
    if (cancelAddFriendBtn && addFriendModalElem) cancelAddFriendBtn.onclick = () => addFriendModalElem.style.display = 'none';
    if (confirmAddFriendBtn) confirmAddFriendBtn.onclick = addFriendByEmail; // V·∫´n d√πng logic m·ªü profile

    // Friend Request Modal
    if (openFriendReqBtn && friendReqModal) openFriendReqBtn.onclick = () => { friendReqModal.style.display = 'flex'; loadFriendRequests(); };
    if (closeFriendReqModal && friendReqModal) closeFriendReqModal.onclick = () => { friendReqModal.style.display = 'none'; };

    // Create Group Modal
    if (closeGroupModalBtn && createGroupModal) closeGroupModalBtn.onclick = () => createGroupModal.style.display = 'none';
    if (confirmCreateGroupBtn) confirmCreateGroupBtn.onclick = confirmCreateGroup;

    // Reactions Modal
    if (closeReactionsModal && reactionsModal) closeReactionsModal.onclick = () => reactionsModal.style.display = 'none';
    if (reactionsModal) reactionsModal.onclick = (e) => { if (e.target === reactionsModal) reactionsModal.style.display = 'none'; };

    // Edit Profile Modal
    const editProfileBtn = document.getElementById('edit-profile-btn'); // N√∫t m·ªü modal (n·∫øu c√≥)
    if (editProfileBtn && editProfileModal) editProfileBtn.onclick = () => { /* Logic ƒëi·ªÅn form */ editProfileModal.style.display = 'flex';};
    if (cancelProfileEditBtn && editProfileModal) cancelProfileEditBtn.onclick = () => editProfileModal.style.display = 'none';
    if (saveProfileEditBtn) saveProfileEditBtn.onclick = saveProfileChanges;

    // Custom Confirm Modal (ƒë√£ g√°n trong showConfirmation)

    // Report User Modal
    if (cancelReportBtn && reportUserModal) cancelReportBtn.onclick = () => { reportUserModal.style.display = 'none'; if(reportDetails) reportDetails.value = ''; /* Reset form */ };
    if (submitReportBtn) submitReportBtn.onclick = submitReport;
    if (attachEvidenceBtn) attachEvidenceBtn.onclick = enterMessageSelectionMode;
    if (cancelSelectionBtn) cancelSelectionBtn.onclick = () => exitMessageSelectionMode(false);
    if (confirmSelectionBtn) confirmSelectionBtn.onclick = () => exitMessageSelectionMode(true);
    // X·ª≠ l√Ω radio reasons
    document.querySelectorAll('.report-reason-row').forEach(row => { row.onclick = () => { document.querySelectorAll('.report-reason-row').forEach(r => r.classList.remove('selected')); row.classList.add('selected'); const radio = row.querySelector('input[type="radio"]'); if(radio) radio.checked = true; }; });

    // Edit Group Modal (ƒë√£ g√°n trong showGroupInfo)
    // Add Member Modal (ƒë√£ g√°n trong showGroupInfo)

    // Changelog Modal
    if (closeChangelogModalBtn && changelogModal) closeChangelogModalBtn.onclick = () => changelogModal.style.display = 'none';
    if (changelogModal) changelogModal.onclick = (e) => { if (e.target === changelogModal) changelogModal.style.display = 'none'; };

    // Announcement Modal
    if (closeAnnouncementBtn && announcementOverlay) closeAnnouncementBtn.onclick = () => announcementOverlay.classList.remove('show');
    if (announcementOverlay) announcementOverlay.onclick = (e) => { if (e.target === announcementOverlay && closeAnnouncementBtn && closeAnnouncementBtn.style.display !== 'none') announcementOverlay.classList.remove('show'); };

    // Report Bug Modal
    if (cancelReportBugBtn && reportBugModal) cancelReportBugBtn.onclick = () => { reportBugModal.style.display = 'none'; if(bugDescription) bugDescription.value = ''; if(bugSteps) bugSteps.value = ''; };
    if (submitBugReportBtn) submitBugReportBtn.onclick = submitBugReport;
    if (reportBugModal) reportBugModal.onclick = (e) => { if (e.target === reportBugModal) { reportBugModal.style.display = 'none'; if(bugDescription) bugDescription.value = ''; if(bugSteps) bugSteps.value = ''; } };

    // About Modal
    if (closeAboutModalBtn && aboutModal) closeAboutModalBtn.onclick = () => aboutModal.style.display = 'none';
    if (aboutModal) aboutModal.onclick = (e) => { if (e.target === aboutModal) aboutModal.style.display = 'none'; };

    // Join Group Modal (n·∫øu c√≥ logic join qua link)
    const cancelJoinBtn = document.getElementById('cancel-join-group-btn');
    const confirmJoinBtn = document.getElementById('confirm-join-group-btn');
    const joinGroupModal = document.getElementById('join-group-modal');
    if(cancelJoinBtn && joinGroupModal) cancelJoinBtn.onclick = () => joinGroupModal.style.display = 'none';
    // if(confirmJoinBtn) confirmJoinBtn.onclick = () => { /* Logic join group */ };

    // --- G√°n s·ª± ki·ªán cho c√°c n√∫t trong khu v·ª±c Chat ---
    if (sendBtn) sendBtn.onclick = sendMessage;
    if (cancelReplyBtn) cancelReplyBtn.onclick = cancelReply;
    if (cancelEditBtn) cancelEditBtn.onclick = cancelEdit;
    if (cancelPreviewBtn) cancelPreviewBtn.onclick = cancelImagePreview;
    if (closeInfoBtn && chatInfoPanel) closeInfoBtn.onclick = () => chatInfoPanel.classList.remove('open');
    if (toastCloseBtn && toast) toastCloseBtn.onclick = () => toast.style.display = 'none';
    if (lightboxCloseBtn && imageLightbox) lightboxCloseBtn.onclick = () => imageLightbox.style.display = 'none';
    if (imageLightbox) imageLightbox.onclick = (e) => { if (e.target === imageLightbox) imageLightbox.style.display = 'none'; };

    // --- LOGIC INPUT TEXT V√Ä CH·ªåN ·∫¢NH ---
    if (messageInput) {
        messageInput.addEventListener('paste', handlePasteImage);
        messageInput.addEventListener('input', handleTextInput);
        messageInput.addEventListener('keypress', handleEnterSend);
    }
    if (imageInput) imageInput.onchange = handleImageSelection;

    // --- C√ÅC LISTENER KH√ÅC (Context Menu, Mouse Over, Visibility) ---
    if (messagesContainer) {
        messagesContainer.addEventListener('contextmenu', showMessageContextMenu);
        messagesContainer.addEventListener('mouseover', handleMouseOverMessage);
    }
    document.addEventListener('visibilitychange', handleVisibilityChange);

    // ƒê√≥ng c√°c menu khi click ra ngo√†i
    document.addEventListener('click', (e) => {
        if (navSettingsMenu && !navSettingsMenu.contains(e.target) && e.target !== navAvatar) navSettingsMenu.style.display = 'none';
        if (addMenu && !addMenu.contains(e.target) && e.target !== addBtn) addMenu.style.display = 'none';
        if (messageContextMenu && !messageContextMenu.contains(e.target)) messageContextMenu.style.display = 'none';
         // ƒê√≥ng dropdown t√¨m ki·∫øm n·∫øu click ra ngo√†i
        if (globalSearch && searchDropdown && e.target !== globalSearch && !searchDropdown.contains(e.target)) searchDropdown.style.display = 'none';
    });
}

// --- C√ÅC H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN INPUT/·∫¢NH/VISIBILITY ---
function handlePasteImage(event) {
    const items = (event.clipboardData || window.clipboardData).items; let imageFile = null;
    for (let i = 0; i < items.length; i++) { if (items[i].kind === 'file' && items[i].type.startsWith('image/')) { imageFile = items[i].getAsFile(); break; }}
    if (imageFile && imagePreview && imagePreviewContainer && messageInput && chatInputContainer) {
        event.preventDefault(); selectedImageFile = imageFile; const reader = new FileReader();
        reader.onload = (ev) => { if(ev.target?.result) imagePreview.src = ev.target.result; imagePreviewContainer.style.display = 'block'; messageInput.placeholder = 'Th√™m ch√∫ th√≠ch...'; chatInputContainer.classList.add('has-text'); };
        reader.readAsDataURL(imageFile);
    }
}
function handleTextInput() {
    if(!messageInput || !chatInputContainer) return;
    const hasText = messageInput.value.trim().length > 0;
    chatInputContainer.classList.toggle('has-text', hasText || selectedImageFile != null);
    if(!currentChatId || !currentUser) return; const tRef = ref(rtdb, `/typing/${currentChatId}/${currentUser.uid}`);
    set(tRef, true); clearTimeout(typingTimer); typingTimer = setTimeout(() => set(tRef, false), 2000);
}
function handleEnterSend(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
function handleImageSelection(e) {
    const f = e.target.files?.[0]; if (!f || !imagePreview || !imagePreviewContainer || !messageInput || !chatInputContainer) return; selectedImageFile = f; const reader = new FileReader();
    reader.onload = (ev) => { if(ev.target?.result) imagePreview.src = ev.target.result; imagePreviewContainer.style.display = 'block'; messageInput.placeholder = 'Th√™m ch√∫ th√≠ch...'; chatInputContainer.classList.add('has-text'); };
    reader.readAsDataURL(f);
}
function handleMouseOverMessage(e) {
    const msgWrapper = e.target.closest('.msg-wrapper'); if (!msgWrapper?.dataset.key) return;
    let picker = msgWrapper.querySelector('.reaction-picker');
    const contentWrapper = msgWrapper.querySelector('.msg-content-wrapper'); // G·∫Øn v√†o ƒë√¢y
    if (!picker && contentWrapper) { picker = createReactionPicker(msgWrapper.dataset.key); contentWrapper.appendChild(picker); }
    // else if (!picker && !contentWrapper) { // Fallback n·∫øu c·∫•u tr√∫c HTML kh√°c
    //      picker = createReactionPicker(msgWrapper.dataset.key);
    //      msgWrapper.appendChild(picker);
    // }
    // Logic hi·ªán/·∫©n picker ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω b·∫±ng CSS :hover
}
function handleVisibilityChange() { if (!document.hidden) { unreadCount = 0; document.title = originalTitle; } }

// --- KH·ªûI ƒê·ªòNG KI·ªÇM TRA AUTH & INIT THEME ---
initTheme(); // G·ªçi initTheme ngay khi script load
// onAuthStateChanged s·∫Ω t·ª± ch·∫°y v√† g·ªçi initializeAppLogic sau khi user h·ª£p l·ªá

</script>
</body>
</html>