<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Qola Messenger</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');

:root{
  --accent-1:#60a5fa;
  --accent-2:#2563eb;
  --bg-page:linear-gradient(135deg,#0f172a,#1e293b);
  --glass:rgba(255,255,255,0.06);
  --glass-2:rgba(255,255,255,0.08);
  /* --- THAY ƒê·ªîI ·ªû ƒê√ÇY --- */
  /* T·ªõ ƒë√£ ƒë·ªïi m√†u n·ªÅn sang m√†u t·ªëi v√† tƒÉng ƒë·ªô ƒë·ª•c l√™n 75% */
  --glass-3:rgba(30, 41, 59, 0.75);
  --text:#e5e7eb;
  --text-2:#cbd5e1;
  --border:rgba(255,255,255,0.12);
  --bubble-me: linear-gradient(135deg,#3b82f6,#2563eb);
  --bubble-you: rgba(255,255,255,0.15);
  --input:#0b1220;
  --shadow: 0 18px 60px rgba(0,0,0,.35);
  --recalled-bg: rgba(255,255,255,0.1);
  --skeleton-bg: rgba(255,255,255,0.08);
}

/* TH√äM KH·ªêI CSS N√ÄY V√ÄO STYLE */

/* ·∫®n b·∫£ng ch·ªçn reaction khi tin nh·∫Øn b·ªã thu h·ªìi */
.msg-wrapper .recalled-message + .reaction-picker,
.msg-wrapper .recalled-message ~ .reaction-picker { /* D√πng ~ ƒë·ªÉ bao qu√°t h∆°n */
    display: none !important;
    pointer-events: none;
}

/* ·∫®n b·∫£ng t·ªïng k·∫øt reaction khi tin nh·∫Øn b·ªã thu h·ªìi */
.msg-wrapper .recalled-message + .reactions-display,
.msg-wrapper .recalled-message ~ .reactions-display { /* D√πng ~ */
    display: none !important;
    pointer-events: none;
}

/* TH√äM KH·ªêI CSS N√ÄY V√ÄO NGAY D∆Ø·ªöI :root */
.light {
  --bg-page: linear-gradient(135deg,#a1c4fd,#c2e9fb);
  --glass: rgba(255,255,255,0.5);
  --glass-2: rgba(255,255,255,0.6);
  --glass-3: rgb(249, 250, 251);
  --text:#0f172a;
  --text-2:#334155;
  --border: rgba(0,0,0,0.1);
  --bubble-me: linear-gradient(135deg,#007aff,#0056b3);
  --bubble-you: rgba(229,229,234,0.92);
  --input: rgba(255,255,255,0.85);
  --shadow: 0 18px 60px rgba(0,0,0,.2);
  --recalled-bg: rgba(0,0,0,0.05);
  --skeleton-bg: rgba(0,0,0,0.08);
}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg-page); color:var(--text);
  overflow:hidden; display:flex;
}

/* --- START: Giao di·ªán to√†n m√†n h√¨nh --- */
.container{
    width: 100%;
    height: 100%;
    margin-top: 0;
    border-radius: 0;
    overflow: hidden;
    display: flex;
    background: var(--glass-2);
    border: 1px solid var(--border);
    backdrop-filter: blur(22px);
    box-shadow: var(--shadow);
    position: relative;
}

body.is-hiding-status .status.online {
    /* ...bu·ªôc t·∫•t c·∫£ c√°c ch·∫•m xanh online ph·∫£i tr·ªü v·ªÅ m√†u x√°m offline */
    background: #64748b; 
}
/* --- END: Giao di·ªán to√†n m√†n h√¨nh --- */

#sidebar{width:36%; max-width:420px; padding:16px; border-right:1px solid var(--border); display:flex; flex-direction:column; gap:14px; position:relative}
.sidebar-head{display:flex; align-items:center; gap:12px; padding-bottom: 10px;}
.sidebar-title{font-size:22px; font-weight:700}

/* THAY TH·∫æ TO√ÄN B·ªò CSS C≈® CHO 2 KH·ªêI N√ÄY B·∫∞NG C√ÅI M·ªöI */
.sidebar-head {
    display: flex;
    align-items: center;
    gap: 12px;
    padding-bottom: 10px;
    position: relative; /* Th√™m d√≤ng n√†y ƒë·ªÉ ƒë·ªãnh v·ªã menu con */
}

#add-btn {
    background: var(--glass-border);
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 12px;
    color: var(--text-secondary);
    font-size: 24px;
    font-weight: 500;
    cursor: pointer;
    margin-left: auto;
    transition: all 0.2s;
    position: relative; 
    z-index: 30;
}
#add-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: var(--text-primary);
}

/* --- START: CSS cho thanh t√¨m ki·∫øm m·ªõi --- */
#sidebar-search-container {
    position: relative; /* Quan tr·ªçng ƒë·ªÉ ƒë·ªãnh v·ªã dropdown */
    padding-bottom: 10px;
}
#global-search{
    width: 100%;
    padding: 12px 16px;
    border: none;
    outline: none;
    border-radius: 12px;
    background: var(--input);
    color: var(--text);
    font-size: 14px;
}
#search-dropdown{
    position:absolute;
    top: 50px;
    left: 0;
    right: 0;
    width: auto;
    margin: 0;
    background:var(--glass-3);
    border:1px solid var(--border);
    border-radius:16px;
    /* --- THAY ƒê·ªîI ·ªû ƒê√ÇY --- */
    /* T·ªõ tƒÉng ƒë·ªô m·ªù l√™n m·ªôt ch√∫t ƒë·ªÉ hi·ªáu ·ª©ng ƒë·∫πp h∆°n */
    backdrop-filter:blur(18px);
    box-shadow:var(--shadow);
    max-height:52vh;
    overflow:auto;
    display:none;
    padding:6px 6px 10px;
    z-index: 100;
}
/* --- END: CSS cho thanh t√¨m ki·∫øm m·ªõi --- */

.section-title{font-size:12px; opacity:.8; margin:8px 6px}
.result-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:12px; cursor:pointer; }
.result-item:hover{background:var(--glass)}
.result-left{display:flex; align-items:center; gap:10px; min-width:0}
.result-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
.result-name{font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.result-sub{font-size:12px; color:var(--text-2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.result-actions{display:flex; gap:8px}
.result-action { display: flex; align-items: center; justify-content: flex-end; }
.add-friend-btn { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; border: none; padding: 6px 10px; border-radius: 8px; font-size: 13px; cursor: pointer; transition: 0.2s; }
.add-friend-btn:hover { transform: scale(1.05); opacity: 0.9; }
.add-friend-btn:disabled { background: rgba(255,255,255,0.3); cursor: default; }
.friend-label { font-size: 13px; opacity: 0.7; }

.list-title{font-size:13px; color:var(--text-2); margin:4px 0}
ul{list-style:none}
/* --- START: S·ª≠a chi·ªÅu cao danh s√°ch cho ph√π h·ª£p --- */
#friend-list,#group-list{
    overflow:auto;
    max-height:calc(100vh - 250px); /* TƒÉng kh√¥ng gian hi·ªÉn th·ªã */
    padding-right:6px
}
/* --- END: S·ª≠a chi·ªÅu cao danh s√°ch --- */

.item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px; border-radius:12px; cursor:pointer; }
.item:hover{background:var(--glass)}
.item-left{min-width:0; display:flex; align-items:center; gap:10px}
.item-name{ white-space: normal; word-break: break-word; }
.item-last-msg { font-size: 13px; color: var(--text-2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
.beta-tag { font-size: 10px; background-color: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-left: 8px; }
.status{width:10px; height:10px; border-radius:50%; background:#64748b}
.status.online{background:#22c55e}

.sidebar-loader .skeleton-item { display: flex; align-items: center; gap: 10px; padding: 12px; }
.skeleton { background: var(--skeleton-bg); position: relative; overflow: hidden; }
.skeleton-circle { width: 40px; height: 40px; border-radius: 50%; }
.skeleton-line { height: 16px; border-radius: 6px; flex: 1; }
.skeleton::after { content: ''; position: absolute; inset: 0; transform: translateX(-100%); background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent); animation: shimmer 1.5s infinite; }
@keyframes shimmer { 100% { transform: translateX(100%); } }
#sidebar-lists { display: none; }
#sidebar.loaded #sidebar-lists { display: block; }
#sidebar.loaded #sidebar-loader { display: none; }

.sidebar-footer{ position:absolute; left:12px; right:12px; bottom:12px; display:flex; align-items:center; justify-content:space-between; gap:12px; background:var(--glass); border:1px solid var(--border); border-radius:14px; padding:8px 10px; }
#sidebar-avatar{ width:42px; height:42px; border-radius:50%; object-fit:cover; border:2px solid rgba(255,255,255,.25); cursor:pointer; }
.settings{ display:flex; align-items:center; gap:8px; }
#open-settings{ border:1px solid var(--border); background:transparent; color:var(--text); border-radius:12px; padding:8px 12px; cursor:pointer; }
.settings-menu{
    position:absolute;
    bottom:60px;
    left:10px;
    width:220px;
    display:none;
    background:var(--glass-3);
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
    box-shadow:var(--shadow);
    z-index: 20;
    /* --- TH√äM V√ÄO ƒê√ÇY --- */
    /* Th√™m hi·ªáu ·ª©ng m·ªù cho ƒë·ªìng b·ªô v·ªõi thanh t√¨m ki·∫øm */
    backdrop-filter: blur(18px);
}
.settings-row{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px; border-radius:10px}
.settings-row:hover{background:var(--glass)}
.switch{position:relative; width:44px; height:24px; background:var(--glass); border:1px solid var(--border); border-radius:999px}
.switch::after{ content:''; position:absolute; width:18px; height:18px; border-radius:50%; background:linear-gradient(135deg,var(--accent-1),var(--accent-2)); top:2px; left:3px; transition:.2s; }
.switch.on::after{left:23px}

#chat-window{flex:1; display:flex; flex-direction:column; padding:20px; position:relative;}
#chat-header{display:flex; align-items:center; justify-content:space-between; padding-bottom:12px; border-bottom:1px solid var(--border); gap: 12px;}
#current-chat-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border); }
#current-chat-friend-name{font-size:18px; font-weight:700}
#messages-container{ flex:1; overflow:auto; display:flex; flex-direction:column; gap:2px; padding:14px 2px; scrollbar-width:thin; }
#messages-container::-webkit-scrollbar{width:8px}
#messages-container::-webkit-scrollbar-thumb{background:var(--glass-3); border-radius:10px}
#messages-container::-webkit-scrollbar-track{background:transparent}
.msg-wrapper { position: relative; margin: 6px 0; align-self: flex-start; max-width: 70%; display: flex; gap: 10px; align-items: flex-end; }
.msg-wrapper:hover .reaction-picker { opacity: 1; transform: translateY(0) scale(1); }
.msg-wrapper.sent { align-self: flex-end; }
.msg-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-bottom: 6px; cursor: pointer; }
.msg-wrapper.sent .msg-avatar { display: none; }
.msg-sender-name { font-size: 13px; font-weight: 500; color: var(--text-2); margin-bottom: 4px; }
.msg { background: var(--bubble-you); color: var(--text); padding: 10px 14px; border-radius: 18px; display: inline-block; word-break: break-word; line-height: 1.4em; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: background 0.3s ease; position: relative; }
.msg.sent { background: var(--bubble-me); color: #fff; box-shadow: 0 2px 8px rgba(37,99,235,0.4); }
.msg img { max-width: 100%; border-radius: 14px; margin-top: 5px; cursor: pointer; }
.msg-meta, .msg-status { font-size: 11px; opacity: 0.7; text-align: right; margin-top: 4px; }
.sent .msg-status { color: rgba(255,255,255,0.7); }
.recalled-message { font-style: italic; color: var(--text-2); background-color: var(--recalled-bg); border: 1px dashed var(--border); padding: 8px 12px; border-radius: 12px; }
.reply-quote { background: var(--glass); padding: 6px 10px; border-left: 3px solid var(--accent-1); margin-bottom: 8px; border-radius: 4px; }
.reply-quote .sender { font-weight: 600; font-size: 13px; }
.reply-quote .text { font-size: 13px; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.edited-label { margin-left: 6px; font-style: italic; opacity: 0.8; font-size: 10px; }

#typing-indicator{height:22px; font-size:13px; font-style:italic; color:var(--text-2)}
#image-preview-container, #reply-preview-container, #edit-preview-container { display:none; background:var(--glass); border:1px solid var(--border); border-radius:12px; padding: 8px 12px; margin-bottom:8px; position:relative; }
#image-preview{max-height:130px; border-radius:8px}
#cancel-preview-btn{position:absolute; right:-6px; top:-6px; width:22px; height:22px; border-radius:50%; border:none; background:#111; color:#fff; cursor:pointer}
#reply-preview-container { border-left: 3px solid var(--accent-1); }
#edit-preview-container { border-left: 3px solid #f59e0b; }
#reply-preview-sender, #edit-preview-title { font-weight: 600; font-size: 13px; }
#edit-preview-title { color: #f59e0b; }
#reply-preview-text, #edit-preview-text { font-size: 13px; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#edit-preview-text { font-style: italic; }
#cancel-reply-btn, #cancel-edit-btn { position:absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-2); cursor: pointer; font-size: 16px; padding: 5px; }

.chat-input { display: flex; gap: 10px; align-items: center; padding-top: 15px; margin-top: auto; border-top: 1px solid var(--border); }
#message-input{ flex:1; border:1px solid var(--border); border-radius:16px; padding:12px 14px; background:var(--input); color:var(--text) }
#send-btn,.image-upload-label{ border:none; border-radius:12px; padding:12px 16px; color:#fff; background:linear-gradient(135deg,var(--accent-1),var(--accent-2)); cursor:pointer; flex-shrink: 0; }
#send-btn[disabled]{opacity:.6; cursor:not-allowed}
.image-upload-label{background:transparent; color:var(--accent-1); border:1px solid var(--border)}
#inactive-chat-indicator { text-align: center; padding: 12px; margin-top: 15px; border-radius: 12px; background: rgba(0,0,0,0.15); color: var(--text-2); font-style: italic; font-size: 14px; border: 1px solid var(--border); }
.message-date-separator { text-align: center; margin: 18px 0; font-size: 13px; color: rgba(255,255,255,0.6); font-weight: 500; width: 100%; }
.message-date-separator::before, .message-date-separator::after { content: ""; position: relative; display: inline-block; width: 30%; height: 1px; background: rgba(255,255,255,0.1); top: -3px; margin: 0 8px; }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(12px); display: flex; justify-content: center; align-items: center; z-index: 5000; }
.modal-content {
    background: rgba(22, 25, 35, 0.85);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    /* TƒÉng padding cho tho√°ng h∆°n */
    padding: 30px 35px; 
    /* TƒÉng chi·ªÅu r·ªông t·ªëi ƒëa */
    width: min(90vw, 520px); 
    color: #fff;
    text-align: left;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    animation: fadeIn .3s ease;
}cho ti√™u ƒë·ªÅ modal n·ªïi b·∫≠t h∆°n */
.modal-content h2 {
    text-align: center;
    margin-bottom: 25px; /* TƒÉng kho·∫£ng c√°ch */
    font-size: 22px; /* TƒÉng k√≠ch th∆∞·ªõc ch·ªØ */
    padding-bottom: 15px; /* Th√™m kho·∫£ng ƒë·ªám d∆∞·ªõi */
    border-bottom: 1px solid var(--glass-border); /* Th√™m ƒë∆∞·ªùng k·∫ª ngang */
    background: -webkit-linear-gradient(45deg, var(--accent-1), #c084fc); /* T·∫°o d·∫£i m√†u gradient */
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    display: flex; /* CƒÉn ch·ªânh icon v√† ch·ªØ */
    align-items: center;
    justify-content: center;
    gap: 10px; /* Kho·∫£ng c√°ch gi·ªØa icon v√† ch·ªØ */
}

/* Th√™m icon cho ti√™u ƒë·ªÅ l·ªùi m·ªùi k·∫øt b·∫°n */
#friend-request-modal .modal-content h2::before {
    font-size: 24px;
    display: inline-block;
    filter: grayscale(100%) contrast(200%); /* Hi·ªáu ·ª©ng cho icon */
}
@keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to {opacity:1; transform:scale(1);} }
.btn{ padding:8px 12px; border:none; border-radius:10px; background:linear-gradient(135deg,var(--accent-1),var(--accent-2)); color:#fff; cursor:pointer; }
.btn-ghost, .cancel-btn { background: rgba(255,255,255,0.15); color: #fff; border: none; padding: 10px 14px; border-radius: 10px; cursor: pointer; }
.danger-btn { background: linear-gradient(135deg, #ef4444, #b91c1c); }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
.form-label { font-size: 14px; color: var(--text-2); margin-bottom: 6px; display: block; }
.modal-content input, .modal-content textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--input); color: var(--text); outline: none; font-size: 14px; margin-bottom: 15px; }
.clickable{cursor:pointer}
.hidden{display:none}

/* C√°c CSS kh√°c... (gi·ªØ nguy√™n kh√¥ng ƒë·ªïi) */
/* T√åM V√Ä THAY TH·∫æ TO√ÄN B·ªò RULE CSS C≈® B·∫∞NG C√ÅI N√ÄY */
.verified-tick {
    display: inline-block;
    width: 1.1em; /* TƒÉng nh·∫π k√≠ch th∆∞·ªõc cho c√¢n ƒë·ªëi h∆°n */
    height: 1.1em;
    margin-left: 5px;
    vertical-align: -0.2em; /* Tinh ch·ªânh l·∫°i ƒë·ªÉ icon n·∫±m gi·ªØa d√≤ng ch·ªØ */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2360a5fa'%3E%3Cpath fill-rule='evenodd' d='M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.06 0l4-5.5z' clip-rule='evenodd' /%3E%3C/svg%3E");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
}

#add-btn {
    background: var(--glass-border);
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 12px;
    color: var(--text-secondary);
    font-size: 24px;
    font-weight: 500;
    cursor: pointer;
    margin-left: auto; /* ƒê·∫©y n√∫t sang ph·∫£i */
    transition: all 0.2s;
    position: relative; /* Th√™m d√≤ng n√†y */
    z-index: 30;        /* Th√™m d√≤ng n√†y */
}
#add-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: var(--text-primary);
}

/* --- CSS M·ªöI CHO POPUP G·ª¢I √ù TAG (@) --- */
.suggestion-popup {
    position: absolute;
    bottom: 75px; /* N·∫±m ngay tr√™n thanh chat input */
    left: 15px;
    right: 15px;
    max-height: 200px;
    overflow-y: auto;
    background: var(--glass-3); /* D√πng m√†u glass-3 cho ƒë·ªìng b·ªô */
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 14px;
    box-shadow: 0 -8px 20px rgba(0,0,0,0.2);
    z-index: 100;
    display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
    padding: 6px;
    scrollbar-width: thin;
}
.suggestion-popup::-webkit-scrollbar{ width: 6px; }
.suggestion-popup::-webkit-scrollbar-thumb{ background: var(--glass); border-radius: 6px; }

.suggestion-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-radius: 10px;
    cursor: pointer;
    color: var(--text-primary);
    transition: background-color 0.2s;
}
.suggestion-item:hover {
    background-color: var(--glass);
}
.suggestion-item img {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
}
.suggestion-item .name {
    font-weight: 500;
}
.suggestion-item .all {
    font-weight: 600;
    color: var(--accent-1);
}

/* --- CSS M·ªöI CHO TIN NH·∫ÆN ƒê∆Ø·ª¢C TAG --- */

/* L√†m n·ªïi b·∫≠t c·∫£ bong b√≥ng chat n·∫øu c·∫≠u ƒë∆∞·ª£c tag */
.msg-wrapper.mentioned-me .msg {
    background-color: rgba(96, 165, 250, 0.25); /* N·ªÅn xanh nh·∫π */
    border: 1px solid var(--accent-1);
}
/* Trong theme s√°ng th√¨ d√πng m√†u kh√°c */
.light .msg-wrapper.mentioned-me .msg {
     background-color: rgba(0, 122, 255, 0.15);
     border: 1px solid var(--accent-2);
}

/* L√†m n·ªïi b·∫≠t ph·∫ßn @username b√™n trong tin nh·∫Øn */
.mention {
    font-weight: 600;
    color: var(--accent-1);
    background-color: rgba(96, 165, 250, 0.15);
    padding: 1px 4px;
    border-radius: 4px;
}

.lightbox-overlay { position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; animation: fadeIn 0.3s; }
.lightbox-content { max-width: 90%; max-height: 90%; object-fit: contain; }
.lightbox-close-btn { position: absolute; top: 20px; right: 35px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; transition: 0.2s; }
.lightbox-close-btn:hover { color: #bbb; }
#friend-request-list {
    max-height: 350px;
    min-height: 200px; /* Th√™m d√≤ng n√†y ƒë·ªÉ ƒë·∫∑t chi·ªÅu cao t·ªëi thi·ªÉu */
    overflow-y: auto;
    margin: 15px 0;
    /* Th√™m 3 d√≤ng n√†y ƒë·ªÉ cƒÉn gi·ªØa n·ªôi dung khi tr·ªëng */
    display: flex;
    align-items: center;
    justify-content: center;
}

/* --- B∆Ø·ªöC 3: T√åM V√Ä THAY TH·∫æ RULE CSS N√ÄY --- */
/* TƒÉng k√≠ch th∆∞·ªõc cho c√°c n√∫t Ch·∫•p nh·∫≠n/T·ª´ ch·ªëi */
.friend-req-btn {
    padding: 8px 14px; /* TƒÉng padding */
    border: none;
    border-radius: 8px;
    font-size: 14px; /* TƒÉng c·ª° ch·ªØ */
    cursor: pointer;
    transition: .2s;
}
.friend-req-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px 12px; margin-bottom: 8px; transition: background .2s; }
.friend-req-item:hover { background: rgba(255,255,255,0.1); }
.friend-req-name { font-weight: 500; text-align: left; }
.friend-req-buttons { display: flex; gap: 6px; }
.accept-btn { background: linear-gradient(135deg,#22c55e,#15803d); color: #fff; }
.reject-btn { background: rgba(239,68,68,0.9); color: #fff; }
.msg-content-wrapper {
    position: relative;
}

/* --- CSS M·ªöI CHO HI·ªÜU ·ª®NG LOADING N√öT G·ª¨I --- */

/* Hi·ªáu ·ª©ng xoay tr√≤n */
@keyframes spin { 
    100% { transform: rotate(360deg); } 
}

/* M·∫∑c ƒë·ªãnh ·∫©n icon spinner */
#send-btn .spinner-icon {
    display: none;
}

/* Khi n√∫t c√≥ class 'loading'... */
#send-btn.loading {
    cursor: wait; /* ƒê·ªïi con tr·ªè chu·ªôt th√†nh d·∫°ng ch·ªù */
}
#send-btn.loading .send-icon {
    display: none; /* ...·∫©n icon g·ª≠i ƒëi */
}
#send-btn.loading .spinner-icon {
    display: block; /* ...hi·ªán icon spinner l√™n */
    animation: spin 1.2s linear infinite; /* ...v√† cho n√≥ xoay */
}
/* CSS m·ªõi cho n√∫t m·ªü l·ªùi m·ªùi k·∫øt b·∫°n */
#open-friend-req-btn {
    position: absolute;
    bottom: 75px; /* TƒÉng kho·∫£ng c√°ch t·ª´ d∆∞·ªõi l√™n */
    left: 16px;
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
    color: #fff;
    border: none;
    border-radius: 16px; /* Bo g√≥c vu√¥ng h∆°n */
    width: 48px;
    height: 48px;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

#open-friend-req-btn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 25px rgba(37, 99, 235, 0.4);
}

/* Th√™m hi·ªáu ·ª©ng ch·∫•m ƒë·ªè th√¥ng b√°o (s·∫Ω d√πng JS ƒë·ªÉ b·∫≠t/t·∫Øt) */
#open-friend-req-btn::after {
    content: '';
    position: absolute;
    top: 6px;
    right: 6px;
    width: 10px;
    height: 10px;
    background-color: #ef4444; /* M√†u ƒë·ªè */
    border-radius: 50%;
    border: 2px solid var(--bg-light);
    transform: scale(0); /* M·∫∑c ƒë·ªãnh ·∫©n ƒëi */
    transition: transform 0.2s ease-in-out;
}

#open-friend-req-btn.has-new-request::after {
    transform: scale(1); /* Hi·ªán l√™n khi c√≥ l·ªùi m·ªùi m·ªõi */
}
#group-members-checklist { max-height: 200px; overflow-y: auto; text-align: left; border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin: 10px 0 20px; background: var(--input); }
#group-members-checklist label { display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 8px; cursor: pointer; }
#group-members-checklist label:hover { background-color: var(--glass); }
#group-members-checklist input[type="checkbox"] { width: 18px; height: 18px; }
#open-info-btn, #group-info-btn { border:1px solid var(--border); background:transparent; color:var(--text); border-radius:12px; padding:8px 12px; cursor:pointer; }
#chat-info-panel { position: absolute; right: -340px; top: 0; width: 320px; height: 100%; background: rgba(22, 25, 35, 0.85); backdrop-filter: blur(20px); border-left: 1px solid rgba(255,255,255,0.08); box-shadow: -8px 0 25px rgba(0,0,0,0.4); color: #f3f4f6; transition: right .3s ease; display: flex; flex-direction: column; z-index: 1000; }
#chat-info-panel.open { right: 0; }
#chat-info-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); }
#chat-info-header h3 { font-size: 18px; font-weight: 600; color: #fff; }
#close-info-btn { background: rgba(255,255,255,0.2); border: none; border-radius: 8px; width: 30px; height: 30px; color: #fff; cursor: pointer; transition: .2s; }
#close-info-btn:hover { background: rgba(255,255,255,0.4); }
.chat-info-body { flex: 1; overflow-y: auto; padding: 16px; }
.chat-info-section { text-align: center; margin-bottom: 25px; }
.chat-info-avatar { width: 95px; height: 95px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); box-shadow: 0 0 15px rgba(59,130,246,0.3); object-fit: cover; }
.chat-info-name { font-size: 18px; font-weight: 600; margin: 10px 0; }
.chat-info-body h5 { font-size: 14px; text-transform: uppercase; letter-spacing: .5px; color: rgba(255,255,255,0.75); margin-bottom: 10px; text-align: left; }
.sent-images-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 25px; }
.sent-images-grid img { width: 100%; border-radius: 8px; cursor: pointer; transition: 0.2s; }
.sent-images-grid img:hover { transform: scale(1.06); box-shadow: 0 4px 10px rgba(59,130,246,0.5); }
.chat-actions button { width: 100%; padding: 11px; border: none; border-radius: 10px; font-size: 15px; color: #fff; cursor: pointer; margin-top: 10px; transition: 0.25s; }
.primary-btn { background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 10px; padding: 8px 14px; color: white; font-weight: 500; cursor: pointer; }
.primary-btn:hover { filter: brightness(1.1); }
/* --- THAY TH·∫æ TO√ÄN B·ªò CSS C≈® CHO KHU V·ª∞C CHAT INPUT B·∫∞NG KH·ªêI N√ÄY --- */

.chat-input {
    display: flex; /* ƒê·∫£m b·∫£o l√† flexbox */
    gap: 0; /* B·ªè gap n·∫øu c√≥ */
    align-items: flex-end; /* CƒÉn c√°c item xu·ªëng d∆∞·ªõi */
    padding-top: 15px;
    margin-top: auto;
    border-top: 1px solid var(--border);
}

.image-upload-label { /* Gi·ªØ nguy√™n ho·∫∑c ch·ªânh s·ª≠a n·∫øu c·∫ßn */
    background: transparent;
    color: var(--accent-1);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 16px;
    cursor: pointer;
    flex-shrink: 0;
    margin-right: 10px; /* Th√™m kho·∫£ng c√°ch ph·∫£i */
}

#message-input {
    transition: width 0.3s ease; /* Hi·ªáu ·ª©ng co gi√£n */
    flex: 1; /* Lu√¥n chi·∫øm ph·∫ßn c√≤n l·∫°i */
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 12px 14px;
    background: var(--input);
    color: var(--text);
    margin: 0; /* B·ªè margin c≈© */
}

#send-btn {
    width: 0; /* M·∫∑c ƒë·ªãnh ·∫©n n√∫t g·ª≠i */
    padding: 12px 0;
    margin: 0 0 0 10px; /* Ch·ªâ c·∫ßn margin tr√°i */
    border: none;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
    color: #fff;
    transform: scale(0.8);
    opacity: 0;
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
    flex-shrink: 0; /* NgƒÉn n√∫t b·ªã co l·∫°i */
    /* CƒÉn gi·ªØa icon b√™n trong */
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Khi c√≥ ch·ªØ trong input */
.chat-input.has-text #send-btn {
    width: 48px;  /* Chi·ªÅu r·ªông c·ªë ƒë·ªãnh */
    padding: 12px; /* Padding ƒë·ªÅu */
    transform: scale(1);
    opacity: 1;
}

/* ·∫®n n√∫t khi disabled (tr∆∞·ªùng h·ª£p b·ªã ch·∫∑n chat) */
#send-btn[disabled]{opacity:.6; cursor:not-allowed}

/* --- CSS M·ªöI CHO HI·ªÜU ·ª®NG LOADING N√öT G·ª¨I --- */
@keyframes spin { 
    100% { transform: rotate(360deg); } 
}
#send-btn .spinner-icon {
    display: none; /* M·∫∑c ƒë·ªãnh ·∫©n spinner */
}
#send-btn.loading {
    cursor: wait; /* ƒê·ªïi con tr·ªè */
}
#send-btn.loading .send-icon {
    display: none; /* ·∫®n icon g·ª≠i */
}
#send-btn.loading .spinner-icon {
    display: block; /* Hi·ªán spinner */
    animation: spin 1.2s linear infinite; /* Xoay spinner */
}
#block-user-btn, #unblock-user-btn { background: linear-gradient(135deg, #ef4444, #b91c1c); }
#unblock-user-btn { background: linear-gradient(135deg, #22c55e, #16a34a); }
#block-user-btn:hover, #unblock-user-btn:hover { filter: brightness(1.1); }
#remove-friend-btn { background: linear-gradient(135deg, #6b7280, #4b5563); opacity: 0.9; }
#remove-friend-btn:hover { opacity: 1; filter: brightness(1.1); }
#leave-group-btn { background: linear-gradient(135deg, #ef4444, #b91c1c); }
#group-members-list {list-style: none; padding: 0; margin-bottom: 20px; display: flex; flex-direction: column; gap: 8px;}
.member-item { display: flex; justify-content: space-between; align-items: center; background: var(--glass); padding: 8px 12px; border-radius: 8px; }
.member-info { display: flex; flex-direction: column; align-items: flex-start; }
.member-name { font-weight: 500; }
.member-role { font-size: 12px; opacity: 0.7; padding: 2px 6px; border-radius: 6px; }
.role-admin { background-color: #a855f7; color: white; }
.role-moderator { background-color: #2563eb; color: white; }
.role-member { background-color: #4b5563; color: white; }
.member-actions button { background: none; border: 1px solid var(--border); color: var(--text-2); padding: 4px 8px; font-size: 11px; border-radius: 6px; cursor: pointer; margin-left: 4px; }
.member-actions button:hover { background: var(--glass-3); }
#message-context-menu { position: fixed; display: none; background: var(--glass-3); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 12px; padding: 8px; box-shadow: var(--shadow); z-index: 9999; }
.context-menu-btn { display: block; width: 100%; text-align: left; background: none; border: none; color: var(--text); padding: 10px 14px; border-radius: 8px; cursor: pointer; }
.context-menu-btn:hover { background: var(--glass); }
.context-menu-btn.danger { color: #f43f5e; }
.reaction-picker { position: absolute; top: -45px; background: var(--glass-3); backdrop-filter: blur(10px); border-radius: 20px; padding: 6px; display: flex; gap: 8px; box-shadow: var(--shadow); opacity: 0; transition: opacity 0.2s, transform 0.2s; pointer-events: none; z-index: 100; }
.msg-wrapper.sent .reaction-picker { right: 10px; }
.msg-wrapper.received .reaction-picker { left: 10px; }
.msg-wrapper:hover .reaction-picker { opacity: 1; transform: scale(1); pointer-events: all; }
.reaction-btn { font-size: 22px; cursor: pointer; transition: transform 0.15s; }
.reaction-btn:hover { transform: scale(1.2); }
.reactions-display { position: absolute; bottom: -10px; background: var(--glass-2); border-radius: 10px; padding: 2px 5px; display: flex; gap: 3px; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); cursor: pointer; }
.msg-wrapper.sent .reactions-display { right: 10px; }
.msg-wrapper.received .reactions-display { left: 0px; }

/* --- CSS M·ªöI CHO THANH NH·∫¨P TIN NH·∫ÆN ƒê·ªòNG --- */
.chat-input {
    gap: 0; /* B·ªè gap c≈© */
    align-items: flex-end; /* CƒÉn c√°c item xu·ªëng d∆∞·ªõi */
}
#message-input {
    /* Cho ph√©p co gi√£n v√† c√≥ hi·ªáu ·ª©ng */
    transition: width 0.3s ease;
    flex: 1; /* Lu√¥n chi·∫øm ph·∫ßn c√≤n l·∫°i */
    margin: 0 10px; /* T·∫°o kho·∫£ng c√°ch m·ªõi */
}
#send-btn {
    width: 0; /* M·∫∑c ƒë·ªãnh ·∫©n n√∫t g·ª≠i */
    padding: 12px 0;
    margin: 0;
    transform: scale(0.8);
    opacity: 0;
    overflow: hidden; /* ·∫®n icon khi co l·∫°i */
    transition: all 0.3s ease;
}
/* Khi c√≥ ch·ªØ, thanh input s·∫Ω co l·∫°i v√† n√∫t g·ª≠i hi·ªán ra */
.chat-input.has-text #send-btn {
    width: 48px;
    padding: 12px 16px;
    transform: scale(1);
    opacity: 1;
}

/* --- S·ª¨A L·ªñI MENU D√ÄI B·∫§T TH∆Ø·ªúNG --- */
#add-menu {
    height: auto !important; /* Quan tr·ªçng: ƒê·ªÉ menu t·ª± co gi√£n theo n·ªôi dung */
}

#reactions-modal .modal-content { text-align: center; width: 380px; }
#reactions-list { max-height: 300px; overflow-y: auto; margin: 15px 0; }
.reaction-user-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 8px; }
.reaction-user-item:hover { background: var(--glass); }
.reaction-user-info { display: flex; align-items: center; gap: 10px; }
.reaction-user-avatar { width: 36px; height: 36px; border-radius: 50%; }
.reaction-user-name { font-weight: 500; }
.reaction-emoji { font-size: 20px; }
#toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(22, 25, 35, 0.85); color: white; padding: 20px 30px; border-radius: 12px; z-index: 10000; backdrop-filter: blur(10px); border: 1px solid var(--border); box-shadow: var(--shadow); text-align: center; display: none; animation: fadeIn .3s ease; }
#toast-message { margin-bottom: 15px; }
#toast-close-btn { background: var(--accent-1); color: white; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; }
.report-form .form-label { text-align: left; margin-bottom: 10px; }
.report-reason-row { display: flex; align-items: center; padding: 12px; border-radius: 10px; border: 1px solid transparent; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
.report-reason-row:hover { background-color: var(--glass); }
.report-reason-row input[type="radio"] { display: none; }
.report-reason-row .custom-radio { width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 50%; margin-right: 12px; display: inline-block; position: relative; transition: border-color 0.2s; }
.report-reason-row input[type="radio"]:checked + .custom-radio { border-color: var(--accent-1); }
.report-reason-row input[type="radio"]:checked + .custom-radio::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 10px; height: 10px; border-radius: 50%; background-color: var(--accent-1); }
.report-reason-row.selected { background-color: var(--glass); border-color: var(--accent-1); }
#messages-container.selection-mode .msg-wrapper { cursor: pointer; padding: 4px; border-radius: 14px; border: 2px solid transparent; transition: border-color 0.2s, background-color 0.2s; }
#messages-container.selection-mode .msg-wrapper:hover { background-color: var(--glass); }
#messages-container.selection-mode .msg-wrapper.selected { border-color: var(--accent-1); background-color: rgba(96, 165, 250, 0.2); }
</style>
</head>
<body>

<div id="toast"><div id="toast-message"></div><button id="toast-close-btn">OK</button></div>
<div id="message-context-menu"></div>
<div id="image-lightbox" class="lightbox-overlay" style="display: none;"><span class="lightbox-close-btn">&times;</span><img class="lightbox-content" id="lightbox-img"></div>
<div id="friend-request-modal" class="modal-overlay" style="display:none;"><div class="modal-content"><h2>üì© L·ªùi M·ªùi K·∫øt B·∫°n</h2><div id="friend-request-list"></div><button id="close-friend-req-modal" class="cancel-btn">ƒê√≥ng</button></div></div>
<div id="create-group-modal" class="modal-overlay" style="display:none;"><div class="modal-content"><h2>T·∫°o nh√≥m m·ªõi</h2><input type="text" id="group-name-input" placeholder="Nh·∫≠p t√™n nh√≥m..."><h4>M·ªùi b·∫°n b√®</h4><div id="group-members-checklist"></div><div class="modal-actions"><button id="close-group-modal-btn" class="btn-ghost">H·ªßy</button><button id="confirm-create-group-btn" class="btn">T·∫°o Nh√≥m</button></div></div></div>
<div id="reactions-modal" class="modal-overlay" style="display:none;"><div class="modal-content"><h2>üëç L∆∞·ª£t b√†y t·ªè c·∫£m x√∫c</h2><div id="reactions-list"></div><button id="close-reactions-modal" class="btn-ghost" style="margin-top: 15px;">ƒê√≥ng</button></div></div>
<div id="edit-profile-modal" class="modal-overlay" style="display:none;"><div class="modal-content"><h2>üë§ Ch·ªânh s·ª≠a h·ªì s∆°</h2><label class="form-label" for="profile-display-name">T√™n hi·ªÉn th·ªã</label><input type="text" id="profile-display-name" placeholder="T√™n c·ªßa b·∫°n..."><label class="form-label" for="profile-bio">Gi·ªõi thi·ªáu (Bio)</label><textarea id="profile-bio" rows="3" placeholder="Vi·∫øt g√¨ ƒë√≥ v·ªÅ b·∫°n..."></textarea><label class="form-label" for="profile-avatar-url">URL ·∫¢nh ƒë·∫°i di·ªán</label><input type="text" id="profile-avatar-url" placeholder="https://example.com/avatar.png"><div class="modal-actions"><button id="cancel-profile-edit-btn" class="btn-ghost">H·ªßy</button><button id="save-profile-edit-btn" class="btn">L∆∞u thay ƒë·ªïi</button></div></div></div>
<div id="custom-confirm-modal" class="modal-overlay" style="display:none;"><div class="modal-content" style="width: 400px; text-align: center;"><h2 id="confirm-title">X√°c nh·∫≠n h√†nh ƒë·ªông</h2><p id="confirm-message" style="margin: 15px 0; color: var(--text-2); font-size: 15px;"></p><div class="modal-actions" style="justify-content: center;"><button id="confirm-cancel-btn" class="btn-ghost">H·ªßy</button><button id="confirm-ok-btn" class="btn danger-btn">OK</button></div></div></div>
<div id="report-user-modal" class="modal-overlay" style="display:none;"><div class="modal-content"><h2>‚ö†Ô∏è B√°o c√°o ng∆∞·ªùi d√πng</h2><p id="reporting-user-name" style="color: var(--text-2); margin-bottom: 20px;"></p><div id="report-form" class="form report-form"><label class="form-label">L√Ω do b√°o c√°o:</label><label class="report-reason-row"><input type="radio" name="reportReason" value="spam" checked><span class="custom-radio"></span>G·ª≠i tin nh·∫Øn r√°c (Spam)</label><label class="report-reason-row"><input type="radio" name="reportReason" value="harassment"><span class="custom-radio"></span>Qu·∫•y r·ªëi, b·∫Øt n·∫°t</label><label class="report-reason-row"><input type="radio" name="reportReason" value="inappropriate"><span class="custom-radio"></span>N·ªôi dung kh√¥ng ph√π h·ª£p</label><label class="report-reason-row"><input type="radio" name="reportReason" value="impersonation"><span class="custom-radio"></span>M·∫°o danh</label><label for="report-details" class="form-label" style="margin-top: 15px;">M√¥ t·∫£ th√™m (n·∫øu c√≥):</label><textarea id="report-details" rows="3" placeholder="Cung c·∫•p th√™m chi ti·∫øt v·ªÅ h√†nh vi..."></textarea><button id="attach-evidence-btn" class="btn-ghost" style="margin-top: 15px;">‚ûï ƒê√≠nh k√®m b·∫±ng ch·ª©ng (tin nh·∫Øn)</button><div id="evidence-preview" style="font-size: 13px; color: var(--text-2); margin-top: 8px; display: none;"></div></div><div class="modal-actions"><button id="cancel-report-btn" class="btn-ghost">H·ªßy</button><button id="submit-report-btn" class="btn danger-btn">G·ª≠i b√°o c√°o</button></div></div></div>

<div class="container" id="app" style="display:none;">
    <div id="sidebar">
        <div class="sidebar-head">
            <div class="sidebar-title">Qola Chat</div>
            <button id="add-btn" title="T√πy ch·ªçn m·ªõi">+</button> <div class="settings-menu" id="add-menu" style="left: auto; right: 16px; top: 60px; width: 180px;">
                <div class="settings-row clickable" id="create-group-from-menu">T·∫°o nh√≥m m·ªõi ‚ûï</div>
                <div class="settings-row clickable" id="add-friend-from-menu">Th√™m b·∫°n b√® üìß</div>
            </div>
        </div>
        <div id="sidebar-search-container">
            <input id="global-search" placeholder="T√¨m m·ªçi th·ª©: ng∆∞·ªùi d√πng, b·∫°n b√®, nh√≥m..." />
            <div id="search-dropdown"></div>
        </div>

        <div id="sidebar-loader">
            <div class="list-title">B·∫°n b√®</div>
            <div class="skeleton-item"><div class="skeleton skeleton-circle"></div><div class="skeleton skeleton-line"></div></div>
            <div class="skeleton-item"><div class="skeleton skeleton-circle"></div><div class="skeleton skeleton-line"></div></div>
            <div class="list-title">Nh√≥m</div>
            <div class="skeleton-item"><div class="skeleton skeleton-circle"></div><div class="skeleton skeleton-line"></div></div>
        </div>
        <div id="sidebar-lists">
            <div class="list-title">B·∫°n b√®</div><ul id="friend-list"></ul>
            <div class="list-title">Nh√≥m</div><ul id="group-list"></ul>
        </div>
        <button id="open-friend-req-btn" title="L·ªùi m·ªùi k·∫øt b·∫°n">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
        </button>
        <div class="sidebar-footer">
            <img id="sidebar-avatar" src="https://placehold.co/42x42/111/fff?text=Q" alt="avatar" title="M·ªü trang c√° nh√¢n" />
            <div class="settings">
                <button id="open-settings">‚öôÔ∏è C√†i ƒë·∫∑t</button>
                <div class="settings-menu" id="settings-menu">
                    <div class="settings-row clickable" id="go-to-settings">C√†i ƒë·∫∑t n√¢ng cao ‚öôÔ∏è</div>
                    <div class="settings-row clickable" id="go-login">ƒêƒÉng xu·∫•t</div>
                </div>
            </div>
        </div>
    </div>

    <div id="chat-window">
        <div id="chat-header">
            <img id="current-chat-avatar" src="https://placehold.co/40x40" alt="avatar" style="display: none;">
            <div id="current-chat-friend-name">Ch·ªçn cu·ªôc tr√≤ chuy·ªán</div>
            <div id="chat-header-buttons">
                <button id="open-info-btn" title="Th√¥ng tin">‚ò∞</button>
                <button id="group-info-btn" title="Th√¥ng tin nh√≥m">‚ò∞</button>
            </div>
        </div>
        <div id="messages-container"></div>
        <div id="typing-indicator"></div>

        <div id="reply-preview-container" style="display: none;">
            <div id="reply-preview-sender"></div>
            <div id="reply-preview-text"></div>
            <button id="cancel-reply-btn">‚úñ</button>
        </div>
        <div id="edit-preview-container" style="display: none;">
            <div id="edit-preview-title">‚úèÔ∏è ƒêang ch·ªânh s·ª≠a</div>
            <div id="edit-preview-text"></div>
            <button id="cancel-edit-btn">‚úñ</button>
        </div>
        <div id="image-preview-container" style="display: none;">
            <img id="image-preview" />
            <button id="cancel-preview-btn">‚úñ</button>
        </div>
        <div id="selection-bar" style="display: none; padding: 10px; background: var(--glass-3); border-top: 1px solid var(--border); text-align: right;">
            <span id="selection-count" style="margin-right: 15px; color: var(--text-2);">ƒê√£ ch·ªçn: 0</span>
            <button id="cancel-selection-btn" class="btn-ghost">H·ªßy</button>
            <button id="confirm-selection-btn" class="btn">Xong</button>
        </div>
            <div id="mention-suggestions" class="suggestion-popup">
        </div>
    <div class="chat-input">
        <label for="image-input" class="image-upload-label">üñºÔ∏è</label>
        <input id="image-input" type="file" accept="image/*" style="display:none" />
        <input id="message-input" placeholder="Nh·∫≠p tin nh·∫Øn..."/>

        <button id="send-btn">
            <svg class="send-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            <svg class="spinner-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>
        </button>
    </div>
        <div id="inactive-chat-indicator" style="display: none;">Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn cho ng∆∞·ªùi n√†y.</div>
    </div>

    <div id="chat-info-panel">
        <div id="chat-info-header">
            <h3>Th√¥ng tin</h3>
            <button id="close-info-btn">‚úñ</button>
        </div>
        <div class="chat-info-body">
            <div id="friend-info-content" style="display:none;">
                <div class="chat-info-section">
                    <img id="chat-friend-avatar" class="chat-info-avatar" src="https://placehold.co/80x80" alt="avatar">
                    <h4 id="chat-friend-name" class="chat-info-name">Ch∆∞a ch·ªçn</h4>
                </div>
                <h5>·∫¢nh ƒë√£ g·ª≠i</h5>
                <div id="sent-images-grid" class="sent-images-grid"></div>
                <div class="chat-actions">
                    <button id="block-user-btn">üö´ Ch·∫∑n ng∆∞·ªùi n√†y</button>
                    <button id="unblock-user-btn" style="display: none;">üîì B·ªè ch·∫∑n ng∆∞·ªùi n√†y</button>
                    <button id="remove-friend-btn">‚ùå X√≥a b·∫°n b√®</button>
                    <button id="report-user-btn" style="background: #a16207;">‚ö†Ô∏è B√°o c√°o ng∆∞·ªùi n√†y</button>
                </div>
            </div>
            <div id="group-info-content" style="display:none;">
                <div class="chat-info-section">
                    <img id="group-avatar" class="chat-info-avatar" src="https://placehold.co/80x80/EFEFEF/333333?text=G" alt="avatar nh√≥m">
                    <h4 id="group-name-display" class="chat-info-name">T√™n nh√≥m</h4>
                </div>
                <h5>Th√†nh vi√™n</h5>
                <ul id="group-members-list"></ul>
                <h5>·∫¢nh ƒë√£ g·ª≠i</h5>
                <div id="group-sent-images-grid" class="sent-images-grid"></div>
                <div class="chat-actions">
                    <button id="leave-group-btn">üö™ R·ªùi nh√≥m</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="join-group-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="text-align: center;">
        <div class="chat-info-section" style="margin-bottom: 15px;">
             <img id="join-group-avatar" class="chat-info-avatar" src="https://placehold.co/80x80" alt="avatar nh√≥m">
             <h3 id="join-group-name" class="chat-info-name" style="margin-top: 10px; margin-bottom: 5px; font-size: 20px;">T√™n nh√≥m</h3>
             <p id="join-group-member-count" style="color: var(--text-2); font-size: 14px; margin: 0;">... th√†nh vi√™n</p>
        </div>
        
        <p style="margin: 15px 0; color: var(--text-2);">B·∫°n c√≥ mu·ªën tham gia nh√≥m n√†y kh√¥ng?</p>
        
        <div class="modal-actions" style="justify-content: center;">
            <button id="cancel-join-group-btn" class="btn-ghost">H·ªßy</button>
            <button id="confirm-join-group-btn" class="btn">Tham gia ngay</button>
        </div>
    </div>
</div>

<div id="add-friend-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h2>Th√™m b·∫°n b√®</h2>
        <label for="add-friend-email-input" class="form-label">Nh·∫≠p email c·ªßa ng∆∞·ªùi b·∫°n mu·ªën k·∫øt b·∫°n:</label>
        <input type="email" id="add-friend-email-input" placeholder="nhapemail@qola.com">
        <div class="modal-actions">
            <button id="cancel-add-friend-btn" class="btn-ghost">H·ªßy</button>
            <button id="confirm-add-friend-btn" class="btn">G·ª≠i l·ªùi m·ªùi</button>
        </div>
    </div>
</div>

<script type="module">
/***** Qola Messenger ‚Äî index.app.js v9 (New Features) *****/
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, getDocs, setDoc, updateDoc, addDoc,
  collection, query, where, onSnapshot, serverTimestamp, limit, arrayUnion, arrayRemove, deleteField
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
import {
  getDatabase, ref, onValue, onChildAdded, onChildChanged, push, update as rtdbUpdate,
  set, onDisconnect, serverTimestamp as dbServerTimestamp, off, remove,
  query as rtdbQuery, orderByChild, limitToLast, get
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBuGG9WKYZHb1qbmihpJFjCBsTB_VJ_LvU",
    authDomain: "qola-web.firebaseapp.com",
    databaseURL: "https://qola-web-default-rtdb.firebaseio.com",
    projectId: "qola-web",
    storageBucket: "qola-web.firebasestorage.app",
    messagingSenderId: "477682993077",
    appId: "1:477682993077:web:7dce15eb2c365729173bfc"
};
const IMGBB_API_KEY = "e6c2724ff8344c073410da4876c3d35f";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const rtdb = getDatabase(app);

function initTheme() {
    const saved = localStorage.getItem('theme') || 'dark';
    document.body.classList.toggle('light', saved === 'light');
}
initTheme(); // G·ªçi h√†m ƒë·ªÉ ch·∫°y ngay l·∫≠p t·ª©c
// To√†n b·ªô c√°c DOM Elements v√† State Variables... (gi·ªØ nguy√™n kh√¥ng ƒë·ªïi)
const toast = document.getElementById('toast');
const toastMessage = document.getElementById('toast-message');
const chatInputContainer = document.querySelector('.chat-input');
const inactiveChatIndicator = document.getElementById('inactive-chat-indicator');
const toastCloseBtn = document.getElementById('toast-close-btn');
const messageContextMenu = document.getElementById('message-context-menu');
const replyPreviewContainer = document.getElementById('reply-preview-container');
const replyPreviewSender = document.getElementById('reply-preview-sender');
const replyPreviewText = document.getElementById('reply-preview-text');
const cancelReplyBtn = document.getElementById('cancel-reply-btn');
const reportUserModal = document.getElementById('report-user-modal');
const reportingUserName = document.getElementById('reporting-user-name');
const submitReportBtn = document.getElementById('submit-report-btn');
const cancelReportBtn = document.getElementById('cancel-report-btn');
const reportDetails = document.getElementById('report-details');
let reportingUser = null;
const confirmModal = document.getElementById('custom-confirm-modal');
const confirmMessage = document.getElementById('confirm-message');
const confirmOkBtn = document.getElementById('confirm-ok-btn');
const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
const appRoot = document.getElementById('app');
const imageLightbox = document.getElementById('image-lightbox');
const lightboxImg = document.getElementById('lightbox-img');
const lightboxCloseBtn = document.querySelector('.lightbox-close-btn');
const globalSearch = document.getElementById('global-search');
const searchDropdown = document.getElementById('search-dropdown');
const openFriendReqBtn = document.getElementById('open-friend-req-btn');
const friendReqModal = document.getElementById('friend-request-modal');
const friendReqList = document.getElementById('friend-request-list');
const closeFriendReqModal = document.getElementById('close-friend-req-modal');
const createGroupBtn = document.getElementById('create-group-btn');
const createGroupModal = document.getElementById('create-group-modal');
const closeGroupModalBtn = document.getElementById('close-group-modal-btn');
const groupNameInput = document.getElementById('group-name-input');
const groupMembersChecklist = document.getElementById('group-members-checklist');
const confirmCreateGroupBtn = document.getElementById('confirm-create-group-btn');
const friendList = document.getElementById('friend-list');
const groupList = document.getElementById('group-list');
const sidebarAvatar = document.getElementById('sidebar-avatar');
const sidebar = document.getElementById('sidebar');
const openSettings = document.getElementById('open-settings');
const settingsMenu = document.getElementById('settings-menu');
const themeSwitch  = document.getElementById('theme-switch');
const goLogin = document.getElementById('go-login');
const currentChatFriendName = document.getElementById('current-chat-friend-name');
const messagesContainer = document.getElementById('messages-container');
const typingIndicator = document.getElementById('typing-indicator');
let messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const imageInput = document.getElementById('image-input');
const imagePreviewContainer = document.getElementById('image-preview-container');
const imagePreview = document.getElementById('image-preview');
const cancelPreviewBtn = document.getElementById('cancel-preview-btn');
const chatInfoPanel = document.getElementById('chat-info-panel');
const openInfoBtn = document.getElementById('open-info-btn');
const groupInfoBtn = document.getElementById('group-info-btn');
const closeInfoBtn = document.getElementById('close-info-btn');
const friendInfoContent = document.getElementById('friend-info-content');
const friendAvatar = document.getElementById('chat-friend-avatar');
const friendName = document.getElementById('chat-friend-name');
const sentImagesGrid = document.getElementById('sent-images-grid');
const blockUserBtn = document.getElementById('block-user-btn');
const unblockUserBtn = document.getElementById('unblock-user-btn');
const removeFriendBtn = document.getElementById('remove-friend-btn');
const groupInfoContent = document.getElementById('group-info-content');
const groupAvatar = document.getElementById('group-avatar');
const groupNameDisplay = document.getElementById('group-name-display');
const groupMembersList = document.getElementById('group-members-list');
const groupSentImagesGrid = document.getElementById('group-sent-images-grid');
const leaveGroupBtn = document.getElementById('leave-group-btn');
const reactionsModal = document.getElementById('reactions-modal');
const reactionsList = document.getElementById('reactions-list');
const closeReactionsModal = document.getElementById('close-reactions-modal');
const editPreviewContainer = document.getElementById('edit-preview-container');
const editPreviewText = document.getElementById('edit-preview-text');
const cancelEditBtn = document.getElementById('cancel-edit-btn');
let isEditing = false;
const editProfileBtn = document.getElementById('edit-profile-btn');
const editProfileModal = document.getElementById('edit-profile-modal');
const profileDisplayName = document.getElementById('profile-display-name');
const attachEvidenceBtn = document.getElementById('attach-evidence-btn');
const evidencePreview = document.getElementById('evidence-preview');
const selectionBar = document.getElementById('selection-bar');
const selectionCount = document.getElementById('selection-count');
const cancelSelectionBtn = document.getElementById('cancel-selection-btn');
const confirmSelectionBtn = document.getElementById('confirm-selection-btn');
let selectedEvidence = [];
const profileBio = document.getElementById('profile-bio');
const profileAvatarUrl = document.getElementById('profile-avatar-url');
const saveProfileEditBtn = document.getElementById('save-profile-edit-btn');
const cancelProfileEditBtn = document.getElementById('cancel-profile-edit-btn');
let currentUser = null;
let lastMessageDate = null;
let currentUserData = {};
let currentFriends = [];
let currentChatId = null;
let currentChatType = null;
let currentFriendUid = null;
let currentChatPeerData = null;
let typingTimer;
let typingUnsub = null;
let msgsUnsub = null;
let currentGroupMembers = [];
let selectedImageFile = null;
let replyingTo = null;
let editingMessageKey = null;
let unreadCount = 0;
const originalTitle = document.title;

// --- Core App Logic ---
onAuthStateChanged(auth, async (user) => {
    // 1. Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
    if (!user) {
        window.location.href = 'login.html';
        return; // D·ª´ng h√†m l·∫°i ngay
    }

    // 2. L·∫•y d·ªØ li·ªáu ng∆∞·ªùi d√πng t·ª´ Firestore ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i
    const userDocRef = doc(db, 'users', user.uid);
    const userDocSnap = await getDoc(userDocRef);

    // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu (hi·∫øm g·∫∑p, nh∆∞ng n√™n c√≥)
    if (!userDocSnap.exists()) {
        await signOut(auth);
        window.location.href = 'login.html';
        return;
    }

    const userData = userDocSnap.data();

    // 3. Ki·ªÉm tra xem t√†i kho·∫£n c√≥ b·ªã "x√≥a m·ªÅm" (ng·ª´ng ho·∫°t ƒë·ªông) kh√¥ng
    if (userData.isDeactivated === true) {
        alert("T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ ng·ª´ng ho·∫°t ƒë·ªông.");
        await signOut(auth);
        window.location.href = 'login.html';
        return;
    }

    // 4. Ki·ªÉm tra xem ng∆∞·ªùi d√πng c√≥ c·∫ßn ho√†n t·∫•t h·ªì s∆° kh√¥ng
    if (userData.needsSetup === true) {
        window.location.href = 'setup.html';
        return;
    }

    // 5. N·∫øu t·∫•t c·∫£ ki·ªÉm tra ƒë·ªÅu qua, ti·∫øn h√†nh kh·ªüi ch·∫°y ·ª©ng d·ª•ng
    currentUser = user;
    currentUserData = userData; // G√°n d·ªØ li·ªáu ng∆∞·ªùi d√πng v√†o bi·∫øn to√†n c·ª•c
    appRoot.style.display = 'flex';

    // G·ªçi c√°c h√†m kh·ªüi t·∫°o c·∫ßn thi·∫øt
    setupPresence(user.uid, userData.hideOnlineStatus);
    wireProfile();
    loadFriendsAndGroups();
    attachEventListeners();
    
    // START: S·ª¨A L·ªñI T√åM KI·∫æM
    // G·ªçi h√†m t√¨m ki·∫øm ·ªü ƒë√¢y ƒë·ªÉ ƒë·∫£m b·∫£o currentUser ƒë√£ t·ªìn t·∫°i
    attachGlobalSearch();
    // END: S·ª¨A L·ªñI T√åM KI·∫æM

    handleUrlChat();
    listenForNotifications_Optimized();
});

// To√†n b·ªô c√°c h√†m Javascript kh√°c... (gi·ªØ nguy√™n kh√¥ng ƒë·ªïi)
function listenForAllNotifications() {
    const groupsQuery = query(collection(db, 'groups'), where('member_uids', 'array-contains', currentUser.uid));
    onSnapshot(groupsQuery, (snapshot) => {
        snapshot.forEach((groupDoc) => {
            const groupId = groupDoc.id;
            const lastMsgQuery = rtdbQuery(ref(rtdb, `/messages/${groupId}`), orderByChild('timestamp'), limitToLast(1));
            onValue(lastMsgQuery, (msgSnap) => {
                if (!msgSnap.exists()) return;
                const [msg] = Object.values(msgSnap.val());
                if (msg.senderId !== currentUser.uid && groupId !== currentChatId) {
                    showSimpleNotification(msg.senderName, msg.text || "ƒê√£ g·ª≠i m·ªôt ·∫£nh", `https://placehold.co/96x96?text=${msg.senderName[0]}`);
                }
            });
        });
    });
    currentUserData.friends?.forEach(friendId => {
        const chatId = [currentUser.uid, friendId].sort().join('_');
        const lastMsgQuery = rtdbQuery(ref(rtdb, `/messages/${chatId}`), orderByChild('timestamp'), limitToLast(1));
        onValue(lastMsgQuery, (msgSnap) => {
            if (!msgSnap.exists()) return;
            const [msg] = Object.values(msgSnap.val());
            if (msg.senderId !== currentUser.uid && chatId !== currentChatId) {
                const senderAvatar = userCache[msg.senderId]?.avatarUrl;
                showSimpleNotification(msg.senderName, msg.text || "ƒê√£ g·ª≠i m·ªôt ·∫£nh", senderAvatar);
            }
        });
    });
}
function startEditMessage(key, message) {
    if (replyingTo) cancelReply();
    isEditing = true;
    editingMessageKey = key;
    editPreviewText.textContent = message.text;
    editPreviewContainer.style.display = 'block';
    messageInput.value = message.text;
    messageInput.focus();
    sendBtn.textContent = 'L∆∞u';
}
function cancelEdit() {
    isEditing = false;
    editingMessageKey = null;
    editPreviewContainer.style.display = 'none';
    messageInput.value = '';
    sendBtn.textContent = 'G·ª≠i';
}
function enterMessageSelectionMode() {
    reportUserModal.style.display = 'none';
    selectionBar.style.display = 'flex';
    messagesContainer.classList.add('selection-mode');
    selectedEvidence = [];
    updateSelectionCount();
}
function exitMessageSelectionMode(saveChanges = false) {
    selectionBar.style.display = 'none';
    messagesContainer.classList.remove('selection-mode');
    document.querySelectorAll('.msg-wrapper.selected').forEach(el => el.classList.remove('selected'));
    reportUserModal.style.display = 'flex';
    if (saveChanges && selectedEvidence.length > 0) {
        evidencePreview.textContent = `ƒê√£ ƒë√≠nh k√®m ${selectedEvidence.length} tin nh·∫Øn.`;
        evidencePreview.style.display = 'block';
    } else {
        selectedEvidence = [];
        evidencePreview.style.display = 'none';
    }
}
function updateSelectionCount() {
    selectionCount.textContent = `ƒê√£ ch·ªçn: ${selectedEvidence.length}`;
}
function showConfirmation(message) {
    return new Promise(resolve => {
        confirmMessage.textContent = message;
        confirmModal.style.display = 'flex';
        confirmOkBtn.onclick = () => {
            confirmModal.style.display = 'none';
            resolve(true);
        };
        confirmCancelBtn.onclick = () => {
            confirmModal.style.display = 'none';
            resolve(false);
        };
    });
}
function requestSimpleNotificationPermission() {
    if (!("Notification" in window)) {
        alert("Tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ th√¥ng b√°o tr√™n m√†n h√¨nh.");
        return;
    }
    if (Notification.permission !== "granted") {
        Notification.requestPermission().then((permission) => {
            if (permission === "granted") {
                showToast("ƒê√£ b·∫≠t th√¥ng b√°o tr√¨nh duy·ªát!", "success");
            } else {
                showToast("B·∫°n ƒë√£ kh√¥ng cho ph√©p nh·∫≠n th√¥ng b√°o.", "error");
            }
        });
    } else {
        showToast("Th√¥ng b√°o tr√¨nh duy·ªát ƒë√£ ƒë∆∞·ª£c b·∫≠t t·ª´ tr∆∞·ªõc.", "info");
    }
}
function showSimpleNotification(senderName, messageText, avatarUrl) {
    if (Notification.permission !== "granted") return;
    const options = {
        body: messageText,
        icon: avatarUrl || 'https://placehold.co/96x96?text=Q'
    };
    new Notification(senderName, options);
}

async function addFriendByEmail() {
    const emailInput = document.getElementById('add-friend-email-input');
    const addFriendModal = document.getElementById('add-friend-modal');
    const email = emailInput.value.trim().toLowerCase();
    const addBtn = document.getElementById('add-btn');
    const addMenu = document.getElementById('add-menu');
    addBtn.onclick = (e) => { e.stopPropagation(); addMenu.style.display = addMenu.style.display === 'block' ? 'none' : 'block'; };
    document.getElementById('create-group-from-menu').onclick = () => { openCreateGroupModal(); addMenu.style.display = 'none'; };
    document.getElementById('add-friend-from-menu').onclick = () => { document.getElementById('add-friend-modal').style.display = 'flex'; addMenu.style.display = 'none'; };
    const settingsMenu = document.getElementById('settings-menu');
    openSettings.onclick = (e)=> { e.stopPropagation(); settingsMenu.style.display = settingsMenu.style.display==='block' ? 'none' : 'block'; };
    document.getElementById('go-to-settings').onclick = () => window.location.href = 'settings.html';
    document.getElementById('go-login').onclick = async ()=>{ await signOut(auth); window.location.href='login.html'; };

    if (!email) return showToast("Vui l√≤ng nh·∫≠p email.", "error");

     document.addEventListener('click',(e)=>{
        if(!settingsMenu.contains(e.target) && e.target!==openSettings) settingsMenu.style.display='none';
        if(!addMenu.contains(e.target) && e.target!==addBtn) addMenu.style.display='none';
        if (!messageContextMenu.contains(e.target)) messageContextMenu.style.display = 'none';
    });

    const confirmBtn = document.getElementById('confirm-add-friend-btn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = "ƒêang g·ª≠i...";

    const q = query(collection(db, "users"), where("email", "==", email));
    const querySnapshot = await getDocs(q);

    if (querySnapshot.empty) {
        showToast("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng v·ªõi email n√†y.", "error");
    } else {
        const targetUser = querySnapshot.docs[0].data();
        if (targetUser.uid === currentUser.uid) {
            showToast("B·∫°n kh√¥ng th·ªÉ t·ª± k·∫øt b·∫°n v·ªõi ch√≠nh m√¨nh.", "error");
        } else {
            try {
                await addDoc(collection(db, "friend_requests"), { 
                    from_uid: currentUser.uid, from_email: currentUser.email, to_uid: targetUser.uid, 
                    status: 'pending', timestamp: serverTimestamp() 
                });
                showToast("ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n!", "success");
                emailInput.value = '';
                addFriendModal.style.display = 'none';
            } catch (err) {
                console.error(err);
                showToast("L·ªói khi g·ª≠i l·ªùi m·ªùi.", "error");
            }
        }
    }
    
    confirmBtn.disabled = false;
    confirmBtn.textContent = "G·ª≠i l·ªùi m·ªùi";
}

// THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈® B·∫∞NG H√ÄM N√ÄY
// THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈® B·∫∞NG PHI√äN B·∫¢N HO√ÄN CH·ªàNH N√ÄY
function attachEventListeners() {
    handleMentionInput();
    // --- L·∫•y c√°c y·∫øu t·ªë Menu ch√≠nh ---
    const addBtn = document.getElementById('add-btn');
    const addMenu = document.getElementById('add-menu');
    const settingsBtn = document.getElementById('open-settings');
    const settingsMenu = document.getElementById('settings-menu');

    // --- X·ª≠ l√Ω Menu ---
    addBtn.onclick = (e) => {
        e.stopPropagation();
        settingsMenu.style.display = 'none';
        addMenu.style.display = addMenu.style.display === 'block' ? 'none' : 'block';
    };
    settingsBtn.onclick = (e) => {
        e.stopPropagation();
        addMenu.style.display = 'none';
        settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
    };
    
    // --- G√°n s·ª± ki·ªán cho c√°c m·ª•c b√™n trong Menu ---
    document.getElementById('create-group-from-menu').onclick = () => { openCreateGroupModal(); addMenu.style.display = 'none'; };
    document.getElementById('add-friend-from-menu').onclick = () => { document.getElementById('add-friend-modal').style.display = 'flex'; addMenu.style.display = 'none'; };
    document.getElementById('go-to-settings').onclick = () => window.location.href = 'settings.html';
    document.getElementById('go-login').onclick = async () => { await signOut(auth); window.location.href='login.html'; };

    // --- G√°n s·ª± ki·ªán cho c√°c Popup (Modal) ---
    document.getElementById('cancel-add-friend-btn').onclick = () => document.getElementById('add-friend-modal').style.display = 'none';
    document.getElementById('confirm-add-friend-btn').onclick = addFriendByEmail;
    openFriendReqBtn.onclick = () => { friendReqModal.style.display = 'flex'; loadFriendRequests(); };
    closeFriendReqModal.onclick = () => { friendReqModal.style.display = 'none'; };
    closeGroupModalBtn.onclick = () => createGroupModal.style.display = 'none';
    confirmCreateGroupBtn.onclick = confirmCreateGroup;
    closeReactionsModal.onclick = () => reactionsModal.style.display = 'none';
    cancelReportBtn.onclick = () => { reportUserModal.style.display = 'none'; reportDetails.value = ''; };
    submitReportBtn.onclick = submitReport;
    attachEvidenceBtn.onclick = enterMessageSelectionMode;
    cancelSelectionBtn.onclick = () => exitMessageSelectionMode(false);
    confirmSelectionBtn.onclick = () => exitMessageSelectionMode(true);
    
    // --- G√°n s·ª± ki·ªán cho c√°c n√∫t trong khu v·ª±c Chat ---
    sendBtn.onclick = sendMessage;
    cancelReplyBtn.onclick = cancelReply;
    cancelEditBtn.onclick = cancelEdit;
    cancelPreviewBtn.onclick = cancelImagePreview;
    closeInfoBtn.onclick = () => chatInfoPanel.classList.remove('open');
    sidebarAvatar.onclick = () => { if(!currentUser) return; window.open(`profile.html?id=${encodeURIComponent(currentUser.uid)}`,'_blank'); };
    toastCloseBtn.onclick = () => toast.style.display = 'none';
    lightboxCloseBtn.onclick = () => imageLightbox.style.display = 'none';
    imageLightbox.onclick = (e) => { if (e.target === imageLightbox) { imageLightbox.style.display = 'none'; } };

    // --- LOGIC M·ªöI CHO √î NH·∫¨P TIN NH·∫ÆN V√Ä CH·ªåN ·∫¢NH ---
    messageInput.addEventListener('input', () => {
        const hasText = messageInput.value.trim().length > 0;
        chatInputContainer.classList.toggle('has-text', hasText);
        
        if(!currentChatId) return;
        const tRef = ref(rtdb, `/typing/${currentChatId}/${currentUser.uid}`);
        set(tRef, true);
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => set(tRef, false), 2000);
    });

    messageInput.addEventListener('keypress', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    imageInput.onchange = (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        selectedImageFile = f;
        const reader = new FileReader();
        reader.onload = (ev) => {
            imagePreview.src = ev.target.result;
            imagePreviewContainer.style.display = 'block';
            messageInput.placeholder = 'Th√™m ch√∫ th√≠ch...';
        };
        reader.readAsDataURL(f);
    };
    // --- K·∫æT TH√öC LOGIC M·ªöI ---

    // --- C√ÅC LISTENER C≈® KH√ÅC ---
    messagesContainer.addEventListener('contextmenu', showMessageContextMenu);
    messagesContainer.addEventListener('mouseover', e => { 
        const msgWrapper = e.target.closest('.msg-wrapper'); 
        if (msgWrapper && msgWrapper.dataset.key) { 
            let picker = msgWrapper.querySelector('.reaction-picker'); 
            if (!picker) { 
                picker = createReactionPicker(msgWrapper.dataset.key); 
                msgWrapper.appendChild(picker); 
            } 
        } 
    });
    document.querySelectorAll('.report-reason-row').forEach(row => { 
        row.addEventListener('click', () => { 
            document.querySelectorAll('.report-reason-row').forEach(r => r.classList.remove('selected')); 
            row.classList.add('selected'); 
            row.querySelector('input[type="radio"]').checked = true; 
        }); 
    });

    document.addEventListener('click', (e) => {
        if (!addMenu.contains(e.target) && e.target !== addBtn) addMenu.style.display = 'none';
        if (!settingsMenu.contains(e.target) && e.target !== settingsBtn) settingsMenu.style.display = 'none';
        if (!messageContextMenu.contains(e.target)) messageContextMenu.style.display = 'none';
    });
    document.addEventListener('visibilitychange', () => { 
        if (!document.hidden) { 
            unreadCount = 0; 
            document.title = originalTitle; 
        } 
    });
}
function openLightbox(imageUrl) {
    lightboxImg.src = imageUrl;
    imageLightbox.style.display = 'flex';
}
function showToast(message, type = 'info') {
    toastMessage.textContent = message;
    toast.style.display = 'block';
}
// T√åM V√Ä THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈® B·∫∞NG H√ÄM N√ÄY
function escapeHtml(s) {
    // N·∫øu ƒë·∫ßu v√†o kh√¥ng ph·∫£i l√† chu·ªói (b·ªã null ho·∫∑c undefined), tr·∫£ v·ªÅ chu·ªói r·ªóng
    if (typeof s !== 'string') {
        return '';
    }
    // N·∫øu l√† chu·ªói th√¨ x·ª≠ l√Ω nh∆∞ b√¨nh th∆∞·ªùng
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
}
function createVerifiedTickHTML(isVerified) {
    return isVerified ? '<span class="verified-tick"></span>' : '';
}
function setupPresence(uid, isHidden = false){
  const statusRef = ref(rtdb, `/status/${uid}`);
  
  // N·∫øu ng∆∞·ªùi d√πng ch·ªçn ·∫®N, ƒë·∫∑t tr·∫°ng th√°i offline v√† d·ª´ng l·∫°i
  if (isHidden) {
      set(statusRef, { isOnline: false, last_seen: dbServerTimestamp() });
      return;
  }

  // N·∫øu kh√¥ng ·∫©n, th√¨ ch·∫°y logic online/offline nh∆∞ b√¨nh th∆∞·ªùng
  const connectedRef = ref(rtdb, '.info/connected');
  onValue(connectedRef,(snap)=>{
    if(snap.val() === false) return;
    onDisconnect(statusRef).set({ isOnline:false, last_seen: dbServerTimestamp() })
      .then(()=> set(statusRef, { isOnline:true, last_seen: dbServerTimestamp() }));
  });
}
// T√åM V√Ä THAY TH·∫æ TO√ÄN B·ªò h√†m wireProfile c≈© b·∫±ng h√†m n√†y
function wireProfile(){
  // 'ds' l√† d·ªØ li·ªáu snapshot nh·∫≠n v·ªÅ t·ª´ Firebase
  onSnapshot(doc(db,'users',currentUser.uid),(ds)=>{
    
    // D√íNG N√ÄY L√Ä QUAN TR·ªåNG NH·∫§T:
    // N√≥ l·∫•y d·ªØ li·ªáu t·ª´ snapshot (ds) v√† g√°n v√†o bi·∫øn 'd'.
    // L·ªói c·ªßa c·∫≠u c√≥ th·ªÉ l√† do thi·∫øu ho·∫∑c sai d√≤ng n√†y.
    const d = ds.data() || {}; 
    
    // C√°c d√≤ng b√™n d∆∞·ªõi ƒë·ªÅu s·ª≠ d·ª•ng bi·∫øn 'd' m·ªôt c√°ch an to√†n
    sidebarAvatar.src = d.avatarUrl || `https://placehold.co/42x42/111/fff?text=${(d.email||'?')[0].toUpperCase()}`;
    currentUserData = d;
    currentFriends = d.friends || [];

    // Th√™m ho·∫∑c x√≥a class tr√™n th·∫ª <body> d·ª±a v√†o c√†i ƒë·∫∑t ·∫©n tr·∫°ng th√°i
    document.body.classList.toggle('is-hiding-status', d.hideOnlineStatus === true);
  });
}
async function ensureUserDoc(){
  const uref=doc(db,'users',currentUser.uid);
  const got=await getDoc(uref);
  if(!got.exists()){
    await setDoc(uref,{uid:currentUser.uid,email:currentUser.email,displayName:currentUser.email.split('@')[0],bio:'',avatarUrl:'',friends:[], blocked: []});
  }
}
function loadFriendsAndGroups(){
    onSnapshot(doc(db,'users',currentUser.uid), async (meDoc)=>{
      friendList.innerHTML='';
      const fids = meDoc.data()?.friends || [];
      currentFriends = fids;
      for(const uid of fids){
        const userDoc = await getDoc(doc(db,'users',uid));
        if(!userDoc.exists()) continue;
        const u = userDoc.data();
        const verifiedTick = createVerifiedTickHTML(u.isVerified);
        const chatId = [currentUser.uid, uid].sort().join('_');
        const li = document.createElement('li');
        li.className = 'item clickable';
        li.innerHTML = `
          <div class="item-left">
            <img class="result-avatar" src="${u.avatarUrl || `https://placehold.co/40x40/111/fff?text=${u.displayName[0]}`}">
            <div style="min-width: 0;">
                <div class="item-name">${u.displayName || u.email}${verifiedTick}</div>
                <div class="item-last-msg" id="last-msg-${chatId}"></div>
            </div>
          </div>
          <div class="status" id="st-${uid}"></div>`;
        li.onclick = () => startDirectChat(u);
        friendList.appendChild(li);
        onValue(ref(rtdb,`/status/${uid}`),(s)=>{
          const el=document.getElementById(`st-${uid}`); if(!el) return;
          el.classList.toggle('online', !!s.val()?.isOnline);
        });
        const lastMsgQuery = rtdbQuery(ref(rtdb, `/messages/${chatId}`), orderByChild('timestamp'), limitToLast(1));
        onValue(lastMsgQuery, (snap) => {
            const lastMsgEl = document.getElementById(`last-msg-${chatId}`);
            if (!lastMsgEl) return;
            if (snap.exists()) {
                const [lastMsg] = Object.values(snap.val());
                let preview = '';
                if (lastMsg.recalled) {
                    preview = 'Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi';
                } else if (lastMsg.text) {
                    preview = lastMsg.text;
                } else if (lastMsg.imageUrl) {
                    preview = 'ƒê√£ g·ª≠i m·ªôt ·∫£nh';
                }
                if (lastMsg.senderId === currentUser.uid) {
                    preview = `B·∫°n: ${preview}`;
                }
                lastMsgEl.textContent = preview;
            }
        });
      }
      sidebar.classList.add('loaded');
    });
    const qg = query(collection(db,'groups'), where('member_uids','array-contains', currentUser.uid));
    onSnapshot(qg,(qs)=>{
      groupList.innerHTML='';
      qs.forEach((d)=>{
        const g=d.data();
        const groupId = d.id;
        const li=document.createElement('li');
        li.className='item clickable';
        li.innerHTML=`
            <div class="item-left">
                <img class="result-avatar" src="https://placehold.co/40x40/0af/fff?text=${g.groupName[0]}">
                <div style="min-width: 0;">
                    <div class="item-name">üë• ${g.groupName}</div>
                    <div class="item-last-msg" id="last-msg-${groupId}"></div>
                </div>
            </div>`;
        li.onclick=()=> startGroupChat(groupId, g.groupName);
        groupList.appendChild(li);
        const lastMsgQuery = rtdbQuery(ref(rtdb, `/messages/${groupId}`), orderByChild('timestamp'), limitToLast(1));
        onValue(lastMsgQuery, (snap) => {
            const lastMsgEl = document.getElementById(`last-msg-${groupId}`);
            if (!lastMsgEl) return;
            if (snap.exists()) {
                const [lastMsg] = Object.values(snap.val());
                let preview = '';
                if (lastMsg.recalled) {
                    preview = 'Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi';
                } else if (lastMsg.text) {
                    preview = lastMsg.text;
                } else if (lastMsg.imageUrl) {
                    preview = 'ƒê√£ g·ª≠i m·ªôt ·∫£nh';
                }
                const senderPrefix = lastMsg.senderId === currentUser.uid ? 'B·∫°n: ' : `${lastMsg.senderName.split(' ')[0]}: `;
                lastMsgEl.textContent = senderPrefix + preview;
            }
        });
      });
    });
}
async function startDirectChat(friend) {
    if (!friend || !friend.uid) return;

    const friendDoc = await getDoc(doc(db, 'users', friend.uid));
    if (!friendDoc.exists()) {
        return showToast("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†y.", "error");
    }

    const friendData = friendDoc.data();
    currentChatPeerData = friendData;

    let isChatActive = true;
    let inactiveReason = ""; // Bi·∫øn l∆∞u l√Ω do

    // --- LOGIC M·ªöI B·∫ÆT ƒê·∫¶U T·ª™ ƒê√ÇY ---
    if (currentUserData.blocked?.includes(friend.uid)) {
        // Tr∆∞·ªùng h·ª£p 1: M√åNH ch·∫∑n H·ªå
        inactiveReason = "B·∫°n ƒë√£ ch·∫∑n ng∆∞·ªùi n√†y. H√£y b·ªè ch·∫∑n ƒë·ªÉ ti·∫øp t·ª•c nh·∫Øn tin.";
        isChatActive = false;
    } else if (friendData?.blocked?.includes(currentUser.uid)) {
        // Tr∆∞·ªùng h·ª£p 2: H·ªå ch·∫∑n M√åNH
        inactiveReason = "B·∫°n kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn cho ng∆∞·ªùi n√†y.";
        isChatActive = false;
    } else if (friendData.isDeactivated === true) {
        // Tr∆∞·ªùng h·ª£p 3: T√†i kho·∫£n c·ªßa h·ªç b·ªã kh√≥a
        inactiveReason = "Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn cho ng∆∞·ªùi n√†y.";
        isChatActive = false;
    } else {
        // M·ªçi th·ª© b√¨nh th∆∞·ªùng
        isChatActive = true;
    }
    // --- K·∫æT TH√öC LOGIC M·ªöI ---

    const uids = [currentUser.uid, friend.uid].sort();
    const chatId = uids.join('_');
    currentFriendUid = friend.uid;

    // C·∫≠p nh·∫≠t l·∫°i text cho √¥ th√¥ng b√°o
    inactiveChatIndicator.textContent = inactiveReason;
    openChat({ id: chatId, name: friendData.displayName || friendData.email, type: 'direct', isActive: isChatActive });

    history.replaceState(null, '', `?chat=${friend.uid}`);
}
function startGroupChat(groupId, groupName){
    if (!sessionStorage.getItem('groupBetaWarningShown')) {
        showToast('T√≠nh nƒÉng Nh√≥m ƒëang trong giai ƒëo·∫°n th·ª≠ nghi·ªám (Beta)...');
        sessionStorage.setItem('groupBetaWarningShown', 'true');
    }
    currentFriendUid = null;
    currentChatPeerData = null;
    openChat({id:groupId, name:groupName, type:'group', isActive: true});
    history.replaceState(null, '', `?chat_group=${groupId}`);
}
function openChat(chat) {
    // 1. NG·∫ÆT K·∫æT N·ªêI C≈® NGAY L·∫¨P T·ª®C (S·ª≠a l·ªói l·∫∑p tin nh·∫Øn)
    if (msgsUnsub) {
        msgsUnsub();
        msgsUnsub = null; // ƒê·∫∑t l·∫°i th√†nh null ƒë·ªÉ ch·∫Øc ch·∫Øn
    }
    if (typingUnsub) {
        typingUnsub();
        typingUnsub = null; // ƒê·∫∑t l·∫°i th√†nh null
    }

    // 2. Reset tr·∫°ng th√°i v√† UI
    lastMessageDate = null;
    currentChatId = chat.id;
    currentChatType = chat.type;
    currentGroupMembers = []; // Reset danh s√°ch th√†nh vi√™n
    messagesContainer.innerHTML = ''; // X√≥a tin nh·∫Øn c≈©
    typingIndicator.textContent = ''; // X√≥a tr·∫°ng th√°i g√µ ph√≠m
    chatInfoPanel.classList.remove('open'); // ƒê√≥ng panel th√¥ng tin n·∫øu ƒëang m·ªü
    cancelReply(); // H·ªßy tr·∫°ng th√°i tr·∫£ l·ªùi (n·∫øu c√≥)
    cancelEdit(); // H·ªßy tr·∫°ng th√°i s·ª≠a (n·∫øu c√≥)
    cancelImagePreview(); // H·ªßy xem tr∆∞·ªõc ·∫£nh (n·∫øu c√≥)

    // 3. C·∫≠p nh·∫≠t Header Chat
    const verifiedTick = createVerifiedTickHTML(currentChatPeerData?.isVerified);
    currentChatFriendName.innerHTML = `${escapeHtml(chat.name)} ${verifiedTick}`;
    const chatHeaderAvatar = document.getElementById('current-chat-avatar');

    if (chat.type === 'direct' && currentChatPeerData) {
        chatHeaderAvatar.src = currentChatPeerData.avatarUrl || `https://placehold.co/40x40/EFEFEF/333?text=${chat.name[0]}`;
        chatHeaderAvatar.style.display = 'block';
        chatHeaderAvatar.onclick = () => { if (currentFriendUid) window.open(`profile.html?id=${currentFriendUid}`, '_blank'); };
        groupInfoBtn.style.display = 'none';
        openInfoBtn.style.display = 'block';
        openInfoBtn.onclick = () => { if (currentFriendUid) { showFriendInfo(currentFriendUid); chatInfoPanel.classList.add('open'); } };
        currentFriendUid = currentChatPeerData.uid; // C·∫≠p nh·∫≠t l·∫°i friendUid
    } else if (chat.type === 'group') {
        chatHeaderAvatar.src = `https://placehold.co/40x40/1e293b/fff?text=${chat.name[0]}`; // Placeholder cho nh√≥m
        chatHeaderAvatar.style.display = 'block';
        chatHeaderAvatar.onclick = null; // Kh√¥ng c·∫ßn click avatar nh√≥m
        openInfoBtn.style.display = 'none';
        groupInfoBtn.style.display = 'block';
        groupInfoBtn.onclick = () => { showGroupInfo(chat.id); chatInfoPanel.classList.add('open'); };
        currentFriendUid = null; // Reset friendUid

        // L·∫•y danh s√°ch th√†nh vi√™n nh√≥m
        const groupRef = doc(db, "groups", chat.id);
        getDoc(groupRef).then(async (groupDoc) => {
            if (groupDoc.exists()) {
                const groupData = groupDoc.data();
                const memberUids = groupData.member_uids || [];
                const memberPromises = memberUids.map(uid => getDoc(doc(db, "users", uid)));
                const memberDocs = await Promise.all(memberPromises);
                currentGroupMembers = memberDocs
                    .filter(d => d.exists())
                    .map(d => {
                        const uData = d.data();
                        return { uid: uData.uid, displayName: uData.displayName || uData.email, avatarUrl: uData.avatarUrl };
                    });
            }
        });
    } else {
        // Tr∆∞·ªùng h·ª£p kh√¥ng x√°c ƒë·ªãnh (v√≠ d·ª•: m√†n h√¨nh ch·ªù)
        chatHeaderAvatar.style.display = 'none';
        chatHeaderAvatar.onclick = null;
        openInfoBtn.style.display = 'none';
        groupInfoBtn.style.display = 'none';
        currentFriendUid = null;
    }

    // 4. K√≠ch ho·∫°t/V√¥ hi·ªáu h√≥a thanh nh·∫≠p li·ªáu
    if (chat.isActive) {
        chatInputContainer.style.display = 'flex';
        inactiveChatIndicator.style.display = 'none';
        messageInput.disabled = false;
        messageInput.placeholder = "Nh·∫≠p tin nh·∫Øn...";
        messageInput.focus();
    } else {
        chatInputContainer.style.display = 'none';
        inactiveChatIndicator.style.display = 'block';
        // inactiveChatIndicator.textContent ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong startDirectChat
    }

    // 5. G·∫Øn listener m·ªõi cho tr·∫°ng th√°i g√µ ph√≠m
    // 5. G·∫Øn listener m·ªõi cho tr·∫°ng th√°i g√µ ph√≠m
    const typingRef = ref(rtdb, `/typing/${chat.id}`);
    typingUnsub = onValue(typingRef, (snap) => {
        const obj = snap.val() || {};
        const othersTyping = Object.keys(obj).filter(uid => obj[uid] && uid !== currentUser.uid);
        
        // --- S·ª¨A L·ªñI HI·ªÇN TH·ªä ·ªû ƒê√ÇY ---
        if (othersTyping.length > 0) {
            if (chat.type === 'direct') {
                // N·∫øu l√† chat 1-1, ch·ªâ hi·ªán "ƒêang nh·∫≠p..."
                typingIndicator.textContent = 'ƒêang nh·∫≠p...';
            } else {
                // N·∫øu l√† chat nh√≥m, hi·ªán s·ªë ng∆∞·ªùi ƒëang nh·∫≠p
                typingIndicator.textContent = `${othersTyping.length} ng∆∞·ªùi ƒëang nh·∫≠p...`;
                // N√¢ng cao: C√≥ th·ªÉ l·∫•y t√™n ng∆∞·ªùi ƒëang g√µ n·∫øu mu·ªën
                const typerNames = othersTyping.map(uid => currentGroupMembers.find(m => m.uid === uid)?.displayName || '...').join(', ');
                typingIndicator.textContent = `${typerNames} ƒëang nh·∫≠p...`;
            }
        } else {
            typingIndicator.textContent = ''; // Kh√¥ng ai g√µ th√¨ x√≥a
        }
        // --- K·∫æT TH√öC S·ª¨A L·ªñI ---
    });
    // 6. G·∫Øn listener m·ªõi cho tin nh·∫Øn
    const msgsRef = ref(rtdb, `/messages/${chat.id}`);
    const unsubChildAdded = onChildAdded(msgsRef, (snap) => renderMessage(snap.key, snap.val(), chat));
    const unsubChildChanged = onChildChanged(msgsRef, (snap) => renderMessage(snap.key, snap.val(), chat));
    
    // G√°n l·∫°i h√†m unsub m·ªõi
    msgsUnsub = () => {
        off(msgsRef, 'child_added', unsubChildAdded);
        off(msgsRef, 'child_changed', unsubChildChanged);
    };

    // 7. G√°n l·∫°i s·ª± ki·ªán cho n√∫t ch·ªçn ·∫£nh (ƒë·∫£m b·∫£o n√≥ lu√¥n ho·∫°t ƒë·ªông)
    imageInput.onchange = (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        selectedImageFile = f;
        const reader = new FileReader();
        reader.onload = (ev) => {
            imagePreview.src = ev.target.result;
            imagePreviewContainer.style.display = 'block';
            messageInput.placeholder = 'Th√™m ch√∫ th√≠ch...';
        };
        reader.readAsDataURL(f);
    };
}
// TH√äM H√ÄM M·ªöI N√ÄY V√ÄO SCRIPT
function handleMentionInput() {
    const mentionPopup = document.getElementById('mention-suggestions');
    const input = messageInput; // ƒê·∫£m b·∫£o bi·∫øn messageInput l√† global (d√πng let)
    let isMentioning = false;
    let mentionQuery = '';

    input.addEventListener('input', (e) => {
        const text = input.value;
        const cursorPos = input.selectionStart;
        let lastAtPos = -1;

        // T√¨m v·ªã tr√≠ d·∫•u @ g·∫ßn nh·∫•t tr∆∞·ªõc con tr·ªè
        for (let i = cursorPos - 1; i >= 0; i--) {
            if (text[i] === '@') {
                // Ki·ªÉm tra xem c√≥ ph·∫£i l√† b·∫Øt ƒë·∫ßu mention kh√¥ng (tr∆∞·ªõc ƒë√≥ l√† kho·∫£ng tr·∫Øng ho·∫∑c ƒë·∫ßu d√≤ng)
                if (i === 0 || /\s/.test(text[i - 1])) {
                    lastAtPos = i;
                    break;
                }
            }
            // N·∫øu g·∫∑p kho·∫£ng tr·∫Øng tr∆∞·ªõc khi g·∫∑p @ th√¨ kh√¥ng ph·∫£i ƒëang mention
            if (/\s/.test(text[i])) break; 
        }

        if (lastAtPos !== -1 && currentChatType === 'group') {
            isMentioning = true;
            mentionQuery = text.substring(lastAtPos + 1, cursorPos).toLowerCase();
            showSuggestions(mentionQuery);
        } else {
            isMentioning = false;
            mentionPopup.style.display = 'none';
        }
    });

    input.addEventListener('keydown', (e) => {
        // C√≥ th·ªÉ th√™m logic x·ª≠ l√Ω ph√≠m m≈©i t√™n/Enter ƒë·ªÉ ch·ªçn g·ª£i √Ω ·ªü ƒë√¢y (n√¢ng cao)
    });

    function showSuggestions(query) {
        mentionPopup.innerHTML = ''; // X√≥a g·ª£i √Ω c≈©
        let suggestions = [];

        // Th√™m @all n·∫øu query r·ªóng ho·∫∑c kh·ªõp
        if ('all'.includes(query)) {
            suggestions.push({ type: 'all' });
        }

        // L·ªçc th√†nh vi√™n
        if (currentGroupMembers.length > 0) {
            const filteredMembers = currentGroupMembers.filter(member => 
                member.uid !== currentUser.uid && // Kh√¥ng tag ch√≠nh m√¨nh
                member.displayName.toLowerCase().includes(query)
            );
            suggestions = suggestions.concat(filteredMembers.map(m => ({ ...m, type: 'user' })));
        }

        if (suggestions.length === 0) {
            mentionPopup.style.display = 'none';
            return;
        }

        suggestions.forEach(item => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            if (item.type === 'all') {
                div.innerHTML = `<span class="all">@all</span>`;
                div.onclick = () => insertMention('@all', 'all');
            } else {
                const avatar = item.avatarUrl || `https://placehold.co/28x28?text=${item.displayName[0]}`;
                div.innerHTML = `<img src="${avatar}" alt=""><span class="name">${item.displayName}</span>`;
                div.onclick = () => insertMention(item.displayName, item.uid);
            }
            mentionPopup.appendChild(div);
        });

        mentionPopup.style.display = 'block';
    }

    function insertMention(name, uidOrAll) {
        const text = input.value;
        const cursorPos = input.selectionStart;
        let lastAtPos = -1;
         // T√¨m l·∫°i v·ªã tr√≠ @ ƒë·ªÉ thay th·∫ø ch√≠nh x√°c
        for (let i = cursorPos - 1; i >= 0; i--) {
             if (text[i] === '@') {
                if (i === 0 || /\s/.test(text[i - 1])) {
                    lastAtPos = i;
                    break;
                }
            }
             if (/\s/.test(text[i])) break;
        }

        if (lastAtPos !== -1) {
            const before = text.substring(0, lastAtPos);
            const after = text.substring(cursorPos);
            const mentionText = (uidOrAll === 'all') ? '@all' : `@${name}`;
            input.value = before + mentionText + ' ' + after; // Th√™m kho·∫£ng tr·∫Øng sau mention
            
            // Di chuy·ªÉn con tr·ªè ra sau kho·∫£ng tr·∫Øng
            input.focus();
            const newCursorPos = before.length + mentionText.length + 1;
            input.setSelectionRange(newCursorPos, newCursorPos);
        }

        mentionPopup.style.display = 'none';
        isMentioning = false;
         // K√≠ch ho·∫°t l·∫°i vi·ªác ki·ªÉm tra n√∫t g·ª≠i sau khi ch√®n text
         input.dispatchEvent(new Event('input')); 
    }
}

function listenForNotifications_Optimized() {
    const notifsRef = ref(rtdb, `/notifications/${currentUser.uid}`);
    onChildAdded(notifsRef, (snapshot) => {
        const notification = snapshot.val();
        if (notification.chatId !== currentChatId) {
            showSimpleNotification(notification.from, notification.preview, notification.avatar);
        }
        remove(snapshot.ref);
    });
}
async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text && !selectedImageFile && !replyingTo) return;
    if (!currentChatId) return;

    // 1. B·∫Øt ƒë·∫ßu loading
    sendBtn.classList.add('loading');
    sendBtn.disabled = true;
    messageInput.disabled = true;

    try {
        // 2. Khai b√°o imageUrl b√™n ngo√†i ƒë·ªÉ ƒë·∫£m b·∫£o scope
        let imageUrl = null; 

        // 3. Upload ·∫£nh n·∫øu c√≥
        if (selectedImageFile) {
            imageUrl = await uploadImage(selectedImageFile);
        }

        // 4. Parse mentions (n·∫øu l√† chat nh√≥m)
        let mentions = [];
        if (currentChatType === 'group' && text) {
            const mentionRegex = /@(\S+)/g;
            let match;
            while ((match = mentionRegex.exec(text)) !== null) {
                const username = match[1];
                if (username === 'all') {
                    if (!mentions.includes('all')) mentions.push('all');
                } else {
                    const mentionedMember = currentGroupMembers.find(m => m.displayName === username);
                    if (mentionedMember && !mentions.includes(mentionedMember.uid)) {
                        mentions.push(mentionedMember.uid);
                    }
                }
            }
        }

        // 5. Chu·∫©n b·ªã d·ªØ li·ªáu tin nh·∫Øn
        const newMsgRef = push(ref(rtdb, `/messages/${currentChatId}`));
        const newMsgKey = newMsgRef.key;
        
        const msg = {
            senderId: currentUser.uid,
            senderName: currentUserData.displayName || currentUser.email.split('@')[0],
            text: text || null,
            imageUrl: imageUrl, // Lu√¥n t·ªìn t·∫°i (l√† URL ho·∫∑c null)
            timestamp: Date.now(),
            readBy: { [currentUser.uid]: true },
            replyTo: replyingTo ? replyingTo.key : null,
            mentions: mentions.length > 0 ? mentions : null
        };

        // 6. Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i (tin nh·∫Øn + notification)
        const updates = {};
        updates[`/messages/${currentChatId}/${newMsgKey}`] = msg;
        
        const notificationPayload = {
            from: msg.senderName, avatar: currentUserData.avatarUrl,
            preview: msg.text || "ƒê√£ g·ª≠i m·ªôt ·∫£nh", chatId: currentChatId,
            chatType: currentChatType, senderId: currentUser.uid,
        };

        if (currentChatType === 'direct') {
            const uids = currentChatId.split('_');
            const recipientId = uids[0] === currentUser.uid ? uids[1] : uids[0];
            // TODO: Ki·ªÉm tra xem ng∆∞·ªùi nh·∫≠n c√≥ mute chat n√†y kh√¥ng tr∆∞·ªõc khi g·ª≠i notif
            updates[`/notifications/${recipientId}/${newMsgKey}`] = notificationPayload;
        } 
        // TODO: Logic g·ª≠i notification cho nh√≥m (ch·ªâ g·ª≠i cho ng∆∞·ªùi ƒë∆∞·ª£c tag ho·∫∑c all?)

        // 7. G·ª≠i d·ªØ li·ªáu l√™n Firebase
        await rtdbUpdate(ref(rtdb), updates);

        // 8. D·ªçn d·∫πp UI n·∫øu g·ª≠i th√†nh c√¥ng
        messageInput.value = '';
        chatInputContainer.classList.remove('has-text');
        cancelImagePreview();
        cancelReply();
        clearTimeout(typingTimer);
        set(ref(rtdb, `/typing/${currentChatId}/${currentUser.uid}`), false);

    } catch (e) {
        console.error("L·ªói khi g·ª≠i tin nh·∫Øn:", e);
        showToast('G·ª≠i tin nh·∫Øn th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i.', 'error');
    } finally {
        // 9. Lu√¥n k·∫øt th√∫c loading v√† m·ªü l·∫°i input
        sendBtn.classList.remove('loading');
        sendBtn.disabled = false; // N√∫t t·ª± ·∫©n nh·ªù CSS
        messageInput.disabled = false;
        if (currentChatId) { // Ch·ªâ focus n·∫øu v·∫´n ƒëang trong chat
             messageInput.focus();
        }
    }
}
function renderMessage(key, m, chatCtx) {
    // 1. KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN THO√ÅT S·ªöM
    if (currentUserData.blocked?.includes(m.senderId)) return; // B·ªã ch·∫∑n -> kh√¥ng render
    if (!m) { // Tin nh·∫Øn b·ªã x√≥a ho√†n to√†n kh·ªèi DB
        const elToRemove = document.querySelector(`.msg-wrapper[data-key="${key}"]`);
        if (elToRemove) elToRemove.remove();
        return;
    }

    // 2. KHAI B√ÅO BI·∫æN C·ªêT L√ïI
    const isSent = m.senderId === currentUser.uid;

    // 3. X·ª¨ L√ù C√ÅC T√ÅC V·ª§ PH·ª§ (C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ tab)
    if (!isSent && document.hidden) {
        unreadCount++;
        document.title = `(${unreadCount}) ${originalTitle}`;
    }

    // 4. QU·∫¢N L√ù DOM ELEMENT (L·∫•y ho·∫∑c t·∫°o element ch√≠nh)
    let existingEl = document.querySelector(`.msg-wrapper[data-key="${key}"]`);
    const isNewMessage = !existingEl;
    if (isNewMessage) {
        existingEl = document.createElement('div');
        existingEl.className = 'msg-wrapper';
        existingEl.dataset.key = key;
    }

    // 5. KI·ªÇM TRA MENTION V√Ä TH√äM CLASS HIGHLIGHT
    let isMentioned = false;
    if (m.mentions && m.mentions.length > 0) {
        if (m.mentions.includes(currentUser.uid) || m.mentions.includes('all')) {
            isMentioned = true;
        }
    }
    existingEl.classList.toggle('mentioned-me', isMentioned);

    // 6. RENDER D·∫¢I PH√ÇN C√ÅCH NG√ÄY (CH·ªà KHI L√Ä TIN NH·∫ÆN M·ªöI)
    if (isNewMessage && m.timestamp) {
        const messageDate = new Date(m.timestamp).toLocaleDateString('vi-VN');
        if (messageDate !== lastMessageDate) {
            const separator = document.createElement('div');
            separator.className = 'message-date-separator';
            separator.textContent = (messageDate === new Date().toLocaleDateString('vi-VN')) ? 'H√¥m nay' : messageDate;
            // Ch√®n v√†o tr∆∞·ªõc existingEl n·∫øu existingEl ƒë√£ c√≥ trong DOM, n·∫øu kh√¥ng th√¨ append v√†o cu·ªëi
            if (existingEl.parentNode === messagesContainer) {
                 messagesContainer.insertBefore(separator, existingEl);
            } else {
                 messagesContainer.appendChild(separator); // L·∫ßn ƒë·∫ßu ti√™n th√™m tin nh·∫Øn
            }
            lastMessageDate = messageDate;
        }
    }

    // 7. G·∫ÆN ELEMENT V√ÄO GIAO DI·ªÜN (N·∫æU L√Ä TIN M·ªöI)
    if (isNewMessage) {
        messagesContainer.appendChild(existingEl);
    }

    // 8. T·∫†O HTML CHO N·ªòI DUNG TIN NH·∫ÆN
    existingEl.classList.toggle('sent', isSent);
    existingEl.classList.toggle('received', !isSent);

    // -- T·∫°o HTML cho Avatar --
    let avatarHtml = '';
    if (!isSent) {
        let avatarUrl = '';
        let senderUidForProfile = '';
        if (chatCtx.type === 'direct' && currentChatPeerData) {
            avatarUrl = currentChatPeerData.avatarUrl || `https://placehold.co/32x32/EFEFEF/333?text=${currentChatPeerData.displayName[0]}`;
            senderUidForProfile = currentChatPeerData.uid;
        } else if (chatCtx.type === 'group') {
            const memberInfo = currentGroupMembers.find(mem => mem.uid === m.senderId);
            avatarUrl = memberInfo?.avatarUrl || `https://placehold.co/32x32/1e293b/fff?text=${m.senderName ? m.senderName[0].toUpperCase() : '?'}`;
            senderUidForProfile = m.senderId;
        }
        if (avatarUrl) {
            avatarHtml = `<img src="${avatarUrl}" class="msg-avatar" data-uid="${senderUidForProfile}">`;
        }
    }

    // -- T·∫°o HTML cho T√™n ng∆∞·ªùi g·ª≠i (ch·ªâ trong group chat v√† tin nh·∫Øn nh·∫≠n) --
    let senderNameHtml = '';
    if (!isSent && chatCtx.type === 'group') {
        senderNameHtml = `<div class="msg-sender-name">${escapeHtml(m.senderName) || '...'}</div>`;
    }

    // -- T·∫°o HTML cho Bong b√≥ng chat --
    let msgBubbleHtml = '';
    if (m.recalled) {
        msgBubbleHtml = `<div class="msg recalled-message">Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi</div>`;
    } else {
        // G√°n data-sender-name v√†o th·∫ª .msg ƒë·ªÉ l·∫•y khi reply
        let content = `<div class="msg ${isSent ? 'sent' : ''}" data-sender-name="${escapeHtml(m.senderName || '')}">`;

        // Render quote tr·∫£ l·ªùi
        if (m.replyTo) {
            const repliedMsgWrapper = document.querySelector(`.msg-wrapper[data-key="${m.replyTo}"]`);
            if (repliedMsgWrapper) {
                const repliedMsgEl = repliedMsgWrapper.querySelector('.msg');
                if (repliedMsgEl && !repliedMsgEl.classList.contains('recalled-message')) {
                     const originalSenderName = repliedMsgEl.dataset.senderName || '...'; // L·∫•y t√™n g·ªëc
                     const originalText = repliedMsgEl.querySelector('.msg-text')?.textContent || (repliedMsgEl.querySelector('img') ? '·∫¢nh' : '...');
                     content += `<div class="reply-quote"><div class="sender">Tr·∫£ l·ªùi ${escapeHtml(originalSenderName)}</div><div class="text">${escapeHtml(originalText)}</div></div>`;
                } else {
                     content += `<div class="reply-quote"><div class="sender">Tr·∫£ l·ªùi tin nh·∫Øn ƒë√£ thu h·ªìi</div></div>`;
                }
            }
        }

        // Render text v√† highlight mention
        let messageTextHtml = '';
        if (m.text) {
            let escapedText = escapeHtml(m.text); // Lu√¥n escape tr∆∞·ªõc
            if (m.mentions && m.mentions.length > 0 && currentChatType === 'group') {
                 const sortedMembers = [...currentGroupMembers].sort((a, b) => b.displayName.length - a.displayName.length);
                 escapedText = escapedText.replace(/@all/g, '<span class="mention">@all</span>');
                 sortedMembers.forEach(member => {
                      const escapedName = escapeHtml(`@${member.displayName}`);
                      const regex = new RegExp(`(?<![a-zA-Z0-9])${escapedName.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}(?![a-zA-Z0-9])`, 'g');
                      if (m.mentions.includes(member.uid)) {
                          escapedText = escapedText.replace(regex, `<span class="mention">@${member.displayName}</span>`);
                      }
                 });
            }
            messageTextHtml = `<div class="msg-text">${escapedText}</div>`;
        }
        content += messageTextHtml;

        // Render ·∫£nh
        if (m.imageUrl) content += `<img src="${m.imageUrl}" alt="img"/>`;

        // Render timestamp v√† tr·∫°ng th√°i edited
        if (m.timestamp) {
            const d = new Date(m.timestamp);
            const hm = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            const editedLabel = m.edited ? `<span class="edited-label">(ƒë√£ ch·ªânh s·ª≠a)</span>` : '';
            content += `<div class="msg-meta">${hm}${editedLabel}</div>`;
        }

        // Render tr·∫°ng th√°i ƒê√£ g·ª≠i/ƒê√£ xem (cho tin nh·∫Øn g·ª≠i ƒëi)
        if (isSent) {
            let status = 'ƒê√£ g·ª≠i';
            if (chatCtx.type === 'direct') {
                const uids = chatCtx.id.split('_');
                const peerUid = uids[0] === currentUser.uid ? uids[1] : uids[0];
                if (m.readBy && m.readBy[peerUid]) { status = 'ƒê√£ xem'; }
            } else {
                if (m.readBy && Object.keys(m.readBy).length > 1) { status = 'ƒê√£ xem'; }
            }
            content += `<div class="msg-status">${status}</div>`;
        }

        content += `</div>`; // ƒê√≥ng th·∫ª div.msg
        msgBubbleHtml = content;
    }

    // 9. GH√âP HTML HO√ÄN CH·ªàNH
    existingEl.innerHTML = `
        ${avatarHtml}
        <div class="msg-content-wrapper">
            ${senderNameHtml}
            ${msgBubbleHtml}
            </div>
    `;

    // 10. RENDER B·∫¢NG T·ªîNG K·∫æT REACTION (Ch·ªâ khi ch∆∞a b·ªã thu h·ªìi)
    const reactions = m.reactions || {};
    let reactionsDisplay = existingEl.querySelector('.reactions-display'); // T√¨m l·∫°i sau khi innerHTML
    const msgContentWrapper = existingEl.querySelector('.msg-content-wrapper'); // Kh·ªëi ch·ª©a bubble chat

    if (Object.keys(reactions).length > 0 && !m.recalled && msgContentWrapper) { // Check th√™m msgContentWrapper
        if (!reactionsDisplay) {
            reactionsDisplay = document.createElement('div');
            reactionsDisplay.className = 'reactions-display';
            msgContentWrapper.appendChild(reactionsDisplay); // G·∫Øn v√†o msg-content-wrapper
        }
        let reactionsHTML = '';
        for (const emoji in reactions) {
            let count = 0;
            if (emoji === '‚ù§Ô∏è') {
                 count = Object.values(reactions[emoji]).reduce((sum, val) => sum + (typeof val === 'number' ? val : 1), 0);
            } else {
                 count = Object.keys(reactions[emoji]).length;
            }
            if (count > 0) {
                reactionsHTML += `<span>${emoji} ${count}</span>`;
            }
        }
        reactionsDisplay.innerHTML = reactionsHTML;
        reactionsDisplay.onclick = (e) => { e.stopPropagation(); showReactionsDetails(key); };
    } else {
        if (reactionsDisplay) reactionsDisplay.remove();
    }

    // 11. G√ÅN L·∫†I C√ÅC S·ª∞ KI·ªÜN KH√ÅC
    const imageInMessage = existingEl.querySelector('.msg img');
    if (imageInMessage) { imageInMessage.onclick = () => openLightbox(imageInMessage.src); }

    const avatarInMessage = existingEl.querySelector('.msg-avatar');
    if (avatarInMessage && avatarInMessage.dataset.uid) {
        avatarInMessage.onclick = () => window.open(`profile.html?id=${avatarInMessage.dataset.uid}`, '_blank');
    }

    existingEl.onclick = () => {
        if (messagesContainer.classList.contains('selection-mode')) {
            const messageData = { key, ...m };
            const index = selectedEvidence.findIndex(e => e.key === key);
            if (index > -1) {
                selectedEvidence.splice(index, 1);
                existingEl.classList.remove('selected');
            } else {
                selectedEvidence.push(messageData);
                existingEl.classList.add('selected');
            }
            updateSelectionCount();
        }
    };
    
    // 12. C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI "ƒê√É ƒê·ªåC"
    if (!isSent && (!m.readBy || !m.readBy[currentUser.uid])) {
        rtdbUpdate(ref(rtdb, `/messages/${chatCtx.id}/${key}/readBy`), { [currentUser.uid]: true });
    }

    // 13. T·ª∞ ƒê·ªòNG CU·ªòN XU·ªêNG D∆Ø·ªöI
    const shouldScroll = messagesContainer.scrollHeight - messagesContainer.scrollTop < messagesContainer.clientHeight + 150 || isSent || isNewMessage; // Cu·ªôn n·∫øu l√† tin m·ªõi
    if (shouldScroll) {
         // D√πng setTimeout nh·ªè ƒë·ªÉ ƒë·ª£i tr√¨nh duy·ªát render xong r·ªìi m·ªõi cu·ªôn
         setTimeout(() => { messagesContainer.scrollTop = messagesContainer.scrollHeight; }, 50); 
    }
}
function showMessageContextMenu(e) {
    const wrapper = e.target.closest('.msg-wrapper');
    if (!wrapper) return;
    e.preventDefault();
    const msgKey = wrapper.dataset.key;
    const msgRef = ref(rtdb, `/messages/${currentChatId}/${msgKey}`);
    onValue(msgRef, (snap) => {
        if (!snap.exists()) return;
        const msg = snap.val();
        messageContextMenu.innerHTML = '';
        if (!msg.recalled) {
            const btnReply = document.createElement('button');
            btnReply.className = 'context-menu-btn';
            btnReply.textContent = '‚Ü™Ô∏è Tr·∫£ l·ªùi';
            btnReply.onclick = () => {
                replyToMessage(msgKey, msg);
                messageContextMenu.style.display = 'none';
            };
            messageContextMenu.appendChild(btnReply);
        }
        if (msg.senderId === currentUser.uid) {
            if (msg.text && !msg.recalled) {
                const btnEdit = document.createElement('button');
                btnEdit.className = 'context-menu-btn';
                btnEdit.textContent = '‚úèÔ∏è Ch·ªânh s·ª≠a';
                btnEdit.onclick = () => {
                    startEditMessage(msgKey, msg);
                    messageContextMenu.style.display = 'none';
                };
                messageContextMenu.appendChild(btnEdit);
            }
            const timeSinceSent = Date.now() - msg.timestamp;
            if (timeSinceSent < 3 * 60 * 1000 && !msg.recalled) {
                const btnRecall = document.createElement('button');
                btnRecall.className = 'context-menu-btn danger';
                btnRecall.textContent = 'üóëÔ∏è Thu h·ªìi';
                btnRecall.onclick = () => {
                    recallMessage(msgKey);
                    messageContextMenu.style.display = 'none';
                };
                messageContextMenu.appendChild(btnRecall);
            }
        }
        const btnDelete = document.createElement('button');
        btnDelete.className = 'context-menu-btn danger';
        btnDelete.textContent = '‚ùå X√≥a ·ªü ph√≠a b·∫°n';
        btnDelete.onclick = () => {
            deleteMessageForSelf(msgKey);
            messageContextMenu.style.display = 'none';
        };
        messageContextMenu.appendChild(btnDelete);
        messageContextMenu.style.display = 'block';
        messageContextMenu.style.left = `${e.pageX}px`;
        messageContextMenu.style.top = `${e.pageY}px`;
    }, { onlyOnce: true });
}
function recallMessage(key) {
    const msgRef = ref(rtdb, `/messages/${currentChatId}/${key}`);
    rtdbUpdate(msgRef, { text: null, imageUrl: null, recalled: true, replyTo: null, reactions: {} });
}
function deleteMessageForSelf(key) {
    const el = document.querySelector(`.msg-wrapper[data-key="${key}"]`);
    if (el) el.remove();
}
function replyToMessage(key, message) {
    replyingTo = { key, message };
    replyPreviewContainer.style.display = 'block';
    replyPreviewSender.textContent = `ƒêang tr·∫£ l·ªùi ${message.senderId === currentUser.uid ? 'ch√≠nh m√¨nh' : message.senderName || '...'}`;
    replyPreviewText.textContent = message.text || 'M·ªôt h√¨nh ·∫£nh';
    messageInput.focus();
}
function cancelReply() {
    replyingTo = null;
    replyPreviewContainer.style.display = 'none';
}
function cancelImagePreview(){
  selectedImageFile=null; imageInput.value=''; imagePreviewContainer.style.display='none';
  messageInput.placeholder='Nh·∫≠p tin nh·∫Øn...';
}
async function uploadImage(file){
  if(!IMGBB_API_KEY) throw new Error('Thi·∫øu API ImgBB');
  const fd=new FormData(); fd.append('image', file);
  const res=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:'POST', body:fd});
  const data=await res.json(); if(data.success) return data.data.url;
  throw new Error(data.error?.message||'Upload fail');
}
async function handleAcceptFriend(reqId, fromUid){
  const reqRef = doc(db, 'friend_requests', reqId);
  await updateDoc(reqRef, { status: 'accepted' });
  await updateDoc(doc(db, 'users', currentUser.uid), { friends: arrayUnion(fromUid) });
  await updateDoc(doc(db, 'users', fromUid), { friends: arrayUnion(currentUser.uid) });
  showToast('‚úÖ ƒê√£ ch·∫•p nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n!', 'success');
}
async function handleRejectFriend(reqId){
  const reqRef = doc(db, 'friend_requests', reqId);
  await updateDoc(reqRef, { status: 'declined' });
  showToast('‚ùå ƒê√£ t·ª´ ch·ªëi l·ªùi m·ªùi.');
}
async function showFriendInfo(friendUid) {
  groupInfoContent.style.display = 'none';
  friendInfoContent.style.display = 'block';
  const isFriend = currentFriends.includes(friendUid);
  removeFriendBtn.style.display = isFriend ? 'block' : 'none';
  const isBlocked = currentUserData.blocked?.includes(friendUid);
  blockUserBtn.style.display = !isBlocked ? 'block' : 'none';
  unblockUserBtn.style.display = isBlocked ? 'block' : 'none';
  const friendDoc = await getDoc(doc(db, "users", friendUid));
  if (friendDoc.exists()) {
    const d = friendDoc.data();
    const verifiedTick = createVerifiedTickHTML(d.isVerified);
    friendName.innerHTML = `${escapeHtml(d.displayName || d.email)} ${verifiedTick}`;
    friendAvatar.src = d.avatarUrl || `https://placehold.co/80x80/EFEFEF/333?text=${d.displayName?.[0] || 'U'}`;
    blockUserBtn.onclick = () => blockUser(friendUid, friendName.textContent);
    unblockUserBtn.onclick = () => unblockUser(friendUid, friendName.textContent);
    const reportUserBtn = document.getElementById('report-user-btn');
    reportUserBtn.onclick = () => {
        reportingUser = { uid: friendUid, name: d.displayName || d.email };
        reportingUserName.textContent = `B·∫°n ƒëang b√°o c√°o ${reportingUser.name}.`;
        reportUserModal.style.display = 'flex';
    };
  }
  const chatId = [currentUser.uid, friendUid].sort().join("_");
  const msgRef = ref(rtdb, `/messages/${chatId}`);
  onValue(msgRef, (snap) => {
    sentImagesGrid.innerHTML = '';
    snap.forEach((child) => {
      const msg = child.val();
      if (msg.imageUrl) {
        const img = document.createElement('img'); img.src = msg.imageUrl;
        img.onclick = () => window.open(msg.imageUrl, "_blank");
        sentImagesGrid.appendChild(img);
      }
    });
  }, { onlyOnce: true });
  removeFriendBtn.onclick = async () => {
    const confirmed = await showConfirmation(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a "${friendName.textContent}" kh·ªèi danh s√°ch b·∫°n b√®?`);
    if (confirmed) {
        const meRef = doc(db, 'users', currentUser.uid);
        const friendRef = doc(db, 'users', friendUid);
        try {
            await updateDoc(meRef, { friends: arrayRemove(friendUid) });
            await updateDoc(friendRef, { friends: arrayRemove(currentUser.uid) });
            showToast("ƒê√£ x√≥a b·∫°n.", 'success');
            chatInfoPanel.classList.remove('open');
            currentChatFriendName.textContent = "Ch·ªçn cu·ªôc tr√≤ chuy·ªán";
            messagesContainer.innerHTML = '';
            messageInput.disabled = true; sendBtn.disabled = true;
        } catch(error) { console.error("L·ªói khi x√≥a b·∫°n:", error); showToast("C√≥ l·ªói x·∫£y ra khi x√≥a b·∫°n."); }
    }
  };
}
async function submitReport() {
    if (!reportingUser) return;
    const reason = document.querySelector('input[name="reportReason"]:checked').value;
    const details = reportDetails.value.trim();
    try {
        await addDoc(collection(db, "reports"), {
            reporterUid: currentUser.uid,
            reportedUid: reportingUser.uid,
            reason: reason,
            details: details,
            evidence: selectedEvidence,
            timestamp: serverTimestamp()
        });
        showToast("ƒê√£ g·ª≠i b√°o c√°o th√†nh c√¥ng. C·∫£m ∆°n b·∫°n!", "success");
    } catch (error) {
        console.error("L·ªói khi g·ª≠i b√°o c√°o:", error);
        showToast("C√≥ l·ªói x·∫£y ra, kh√¥ng th·ªÉ g·ª≠i b√°o c√°o.", "error");
    } finally {
        reportUserModal.style.display = 'none';
        reportDetails.value = '';
        reportingUser = null;
        selectedEvidence = [];
        evidencePreview.style.display = 'none';
    }
}
function createReactionPicker(msgKey) {
    const picker = document.createElement('div');
    picker.className = 'reaction-picker';
    ['‚ù§Ô∏è', 'üëç', 'üòÇ', 'üòÆ', 'üò¢', 'üò°', 'üö´'].forEach(emoji => {
        const btn = document.createElement('span');
        btn.className = 'reaction-btn';
        btn.textContent = emoji;
        btn.onclick = (e) => { e.stopPropagation(); reactToMessage(msgKey, emoji); };
        picker.appendChild(btn);
    });
    return picker;
}
// THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈® B·∫∞NG H√ÄM N√ÄY
// THAY TH·∫æ H√ÄM reactToMessage
async function reactToMessage(msgKey, emoji) {
    // --- TH√äM ƒêO·∫†N KI·ªÇM TRA N√ÄY V√ÄO ƒê·∫¶U H√ÄM ---
    const checkMsgRef = ref(rtdb, `/messages/${currentChatId}/${msgKey}`);
    const msgSnapshot = await get(checkMsgRef); // D√πng get() ƒë·ªÉ l·∫•y d·ªØ li·ªáu 1 l·∫ßn
    if (!msgSnapshot.exists() || msgSnapshot.val().recalled) {
        // N·∫øu tin nh·∫Øn kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã thu h·ªìi -> kh√¥ng l√†m g√¨ c·∫£
        return; 
    }
    // --- K·∫æT TH√öC ƒêO·∫†N KI·ªÇM TRA ---
    // Logic n√∫t H·ªßy reaction (gi·ªØ nguy√™n)
    if (emoji === 'üö´') {
        const path = `/messages/${currentChatId}/${msgKey}/reactions`;
        const reactionRef = ref(rtdb, path);
        onValue(reactionRef, (snap) => {
            if (snap.exists()) {
                const reactions = snap.val();
                for (const e in reactions) {
                    remove(ref(rtdb, `${path}/${e}/${currentUser.uid}`));
                }
            }
        }, { onlyOnce: true });
        return;
    }

    const path = `/messages/${currentChatId}/${msgKey}/reactions/${emoji}/${currentUser.uid}`;
    const reactionRef = ref(rtdb, path);

    // --- LOGIC M·ªöI CHO PH√âP TH·∫¢ NHI·ªÄU TIM ---
    onValue(reactionRef, (snap) => {
        if (emoji === '‚ù§Ô∏è') {
            // V·ªõi tr√°i tim, n√≥ l√† b·ªô ƒë·∫øm
            const currentCount = snap.val() || 0;
            set(reactionRef, currentCount + 1);
        } else {
            // V·ªõi c√°c icon kh√°c, n√≥ l√† c√¥ng t·∫Øc b·∫≠t/t·∫Øt
            if (snap.exists()) {
                remove(reactionRef);
            } else {
                set(reactionRef, true);
            }
        }
    }, { onlyOnce: true });
}

// THAY TH·∫æ H√ÄM showReactionsDetails ƒê·ªÇ ƒê·∫æM TIM ƒê√öNG
async function showReactionsDetails(msgKey) {
    const msgRef = ref(rtdb, `/messages/${currentChatId}/${msgKey}`);
    onValue(msgRef, async (snap) => {
        if (!snap.exists()) return;
        const msg = snap.val();
        const reactions = msg.reactions || {};
        
        reactionsList.innerHTML = 'ƒêang t·∫£i...';
        reactionsModal.style.display = 'flex';
        
        let allReactors = [];
        for (const [emoji, reactors] of Object.entries(reactions)) {
            for (const [uid, value] of Object.entries(reactors)) {
                // value c√≥ th·ªÉ l√† 'true' ho·∫∑c m·ªôt con s·ªë (n·∫øu l√† tim)
                const count = (emoji === '‚ù§Ô∏è' && typeof value === 'number') ? value : 1;
                allReactors.push({ uid, emoji, count });
            }
        }

        if (allReactors.length === 0) {
            reactionsList.innerHTML = 'Ch∆∞a c√≥ ai b√†y t·ªè c·∫£m x√∫c.';
            return;
        }

        let html = '';
        for (const reactor of allReactors) {
            const userDoc = await getDoc(doc(db, 'users', reactor.uid));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                const countDisplay = reactor.count > 1 ? ` ${reactor.count}` : '';
                html += `
                    <div class="reaction-user-item">
                        <div class="reaction-user-info">
                            <img class="reaction-user-avatar" src="${userData.avatarUrl || `https://placehold.co/36x36?text=${(userData.displayName || '?')[0]}`}">
                            <span class="reaction-user-name">${userData.displayName || userData.email}</span>
                        </div>
                        <span class="reaction-emoji">${reactor.emoji}${countDisplay}</span>
                    </div>
                `;
            }
        }
        reactionsList.innerHTML = html;
    }, { onlyOnce: true });
}

async function openCreateGroupModal() {
    groupMembersChecklist.innerHTML = 'ƒêang t·∫£i b·∫°n b√®...';
    createGroupModal.style.display = 'flex';
    const meDoc = await getDoc(doc(db, 'users', currentUser.uid));
    const friendUids = meDoc.data()?.friends || [];
    groupMembersChecklist.innerHTML = '';
    if (friendUids.length === 0) {
        groupMembersChecklist.innerHTML = '<p>B·∫°n ch∆∞a c√≥ b·∫°n b√® ƒë·ªÉ m·ªùi.</p>';
        return;
    }
    for (const friendUid of friendUids) {
        const friendDoc = await getDoc(doc(db, 'users', friendUid));
        if (friendDoc.exists()) {
            const friendData = friendDoc.data();
            const displayName = friendData.displayName || friendData.email;
            const div = document.createElement('div');
            div.innerHTML = `<label><input type="checkbox" class="group-member-checkbox" value="${friendUid}"> ${displayName}</label>`;
            groupMembersChecklist.appendChild(div);
        }
    }
}
async function confirmCreateGroup() {
    const groupName = groupNameInput.value.trim();
    if (!groupName) return showToast('Vui l√≤ng nh·∫≠p t√™n nh√≥m.');
    const memberCheckboxes = document.querySelectorAll('.group-member-checkbox:checked');
    const invitedUids = Array.from(memberCheckboxes).map(cb => cb.value);
    const memberUids = [currentUser.uid, ...invitedUids];
    const roles = { [currentUser.uid]: 'admin' };
    invitedUids.forEach(uid => roles[uid] = 'member');
    if (memberUids.length < 2) return showToast('Nh√≥m ph·∫£i c√≥ √≠t nh·∫•t 2 ng∆∞·ªùi.');
    try {
        await addDoc(collection(db, 'groups'), {
            groupName, member_uids: memberUids, roles,
            createdBy: currentUser.uid, createdAt: serverTimestamp()
        });
        showToast(`ƒê√£ t·∫°o nh√≥m "${groupName}"!`, 'success');
        createGroupModal.style.display = 'none';
        groupNameInput.value = '';
    } catch (error) { console.error("L·ªói khi t·∫°o nh√≥m:", error); showToast("Kh√¥ng th·ªÉ t·∫°o nh√≥m."); }
}
async function showGroupInfo(groupId) {
    friendInfoContent.style.display = 'none';
    groupInfoContent.style.display = 'block';
    const groupRef = doc(db, "groups", groupId);
    onSnapshot(groupRef, async (groupDoc) => {
        if (!groupDoc.exists()) return;
        const groupData = groupDoc.data();
        const groupName = groupData.groupName;
        const roles = groupData.roles || {};
        const myRole = roles[currentUser.uid];
        groupNameDisplay.textContent = groupName;
        groupAvatar.src = `https://placehold.co/95x95/1e293b/fff?text=${groupName[0]}`;
        const memberUids = groupData.member_uids || [];
        groupMembersList.innerHTML = '';
        for (const uid of memberUids) {
            const userDoc = await getDoc(doc(db, "users", uid));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                const memberRole = roles[uid] || 'member';
                const roleLabels = { admin: 'Tr∆∞·ªüng nh√≥m', moderator: 'Ph√≥ nh√≥m', member: 'Th√†nh vi√™n' };
                const roleClass = { admin: 'role-admin', moderator: 'role-moderator', member: 'role-member' };
                let actionButtons = '';
                if (myRole === 'admin' && uid !== currentUser.uid) {
                    actionButtons += `<button data-action="kick" data-uid="${uid}">Kick</button>`;
                    switch (memberRole) {
                        case 'member':
                            actionButtons += `<button data-action="promote-mod" data-uid="${uid}">Phong Ph√≥ nh√≥m</button>`;
                            break;
                        case 'moderator':
                            actionButtons += `<button data-action="demote-member" data-uid="${uid}">Gi√°ng l√†m Th√†nh vi√™n</button>`;
                            break;
                    }
                } else if (myRole === 'moderator' && memberRole === 'member') {
                    actionButtons += `<button data-action="kick" data-uid="${uid}">Kick</button>`;
                }
                const li = document.createElement('li');
                li.className = 'member-item';
                li.innerHTML = `<div class="member-info"><span class="member-name">${userData.displayName || userData.email}</span><span class="member-role ${roleClass[memberRole]}">${roleLabels[memberRole]}</span></div><div class="member-actions">${actionButtons}</div>`;
                groupMembersList.appendChild(li);
            }
        }
    });
    groupMembersList.onclick = (e) => {
        if (e.target.dataset.action) {
            const action = e.target.dataset.action;
            const targetUid = e.target.dataset.uid;
            if (action === 'kick') { if (confirm('Kick th√†nh vi√™n n√†y?')) kickMember(groupId, targetUid); }
            else if (action === 'promote-mod') { changeRole(groupId, targetUid, 'moderator'); }
            else if (action === 'demote-member') { changeRole(groupId, targetUid, 'member'); }
        }
    };
    groupSentImagesGrid.innerHTML = '';
    const groupMsgsRef = ref(rtdb, `/messages/${groupId}`);
    onValue(groupMsgsRef, (snap) => {
        groupSentImagesGrid.innerHTML = '';
        if (!snap.exists()) return;
        snap.forEach(childSnap => {
            const msg = childSnap.val();
            if (msg.imageUrl) {
                const img = document.createElement('img'); img.src = msg.imageUrl;
                img.onclick = () => window.open(msg.imageUrl, "_blank");
                groupSentImagesGrid.appendChild(img);
            }
        });
    }, { onlyOnce: true });
    leaveGroupBtn.onclick = async () => {
        const groupDoc = await getDoc(doc(db, "groups", groupId));
        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi kh·ªèi nh√≥m "${groupDoc.data().groupName}"?`)) {
            const groupRef = doc(db, 'groups', groupId);
            await updateDoc(groupRef, {
                member_uids: arrayRemove(currentUser.uid),
                [`roles.${currentUser.uid}`]: deleteField()
            });
            showToast('ƒê√£ r·ªùi nh√≥m.', 'success');
            chatInfoPanel.classList.remove('open');
            currentChatFriendName.textContent = "Ch·ªçn cu·ªôc tr√≤ chuy·ªán";
            messagesContainer.innerHTML = '';
            messageInput.disabled = true; sendBtn.disabled = true;
        }
    };
}
async function kickMember(groupId, targetUid) {
    const groupRef = doc(db, 'groups', groupId);
    try {
        await updateDoc(groupRef, {
            member_uids: arrayRemove(targetUid),
            [`roles.${targetUid}`]: deleteField()
        });
        showToast('ƒê√£ kick th√†nh vi√™n.', 'success');
    } catch (error) { console.error("L·ªói khi kick:", error); showToast("C√≥ l·ªói x·∫£y ra."); }
}
async function changeRole(groupId, targetUid, newRole) {
    const groupRef = doc(db, 'groups', groupId);
    try {
        await updateDoc(groupRef, { [`roles.${targetUid}`]: newRole });
        showToast(`ƒê√£ c·∫≠p nh·∫≠t vai tr√≤ th√†nh ${newRole}.`, 'success');
    } catch (error) { console.error("L·ªói khi ƒë·ªïi vai tr√≤:", error); showToast("C√≥ l·ªói x·∫£y ra."); }
}
function attachGlobalSearch(){
    globalSearch.addEventListener('input', async (e)=>{
        const searchTerm = e.target.value.trim().toLowerCase();
        if(!searchTerm){ searchDropdown.style.display='none'; searchDropdown.innerHTML=''; return; }
        
        // L·∫•y danh s√°ch b·∫°n b√® v√† nh√≥m t·ª´ d·ªØ li·ªáu ƒë√£ t·∫£i
        const friendUIDs = currentUserData.friends || [];
        const friendDocs = await Promise.all(friendUIDs.map(uid => getDoc(doc(db, 'users', uid))));
        const friends = friendDocs.map(d => d.data()).filter(Boolean);
        
        const qg = query(collection(db, 'groups'), where('member_uids', 'array-contains', currentUser.uid));
        const gs = await getDocs(qg);
        const groups = [];
        gs.forEach(d => groups.push({id: d.id, ...d.data()}));

        // L·ªçc d·ª±a tr√™n t·ª´ kh√≥a t√¨m ki·∫øm
        const friendsFiltered = friends.filter(u => (u.displayName || u.email || '').toLowerCase().includes(searchTerm));
        const groupsFiltered = groups.filter(g => (g.groupName || '').toLowerCase().includes(searchTerm));
        
        searchDropdown.innerHTML='';
        const addSection=(title,items,render)=>{
            const st=document.createElement('div'); st.className='section-title'; st.textContent=title; searchDropdown.appendChild(st);
            if(!items.length){ const em=document.createElement('div'); em.className='result-item'; em.innerHTML=`<div class="result-sub">Kh√¥ng c√≥ k·∫øt qu·∫£</div>`; searchDropdown.appendChild(em); return; }
            items.forEach(x=> searchDropdown.appendChild(render(x)));
        };

        addSection('B·∫°n b√®', friendsFiltered, (u)=>{
            const el=document.createElement('div'); el.className='result-item';
            const verifiedTick = createVerifiedTickHTML(u.isVerified);
            el.innerHTML=`<div class="result-left"><img class="result-avatar" src="${u.avatarUrl||`https://placehold.co/32x32/111/fff?text=${u.displayName[0]}`}"/><div><div class="result-name">${escapeHtml(u.displayName||u.email)}${verifiedTick}</div></div></div>`;
            el.onclick=()=>{ startDirectChat(u); hideDropdown(); };
            return el;
        });

        addSection('Nh√≥m', groupsFiltered, (g)=>{
            const el=document.createElement('div'); el.className='result-item';
            el.innerHTML=`<div class="result-left"><img class="result-avatar" src="https://placehold.co/32x32/0af/fff?text=G"/><div><div class="result-name">üë• ${g.groupName}</div></div></div>`;
            el.onclick=()=>{ startGroupChat(g.id, g.groupName); hideDropdown(); };
            return el;
        });

        searchDropdown.style.display='block';
    });
    
    const hideDropdown=()=> searchDropdown.style.display='none';
    document.addEventListener('click',(e)=>{
        if(e.target===globalSearch || searchDropdown.contains(e.target)) return;
        hideDropdown();
    });
}

function loadFriendRequests(){
  const q = query(collection(db, 'friend_requests'), where('to_uid', '==', currentUser.uid), where('status', '==', 'pending'));
  onSnapshot(q, (snap)=>{
    // --- B·∫ÆT ƒê·∫¶U CODE M·ªöI ---
    // T·ª± ƒë·ªông b·∫≠t/t·∫Øt ch·∫•m ƒë·ªè th√¥ng b√°o
    const openFriendReqBtn = document.getElementById('open-friend-req-btn');
    openFriendReqBtn.classList.toggle('has-new-request', !snap.empty);
    // --- K·∫æT TH√öC CODE M·ªöI ---

    friendReqList.innerHTML = '';
    if(snap.empty){
      friendReqList.innerHTML = `<p style="opacity:0.7;">Kh√¥ng c√≥ l·ªùi m·ªùi n√†o.</p>`;
      return;
    }
    snap.forEach(docSnap=>{
      const req = docSnap.data();
      const item = document.createElement('div');
      item.className = 'friend-req-item';
      item.innerHTML = `<div class="friend-req-name">${req.from_email}</div><div class="friend-req-buttons"><button class="friend-req-btn accept-btn">Ch·∫•p nh·∫≠n</button><button class="friend-req-btn reject-btn">T·ª´ ch·ªëi</button></div>`;
      const [acceptBtn, rejectBtn] = item.querySelectorAll('button');
      acceptBtn.onclick = ()=> handleAcceptFriend(docSnap.id, req.from_uid);
      rejectBtn.onclick = ()=> handleRejectFriend(docSnap.id);
      friendReqList.appendChild(item);
    });
  });
}
async function saveProfileChanges() {
    const newDisplayName = profileDisplayName.value.trim();
    const newBio = profileBio.value.trim();
    const newAvatarUrl = profileAvatarUrl.value.trim();
    if (!newDisplayName) {
        return showToast('T√™n hi·ªÉn th·ªã kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.');
    }
    const userRef = doc(db, 'users', currentUser.uid);
    try {
        await updateDoc(userRef, {
            displayName: newDisplayName,
            bio: newBio,
            avatarUrl: newAvatarUrl
        });
        showToast('C·∫≠p nh·∫≠t h·ªì s∆° th√†nh c√¥ng!', 'success');
        editProfileModal.style.display = 'none';
    } catch (error) {
        console.error("L·ªói khi c·∫≠p nh·∫≠t h·ªì s∆°:", error);
        showToast('C√≥ l·ªói x·∫£y ra, kh√¥ng th·ªÉ c·∫≠p nh·∫≠t.');
    }
}
async function blockUser(friendUid, name) {
    const confirmed = await showConfirmation(`Ch·∫∑n ${name}? B·∫°n s·∫Ω kh√¥ng nh·∫≠n ƒë∆∞·ª£c tin nh·∫Øn t·ª´ h·ªç n·ªØa v√† h·ªç s·∫Ω b·ªã x√≥a kh·ªèi danh s√°ch b·∫°n b√® (n·∫øu c√≥).`);
    if (confirmed) {
      try {
        await updateDoc(doc(db, 'users', currentUser.uid), {
            blocked: arrayUnion(friendUid),
            friends: arrayRemove(friendUid)
        });
        await updateDoc(doc(db, 'users', friendUid), {
            friends: arrayRemove(currentUser.uid)
        });
        showToast("‚úÖ ƒê√£ ch·∫∑n th√†nh c√¥ng!", 'success');
        chatInfoPanel.classList.remove('open');
      } catch (err) { console.error(err); showToast("‚ùå L·ªói khi ch·∫∑n!"); }
    }
}
async function unblockUser(friendUid, name) {
    const confirmed = await showConfirmation(`B·ªè ch·∫∑n ${name}?`);
    if (confirmed) {
        try {
            await updateDoc(doc(db, 'users', currentUser.uid), { blocked: arrayRemove(friendUid) });
            showToast("‚úÖ ƒê√£ b·ªè ch·∫∑n!", 'success');
            chatInfoPanel.classList.remove('open');
        } catch (err) { console.error(err); showToast("‚ùå L·ªói khi b·ªè ch·∫∑n!"); }
    }
}
async function handleUrlChat() {
    const params = new URLSearchParams(window.location.search);
    const friendUid = params.get('chat');
    const groupId = params.get('chat_group');
    if (friendUid) {
        const userDoc = await getDoc(doc(db, 'users', friendUid));
        if (userDoc.exists()) {
            startDirectChat(userDoc.data());
        }
    } else if (groupId) {
        const groupDoc = await getDoc(doc(db, 'groups', groupId));
        if (groupDoc.exists()) {
            startGroupChat(groupId, groupDoc.data().groupName);
        }
    }
}

</script>
</body>
</html>